---
sidebar_position: 4
sidebar_label: Connectez votre agent aux API tierces
---

# Connectez votre agent IA aux API tierces

Ce guide vous explique comment permettre √† votre agent IA d'acc√©der aux API tierces (par exemple, Google Calendar, GitHub, etc.) au nom des utilisateurs. En tirant parti des connecteurs sociaux de Logto et du Secret Vault, vous pouvez stocker et g√©rer en toute s√©curit√© les jetons d‚Äôacc√®s, permettant √† votre agent d‚Äôeffectuer des t√¢ches automatis√©es sans demander √† plusieurs reprises aux utilisateurs de se r√©-authentifier.

Vous apprendrez √† :

- Configurer des connecteurs sociaux avec stockage de jetons tiers.
- Demander des permissions minimales lors de la premi√®re connexion.
- Demander progressivement des permissions suppl√©mentaires selon les besoins.
- R√©cup√©rer et utiliser les jetons stock√©s pour acc√©der aux API tierces.

## Pourquoi votre agent IA a besoin d‚Äôacc√©der aux API tierces \{#why-your-ai-agent-needs-third-party-api-access}

Les agents IA sont de plus en plus utilis√©s pour automatiser des t√¢ches n√©cessitant une interaction avec des services externes. Par exemple :

- **üìÖ Gestion de calendrier** : Votre agent IA peut planifier automatiquement des r√©unions, ajouter des √©v√©nements ou ajuster des rendez-vous sur Google Calendar.
- **üìß Automatisation des e-mails** : Envoyer des e-mails de suivi, organiser les bo√Ætes de r√©ception ou r√©diger des r√©ponses via les API Gmail.
- **üíª Gestion de code** : Cr√©er des issues GitHub, examiner des pull requests ou g√©rer des d√©p√¥ts.
- **üìÅ Gestion de fichiers** : T√©l√©charger, organiser ou partager des fichiers sur Google Drive ou Dropbox.

Pour effectuer ces t√¢ches, votre agent IA a besoin d‚Äôun acc√®s s√©curis√© aux API tierces autoris√©es par l‚Äôutilisateur, ce qui implique de g√©rer correctement et en toute s√©curit√© les jetons OAuth.

## Comment √ßa fonctionne \{#how-it-works}

Voici un aper√ßu rapide du flux :

```mermaid
sequenceDiagram
    participant User as Utilisateur
    participant Agent as Votre agent IA
    participant Logto
    participant Google as Fournisseur tiers<br/>(par ex., Google)

    rect rgba(200, 230, 200, 0.5)
        Note over User, Google: L'utilisateur accorde des permissions au fournisseur tiers
        User->>Agent: "Ajoute une r√©union √† mon agenda demain √† 15h"
        Agent->>User: Besoin d‚Äôun acc√®s √† Google Calendar, veuillez autoriser
        User->>Agent: Initier l‚Äôautorisation Google
        Agent->>Logto: Initier la v√©rification sociale
        Logto->>Google: Rediriger vers Google
        User->>Google: S‚Äôauthentifier et accorder les permissions
        Google->>Logto: Retourner le code d‚Äôautorisation
        Logto->>Google: √âchanger le code contre des jetons
        Logto->>Logto: Stocker les jetons dans le Secret Vault
        Logto->>Agent: Retourner le r√©sultat de la v√©rification
    end

    rect rgba(200, 200, 230, 0.5)
        Note over User, Google: Ex√©cution de la t√¢che par l‚Äôagent IA
        Agent->>Logto: R√©cup√©rer le jeton d‚Äôacc√®s Google
        Logto->>Agent: Retourner le jeton d‚Äôacc√®s
        Agent->>Google: Appeler l‚ÄôAPI Google Calendar
        Google->>Agent: Retourner le succ√®s
        Agent->>User: "C‚Äôest fait ! J‚Äôai ajout√© la r√©union √† votre agenda."
    end
```

1. **L‚Äôutilisateur demande une t√¢che** : L‚Äôutilisateur demande √† l‚Äôagent IA d‚Äôeffectuer une t√¢che n√©cessitant l‚Äôacc√®s √† une API tierce (par exemple, ajouter un √©v√©nement au calendrier).
2. **Demande d‚Äôautorisation** : L‚Äôagent d√©tecte le besoin d‚Äôacc√®s tiers et invite l‚Äôutilisateur √† autoriser.
3. **Jetons stock√©s** : Apr√®s l‚Äôautorisation de l‚Äôutilisateur, Logto stocke en toute s√©curit√© les jetons d‚Äôacc√®s et de rafra√Æchissement dans le Secret Vault.
4. **Ex√©cution de la t√¢che** : L‚Äôagent r√©cup√®re le jeton stock√© et appelle l‚ÄôAPI tierce pour accomplir la t√¢che.

Une fois autoris√©, l‚Äôutilisateur peut effectuer plusieurs t√¢ches sans devoir r√©autoriser. Logto stocke les jetons en toute s√©curit√© et les renouvelle automatiquement si n√©cessaire, offrant une exp√©rience fluide pour les interactions continues avec l‚Äôagent IA.

## Pr√©requis \{#prerequisites}

Avant de commencer, assurez-vous d‚Äôavoir :

- Un tenant [Logto Cloud](https://cloud.logto.io) (ou Logto auto-h√©berg√© v1.31+)
- Un compte fournisseur tiers avec acc√®s API (par exemple, [Google Cloud Console](https://console.cloud.google.com))
- Une application agent IA int√©gr√©e avec le SDK Logto (les utilisateurs peuvent se connecter √† votre agent IA)

## Configurer un connecteur social avec stockage de jetons \{#set-up-social-connector-with-token-storage}

Pour permettre √† votre agent IA d‚Äôacc√©der aux API tierces, vous devez configurer un connecteur social avec le stockage de jetons activ√©. Cela permet √† Logto de stocker et de g√©rer les jetons d‚Äôacc√®s lorsque les utilisateurs autorisent des services tiers lors de leur interaction avec votre agent IA.

Prenons Google comme exemple :

1. Rendez-vous sur <CloudLink to="/connectors/social">Console > Connecteurs > Connecteurs sociaux</CloudLink>.
2. Cliquez sur **Ajouter un connecteur social** et s√©lectionnez **Google**.
3. Suivez le [guide de configuration du connecteur Google](/integrations/google) pour configurer vos identifiants OAuth client.
4. Dans les param√®tres du connecteur :
   - Activez **Stocker les jetons pour un acc√®s API persistant** pour stocker les jetons dans le Secret Vault.
   - D√©finissez **Prompts** pour inclure `consent` afin de garantir que l‚Äôutilisateur voit la demande de permission.
   - Activez **Acc√®s hors ligne** pour recevoir des jetons de rafra√Æchissement pour un acc√®s API longue dur√©e.
5. Enregistrez vos modifications.

:::info
Vous n‚Äôavez pas besoin d‚Äôajouter ce connecteur √† votre exp√©rience de connexion. Le connecteur sera utilis√© pour l‚Äôautorisation √† la demande lorsque votre agent IA doit acc√©der √† des API tierces, et non pour la connexion utilisateur.
:::

## Demander l‚Äôautorisation et acc√©der aux API tierces \{#request-authorization-and-access-third-party-apis}

Lorsque votre agent IA doit acc√©der √† une API tierce (par exemple, Google Calendar), il doit d‚Äôabord v√©rifier si l‚Äôutilisateur a d√©j√† autoris√© l‚Äôacc√®s. Sinon, invitez l‚Äôutilisateur √† autoriser.

:::info Activer Account API
Avant de continuer, activez Account API dans <CloudLink to="/sign-in-experience/account-center">Console > Exp√©rience de connexion > Centre de compte</CloudLink>. En savoir plus sur [l‚Äôactivation de Account API](/end-user-flows/account-settings/by-account-api#how-to-enable-account-api).
:::

### √âtape 1 : V√©rifier l‚Äôexistence d‚Äôune autorisation \{#step-1-check-for-existing-authorization}

Commencez par essayer de r√©cup√©rer le jeton d‚Äôacc√®s stock√© pour voir si l‚Äôutilisateur a d√©j√† autoris√© :

```tsx
async function getGoogleAccessToken(userAccessToken: string) {
  const response = await fetch(
    'https://[tenant-id].logto.app/my-account/identities/google/access-token',
    {
      headers: {
        Authorization: `Bearer ${userAccessToken}`,
      },
    }
  );

  return response.json();
}
```

### √âtape 2 : Demander l‚Äôautorisation si n√©cessaire \{#step-2-request-authorization-if-needed}

Si aucun jeton n‚Äôexiste, que le jeton a expir√© ou que vous devez √©tendre la port√©e du jeton d‚Äôacc√®s, utilisez la [Social Verification API](/secret-vault/federated-token-set#reauthentication-and-token-renewal) de Logto pour initier le flux d‚Äôautorisation :

```tsx
async function requestGoogleAuthorization(userAccessToken: string, scopes: string) {
  // G√©n√©rer un √©tat al√©atoire pour la protection CSRF
  const state = crypto.randomUUID();
  sessionStorage.setItem('oauth_state', state);

  // Initier la v√©rification sociale
  const response = await fetch('https://[tenant-id].logto.app/api/verification/social', {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${userAccessToken}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      connectorId: '<google_connector_id>',
      state,
      redirectUri: 'https://your-ai-agent.com/callback',
      scope: scopes,
    }),
  });

  const { verificationRecordId, authorizationUri } = await response.json();

  // Stocker verificationRecordId pour une utilisation ult√©rieure
  sessionStorage.setItem('verificationRecordId', verificationRecordId);

  // Rediriger l‚Äôutilisateur vers Google pour l‚Äôautorisation
  window.location.href = authorizationUri;
}
```

### √âtape 3 : G√©rer le callback d‚Äôautorisation \{#step-3-handle-the-authorization-callback}

Apr√®s que l‚Äôutilisateur a accord√© les permissions, Google redirige vers votre application. Finalisez la v√©rification et stockez les jetons :

```tsx
async function handleAuthorizationCallback(
  userAccessToken: string,
  callbackParams: URLSearchParams
) {
  const verificationRecordId = sessionStorage.getItem('verificationRecordId');
  const storedState = sessionStorage.getItem('oauth_state');
  const code = callbackParams.get('code');
  const state = callbackParams.get('state');

  // Valider l‚Äô√©tat pour pr√©venir les attaques CSRF
  if (state !== storedState) {
    throw new Error('Invalid state parameter');
  }

  // V√©rifier l‚Äôautorisation
  await fetch('https://[tenant-id].logto.app/api/verification/social/verify', {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${userAccessToken}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      verificationRecordId,
      connectorData: {
        code,
        state,
        redirectUri: 'https://your-ai-agent.com/callback',
      },
    }),
  });

  // Stocker les jetons dans le Secret Vault de Logto
  await fetch('https://[tenant-id].logto.app/my-account/identities/google/access-token', {
    method: 'PUT',
    headers: {
      Authorization: `Bearer ${userAccessToken}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      verificationRecordId,
    }),
  });

  // Nettoyer
  sessionStorage.removeItem('verificationRecordId');
  sessionStorage.removeItem('oauth_state');
}
```

### √âtape 4 : Appeler l‚ÄôAPI tierce \{#step-4-call-the-third-party-api}

Votre agent IA peut maintenant r√©cup√©rer le jeton et appeler l‚ÄôAPI :

```tsx
async function addCalendarEvent(userAccessToken: string, eventDetails: EventDetails) {
  // Obtenir le jeton d‚Äôacc√®s Google stock√©
  const tokenData = await getGoogleAccessToken(userAccessToken);

  if (!tokenData) {
    // L‚Äôutilisateur n‚Äôa pas autoris√©, demander l‚Äôautorisation avec la port√©e calendrier
    await requestGoogleAuthorization(
      userAccessToken,
      'https://www.googleapis.com/auth/calendar.events'
    );
    return; // Continuera apr√®s la redirection
  }

  // Appeler l‚ÄôAPI Google Calendar
  const response = await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${tokenData.accessToken}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(eventDetails),
  });

  return response.json();
}
```

Logto g√®re automatiquement le rafra√Æchissement des jetons. Si le jeton d‚Äôacc√®s est expir√© mais qu‚Äôun jeton de rafra√Æchissement existe, Logto obtiendra un nouveau jeton d‚Äôacc√®s de mani√®re transparente lors de l‚Äôappel au point de r√©cup√©ration.

## Demander des permissions suppl√©mentaires \{#request-additional-permissions}

Au fur et √† mesure que votre agent IA prend en charge plus de t√¢ches, vous devrez peut-√™tre demander des permissions suppl√©mentaires. Par exemple, si l‚Äôutilisateur a initialement autoris√© un acc√®s en lecture seule au calendrier mais souhaite maintenant cr√©er des √©v√©nements, vous aurez besoin des permissions d‚Äô√©criture.

### Pourquoi l‚Äôautorisation incr√©mentale ? \{#why-incremental-authorization}

- **Meilleure exp√©rience utilisateur** : Les utilisateurs sont plus enclins √† accorder des permissions lorsqu‚Äôils comprennent pourquoi elles sont n√©cessaires dans le contexte.
- **Taux de conversion plus √©lev√©** : Moins de permissions demand√©es d‚Äôembl√©e signifie moins de friction.
- **Renforcement de la confiance** : Les utilisateurs font confiance aux applications qui ne demandent que ce dont elles ont besoin.

### Exemple : Passer de l‚Äôacc√®s en lecture √† l‚Äôacc√®s en √©criture \{#example-upgrading-from-read-to-write-access}

```tsx
async function createCalendarEvent(userAccessToken: string, eventDetails: EventDetails) {
  const tokenData = await getGoogleAccessToken(userAccessToken);

  if (!tokenData) {
    // Pas encore d‚Äôautorisation, demander directement la permission d‚Äô√©criture calendrier
    await requestGoogleAuthorization(userAccessToken, 'https://www.googleapis.com/auth/calendar');
    return;
  }

  // Essayer de cr√©er l‚Äô√©v√©nement
  const response = await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${tokenData.accessToken}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(eventDetails),
  });

  if (response.status === 403) {
    // Permissions insuffisantes, demander une port√©e suppl√©mentaire
    await requestGoogleAuthorization(
      userAccessToken,
      'https://www.googleapis.com/auth/calendar' // Acc√®s complet au calendrier
    );
    return;
  }

  return response.json();
}
```

:::tip
Lors de la demande de port√©es suppl√©mentaires, l‚Äôutilisateur verra un √©cran de consentement affichant uniquement les nouvelles permissions demand√©es. Ses permissions existantes seront conserv√©es.
:::

## G√©rer le statut des jetons \{#manage-token-status}

La Console Logto offre une visibilit√© sur le statut des jetons pour chaque utilisateur :

1. Rendez-vous sur <CloudLink to="/users">Console > Gestion des utilisateurs</CloudLink>.
2. Cliquez sur un utilisateur pour afficher ses d√©tails.
3. Faites d√©filer jusqu‚Äô√† la section **Connexions** pour voir tous les comptes sociaux li√©s.
4. Chaque connexion affiche le statut du jeton :
   - **Actif** : Le jeton d‚Äôacc√®s est valide et pr√™t √† l‚Äôemploi.
   - **Expir√©** : Le jeton d‚Äôacc√®s a expir√©. Si un jeton de rafra√Æchissement existe, il sera renouvel√© automatiquement lors de la prochaine r√©cup√©ration.
   - **Inactif** : Aucun jeton n‚Äôest stock√© pour cette connexion.

## Bonnes pratiques de s√©curit√© \{#security-best-practices}

Lorsque vous d√©veloppez des agents IA qui acc√®dent √† des API tierces, gardez √† l‚Äôesprit ces bonnes pratiques de s√©curit√© :

- **Demandez des port√©es minimales** : Ne demandez que les permissions r√©ellement n√©cessaires √† votre agent.
- **Utilisez l‚Äôautorisation incr√©mentale** : Demandez des permissions suppl√©mentaires dans le contexte, pas toutes d‚Äôun coup.
- **G√©rez l‚Äôexpiration des jetons avec souplesse** : G√©rez toujours les cas o√π les jetons peuvent √™tre expir√©s ou r√©voqu√©s.
- **S√©curisez les jetons d‚Äôacc√®s utilisateur** : Le jeton d‚Äôacc√®s Logto de l‚Äôutilisateur est la cl√© pour r√©cup√©rer les jetons tiers. Prot√©gez-le en cons√©quence.
- **Auditez l‚Äôacc√®s API** : Journalisez quand votre agent IA acc√®de aux API tierces pour le d√©pannage et la conformit√©.

## Ressources associ√©es \{#related-resources}

<Url href="/secret-vault/federated-token-set">Stockage de jetons tiers</Url>
<Url href="/connectors/social-connectors">Connecteurs sociaux</Url>
<Url href="/end-user-flows/sign-up-and-sign-in/social-sign-in">Connexion sociale</Url>
<Url href="/end-user-flows/account-settings/by-account-api">Account API</Url>
