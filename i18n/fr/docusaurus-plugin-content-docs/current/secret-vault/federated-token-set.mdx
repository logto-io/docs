---
id: federated-token-set
title: Stockage de jetons tiers & acc√®s API
sidebar_label: Stockage de jetons tiers
---

import Availability from '@components/Availability';

<Availability cloud oss={{ major: 1, minor: 31 }} />

L'ensemble de jetons tiers (aussi appel√© ensemble de jetons f√©d√©r√©s) est un type de secret stock√© dans le [coffre-fort de secrets](/secret-vault) de Logto, utilis√© pour g√©rer en toute s√©curit√© les jetons d‚Äôacc√®s (Access tokens) et de rafra√Æchissement (Refresh tokens) √©mis par des fournisseurs d'identit√© tiers. Lorsqu'un utilisateur s'authentifie via un connecteur social ou SSO d‚Äôentreprise, Logto stocke les jetons √©mis dans le coffre-fort. Ces jetons peuvent ensuite √™tre r√©cup√©r√©s pour acc√©der aux API tierces au nom de l'utilisateur, sans n√©cessiter une nouvelle authentification.

## Cas d‚Äôutilisation courants \{#common-use-cases}

Cette fonctionnalit√© est essentielle pour les applications modernes telles que les agents IA, les plateformes SaaS, les outils de productivit√© et les applications clients qui doivent interagir avec des services tiers au nom des utilisateurs. Voici quelques exemples pratiques :

**üìÖ Applications de gestion de calendrier** : Apr√®s qu'un utilisateur se connecte avec Google, votre application de productivit√© peut automatiquement synchroniser ses √©v√©nements de calendrier, cr√©er de nouvelles r√©unions et envoyer des invitations sans lui demander de s'authentifier √† nouveau.

**ü§ñ Assistants IA** : Un agent IA peut acc√©der aux d√©p√¥ts GitHub d'un utilisateur pour analyser du code, cr√©er des pull requests ou g√©rer des tickets. Tout cela avec le consentement unique de l'utilisateur lors de la connexion ou de la liaison de compte.

**üìä Tableaux de bord analytiques** : Les plateformes SaaS peuvent extraire des donn√©es des comptes de r√©seaux sociaux connect√©s des utilisateurs (Facebook, LinkedIn) pour g√©n√©rer des analyses et des rapports sans interrompre leur flux de travail avec des demandes de connexion r√©p√©t√©es.

## Activer le stockage de jetons tiers \{#enable-third-party-token-storage}

### Connecteurs sociaux \{#social-connectors}

Cette fonctionnalit√© est disponible pour les [connecteurs sociaux](/connectors/social-connectors) qui prennent en charge le stockage de jetons. Les jetons tiers peuvent √™tre stock√©s lors de la [connexion sociale](/end-user-flows/sign-up-and-sign-in/social-sign-in), de la [liaison de compte social](/end-user-flows/account-settings/by-account-api#link-a-new-social-connection), et [lors du renouvellement des jetons pour l'acc√®s √† l'API tierce](/secret-vault/federated-token-set#reauthentication-and-token-renewal). Les connecteurs actuellement pris en charge incluent : [GitHub](/integrations/github), [Google](/integrations/google), [Facebook](/integrations/facebook), [OAuth 2.0 standard](/integrations/oauth2), et [OIDC standard](/integrations/oidc). La prise en charge d'autres connecteurs sera d√©ploy√©e progressivement.

1. Acc√©dez √† <CloudLink to="/connectors/social">Console > Connecteurs > Connecteurs sociaux</CloudLink>.
2. S√©lectionnez le connecteur social pour lequel vous souhaitez activer le stockage de jetons tiers.
3. Suivez les tutoriels de configuration pour configurer le connecteur, y compris l'ajout des port√©es n√©cessaires pour acc√©der √† des API tierces sp√©cifiques.
4. Dans la page "Param√®tres", activez l‚Äôoption **Stocker les jetons pour un acc√®s API persistant**.

### Connecteurs SSO d‚Äôentreprise \{#enterprise-sso-connectors}

Le stockage des jetons est disponible pour tous les [connecteurs d‚Äôentreprise OIDC](/connectors/enterprise-connectors). Les jetons d‚Äôacc√®s (Access tokens) et de rafra√Æchissement (Refresh tokens) peuvent √™tre stock√©s lors de la [connexion SSO d‚Äôentreprise](/end-user-flows/enterprise-sso). Les connecteurs actuellement pris en charge incluent : [Google Workspace](/integrations/google-workspace).

1. Acc√©dez √† <CloudLink to="/enterprise-sso">Console > SSO d‚Äôentreprise</CloudLink>.
2. S√©lectionnez le connecteur SSO d‚Äôentreprise pour lequel vous souhaitez activer le stockage de jetons tiers.
3. Suivez les tutoriels de configuration pour configurer le connecteur, y compris l'ajout des port√©es n√©cessaires pour acc√©der √† des API tierces sp√©cifiques.
4. Dans l‚Äôonglet "Exp√©rience SSO", activez l‚Äôoption **Stocker les jetons pour un acc√®s API persistant**.

N'oubliez pas d'enregistrer vos modifications.

## Stockage des jetons \{#token-storage}

Une fois le stockage de jetons tiers activ√©, Logto stocke automatiquement les jetons d‚Äôacc√®s (Access tokens) et de rafra√Æchissement (Refresh tokens) √©mis par le fournisseur d'identit√© f√©d√©r√© chaque fois qu'un utilisateur s'authentifie via un connecteur social ou SSO d‚Äôentreprise. Cela inclut :

- [Connexion et inscription sociale](/end-user-flows/sign-up-and-sign-in/social-sign-in)
- [Connexion et inscription SSO d‚Äôentreprise](/end-user-flows/enterprise-sso)
- [Liaison de compte social via Account API](/end-user-flows/account-settings/by-account-api#link-a-new-social-connection)

Les jetons stock√©s sont attach√©s √† l'identit√© sociale ou SSO d‚Äôentreprise de l'utilisateur, ce qui leur permet de r√©cup√©rer les jetons ult√©rieurement pour acc√©der √† l‚ÄôAPI sans n√©cessiter une nouvelle authentification.

### V√©rifier le statut du stockage de jetons \{#checking-token-storage-status}

Vous pouvez v√©rifier le statut du stockage de jetons tiers d'un utilisateur dans la Console Logto :

1. Acc√©dez √† <CloudLink to="/users">Console > Utilisateurs</CloudLink>.
2. Cliquez sur l'utilisateur que vous souhaitez inspecter. Cela vous am√®nera √† la page de d√©tails de l'utilisateur.
3. Faites d√©filer jusqu'√† la section **Connexions**. Cette zone r√©pertorie toutes les connexions sociales et SSO d‚Äôentreprise associ√©es √† l'utilisateur.
4. Chaque entr√©e de connexion affiche une √©tiquette de statut de jeton indiquant si des jetons sont stock√©s pour cette connexion.
5. Cliquez sur l'entr√©e de connexion pour afficher plus de d√©tails, y compris les m√©tadonn√©es du jeton d‚Äôacc√®s stock√© et la disponibilit√© du jeton de rafra√Æchissement (le cas √©ch√©ant).

Vous pouvez √©galement v√©rifier les identit√©s tierces de l'utilisateur et le statut du stockage de jetons via la Management API :

- `GET /api/users/{userId}/identities/{target}?includeTokenSecret=true` : R√©cup√©rer l'identit√© sociale d'un utilisateur et le statut du stockage de jetons associ√© √† l'identit√© par un connecteur donn√© (par exemple, `github`, `google`, etc.).
- `GET /api/users/{userId}/sso-identities/{ssoConnectorId}?includeTokenSecret=true` : R√©cup√©rer l'identit√© SSO d‚Äôentreprise d'un utilisateur et le statut du stockage de jetons associ√© √† l'identit√© par un ID de connecteur SSO donn√©.

### Statut du stockage de jetons \{#token-storage-status}

- **Actif** : Le jeton d‚Äôacc√®s est stock√© et actif.
- **Expir√©** : Le jeton d‚Äôacc√®s est stock√© mais a expir√©. Si un jeton de rafra√Æchissement est disponible, il peut √™tre utilis√© pour obtenir un nouveau jeton d‚Äôacc√®s.
- **Inactif** : Aucun jeton d‚Äôacc√®s n'est stock√© pour cette connexion. Cela peut se produire si l'utilisateur ne s'est pas authentifi√© via cette connexion ou si le stockage du jeton a √©t√© supprim√©.
- **Non applicable** : Le connecteur ne prend pas en charge le stockage de jetons.

### M√©tadonn√©es du jeton \{#token-metadata}

Pour l'int√©grit√© et la s√©curit√© des donn√©es, tous les jetons sont chiffr√©s avant d'√™tre stock√©s dans le coffre-fort de secrets. Les valeurs r√©elles des jetons ne sont accessibles qu'√† l'utilisateur final avec la bonne autorisation. Les d√©veloppeurs, quant √† eux, ne peuvent r√©cup√©rer que les m√©tadonn√©es de l'ensemble de jetons pour comprendre l'√©tat des jetons stock√©s sans exposer de contenu sensible.

- `createdAt` : L'horodatage auquel la connexion a √©t√© √©tablie pour la premi√®re fois et o√π l'ensemble de jetons a √©t√© initialement stock√© dans le coffre-fort de secrets.
- `updatedAt` : La derni√®re fois que l'ensemble de jetons a √©t√© mis √† jour.
  - Si aucun jeton de rafra√Æchissement n'est disponible, cette valeur sera identique √† **createdAt**.
  - Si un jeton de rafra√Æchissement est pr√©sent, cette valeur refl√®te la derni√®re fois o√π le jeton d‚Äôacc√®s a √©t√© rafra√Æchi.
- `hasRefreshToken` : Indique si un jeton de rafra√Æchissement est disponible.
  Si le connecteur prend en charge l'acc√®s hors ligne et que la requ√™te d'autorisation est correctement configur√©e, Logto stocke le jeton de rafra√Æchissement lorsqu'il est √©mis par le fournisseur d'identit√© en m√™me temps que le jeton d‚Äôacc√®s.
  Lorsque le jeton d‚Äôacc√®s expire et qu'un jeton de rafra√Æchissement valide existe, Logto tente automatiquement d'obtenir un nouveau jeton d‚Äôacc√®s en utilisant le jeton de rafra√Æchissement stock√© chaque fois que l'utilisateur demande l'acc√®s au fournisseur connect√©.
- `expiresAt` : L'heure d'expiration estim√©e du jeton d‚Äôacc√®s en **secondes**.
  Ceci est calcul√© √† partir de la valeur `expires_in` renvoy√©e par le point de terminaison de jeton du fournisseur d'identit√©. (Ce champ n'est disponible que si le fournisseur inclut `expires_in` dans la r√©ponse du jeton.)
- `scope` : La port√©e (Scope) du jeton d‚Äôacc√®s, indiquant les permissions accord√©es par le fournisseur d'identit√©.
  Ceci est utile pour comprendre quelles actions peuvent √™tre effectu√©es avec le jeton d‚Äôacc√®s stock√©. (Ce champ n'est disponible que si le fournisseur inclut `scope` dans la r√©ponse du jeton.)
- `tokenType` : Le type du jeton d‚Äôacc√®s, g√©n√©ralement "Bearer".
  (Ce champ n'est disponible que si le fournisseur inclut `token_type` dans la r√©ponse du jeton.)

## R√©cup√©ration des jetons \{#token-retrieval}

Une fois le stockage de jetons activ√© et les jetons stock√©s en toute s√©curit√© dans le coffre-fort de secrets de Logto, les utilisateurs finaux peuvent r√©cup√©rer leurs jetons d‚Äôacc√®s tiers depuis votre application cliente en s'int√©grant √† l'[Account API](/end-user-flows/account-settings/by-account-api) de Logto.

- `GET /my-account/identities/:target/access-token` : R√©cup√©rer le jeton d‚Äôacc√®s pour une identit√© sociale en sp√©cifiant le connecteur cible (par exemple, github, google).

- `GET /my-account/sso-identities/:connectorId/access-token` : R√©cup√©rer le jeton d‚Äôacc√®s pour une identit√© SSO d‚Äôentreprise en sp√©cifiant l‚ÄôID du connecteur.

:::info
D√©couvrez comment [activer](/end-user-flows/account-settings/by-account-api#how-to-enable-account-api) et [acc√©der](/end-user-flows/account-settings/by-account-api#access-account-api-using-access-token) √† l‚ÄôAccount API en utilisant le jeton d‚Äôacc√®s √©mis par Logto.
:::

### Rotation des jetons \{#token-rotation}

Les points de terminaison de r√©cup√©ration de jetons renvoient :

- `200` OK : Si le jeton d‚Äôacc√®s est r√©cup√©r√© avec succ√®s et est toujours valide.
- `404` Not Found : Si l'utilisateur ne poss√®de pas d'identit√© sociale ou SSO d‚Äôentreprise associ√©e √† la cible ou √† l‚ÄôID du connecteur sp√©cifi√©, ou si le jeton d‚Äôacc√®s n'est pas stock√©.
- `401` Unauthorized : Si le jeton d‚Äôacc√®s est expir√©.

Si le jeton d‚Äôacc√®s est expir√© et qu'un jeton de rafra√Æchissement est disponible, Logto tente automatiquement de rafra√Æchir le jeton d‚Äôacc√®s et renvoie le nouveau jeton d‚Äôacc√®s dans la r√©ponse. Le stockage du jeton dans le coffre-fort de secrets est √©galement mis √† jour avec le nouveau jeton d‚Äôacc√®s et ses m√©tadonn√©es.

## Suppression du stockage de jetons \{#token-storage-deletion}

Le stockage de jetons tiers est directement li√© √† chaque connexion sociale ou SSO d‚Äôentreprise de l'utilisateur. Cela signifie que l'ensemble de jetons stock√© sera automatiquement supprim√© dans les cas suivants :

- L'identit√© sociale ou SSO d‚Äôentreprise associ√©e est supprim√©e du compte de l'utilisateur.
- Le compte utilisateur est supprim√© de votre tenant.
- Le connecteur social ou SSO d‚Äôentreprise est supprim√© de votre tenant.

### R√©vocation des jetons \{#revoking-tokens}

Vous pouvez √©galement supprimer manuellement l'ensemble de jetons tiers d'un utilisateur pour r√©voquer l'acc√®s :

- Depuis la Console :
  Acc√©dez √† la page de d√©tails de l'identit√© de l'utilisateur. Faites d√©filer jusqu'√† la section **Jeton d‚Äôacc√®s** (si le stockage de jetons est disponible) et cliquez sur le bouton **Supprimer les jetons** √† la fin de la section.
- Via la Management API :
  - `DELETE /api/secret/:id` : Supprimer un secret sp√©cifique par son ID, qui peut √™tre obtenu √† partir des d√©tails de l'identit√© utilisateur.

La r√©vocation de l'ensemble de jetons obligera l'utilisateur √† se r√©-authentifier aupr√®s du fournisseur tiers pour obtenir un nouveau jeton d‚Äôacc√®s avant de pouvoir acc√©der √† nouveau aux API tierces.

## R√©-authentification et renouvellement des jetons \{#reauthentication-and-token-renewal}

Dans les sc√©narios o√π un jeton d‚Äôacc√®s stock√© a expir√© ou lorsqu'une application doit demander des port√©es API suppl√©mentaires, les utilisateurs finaux peuvent se r√©-authentifier aupr√®s du fournisseur tiers pour obtenir un nouveau jeton d‚Äôacc√®s ‚Äî sans avoir besoin de se connecter √† Logto √† nouveau.
Cela peut √™tre r√©alis√© via l‚Äô[API de v√©rification sociale](https://openapi.logto.io/operation/operation-createverificationbysocial) de Logto, qui permet aux utilisateurs de r√©initier un flux d'autorisation sociale f√©d√©r√©e et de mettre √† jour leur ensemble de jetons stock√©.

:::note
La r√©initiation de l'autorisation f√©d√©r√©e est actuellement limit√©e aux connecteurs sociaux.
Pour les connecteurs SSO d‚Äôentreprise, la r√©-authentification et le renouvellement des jetons n√©cessitent que l'utilisateur initie √† nouveau un flux d'authentification Logto complet, car la r√©-autorisation directe aupr√®s du fournisseur SSO d‚Äôentreprise n'est pas encore prise en charge apr√®s la connexion.
:::

```mermaid
sequenceDiagram
    autonumber

    participant User as Utilisateur
    participant Logto as Logto
    participant Provider as Fournisseur tiers

    User->>Logto: post /api/verification/social
    Logto->>User: Rediriger vers le fournisseur tiers
    User->>Provider: S‚Äôauthentifier et autoriser
    Provider->>User: Rediriger avec le code d‚Äôautorisation
    User->>Logto: post /api/verification/social/verify avec le code d‚Äôautorisation
    Logto->>User: Retourner l‚ÄôID de v√©rification sociale
    User->>Logto: patch /my-account/identities/:target/access-token
```

1. L'utilisateur initie une demande de v√©rification sociale en appelant le point de terminaison `POST /api/verification/social`. L'utilisateur peut sp√©cifier des port√©es personnalis√©es pour demander des permissions suppl√©mentaires au fournisseur tiers.

   ```sh
   curl -X POST https://<your-logto-domain>/api/verification/social \
     -H "Authorization: Bearer <access_token>" \
     -H "Content-Type: application/json" \
     -d '{
       "state": "<state>",
       "connectorId": "<logto_connectorId>",
       "redirectUri": "<redirect_uri>",
       "scope": "<custom_scope>"
     }'
   ```

   - **authorization header** : Le jeton d‚Äôacc√®s de l'utilisateur √©mis par Logto.
   - **connectorId** : L‚ÄôID du connecteur social dans Logto.
   - **redirectUri** : L‚ÄôURI vers laquelle rediriger l'utilisateur apr√®s l'authentification. Vous devrez enregistrer cette URI dans les param√®tres de l'application du fournisseur.
   - **scope** : (Optionnel) Port√©es personnalis√©es pour demander des permissions suppl√©mentaires au fournisseur tiers. Si non sp√©cifi√©, les port√©es par d√©faut configur√©es dans le connecteur seront utilis√©es.

2. Logto cr√©e un nouvel enregistrement de v√©rification sociale et retourne l‚ÄôID de v√©rification sociale ainsi que l‚ÄôURL d'autorisation pour rediriger l'utilisateur vers le fournisseur tiers pour l'authentification.

   La r√©ponse ressemblera √† ceci :

   ```json
   {
     "verificationRecordId": "<social_verification_id>",
     "authorizationUri": "<authorization_url>",
     "expiresAt": "<expiration_time>"
   }
   ```

3. Redirigez l'utilisateur vers l‚ÄôURL d'autorisation. L'utilisateur s'authentifie aupr√®s du fournisseur tiers et accorde les permissions.

4. Le fournisseur tiers redirige l'utilisateur vers votre application cliente avec un code d'autorisation.

5. G√©rez le rappel d'autorisation en transmettant le code d'autorisation au point de terminaison de v√©rification de Logto :

   ```sh
   curl -X POST https://<your-logto-domain>/api/verification/social/verify \
     -H "Authorization: Bearer <access_token>" \
     -d '{
       "verificationRecordId": "<social_verification_id>",
       "connectorData": {
         "code": "<authorization_code>",
         "state": "<state>",
         "redirectUri": "<redirect_uri>"
       }
     }'
   ```

   - **authorization header** : Le jeton d‚Äôacc√®s de l'utilisateur √©mis par Logto.
   - **verificationRecordId** : L‚ÄôID de v√©rification sociale retourn√© √† l‚Äô√©tape pr√©c√©dente.
   - **connectorData** : Le code d'autorisation et toute autre donn√©e retourn√©e par le fournisseur tiers lors du rappel.

   :::note
   N'oubliez pas de valider le param√®tre `state` pour pr√©venir les attaques CSRF.
   :::

6. Logto v√©rifie le code d'autorisation et l'√©change contre un nouveau jeton d‚Äôacc√®s et un jeton de rafra√Æchissement aupr√®s du fournisseur tiers, puis retourne l‚ÄôID de v√©rification sociale dans la r√©ponse.

7. Enfin, mettez √† jour le stockage de jetons de l'utilisateur en appelant le point de terminaison `PATCH /my-account/identities/:target/access-token` avec l‚ÄôID de v√©rification sociale :

   ```sh
   curl -X PATCH https://<your-logto-domain>/my-account/identities/<target>/access-token \
     -H "Authorization: Bearer <access_token>" \
     -H "Content-Type: application/json" \
     -d '{
       "socialVerificationId": "<social_verification_id>"
     }'
   ```

   - **authorization header** : Le jeton d‚Äôacc√®s de l'utilisateur √©mis par Logto.
   - **socialVerificationId** : L‚ÄôID de v√©rification sociale v√©rifi√© retourn√© √† l‚Äô√©tape pr√©c√©dente.

   Cela mettra √† jour l'ensemble de jetons de l'utilisateur dans le coffre-fort de secrets de Logto avec le nouveau jeton d‚Äôacc√®s et le jeton de rafra√Æchissement, permettant √† l'utilisateur d'acc√©der aux API tierces sans avoir √† se reconnecter √† Logto.

   Le jeton d‚Äôacc√®s mis √† jour sera retourn√©.
