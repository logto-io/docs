---
id: federated-token-set
title: Stockage de jetons tiers & accÃ¨s API
sidebar_label: Stockage de jetons tiers
---

import Availability from '@components/Availability';

<Availability cloud oss={{ major: 1, minor: 31 }} />

L'ensemble de jetons tiers (aussi appelÃ© ensemble de jetons fÃ©dÃ©rÃ©s) est un type de secret stockÃ© dans le [coffre-fort de secrets](/secret-vault) de Logto, utilisÃ© pour gÃ©rer en toute sÃ©curitÃ© les jetons dâ€™accÃ¨s (Access tokens) et de rafraÃ®chissement (Refresh tokens) Ã©mis par des fournisseurs d'identitÃ© tiers. Lorsqu'un utilisateur s'authentifie via un connecteur social ou SSO dâ€™entreprise, Logto stocke les jetons Ã©mis dans le coffre-fort. Ces jetons peuvent ensuite Ãªtre rÃ©cupÃ©rÃ©s pour accÃ©der aux API tierces au nom de l'utilisateur, sans nÃ©cessiter une nouvelle authentification.

## Cas dâ€™utilisation courants \{#common-use-cases}

Cette fonctionnalitÃ© est essentielle pour les applications modernes telles que les agents IA, les plateformes SaaS, les outils de productivitÃ© et les applications clients qui doivent interagir avec des services tiers au nom des utilisateurs. Voici quelques exemples pratiques :

**ğŸ“… Applications de gestion de calendrier** : AprÃ¨s qu'un utilisateur se soit connectÃ© avec Google, votre application de productivitÃ© peut automatiquement synchroniser ses Ã©vÃ©nements de calendrier, crÃ©er de nouvelles rÃ©unions et envoyer des invitations sans lui demander de s'authentifier Ã  nouveau.

**ğŸ¤– Assistants IA** : Un agent IA peut accÃ©der aux dÃ©pÃ´ts GitHub d'un utilisateur pour analyser du code, crÃ©er des pull requests ou gÃ©rer des tickets. Tout cela avec le consentement unique de l'utilisateur lors de la connexion ou de la liaison de compte.

**ğŸ“Š Tableaux de bord analytiques** : Les plateformes SaaS peuvent extraire des donnÃ©es des comptes de rÃ©seaux sociaux connectÃ©s des utilisateurs (Facebook, LinkedIn) pour gÃ©nÃ©rer des analyses et des rapports sans interrompre leur flux de travail avec des demandes de connexion rÃ©pÃ©tÃ©es.

## Activer le stockage de jetons tiers \{#enable-third-party-token-storage}

### Connecteurs sociaux \{#social-connectors}

Cette fonctionnalitÃ© est disponible pour les [connecteurs sociaux](/connectors/social-connectors) qui prennent en charge le stockage des jetons. Les jetons tiers peuvent Ãªtre stockÃ©s lors de la [connexion sociale](/end-user-flows/sign-up-and-sign-in/social-sign-in), de la [liaison de compte social](/end-user-flows/account-settings/by-account-api#link-a-new-social-connection), et [lors du renouvellement des jetons pour l'accÃ¨s Ã  l'API tierce](/secret-vault/federated-token-set#reauthentication-and-token-renewal). Les connecteurs actuellement pris en charge incluent : [GitHub](/integrations/github), [Google](/integrations/google), [Facebook](/integrations/facebook), [OAuth 2.0 standard](/integrations/oauth2), et [OIDC standard](/integrations/oidc). La prise en charge d'autres connecteurs sera dÃ©ployÃ©e progressivement.

1. AccÃ©dez Ã  <CloudLink to="/connectors/social">Console > Connecteurs > Connecteurs sociaux</CloudLink>.
2. SÃ©lectionnez le connecteur social pour lequel vous souhaitez activer le stockage de jetons tiers.
3. Suivez les tutoriels de configuration pour configurer le connecteur, y compris l'ajout des portÃ©es nÃ©cessaires pour accÃ©der Ã  des API tierces spÃ©cifiques.
4. Dans la page "ParamÃ¨tres", activez lâ€™option **Stocker les jetons pour un accÃ¨s API persistant**.

### Connecteurs SSO dâ€™entreprise \{#enterprise-sso-connectors}

Le stockage des jetons est disponible pour tous les [connecteurs dâ€™entreprise OIDC](/connectors/enterprise-connectors). Les jetons dâ€™accÃ¨s (Access tokens) et de rafraÃ®chissement (Refresh tokens) peuvent Ãªtre stockÃ©s lors de la [connexion SSO dâ€™entreprise](/end-user-flows/enterprise-sso). Les connecteurs actuellement pris en charge incluent : [Google Workspace](/integrations/google-workspace), [Microsoft Entra ID (OIDC)](/integrations/entra-id-oidc), [Okta](/integrations/okta), et [OIDC (Entreprise)](/integrations/oidc-sso).

1. AccÃ©dez Ã  <CloudLink to="/enterprise-sso">Console > SSO dâ€™entreprise</CloudLink>.
2. SÃ©lectionnez le connecteur SSO dâ€™entreprise pour lequel vous souhaitez activer le stockage de jetons tiers.
3. Suivez les tutoriels de configuration pour configurer le connecteur, y compris l'ajout des portÃ©es nÃ©cessaires pour accÃ©der Ã  des API tierces spÃ©cifiques.
4. Dans lâ€™onglet "ExpÃ©rience SSO", activez lâ€™option **Stocker les jetons pour un accÃ¨s API persistant**.

N'oubliez pas d'enregistrer vos modifications.

## Stockage des jetons \{#token-storage}

Une fois le stockage de jetons tiers activÃ©, Logto stocke automatiquement les jetons dâ€™accÃ¨s (Access tokens) et de rafraÃ®chissement (Refresh tokens) Ã©mis par le fournisseur d'identitÃ© fÃ©dÃ©rÃ© chaque fois qu'un utilisateur s'authentifie via un connecteur social ou SSO dâ€™entreprise. Cela inclut :

- [Connexion et inscription sociale](/end-user-flows/sign-up-and-sign-in/social-sign-in)
- [Connexion et inscription SSO dâ€™entreprise](/end-user-flows/enterprise-sso)
- [Liaison de compte social via Account API](/end-user-flows/account-settings/by-account-api#link-a-new-social-connection)

Les jetons stockÃ©s sont attachÃ©s Ã  l'identitÃ© sociale ou SSO dâ€™entreprise de l'utilisateur, ce qui leur permet de rÃ©cupÃ©rer les jetons ultÃ©rieurement pour accÃ©der Ã  lâ€™API sans nÃ©cessiter une nouvelle authentification.

### VÃ©rifier le statut du stockage de jetons \{#checking-token-storage-status}

Vous pouvez vÃ©rifier le statut du stockage de jetons tiers dâ€™un utilisateur dans la Console Logto :

1. AccÃ©dez Ã  <CloudLink to="/users">Console > Utilisateurs</CloudLink>.
2. Cliquez sur l'utilisateur que vous souhaitez inspecter. Cela vous amÃ¨nera Ã  la page de dÃ©tails de l'utilisateur.
3. Faites dÃ©filer jusqu'Ã  la section **Connexions**. Cette zone rÃ©pertorie toutes les connexions sociales et SSO dâ€™entreprise associÃ©es Ã  l'utilisateur.
4. Chaque entrÃ©e de connexion affiche une Ã©tiquette de statut de jeton indiquant si des jetons sont stockÃ©s pour cette connexion.
5. Cliquez sur l'entrÃ©e de connexion pour afficher plus de dÃ©tails, y compris les mÃ©tadonnÃ©es du jeton dâ€™accÃ¨s stockÃ© et la disponibilitÃ© du jeton de rafraÃ®chissement (le cas Ã©chÃ©ant).

Vous pouvez Ã©galement vÃ©rifier les identitÃ©s tierces de l'utilisateur et le statut du stockage de jetons via la Management API :

- `GET /api/users/{userId}/identities/{target}?includeTokenSecret=true` : RÃ©cupÃ©rer l'identitÃ© sociale d'un utilisateur et le statut du stockage de jetons associÃ© Ã  l'identitÃ© par un connecteur donnÃ© (par exemple, `github`, `google`, etc.).
- `GET /api/users/{userId}/sso-identities/{ssoConnectorId}?includeTokenSecret=true` : RÃ©cupÃ©rer l'identitÃ© SSO dâ€™entreprise d'un utilisateur et le statut du stockage de jetons associÃ© Ã  l'identitÃ© par un ID de connecteur SSO donnÃ©.

### Statut du stockage de jetons \{#token-storage-status}

- **Actif** : Le jeton dâ€™accÃ¨s (Access token) est stockÃ© et actif.
- **ExpirÃ©** : Le jeton dâ€™accÃ¨s est stockÃ© mais a expirÃ©. Si un jeton de rafraÃ®chissement est disponible, il peut Ãªtre utilisÃ© pour obtenir un nouveau jeton dâ€™accÃ¨s.
- **Inactif** : Aucun jeton dâ€™accÃ¨s nâ€™est stockÃ© pour cette connexion. Cela peut se produire si l'utilisateur ne s'est pas authentifiÃ© via cette connexion ou si le stockage du jeton a Ã©tÃ© supprimÃ©.
- **Non applicable** : Le connecteur ne prend pas en charge le stockage des jetons.

### MÃ©tadonnÃ©es du jeton \{#token-metadata}

Pour l'intÃ©gritÃ© et la sÃ©curitÃ© des donnÃ©es, tous les jetons sont chiffrÃ©s avant d'Ãªtre stockÃ©s dans le coffre-fort de secrets. Les valeurs rÃ©elles des jetons ne sont accessibles qu'Ã  l'utilisateur final avec la bonne autorisation. Les dÃ©veloppeurs, quant Ã  eux, ne peuvent rÃ©cupÃ©rer que les mÃ©tadonnÃ©es de l'ensemble de jetons pour comprendre l'Ã©tat des jetons stockÃ©s sans exposer de contenu sensible.

- `createdAt` : Lâ€™horodatage de la premiÃ¨re crÃ©ation de la connexion et du stockage initial de lâ€™ensemble de jetons dans le coffre-fort.
- `updatedAt` : La derniÃ¨re fois que lâ€™ensemble de jetons a Ã©tÃ© mis Ã  jour.
  - Si aucun jeton de rafraÃ®chissement nâ€™est disponible, cette valeur sera identique Ã  **createdAt**.
  - Si un jeton de rafraÃ®chissement est prÃ©sent, cette valeur reflÃ¨te la derniÃ¨re fois oÃ¹ le jeton dâ€™accÃ¨s a Ã©tÃ© rafraÃ®chi.
- `hasRefreshToken` : Indique si un jeton de rafraÃ®chissement est disponible.
  Si le connecteur prend en charge lâ€™accÃ¨s hors ligne et que la requÃªte dâ€™autorisation est correctement configurÃ©e, Logto stocke le jeton de rafraÃ®chissement lorsquâ€™il est Ã©mis par le fournisseur dâ€™identitÃ© en mÃªme temps que le jeton dâ€™accÃ¨s.
  Lorsque le jeton dâ€™accÃ¨s expire et quâ€™un jeton de rafraÃ®chissement valide existe, Logto tente automatiquement dâ€™obtenir un nouveau jeton dâ€™accÃ¨s Ã  lâ€™aide du jeton de rafraÃ®chissement stockÃ© chaque fois que lâ€™utilisateur demande lâ€™accÃ¨s au fournisseur connectÃ©.
- `expiresAt` : Lâ€™heure dâ€™expiration estimÃ©e du jeton dâ€™accÃ¨s en **secondes**.
  Ceci est calculÃ© Ã  partir de la valeur `expires_in` renvoyÃ©e par le point de terminaison de jeton du fournisseur dâ€™identitÃ©. (Ce champ nâ€™est disponible que si le fournisseur inclut `expires_in` dans la rÃ©ponse du jeton.)
- `scope` : La portÃ©e (Scope) du jeton dâ€™accÃ¨s, indiquant les permissions accordÃ©es par le fournisseur dâ€™identitÃ©.
  Ceci est utile pour comprendre quelles actions peuvent Ãªtre effectuÃ©es avec le jeton dâ€™accÃ¨s stockÃ©. (Ce champ nâ€™est disponible que si le fournisseur inclut `scope` dans la rÃ©ponse du jeton.)
- `tokenType` : Le type du jeton dâ€™accÃ¨s, gÃ©nÃ©ralement "Bearer".
  (Ce champ nâ€™est disponible que si le fournisseur inclut `token_type` dans la rÃ©ponse du jeton.)

## RÃ©cupÃ©ration des jetons \{#token-retrieval}

Une fois le stockage de jetons activÃ© et les jetons stockÃ©s en toute sÃ©curitÃ© dans le coffre-fort de secrets de Logto, les utilisateurs finaux peuvent rÃ©cupÃ©rer leurs jetons dâ€™accÃ¨s tiers depuis votre application cliente en intÃ©grant lâ€™[Account API](/end-user-flows/account-settings/by-account-api) de Logto.

- `GET /my-account/identities/:target/access-token` : RÃ©cupÃ©rer le jeton dâ€™accÃ¨s pour une identitÃ© sociale en spÃ©cifiant le connecteur cible (par exemple, github, google).

- `GET /my-account/sso-identities/:connectorId/access-token` : RÃ©cupÃ©rer le jeton dâ€™accÃ¨s pour une identitÃ© SSO dâ€™entreprise en spÃ©cifiant lâ€™ID du connecteur.

:::info
DÃ©couvrez comment [activer](/end-user-flows/account-settings/by-account-api#how-to-enable-account-api) et [accÃ©der](/end-user-flows/account-settings/by-account-api#access-account-api-using-access-token) Ã  lâ€™Account API en utilisant le jeton dâ€™accÃ¨s Ã©mis par Logto.
:::

### Rotation des jetons \{#token-rotation}

Les points de terminaison de rÃ©cupÃ©ration de jetons renvoient :

- `200` OK : Si le jeton dâ€™accÃ¨s est rÃ©cupÃ©rÃ© avec succÃ¨s et est toujours valide.
- `404` Not Found : Si lâ€™utilisateur ne possÃ¨de pas dâ€™identitÃ© sociale ou SSO dâ€™entreprise associÃ©e Ã  la cible ou Ã  lâ€™ID de connecteur spÃ©cifiÃ©, ou si le jeton dâ€™accÃ¨s nâ€™est pas stockÃ©.
- `401` Unauthorized : Si le jeton dâ€™accÃ¨s est expirÃ©.

Si le jeton dâ€™accÃ¨s est expirÃ© et quâ€™un jeton de rafraÃ®chissement est disponible, Logto tente automatiquement de rafraÃ®chir le jeton dâ€™accÃ¨s et renvoie le nouveau jeton dâ€™accÃ¨s dans la rÃ©ponse. Le stockage du jeton dans le coffre-fort de secrets est Ã©galement mis Ã  jour avec le nouveau jeton dâ€™accÃ¨s et ses mÃ©tadonnÃ©es.

## Suppression du stockage de jetons \{#token-storage-deletion}

Le stockage de jetons tiers est directement liÃ© Ã  chaque connexion sociale ou SSO dâ€™entreprise de lâ€™utilisateur. Cela signifie que lâ€™ensemble de jetons stockÃ© sera automatiquement supprimÃ© dans les cas suivants :

- Lâ€™identitÃ© sociale ou SSO dâ€™entreprise associÃ©e est supprimÃ©e du compte utilisateur.
- Le compte utilisateur est supprimÃ© de votre tenant.
- Le connecteur social ou SSO dâ€™entreprise est supprimÃ© de votre tenant.

### RÃ©vocation des jetons \{#revoking-tokens}

Vous pouvez Ã©galement supprimer manuellement lâ€™ensemble de jetons tiers dâ€™un utilisateur pour rÃ©voquer lâ€™accÃ¨s :

- Depuis la Console :
  AccÃ©dez Ã  la page de dÃ©tails de lâ€™identitÃ© de lâ€™utilisateur. Faites dÃ©filer jusquâ€™Ã  la section **Jeton dâ€™accÃ¨s** (si le stockage de jetons est disponible) et cliquez sur le bouton **Supprimer les jetons** Ã  la fin de la section.
- Via la Management API :
  - `DELETE /api/secret/:id` : Supprimer un secret spÃ©cifique par son ID, qui peut Ãªtre obtenu Ã  partir des dÃ©tails de lâ€™identitÃ© utilisateur.

La rÃ©vocation de lâ€™ensemble de jetons obligera lâ€™utilisateur Ã  se rÃ©authentifier auprÃ¨s du fournisseur tiers pour obtenir un nouveau jeton dâ€™accÃ¨s avant de pouvoir accÃ©der Ã  nouveau aux API tierces.

## RÃ©authentification et renouvellement des jetons \{#reauthentication-and-token-renewal}

Dans les scÃ©narios oÃ¹ un jeton dâ€™accÃ¨s stockÃ© a expirÃ© ou lorsquâ€™une application doit demander des portÃ©es API supplÃ©mentaires, les utilisateurs finaux peuvent se rÃ©authentifier auprÃ¨s du fournisseur tiers pour obtenir un nouveau jeton dâ€™accÃ¨s â€” sans avoir besoin de se connecter Ã  Logto Ã  nouveau.
Cela peut Ãªtre rÃ©alisÃ© via lâ€™[API de vÃ©rification sociale](https://openapi.logto.io/operation/operation-createverificationbysocial) de Logto, qui permet aux utilisateurs de rÃ©initier un flux dâ€™autorisation sociale fÃ©dÃ©rÃ©e et de mettre Ã  jour leur ensemble de jetons stockÃ©.

:::note
La rÃ©initialisation de lâ€™autorisation fÃ©dÃ©rÃ©e est actuellement limitÃ©e aux connecteurs sociaux.
Pour les connecteurs SSO dâ€™entreprise, la rÃ©authentification et le renouvellement des jetons nÃ©cessitent que lâ€™utilisateur initie Ã  nouveau un flux dâ€™authentification Logto complet, car la rÃ©autorisation directe auprÃ¨s du fournisseur SSO dâ€™entreprise nâ€™est actuellement pas prise en charge aprÃ¨s la connexion.
:::

```mermaid
sequenceDiagram
    autonumber

    participant User as Utilisateur
    participant Logto as Logto
    participant Provider as Fournisseur tiers

    User->>Logto: post /api/verification/social
    Logto->>User: Rediriger vers le fournisseur tiers
    User->>Provider: Sâ€™authentifier et autoriser
    Provider->>User: Rediriger avec le code dâ€™autorisation
    User->>Logto: post /api/verification/social/verify avec le code dâ€™autorisation
    Logto->>User: Retourner lâ€™ID de vÃ©rification sociale
    User->>Logto: patch /my-account/identities/:target/access-token
```

1. Lâ€™utilisateur initie une demande de vÃ©rification sociale en appelant le point de terminaison `POST /api/verification/social`. Lâ€™utilisateur peut spÃ©cifier des portÃ©es personnalisÃ©es pour demander des permissions supplÃ©mentaires au fournisseur tiers.

   ```sh
   curl -X POST https://<your-logto-domain>/api/verification/social \
     -H "Authorization: Bearer <access_token>" \
     -H "Content-Type: application/json" \
     -d '{
       "state": "<state>",
       "connectorId": "<logto_connectorId>",
       "redirectUri": "<redirect_uri>",
       "scope": "<custom_scope>"
     }'
   ```

   - **authorization header** : Le jeton dâ€™accÃ¨s de lâ€™utilisateur Ã©mis par Logto.
   - **connectorId** : Lâ€™ID du connecteur social dans Logto.
   - **redirectUri** : Lâ€™URI vers lequel rediriger lâ€™utilisateur aprÃ¨s lâ€™authentification. Vous devrez enregistrer cet URI dans les paramÃ¨tres de lâ€™application du fournisseur.
   - **scope** : (Optionnel) PortÃ©es personnalisÃ©es pour demander des permissions supplÃ©mentaires au fournisseur tiers. Si non spÃ©cifiÃ©, les portÃ©es par dÃ©faut configurÃ©es dans le connecteur seront utilisÃ©es.

2. Logto crÃ©e un nouvel enregistrement de vÃ©rification sociale et retourne lâ€™ID de vÃ©rification sociale ainsi que lâ€™URL dâ€™autorisation pour rediriger lâ€™utilisateur vers le fournisseur tiers pour lâ€™authentification.

   La rÃ©ponse ressemblera Ã  ceci :

   ```json
   {
     "verificationRecordId": "<social_verification_id>",
     "authorizationUri": "<authorization_url>",
     "expiresAt": "<expiration_time>"
   }
   ```

3. Redirigez lâ€™utilisateur vers lâ€™URL dâ€™autorisation. Lâ€™utilisateur sâ€™authentifie auprÃ¨s du fournisseur tiers et accorde les permissions.

4. Le fournisseur tiers redirige lâ€™utilisateur vers votre application cliente avec un code dâ€™autorisation.

5. GÃ©rez le rappel dâ€™autorisation en transmettant le code dâ€™autorisation au point de terminaison de vÃ©rification de Logto :

   ```sh
   curl -X POST https://<your-logto-domain>/api/verification/social/verify \
     -H "Authorization: Bearer <access_token>" \
     -d '{
       "verificationRecordId": "<social_verification_id>",
       "connectorData": {
         "code": "<authorization_code>",
         "state": "<state>",
         "redirectUri": "<redirect_uri>"
       }
     }'
   ```

   - **authorization header** : Le jeton dâ€™accÃ¨s de lâ€™utilisateur Ã©mis par Logto.
   - **verificationRecordId** : Lâ€™ID de vÃ©rification sociale retournÃ© Ã  lâ€™Ã©tape prÃ©cÃ©dente.
   - **connectorData** : Le code dâ€™autorisation et toute autre donnÃ©e retournÃ©e par le fournisseur tiers lors du rappel.

   :::note
   Nâ€™oubliez pas de valider le paramÃ¨tre `state` pour prÃ©venir les attaques CSRF.
   :::

6. Logto vÃ©rifie le code dâ€™autorisation et lâ€™Ã©change contre un nouveau jeton dâ€™accÃ¨s et un jeton de rafraÃ®chissement auprÃ¨s du fournisseur tiers, puis retourne lâ€™ID de vÃ©rification sociale dans la rÃ©ponse.

7. Enfin, mettez Ã  jour le stockage de jetons de lâ€™utilisateur en appelant le point de terminaison `PATCH /my-account/identities/:target/access-token` avec lâ€™ID de vÃ©rification sociale :

   ```sh
   curl -X PATCH https://<your-logto-domain>/my-account/identities/<target>/access-token \
     -H "Authorization: Bearer <access_token>" \
     -H "Content-Type: application/json" \
     -d '{
       "socialVerificationId": "<social_verification_id>"
     }'
   ```

   - **authorization header** : Le jeton dâ€™accÃ¨s de lâ€™utilisateur Ã©mis par Logto.
   - **socialVerificationId** : Lâ€™ID dâ€™enregistrement de vÃ©rification sociale vÃ©rifiÃ© retournÃ© Ã  lâ€™Ã©tape prÃ©cÃ©dente.

   Cela mettra Ã  jour lâ€™ensemble de jetons de lâ€™utilisateur dans le coffre-fort de secrets de Logto avec le nouveau jeton dâ€™accÃ¨s et le jeton de rafraÃ®chissement, permettant Ã  lâ€™utilisateur dâ€™accÃ©der aux API tierces sans avoir Ã  se reconnecter Ã  Logto.

   Le jeton dâ€™accÃ¨s mis Ã  jour sera retournÃ©.
