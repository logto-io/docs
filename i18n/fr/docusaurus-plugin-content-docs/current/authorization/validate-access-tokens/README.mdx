---
sidebar_position: 6
sidebar_label: Valider les jetons d’accès dans l’API
---

import TabItem from '@theme/TabItem';
import Tabs from '@theme/Tabs';

import DotNetAddValidationLogic from './dotnet/_add-validation-logic.mdx';
import DotNetApplyMiddleware from './dotnet/_apply-middleware.mdx';
import DotNetInit from './dotnet/_init.mdx';
import GoAddValidationLogic from './go/_add-validation-logic.mdx';
import GoApplyMiddleware from './go/_apply-middleware.mdx';
import GoInit from './go/_init.mdx';
import JavaAddValidationLogic from './java/_add-validation-logic.mdx';
import JavaApplyMiddleware from './java/_apply-middleware.mdx';
import JavaInit from './java/_init.mdx';
import NodeAddValidationLogic from './nodejs/_add-validation-logic.mdx';
import NodeApplyMiddleware from './nodejs/_apply-middleware.mdx';
import NodeInit from './nodejs/_init.mdx';
import PhpAddValidationLogic from './php/_add-validation-logic.mdx';
import PhpApplyMiddleware from './php/_apply-middleware.mdx';
import PhpInit from './php/_init.mdx';
import PythonAddValidationLogic from './python/_add-validation-logic.mdx';
import PythonApplyMiddleware from './python/_apply-middleware.mdx';
import PythonInit from './python/_init.mdx';
import RubyAddValidationLogic from './ruby/_add-validation-logic.mdx';
import RubyApplyMiddleware from './ruby/_apply-middleware.mdx';
import RubyInit from './ruby/_init.mdx';
import RustAddValidationLogic from './rust/_add-validation-logic.mdx';
import RustApplyMiddleware from './rust/_apply-middleware.mdx';
import RustInit from './rust/_init.mdx';

# Comment valider les jetons d’accès dans votre service API ou backend

La validation des jetons d’accès (Access tokens) est une étape essentielle pour appliquer le contrôle d’accès basé sur les rôles (RBAC) dans Logto. Ce guide vous explique comment vérifier les JWT émis par Logto dans votre backend / API, en contrôlant la signature, l’émetteur (Issuer), l’audience (Audience), l’expiration, les permissions (Portées / Scopes) et le contexte d’organisation.

## Avant de commencer \{#before-you-start}

- Ce guide suppose que vous êtes familier avec les concepts RBAC de Logto.
- Si vous protégez des ressources API, ce guide suppose que vous avez suivi le guide [Protéger les ressources API globales](/authorization/global-api-resources).
- Si vous protégez des fonctionnalités ou des workflows internes à l’application (permissions non-API), ce guide suppose que vous avez suivi le guide [Protéger les permissions d’organisation (non-API)](/authorization/organization-permissions).
- Si vous protégez des ressources API au niveau organisation, ce guide suppose que vous avez suivi le guide [Protéger les ressources API au niveau organisation](/authorization/organization-level-api-resources).

## Étape 1 : Initialiser les constantes et utilitaires \{#step-1-initialize-constants-and-utilities}

Définissez les constantes et utilitaires nécessaires dans votre code pour gérer l’extraction et la validation du jeton. Une requête valide doit inclure un en-tête `Authorization` sous la forme `Bearer <access_token>`.

<Tabs groupId="api-language">
  <TabItem value="node" label="Node.js">
    <NodeInit />
  </TabItem>
  <TabItem value="python" label="Python">
    <PythonInit />
  </TabItem>
  <TabItem value="go" label="Go">
    <GoInit />
  </TabItem>
  <TabItem value="java" label="Java">
    <JavaInit />
  </TabItem>
  <TabItem value="dotnet" label=".NET">
    <DotNetInit />
  </TabItem>
  <TabItem value="php" label="PHP">
    <PhpInit />
  </TabItem>
  <TabItem value="ruby" label="Ruby">
    <RubyInit />
  </TabItem>
  <TabItem value="rust" label="Rust">
    <RustInit />
  </TabItem>
</Tabs>

## Étape 2 : Récupérer les informations sur votre tenant Logto \{#step-2-retrieve-info-about-your-logto-tenant}

Vous aurez besoin des valeurs suivantes pour valider les jetons émis par Logto :

- URI JSON Web Key Set (JWKS) : L’URL vers les clés publiques de Logto, utilisée pour vérifier la signature des JWT.
- Émetteur (Issuer) : La valeur attendue de l’émetteur (URL OIDC de Logto).

Commencez par trouver l’endpoint de votre tenant Logto. Vous pouvez le trouver à différents endroits :

- Dans la Console Logto, sous **Paramètres** → **Domaines**.
- Dans les paramètres de toute application configurée dans Logto, **Paramètres** → **Endpoints & Credentials**.

### Récupérer depuis l’endpoint de découverte OpenID Connect \{#fetch-from-openid-connect-discovery-endpoint}

Ces valeurs peuvent être récupérées depuis l’endpoint de découverte OpenID Connect de Logto :

```
https://<your-logto-endpoint>/oidc/.well-known/openid-configuration
```

Voici un exemple de réponse (autres champs omis pour la clarté) :

```json
{
  "jwks_uri": "https://your-tenant.logto.app/oidc/jwks",
  "issuer": "https://your-tenant.logto.app/oidc"
}
```

### Codage en dur dans votre code (non recommandé) \{#hardcode-in-your-code-not-recommended}

Puisque Logto ne permet pas de personnaliser l’URI JWKS ou l’émetteur, vous pouvez coder ces valeurs en dur dans votre code. Cependant, cela n’est pas recommandé pour les applications en production car cela peut augmenter la maintenance si la configuration change à l’avenir.

- JWKS URI : `https://<your-logto-endpoint>/oidc/jwks`
- Émetteur : `https://<your-logto-endpoint>/oidc`

## Étape 3 : Valider le jeton et les permissions \{#step-3-validate-the-token-and-permissions}

Après avoir extrait le jeton et récupéré la configuration OIDC, validez les éléments suivants :

- **Signature :** Le JWT doit être valide et signé par Logto (via JWKS).
- **Émetteur (Issuer) :** Doit correspondre à l’émetteur de votre tenant Logto.
- **Audience (Audience) :** Doit correspondre à l’indicateur de ressource API enregistré dans Logto, ou au contexte d’organisation si applicable.
- **Expiration :** Le jeton ne doit pas être expiré.
- **Permissions (Portées / Scopes) :** Le jeton doit inclure les portées requises pour votre API / action. Les portées sont des chaînes séparées par des espaces dans la revendication `scope`.
- **Contexte d’organisation :** Si vous protégez des ressources API au niveau organisation, validez la revendication `organization_id`.

Voir [JSON Web Token](https://auth.wiki/jwt) pour en savoir plus sur la structure et les revendications des JWT.

### À vérifier selon chaque modèle de permission \{#what-to-check-for-each-permission-model}

Les revendications et règles de validation diffèrent selon le modèle de permission :

| Modèle de permission                  | Revendication Audience (`aud`)                                            | Revendication Organisation (`organization_id`)        | Portées (permissions) à vérifier (`scope`) |
| ------------------------------------- | ------------------------------------------------------------------------- | ----------------------------------------------------- | ------------------------------------------ |
| Ressources API globales               | Indicateur de ressource API                                               | _Non présent_                                         | Permissions de ressource API               |
| Permissions d’organisation (non-API)  | `urn:logto:organization:<id>` (le contexte d’organisation est dans `aud`) | _Non présent_                                         | Permissions d’organisation                 |
| Ressources API au niveau organisation | Indicateur de ressource API                                               | ID de l’organisation (doit correspondre à la requête) | Permissions de ressource API               |

<small>
  Pour les permissions d’organisation non-API, le contexte d’organisation est représenté par la
  revendication `aud` (par exemple, `urn:logto:organization:abc123`). La revendication
  `organization_id` n’est présente que pour les jetons de ressource API au niveau organisation.
</small>

:::tip
Validez toujours à la fois les permissions (portées) et le contexte (audience, organisation) pour des APIs multi-tenant sécurisées.
:::

### Ajouter la logique de validation \{#add-the-validation-logic}

<Tabs groupId="api-language">
  <TabItem value="node" label="Node.js">
    <NodeAddValidationLogic />
  </TabItem>
  <TabItem value="python" label="Python">
    <PythonAddValidationLogic />
  </TabItem>
  <TabItem value="go" label="Go">
    <GoAddValidationLogic />
  </TabItem>
  <TabItem value="java" label="Java">
    <JavaAddValidationLogic />
  </TabItem>
  <TabItem value="dotnet" label=".NET">
    <DotNetAddValidationLogic />
  </TabItem>
  <TabItem value="php" label="PHP">
    <PhpAddValidationLogic />
  </TabItem>
  <TabItem value="ruby" label="Ruby">
    <RubyAddValidationLogic />
  </TabItem>
  <TabItem value="rust" label="Rust">
    <RustAddValidationLogic />
  </TabItem>
</Tabs>

## Étape 4 : Appliquer le middleware à votre API \{#step-4-apply-middleware-to-your-api}

Appliquez le middleware à vos routes API protégées.

<Tabs groupId="api-language">
  <TabItem value="node" label="Node.js">
    <NodeApplyMiddleware />
  </TabItem>
  <TabItem value="python" label="Python">
    <PythonApplyMiddleware />
  </TabItem>
  <TabItem value="go" label="Go">
    <GoApplyMiddleware />
  </TabItem>
  <TabItem value="java" label="Java">
    <JavaApplyMiddleware />
  </TabItem>
  <TabItem value="dotnet" label=".NET">
    <DotNetApplyMiddleware />
  </TabItem>
  <TabItem value="php" label="PHP">
    <PhpApplyMiddleware />
  </TabItem>
  <TabItem value="ruby" label="Ruby">
    <RubyApplyMiddleware />
  </TabItem>
  <TabItem value="rust" label="Rust">
    <RustApplyMiddleware />
  </TabItem>
</Tabs>

## Étape 5 : Tester votre implémentation \{#step-5-test-your-implementation}

Testez votre API avec des jetons valides et invalides pour vérifier :

- Les jetons valides passent et donnent accès.
- Retournez `401 Unauthorized` pour les jetons invalides / manquants. Retournez `403 Forbidden` pour les jetons valides qui n’ont pas les permissions ou le contexte requis.

## Ressources associées \{#related-resources}

<Url href="/developers/custom-token-claims">Personnaliser les revendications de jeton</Url>
<Url href="https://auth.wiki/fr/jwt">JSON Web Token (JWT)</Url>
<Url href="https://openid.net/specs/openid-connect-discovery-1_0.html">
  OpenID Connect Discovery
</Url>
<Url href="https://www.rfc-editor.org/rfc/rfc8707.html">RFC 8707 : Indicateurs de ressource</Url>
