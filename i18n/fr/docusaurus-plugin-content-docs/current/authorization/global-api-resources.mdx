---
sidebar_position: 3
---

import illustration from '@site/docs/authorization/assets/rbac-global-api-resources.png';
import AuthorizationRequestExample from '@site/docs/authorization/fragments/AuthorizationRequestExample';
import ClientCredentialsRequestExample from '@site/docs/authorization/fragments/ClientCredentialsRequestExample';
import TokenRequestExample from '@site/docs/authorization/fragments/TokenRequestExample';
import TabItem from '@theme/TabItem';
import Tabs from '@theme/Tabs';

# Prot√©ger les ressources API globales

export const resource = 'https://api.your-app.com';

Prot√©gez les API √† l‚Äô√©chelle du produit en utilisant le contr√¥le d‚Äôacc√®s bas√© sur les r√¥les (RBAC) dans Logto. Attribuez des r√¥les et des permissions globaux pour contr√¥ler l‚Äôacc√®s de tous les utilisateurs et clients √† travers votre application.

## Qu‚Äôest-ce qu‚Äôune ressource API globale ? \{#what-are-global-api-resources}

Les ressources API globales sont des points de terminaison ou des services dans votre application accessibles √† tous les utilisateurs, quel que soit l‚Äôorganisation ou le locataire. Il s‚Äôagit g√©n√©ralement d‚ÄôAPI publiques, de services c≈ìur du produit ou de tout point de terminaison qui n‚Äôest pas limit√© √† une organisation sp√©cifique.

**Cas d‚Äôutilisation courants**

- API publiques ou points de terminaison partag√©s entre tous vos utilisateurs.
- Microservices non li√©s √† la multi-location.
- API principales de l‚Äôapplication (par exemple, `/api/users`, `/api/products`) utilis√©es par tous les clients.

Logto vous permet de s√©curiser ces API en utilisant OAuth 2.1, combin√© √† un contr√¥le d‚Äôacc√®s flexible bas√© sur les r√¥les.

## Fonctionnement dans Logto \{#how-it-works-in-logto}

- **Les ressources API et permissions sont enregistr√©es globalement :** Chaque API que vous souhaitez prot√©ger est d√©finie avec un indicateur de ressource unique (URI) et un ensemble de permissions (port√©es) qui contr√¥lent l‚Äôacc√®s.
- **L‚Äôacc√®s est contr√¥l√© par des r√¥les globaux :** Vous pouvez attribuer des permissions √† des r√¥les, qui sont ensuite attribu√©s √† des utilisateurs ou des clients.
- **S√©par√© des permissions au niveau de l‚Äôorganisation :** Les ressources API globales n‚Äôont pas de contexte d‚Äôorganisation. Cependant, elles peuvent √™tre utilis√©es en combinaison avec des r√¥les d‚Äôorganisation pour fournir une couche de contexte suppl√©mentaire si n√©cessaire. Pour prot√©ger les API au niveau de l‚Äôorganisation, voir [Prot√©ger les ressources API au niveau de l‚Äôorganisation](/authorization/organization-level-api-resources).

<img src={illustration} alt="Ressources API globales RBAC" style={{ maxWidth: '100%' }} />

### Vue d‚Äôensemble de l‚Äôimpl√©mentation \{#implementation-overview}

1. **Enregistrez votre ressource API** et d√©finissez ses permissions dans Logto.
2. **D√©finissez des r√¥les** avec les permissions n√©cessaires pour acc√©der √† l‚ÄôAPI.
3. **Attribuez les r√¥les** aux utilisateurs ou clients.
4. **Utilisez les flux d‚Äôautorisation OAuth 2.0** pour obtenir des jetons d‚Äôacc√®s pour l‚ÄôAPI (le param√®tre resource doit correspondre √† l‚Äôidentifiant API enregistr√©).
5. **Validez les jetons d‚Äôacc√®s** dans votre API pour appliquer les permissions.

### Comprendre les indicateurs de ressource \{#understanding-resource-indicators}

Logto mod√©lise les ressources API selon [RFC 8707 : Indicateurs de ressource pour OAuth 2.0](https://www.rfc-editor.org/rfc/rfc8707.html). Un **indicateur de ressource** est un URI qui identifie de mani√®re unique l‚ÄôAPI ou le service cible demand√©.

**Points cl√©s**

- Les indicateurs de ressource doivent √™tre des URI absolus (par exemple, `https://api.example.com`)
- Pas de composant fragment ; √©vitez d‚Äôutiliser des cha√Ænes de requ√™te si possible.
- Les indicateurs de ressource permettent des jetons restreints √† une audience et la prise en charge d‚Äôarchitectures multi-API.

**Exemple**

- Management API : `https://my-tenant.logto.app/api`
- API globale personnalis√©e : `https://api.yourapp.com`

### Flux d‚Äôautorisation : authentifier et s√©curiser votre API \{#authorization-flow-authenticating-and-securing-your-api}

Le flux ci-dessous s‚Äôapplique √† la fois √† l‚Äôauthentification interactive de l‚Äôutilisateur (navigateur / application) et aux sc√©narios backend machine √† machine (M2M).

Veuillez noter que ce flux ne d√©taille pas tous les param√®tres ou en-t√™tes requis, mais se concentre sur les √©tapes cl√©s. Continuez la lecture pour voir comment ce flux fonctionne en pratique.

```mermaid
sequenceDiagram
    participant Client
    participant Logto
    participant API as Ressource API

    alt Authentification utilisateur
        Client->>Logto: GET /oidc/auth
        Logto->>Logto: Redirige l‚Äôutilisateur vers la page de connexion
        Logto->>Client: Redirige avec `authorization_code`
        alt Utilise le grant authorization_code
            Client->>Logto: POST /oidc/token avec `grant_type=authorization_code`<br/>et param√®tre `resource`
        else Utilise le grant refresh_token
            Client->>Logto: POST /oidc/token avec `grant_type=authorization_code`
            Logto->>Client: Retourne un jeton de rafra√Æchissement
            Client->>Logto: POST /oidc/token avec `grant_type=refresh_token`<br/>et param√®tre `resource`
        end
    else Authentification client machine √† machine (M2M)
        Client->>Logto: POST /oidc/token avec `grant_type=client_credentials`<br/>et param√®tre `resource`
    end

    Logto->>Client: Retourne un jeton d‚Äôacc√®s (JSON Web Token)
    Client->>API: Requ√™te avec jeton Bearer
    API->>API: Valide le jeton d‚Äôacc√®s

    alt Jeton valide
      API->>Client: Retourne les donn√©es de la ressource prot√©g√©e
    else Jeton invalide
      API->>Client: 401 Non autoris√©
    end
```

_Authentification utilisateur = navigateur / application. M2M = service backend ou script utilisant les identifiants client._

:::note
Le param√®tre `resource` doit correspondre exactement √† l‚Äôidentifiant API (indicateur de ressource) que vous avez enregistr√© dans Logto.
:::

## √âtapes d‚Äôimpl√©mentation \{#implementation-steps}

### Enregistrez vos ressources API \{#register-your-api-resources}

1. Allez dans <CloudLink to="/api-resources">Console ‚Üí Ressources API</CloudLink>.
2. Cr√©ez une nouvelle ressource API (par exemple, `https://api.yourapp.com/org`) et d√©finissez ses permissions (port√©es).

Pour toutes les √©tapes de configuration, voir [D√©finir des ressources API avec des permissions](/authorization/role-based-access-control#define-api-resources-with-permissions).

### Configurez des r√¥les globaux \{#set-up-global-roles}

1. Allez dans <CloudLink to="/roles">Console ‚Üí R√¥les</CloudLink>.
2. Cr√©ez des r√¥les correspondant √† vos permissions API (par exemple, `read:products`, `write:products`).
3. Attribuez ces r√¥les aux utilisateurs ou clients qui ont besoin d‚Äôacc√©der √† l‚ÄôAPI.

Pour toutes les √©tapes de configuration, voir [Utiliser des r√¥les globaux](/authorization/role-based-access-control#configure-global-roles).

### Obtenez des jetons d‚Äôacc√®s pour les ressources API globales \{#obtain-access-tokens-for-global-api-resources}

Avant d‚Äôacc√©der √† une ressource API globale, votre client doit obtenir un jeton d‚Äôacc√®s. Logto √©met des [JSON Web Tokens (JWT)](https://auth.wiki/jwt) comme jetons d‚Äôacc√®s pour les ressources API globales. Cela se fait g√©n√©ralement via le [flux d‚Äôautorisation code OAuth 2.0](https://auth.wiki/authorization-code-flow), le [flux de jeton de rafra√Æchissement](https://auth.wiki/refresh-token), ou le [flux client credentials](https://auth.wiki/client-credentials-flow).

#### Flux authorization code ou refresh token \{#authorization-code-or-refresh-token-flow}

Tous les SDK officiels Logto prennent en charge l‚Äôobtention de jetons d‚Äôacc√®s pour les ressources API globales via le flux de jeton de rafra√Æchissement par d√©faut. Une biblioth√®que cliente OAuth 2.0 / OIDC standard peut √©galement √™tre utilis√©e pour impl√©menter ce flux.

<Tabs groupId="user-client">
<TabItem value="logto-sdk" label="Logto SDK">

Lors de l‚Äôinitialisation du client Logto, ajoutez l‚Äôindicateur de ressource au param√®tre `resources` (tableau), puis ajoutez les permissions souhait√©es (port√©es) au param√®tre `scopes`.

Une fois l‚Äôutilisateur authentifi√©, transmettez l‚Äôindicateur de ressource dans le param√®tre `resource` ou un param√®tre similaire lors de la demande du jeton d‚Äôacc√®s (par exemple, en appelant `getAccessToken()`).

Pour plus de d√©tails sur chaque SDK, voir les [D√©marrages rapides](/quick-starts).

</TabItem>
<TabItem value="oauth-client" label="OAuth 2.0 / OIDC client library">

Lors de la configuration de votre client OAuth 2.0 ou de l‚Äôinitialisation du flux authorization code, assurez-vous d‚Äôinclure le param√®tre `resource` et les port√©es souhait√©es dans la requ√™te d‚Äôautorisation.

Certaines biblioth√®ques ne prennent pas en charge nativement le param√®tre `resource`, mais permettent g√©n√©ralement de transmettre des param√®tres suppl√©mentaires dans la requ√™te d‚Äôautorisation. Consultez la documentation de votre biblioth√®que pour plus de d√©tails.

Voici un exemple non normatif de requ√™te d‚Äôautorisation avec les param√®tres `resource` et `scope` :

<AuthorizationRequestExample resource={resource} scope="read:products write:products" />

Une fois l‚Äôutilisateur authentifi√©, vous recevrez un code d‚Äôautorisation. √âchangez ce code contre un jeton d‚Äôacc√®s en effectuant une requ√™te POST vers le point de terminaison `/oidc/token` de Logto, en incluant le param√®tre `resource` dans le corps de la requ√™te.

Voici un exemple non normatif de requ√™te de jeton utilisant le type de grant authorization_code :

<TokenRequestExample grantType="authorization_code" resource={resource} />

Vous pouvez √©galement utiliser le type de grant `refresh_token` pour obtenir un nouveau jeton d‚Äôacc√®s sans interaction utilisateur, tant que le param√®tre `resource` est inclus dans la requ√™te.

Voici un exemple non normatif de requ√™te de jeton utilisant le type de grant refresh_token :

<TokenRequestExample grantType="refresh_token" resource={resource} />

</TabItem>
</Tabs>

#### Flux client credentials \{#client-credentials-flow}

Pour les sc√©narios machine √† machine (M2M), vous pouvez utiliser le flux client credentials pour obtenir un jeton d‚Äôacc√®s pour votre ressource API globale. En effectuant une requ√™te POST vers le point de terminaison `/oidc/token` de Logto, vous pouvez demander un jeton d‚Äôacc√®s en utilisant votre client ID et secret.

Deux param√®tres cl√©s doivent √™tre inclus dans la requ√™te :

- `resource` : L‚ÄôURI indicateur de ressource de l‚ÄôAPI √† laquelle vous souhaitez acc√©der (par exemple, `https://api.yourapp.com`).
- `scope` : Les permissions que vous souhaitez demander pour l‚ÄôAPI (par exemple, `read:products write:products`).

Voici un exemple non normatif de requ√™te de jeton utilisant le type de grant client credentials :

<ClientCredentialsRequestExample
  resource="https://api.yourapp.com"
  scope="read:products write:products"
/>

### Validation des jetons d‚Äôacc√®s JWT dans votre API \{#validating-jwt-access-tokens-in-your-api}

Les JWT √©mis par Logto contiennent des revendications que votre API peut utiliser pour appliquer l‚Äôautorisation.

Lorsque votre API re√ßoit une requ√™te avec un jeton d‚Äôacc√®s √©mis par Logto, vous devez :

- V√©rifier la signature du jeton (en utilisant les JWKs de Logto).
- Confirmer que le jeton n‚Äôest pas expir√© (revendication `exp`).
- V√©rifier que le `iss` (√©metteur) correspond √† votre point de terminaison Logto.
- S‚Äôassurer que le `aud` (audience) correspond √† l‚Äôidentifiant de la ressource API que vous avez enregistr√©e (par exemple, `https://api.yourapp.com`).
- S√©parer la revendication `scope` (s√©par√©e par des espaces) et v√©rifier les permissions requises.

Pour des guides √©tape par √©tape et sp√©cifiques √† chaque langage, voir [Comment valider les jetons d‚Äôacc√®s](/authorization/validate-access-tokens).

### Optionnel : G√©rer le changement de permissions utilisateur \{#optional-handle-user-permission-change}

:::info
üë∑ Travail en cours. üöß
:::

## Bonnes pratiques et conseils de s√©curit√© \{#best-practices-and-security-tips}

- **Gardez les permissions orient√©es m√©tier :** Utilisez des noms clairs correspondant √† des actions r√©elles.
- **Gardez une expiration de jeton courte :** R√©duit le risque en cas de fuite de jeton.
- **Limitez les port√©es accord√©es :** Donnez uniquement aux jetons les permissions r√©ellement n√©cessaires.
- **Utilisez la restriction d‚Äôaudience :** V√©rifiez toujours la revendication `aud` pour √©viter les abus.

## FAQ \{#faqs}

<details>
<summary>

### Que faire si mon client ne prend pas en charge le param√®tre resource ? \{#what-if-my-client-doesn-t-support-the-resource-parameter}

</summary>

D√©finissez une ressource API par d√©faut dans la Console Logto. Les jetons utiliseront cette audience par d√©faut si aucun param√®tre resource n‚Äôest sp√©cifi√© dans la requ√™te de jeton.

</details>

<details>
<summary>

### Pourquoi mon API retourne-t-elle 401 Non autoris√© ? \{#why-do-i-get-401-unauthorized-from-my-api}

</summary>

V√©rifiez les probl√®mes courants suivants :

- **Signature du jeton** : V√©rifiez que votre backend r√©cup√®re les bons JWKs depuis Logto
- **Expiration du jeton** : Assurez-vous que le jeton n‚Äôa pas expir√© (revendication `exp`)
- **Audience** : V√©rifiez que la revendication `aud` correspond √† l‚Äôindicateur de ressource API enregistr√©
- **Port√©es requises** : V√©rifiez que le jeton contient les permissions n√©cessaires dans la revendication `scope`

</details>

<details>
<summary>

### Comment tester sans client complet ? \{#how-do-i-test-without-a-full-client}

</summary>

Utilisez un [jeton d‚Äôacc√®s personnel](/user-management/personal-access-token) pour simuler des appels authentifi√©s. Cela vous permet de tester vos points de terminaison API sans impl√©menter un flux OAuth complet dans votre application cliente.

</details>

<details>
<summary>

### Puis-je utiliser des pr√©fixes de scope ou des versions abr√©g√©es lors de la demande de permissions ? \{#can-i-use-scope-prefixes-or-shortened-versions}

</summary>

Non. Les noms de scope doivent **correspondre exactement** aux noms de permissions d√©finis dans votre ressource API. Les pr√©fixes et versions abr√©g√©es ne fonctionnent pas comme des jokers.

**Exemple :**

Si votre ressource API d√©finit :

- `read:elections`
- `write:elections`

Vous devez demander :

```swift
scopes: ["read:elections", "write:elections"]
```

Ceci **NE fonctionnera PAS** :

```swift
scopes: ["read", "write"]  // ‚ùå Ne correspond pas aux noms de permissions
```

</details>

## Pour aller plus loin \{#further-reading}

<Url href="/authorization/validate-access-tokens">Comment valider les jetons d‚Äôacc√®s</Url>
<Url href="/use-cases/authorization/rbac-in-practice">
  RBAC en pratique : Impl√©menter une autorisation s√©curis√©e pour votre application
</Url>
<Url href="/developers/custom-token-claims">Personnalisation des revendications de jeton</Url>
<Url href="https://www.rfc-editor.org/rfc/rfc8707.html">RFC 8707 : Indicateurs de ressource</Url>
