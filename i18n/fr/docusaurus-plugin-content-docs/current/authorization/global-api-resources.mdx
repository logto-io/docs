---
sidebar_position: 3
---

import TabItem from '@theme/TabItem';
import Tabs from '@theme/Tabs';

import illustration from '@site/docs/authorization/assets/rbac-global-api-resources.png';
import AuthorizationRequestExample from '@site/docs/authorization/fragments/AuthorizationRequestExample';
import ClientCredentialsRequestExample from '@site/docs/authorization/fragments/ClientCredentialsRequestExample';
import TokenRequestExample from '@site/docs/authorization/fragments/TokenRequestExample';

ProtÃ©ger les ressources API globales

export const resource = 'https://api.your-app.com';

ProtÃ©gez les API Ã  lâ€™Ã©chelle du produit en utilisant le contrÃ´le dâ€™accÃ¨s basÃ© sur les rÃ´les (RBAC) dans Logto. Attribuez des rÃ´les et des permissions globales pour contrÃ´ler lâ€™accÃ¨s de tous les utilisateurs et clients Ã  travers votre application.

## Quâ€™est-ce quâ€™une ressource API globale ? \{#what-are-global-api-resources}

Les ressources API globales sont des points de terminaison ou des services dans votre application accessibles Ã  tous les utilisateurs, quel que soit lâ€™organisation ou le locataire. Il sâ€™agit gÃ©nÃ©ralement dâ€™API publiques, de services cÅ“ur du produit ou de tout point de terminaison qui nâ€™est pas limitÃ© Ã  une organisation spÃ©cifique.

**Cas dâ€™utilisation courants**

- API publiques ou points de terminaison partagÃ©s entre tous vos utilisateurs.
- Microservices non liÃ©s Ã  la multi-location.
- API principales de lâ€™application (par exemple, `/api/users`, `/api/products`) utilisÃ©es par tous les clients.

Logto vous permet de sÃ©curiser ces API en utilisant OAuth 2.1, combinÃ© Ã  un contrÃ´le dâ€™accÃ¨s flexible basÃ© sur les rÃ´les.

## Fonctionnement dans Logto \{#how-it-works-in-logto}

- **Les ressources API et les permissions sont enregistrÃ©es globalement :** Chaque API que vous souhaitez protÃ©ger est dÃ©finie avec un indicateur de ressource unique (URI) et un ensemble de permissions (portÃ©es) qui contrÃ´lent lâ€™accÃ¨s.
- **Lâ€™accÃ¨s est contrÃ´lÃ© par des rÃ´les globaux :** Vous pouvez attribuer des permissions Ã  des rÃ´les, qui sont ensuite attribuÃ©s Ã  des utilisateurs ou des clients.
- **SÃ©parÃ© des permissions au niveau de lâ€™organisation :** Les ressources API globales nâ€™ont pas de contexte dâ€™organisation. Cependant, elles peuvent Ãªtre utilisÃ©es en combinaison avec des rÃ´les dâ€™organisation pour fournir une couche de contexte supplÃ©mentaire si nÃ©cessaire. Pour protÃ©ger les API au niveau de lâ€™organisation, voir [ProtÃ©ger les ressources API au niveau de lâ€™organisation](/authorization/organization-level-api-resources).

<img src={illustration} alt="Ressources API globales RBAC" style={{ maxWidth: '100%' }} />

### Vue dâ€™ensemble de lâ€™implÃ©mentation \{#implementation-overview}

1. **Enregistrez votre ressource API** et dÃ©finissez ses permissions dans Logto.
2. **DÃ©finissez des rÃ´les** avec les permissions nÃ©cessaires pour accÃ©der Ã  lâ€™API.
3. **Attribuez les rÃ´les** aux utilisateurs ou clients.
4. **Utilisez les flux dâ€™autorisation OAuth 2.0** pour obtenir des jetons dâ€™accÃ¨s pour lâ€™API (le paramÃ¨tre resource doit correspondre Ã  lâ€™identifiant API enregistrÃ©).
5. **Validez les jetons dâ€™accÃ¨s** dans votre API pour appliquer les permissions.

### Comprendre les indicateurs de ressource \{#understanding-resource-indicators}

Logto modÃ©lise les ressources API selon [RFC 8707 : Indicateurs de ressource pour OAuth 2.0](https://www.rfc-editor.org/rfc/rfc8707.html). Un **indicateur de ressource** est un URI qui identifie de faÃ§on unique lâ€™API ou le service cible demandÃ©.

**Points clÃ©s**

- Les indicateurs de ressource doivent Ãªtre des URI absolus (par exemple, `https://api.example.com`)
- Pas de composant fragment ; Ã©vitez dâ€™utiliser des chaÃ®nes de requÃªte si possible.
- Les indicateurs de ressource permettent des jetons restreints Ã  une audience et la prise en charge dâ€™architectures multi-API.

**Exemple**

- Management API : `https://my-tenant.logto.app/api`
- API globale personnalisÃ©e : `https://api.yourapp.com`

### Flux dâ€™autorisation : authentifier et sÃ©curiser votre API \{#authorization-flow-authenticating-and-securing-your-api}

Le flux ci-dessous sâ€™applique Ã  la fois Ã  lâ€™authentification interactive des utilisateurs (navigateur / application) et aux scÃ©narios backend machine Ã  machine (M2M).

Veuillez noter que ce flux ne dÃ©taille pas tous les paramÃ¨tres ou en-tÃªtes requis, mais se concentre sur les Ã©tapes clÃ©s. Continuez Ã  lire pour voir comment ce flux fonctionne en pratique.

```mermaid
sequenceDiagram
    participant Client
    participant Logto
    participant API as Ressource API

    alt Authentification utilisateur
        Client->>Logto: GET /oidc/auth
        Logto->>Logto: Redirige lâ€™utilisateur vers la page de connexion
        Logto->>Client: Redirige avec `authorization_code`
        alt Utiliser le grant authorization_code
            Client->>Logto: POST /oidc/token avec `grant_type=authorization_code`<br/>et paramÃ¨tre `resource`
        else Utiliser le grant refresh_token
            Client->>Logto: POST /oidc/token avec `grant_type=authorization_code`
            Logto->>Client: Retourne un jeton de rafraÃ®chissement
            Client->>Logto: POST /oidc/token avec `grant_type=refresh_token`<br/>et paramÃ¨tre `resource`
        end
    else Authentification client machine Ã  machine (M2M)
        Client->>Logto: POST /oidc/token avec `grant_type=client_credentials`<br/>et paramÃ¨tre `resource`
    end

    Logto->>Client: Retourne un jeton dâ€™accÃ¨s (JSON Web Token)
    Client->>API: RequÃªte avec jeton Bearer
    API->>API: Valide le jeton dâ€™accÃ¨s

    alt Jeton valide
      API->>Client: Retourne les donnÃ©es de la ressource protÃ©gÃ©e
    else Jeton invalide
      API->>Client: 401 Non autorisÃ©
    end
```

_Authentification utilisateur = navigateur / application. M2M = service backend ou script utilisant les identifiants client._

:::note
Le paramÃ¨tre `resource` doit correspondre exactement Ã  lâ€™identifiant API (indicateur de ressource) que vous avez enregistrÃ© dans Logto.
:::

## Ã‰tapes dâ€™implÃ©mentation \{#implementation-steps}

### Enregistrez vos ressources API \{#register-your-api-resources}

1. Allez dans <CloudLink to="/api-resources">Console â†’ Ressources API</CloudLink>.
2. CrÃ©ez une nouvelle ressource API (par exemple, `https://api.yourapp.com/org`) et dÃ©finissez ses permissions (portÃ©es).

Pour toutes les Ã©tapes de configuration, voir [DÃ©finir des ressources API avec des permissions](/authorization/role-based-access-control#define-api-resources-with-permissions).

### Configurez les rÃ´les globaux \{#set-up-global-roles}

1. Allez dans <CloudLink to="/roles">Console â†’ RÃ´les</CloudLink>.
2. CrÃ©ez des rÃ´les correspondant Ã  vos permissions API (par exemple, `read:products`, `write:products`).
3. Attribuez ces rÃ´les aux utilisateurs ou clients qui ont besoin dâ€™accÃ©der Ã  lâ€™API.

Pour toutes les Ã©tapes de configuration, voir [Utiliser les rÃ´les globaux](/authorization/role-based-access-control#configure-global-roles).

### Obtenez des jetons dâ€™accÃ¨s pour les ressources API globales \{#obtain-access-tokens-for-global-api-resources}

Avant dâ€™accÃ©der Ã  une ressource API globale, votre client doit obtenir un jeton dâ€™accÃ¨s. Logto Ã©met des [JSON Web Tokens (JWT)](https://auth.wiki/jwt) comme jetons dâ€™accÃ¨s pour les ressources API globales. Cela se fait gÃ©nÃ©ralement via le [flux dâ€™autorisation OAuth 2.0 code](https://auth.wiki/authorization-code-flow), le [flux de jeton de rafraÃ®chissement](https://auth.wiki/refresh-token), ou le [flux client credentials](https://auth.wiki/client-credentials-flow).

#### Flux authorization code ou refresh token \{#authorization-code-or-refresh-token-flow}

Tous les SDK officiels Logto prennent en charge lâ€™obtention de jetons dâ€™accÃ¨s pour les ressources API globales via le flux de jeton de rafraÃ®chissement par dÃ©faut. Une bibliothÃ¨que cliente OAuth 2.0 / OIDC standard peut Ã©galement Ãªtre utilisÃ©e pour implÃ©menter ce flux.

<Tabs groupId="user-client">
<TabItem value="logto-sdk" label="Logto SDK">

Lors de lâ€™initialisation du client Logto, ajoutez lâ€™indicateur de ressource au paramÃ¨tre `resources` (tableau), puis ajoutez les permissions souhaitÃ©es (portÃ©es) au paramÃ¨tre `scopes`.

Une fois lâ€™utilisateur authentifiÃ©, transmettez lâ€™indicateur de ressource dans le paramÃ¨tre `resource` ou un paramÃ¨tre similaire lors de la demande du jeton dâ€™accÃ¨s (par exemple, en appelant `getAccessToken()`).

Pour plus de dÃ©tails sur chaque SDK, voir les [DÃ©marrages rapides](/quick-starts).

</TabItem>
<TabItem value="oauth-client" label="BibliothÃ¨que cliente OAuth 2.0 / OIDC">

Lors de la configuration de votre client OAuth 2.0 ou de lâ€™initialisation du flux authorization code, assurez-vous dâ€™inclure le paramÃ¨tre `resource` et les portÃ©es souhaitÃ©es dans la requÃªte dâ€™autorisation.

Certaines bibliothÃ¨ques ne prennent pas en charge nativement le paramÃ¨tre `resource`, mais permettent gÃ©nÃ©ralement de passer des paramÃ¨tres supplÃ©mentaires dans la requÃªte dâ€™autorisation. Consultez la documentation de votre bibliothÃ¨que pour plus de dÃ©tails.

Voici un exemple non normatif de requÃªte dâ€™autorisation avec les paramÃ¨tres `resource` et `scope` :

<AuthorizationRequestExample resource={resource} scope="read:products write:products" />

Une fois lâ€™utilisateur authentifiÃ©, vous recevrez un code dâ€™autorisation. Ã‰changez ce code contre un jeton dâ€™accÃ¨s en effectuant une requÃªte POST vers le point de terminaison `/oidc/token` de Logto, en incluant le paramÃ¨tre `resource` dans le corps de la requÃªte.

Voici un exemple non normatif de requÃªte de jeton utilisant le type de grant authorization_code :

<TokenRequestExample grantType="authorization_code" resource={resource} />

Vous pouvez Ã©galement utiliser le type de grant `refresh_token` pour obtenir un nouveau jeton dâ€™accÃ¨s sans interaction utilisateur, tant que le paramÃ¨tre `resource` est inclus dans la requÃªte.

Voici un exemple non normatif de requÃªte de jeton utilisant le type de grant refresh_token :

<TokenRequestExample grantType="refresh_token" resource={resource} />

</TabItem>
</Tabs>

#### Flux client credentials \{#client-credentials-flow}

Pour les scÃ©narios machine Ã  machine (M2M), vous pouvez utiliser le flux client credentials pour obtenir un jeton dâ€™accÃ¨s pour votre ressource API globale. En effectuant une requÃªte POST vers le point de terminaison `/oidc/token` de Logto, vous pouvez demander un jeton dâ€™accÃ¨s en utilisant votre client ID et secret.

Deux paramÃ¨tres clÃ©s doivent Ãªtre inclus dans la requÃªte :

- `resource` : Lâ€™URI indicateur de ressource de lâ€™API Ã  laquelle vous souhaitez accÃ©der (par exemple, `https://api.yourapp.com`).
- `scope` : Les permissions que vous souhaitez demander pour lâ€™API (par exemple, `read:products write:products`).

Voici un exemple non normatif de requÃªte de jeton utilisant le type de grant client credentials :

<ClientCredentialsRequestExample
  resource="https://api.yourapp.com"
  scope="read:products write:products"
/>

### Validation des jetons dâ€™accÃ¨s JWT dans votre API \{#validating-jwt-access-tokens-in-your-api}

Les JWT Ã©mis par Logto contiennent des revendications que votre API peut utiliser pour appliquer lâ€™autorisation.

Lorsque votre API reÃ§oit une requÃªte avec un jeton dâ€™accÃ¨s Ã©mis par Logto, vous devez :

- VÃ©rifier la signature du jeton (en utilisant les JWKs de Logto).
- Confirmer que le jeton nâ€™est pas expirÃ© (revendication `exp`).
- VÃ©rifier que le `iss` (Ã©metteur) correspond Ã  votre point de terminaison Logto.
- Sâ€™assurer que le `aud` (audience) correspond Ã  lâ€™identifiant de la ressource API que vous avez enregistrÃ©e (par exemple, `https://api.yourapp.com`).
- SÃ©parer la revendication `scope` (sÃ©parÃ©e par des espaces) et vÃ©rifier les permissions requises.

Pour des guides Ã©tape par Ã©tape et spÃ©cifiques Ã  chaque langage, voir [Comment valider les jetons dâ€™accÃ¨s](/authorization/validate-access-tokens).

### Optionnel : GÃ©rer le changement de permission utilisateur \{#optional-handle-user-permission-change}

:::info
ğŸ‘· Travail en cours. ğŸš§
:::

## Bonnes pratiques et conseils de sÃ©curitÃ© \{#best-practices-and-security-tips}

- **Gardez les permissions orientÃ©es mÃ©tier :** Utilisez des noms clairs correspondant Ã  des actions rÃ©elles.
- **Gardez une expiration de jeton courte :** RÃ©duit le risque en cas de fuite dâ€™un jeton.
- **Limitez les portÃ©es accordÃ©es :** Donnez uniquement aux jetons les permissions rÃ©ellement nÃ©cessaires.
- **Utilisez la restriction dâ€™audience :** VÃ©rifiez toujours la revendication `aud` pour Ã©viter les abus.

## FAQ \{#faqs}

<details>
<summary>

### Que faire si mon client ne prend pas en charge le paramÃ¨tre resource ? \{#what-if-my-client-doesn-t-support-the-resource-parameter}

</summary>

DÃ©finissez une ressource API par dÃ©faut dans la Console Logto. Les jetons utiliseront cette audience par dÃ©faut si aucun paramÃ¨tre resource nâ€™est spÃ©cifiÃ© dans la requÃªte de jeton.

</details>

<details>
<summary>

### Pourquoi mon API retourne-t-elle 401 Non autorisÃ© ? \{#why-do-i-get-401-unauthorized-from-my-api}

</summary>

VÃ©rifiez les problÃ¨mes courants suivants :

- **Signature du jeton** : VÃ©rifiez que votre backend rÃ©cupÃ¨re les bons JWKs depuis Logto
- **Expiration du jeton** : Assurez-vous que le jeton nâ€™a pas expirÃ© (revendication `exp`)
- **Audience** : VÃ©rifiez que la revendication `aud` correspond Ã  lâ€™indicateur de ressource API enregistrÃ©
- **PortÃ©es requises** : VÃ©rifiez que le jeton contient les permissions nÃ©cessaires dans la revendication `scope`

</details>

<details>
<summary>

### Comment tester sans client complet ? \{#how-do-i-test-without-a-full-client}

</summary>

Utilisez un [jeton dâ€™accÃ¨s personnel](/user-management/personal-access-token) pour simuler des appels authentifiÃ©s. Cela vous permet de tester vos points de terminaison API sans implÃ©menter un flux OAuth complet dans votre application cliente.

</details>

## Pour aller plus loin \{#further-reading}

<Url href="/authorization/validate-access-tokens">Comment valider les jetons dâ€™accÃ¨s</Url>
<Url href="/use-cases/authorization/rbac-in-practice">
  RBAC en pratique : ImplÃ©menter une autorisation sÃ©curisÃ©e pour votre application
</Url>
<Url href="/developers/custom-token-claims">Personnalisation des revendications de jeton</Url>
<Url href="https://www.rfc-editor.org/rfc/rfc8707.html">RFC 8707 : Indicateurs de ressource</Url>
