## Étape 1 : Créer un projet sur la plateforme Google Auth \{#step-1-create-a-project-on-google-auth-platform}

Avant de pouvoir utiliser Google comme fournisseur d'authentification, vous devez configurer un projet dans la Google Cloud Console afin d'obtenir des identifiants OAuth 2.0. Si vous avez déjà un projet, vous pouvez passer cette étape.

1. Rendez-vous sur la [Google Cloud Console](https://console.cloud.google.com/) et connectez-vous avec votre compte Google.
2. Cliquez sur le bouton **Sélectionner un projet** dans la barre de menu supérieure, puis cliquez sur le bouton **Nouveau projet** pour créer un projet.
3. Dans votre nouveau projet, accédez à **APIs & Services > Écran de consentement OAuth** pour configurer votre application :
   - **Informations sur l'application** : Saisissez le **Nom de l'application** et l'**E-mail de support** qui seront affichés sur la page de consentement.
   - **Audience (Audience)** : Sélectionnez le type d'audience souhaité :
     - **Interne** – Uniquement pour les utilisateurs Google Workspace au sein de votre organisation
     - **Externe** – Pour tout utilisateur Google (nécessite une vérification pour une utilisation en production)
   - **Informations de contact** : Fournissez des adresses e-mail afin que Google puisse vous notifier de tout changement concernant votre projet.
   - Cochez **J'accepte les politiques de Google** pour terminer la configuration de base.
4. Facultativement, allez dans la section **Branding** pour modifier les informations du produit et téléchargez votre **Logo d'application**, qui apparaîtra sur l'écran de consentement OAuth pour aider les utilisateurs à reconnaître votre application.

:::tip
Si vous choisissez le type d'audience **Externe**, vous devrez ajouter des utilisateurs de test pendant le développement et publier votre application pour une utilisation en production.
:::

## Étape 2 : Créer des identifiants OAuth 2.0 \{#step-2-create-oauth-2-0-credentials}

Accédez à la page [Identifiants](https://console.cloud.google.com/apis/credentials) dans la Google Cloud Console et créez des identifiants OAuth pour votre application.

1. Cliquez sur **Créer des identifiants > ID client OAuth**.
2. Sélectionnez **Application Web** comme type d'application.
3. Renseignez le **Nom** de votre client OAuth. Cela vous aide à identifier les identifiants et n'est pas affiché aux utilisateurs finaux.
4. Configurez les URI autorisés :
   - **Origines JavaScript autorisées** : Ajoutez l'origine de votre instance Logto (par exemple, `https://votre-domaine-logto.com`)
   - **URI de redirection autorisés** : Ajoutez l'**URI de rappel** Logto (copiez-le depuis votre connecteur Google Logto)
5. Cliquez sur **Créer** pour générer le client OAuth.

## Étape 3 : Configurer le connecteur Logto avec les identifiants \{#step-3-configure-logto-connector-with-credentials}

Après avoir créé le client OAuth, Google affichera une fenêtre modale avec vos identifiants :

1. Copiez l'**ID client** et collez-le dans le champ `clientId` dans Logto.
2. Copiez le **Secret client** et collez-le dans le champ `clientSecret` dans Logto.
3. Cliquez sur **Enregistrer et Terminer** dans Logto pour connecter votre système d'identité à Google.

:::warning
Gardez votre secret client en sécurité et ne l'exposez jamais dans du code côté client. En cas de compromission, générez-en un nouveau immédiatement.
:::

## Étape 4 : Configurer les portées (Scopes) \{#step-4-configure-scopes}

Les portées (Portées) définissent les permissions que votre application demande aux utilisateurs et contrôlent les données auxquelles votre application peut accéder depuis leurs comptes Google.

### Configurer les portées dans la Google Cloud Console \{#configure-scopes-in-google-cloud-console}

1. Accédez à **APIs & Services > Écran de consentement OAuth > Portées**.
2. Cliquez sur **Ajouter ou supprimer des portées** et sélectionnez uniquement les portées requises par votre application :
   - **Authentification (Authentification) (Obligatoire)** :
     - `https://www.googleapis.com/auth/userinfo.email`
     - `https://www.googleapis.com/auth/userinfo.profile`
     - `openid`
   - **Accès API (Optionnel)** : Ajoutez toute portée supplémentaire nécessaire à votre application (par exemple, Drive, Calendar, YouTube). Parcourez la [bibliothèque d'API Google](https://console.cloud.google.com/apis/library) pour trouver les services disponibles. Si votre application a besoin d'accéder à des API Google au-delà des permissions de base, activez d'abord les API spécifiques que votre application utilisera (par exemple, Google Drive API, Gmail API, Calendar API) dans la bibliothèque d'API Google.
3. Cliquez sur **Mettre à jour** pour confirmer la sélection.
4. Cliquez sur **Enregistrer et continuer** pour appliquer les modifications.

### Configurer les portées dans Logto \{#configure-scopes-in-logto}

Choisissez une ou plusieurs des approches suivantes selon vos besoins :

**Option 1 : Aucune portée API supplémentaire requise**

- Laissez le champ `Scopes` vide dans votre connecteur Google Logto.
- Les portées par défaut `openid profile email` seront demandées pour garantir que Logto puisse obtenir correctement les informations de base de l'utilisateur.

**Option 2 : Demander des portées supplémentaires à la connexion**

- Saisissez toutes les portées souhaitées dans le champ **Scopes**, séparées par des espaces.
- Toute portée que vous indiquez ici remplace les valeurs par défaut, donc incluez toujours les portées d'authentification : `https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile openid`.
- Utilisez les URL complètes des portées. Exemple : `https://www.googleapis.com/auth/calendar.readonly`.

**Option 3 : Demander des portées incrémentielles ultérieurement**

- Après la connexion de l'utilisateur, vous pouvez demander des portées supplémentaires à la demande en relançant un flux d'autorisation sociale fédérée et en mettant à jour l'ensemble de jetons stockés de l'utilisateur.
- Ces portées supplémentaires n'ont pas besoin d'être renseignées dans le champ `Scopes` de votre connecteur Google Logto, et peuvent être obtenues via l'API de vérification sociale de Logto.

En suivant ces étapes, votre connecteur Google Logto demandera exactement les permissions dont votre application a besoin — ni plus, ni moins.

:::tip
Si votre application demande ces portées pour accéder à l'API Google et effectuer des actions, assurez-vous d'activer **Stocker les jetons pour un accès API persistant** dans le connecteur Google Logto. Voir la section suivante pour plus de détails.
:::

## Étape 5 : Personnaliser les invites d'authentification \{#step-5-customize-authentication-prompts}

Configurez les **Prompts** dans Logto pour contrôler l'expérience d'authentification utilisateur. Prompts est un tableau de chaînes qui spécifie le type d'interaction utilisateur requise :

- `none` – Le serveur d'autorisation n'affiche aucun écran d'authentification ou de consentement. Retourne une erreur si l'utilisateur n'est pas déjà authentifié et n'a pas préconfiguré le consentement pour les portées demandées. Utilisez ceci pour vérifier l'existence d'une authentification et/ou d'un consentement.
- `consent` – Le serveur d'autorisation invite l'utilisateur à donner son consentement avant de retourner des informations au client. Nécessaire pour activer l'**accès hors ligne** à l'API Google.
- `select_account` – Le serveur d'autorisation invite l'utilisateur à sélectionner un compte utilisateur. Cela permet aux utilisateurs ayant plusieurs comptes Google de choisir celui à utiliser pour l'authentification.

## Étape 6 : Paramètres généraux \{#step-6-general-settings}

Voici quelques paramètres généraux qui ne bloqueront pas la connexion à Google mais peuvent affecter l'expérience d'authentification de l'utilisateur final.

### Synchroniser les informations de profil \{#sync-profile-information}

Dans le connecteur Google, vous pouvez définir la politique de synchronisation des informations de profil, telles que les noms d'utilisateur et les avatars. Choisissez parmi :

- **Synchroniser uniquement à l'inscription** : Les informations de profil sont récupérées une seule fois lors de la première connexion de l'utilisateur.
- **Toujours synchroniser à la connexion** : Les informations de profil sont mises à jour à chaque connexion de l'utilisateur.

### Stocker les jetons pour accéder aux API Google (Optionnel) \{#store-tokens-to-access-google-apis-optional}

Si vous souhaitez accéder aux [API Google](https://console.cloud.google.com/apis/library) et effectuer des actions avec l'autorisation de l'utilisateur (que ce soit via la connexion sociale ou la liaison de compte), Logto doit obtenir des portées API spécifiques et stocker les jetons.

1. Ajoutez les portées requises dans la configuration de l'écran de consentement OAuth de votre Google Cloud Console et dans le connecteur Google Logto.
2. Activez **Stocker les jetons pour un accès API persistant** dans le connecteur Google Logto. Logto stockera en toute sécurité les jetons d'accès et de rafraîchissement Google dans le Secret Vault.
3. Pour garantir le retour des jetons de rafraîchissement, configurez votre connecteur Google Logto comme suit :
   - Définissez **Prompts** pour inclure `consent`
   - Activez **Accès hors ligne**

:::warning
Vous n'avez pas besoin d'ajouter `offline_access` dans le champ `Scope` de Logto — cela peut entraîner une erreur. Google utilise automatiquement `access_type=offline` lorsque l'accès hors ligne est activé.
:::

## Étape 7 : Activer Google One Tap (Optionnel) \{#step-7-enable-google-one-tap-optional}

[Google One Tap](https://developers.google.com/identity/gsi/web/guides/features) est un moyen sécurisé et simplifié permettant aux utilisateurs de se connecter à votre site web avec leur compte Google via une interface popup.

Une fois le connecteur Google configuré, vous verrez une carte pour Google One Tap dans la page de détails du connecteur. Activez Google One Tap en basculant l'interrupteur.

### Options de configuration de Google One Tap \{#google-one-tap-configuration-options}

- **Sélection automatique de l'identifiant si possible** – Connecte automatiquement l'utilisateur avec le compte Google si [certaines conditions sont remplies](https://developers.google.com/identity/gsi/web/guides/automatic-sign-in-sign-out)
- **Annuler l'invite si l'utilisateur clique/tape en dehors** – Ferme l'invite Google One Tap si l'utilisateur clique ou tape en dehors de l'invite. Si désactivé, l'utilisateur doit cliquer sur le bouton de fermeture pour rejeter l'invite.
- **Activer l'expérience utilisateur One Tap améliorée sur les navigateurs ITP** – Active l'expérience utilisateur Google One Tap améliorée sur les navigateurs avec Intelligent Tracking Prevention (ITP). Consultez [cette documentation](https://developers.google.com/identity/gsi/web/guides/features#upgraded_ux_on_itp_browsers) pour plus d'informations.

:::warning
Assurez-vous d'ajouter votre domaine dans la section **Origines JavaScript autorisées** de la configuration de votre client OAuth. Sinon, Google One Tap ne pourra pas s'afficher.
:::

### Limitations importantes avec Google One Tap \{#important-limitations-with-google-one-tap}

Si vous activez **Stocker les jetons pour un accès API persistant** en même temps que **Google One Tap**, vous ne recevrez pas automatiquement de jeton d'accès ni les portées demandées.

La connexion via Google One Tap (contrairement au bouton standard "Se connecter avec Google") **ne** délivre pas de jeton d'accès OAuth. Elle ne retourne qu'un jeton d'identifiant (un JWT signé) qui vérifie l'identité de l'utilisateur, mais ne donne pas accès à l'API.

Pour accéder aux API Google avec les utilisateurs Google One Tap, vous pouvez utiliser l'API de vérification sociale de Logto pour relancer un flux d'autorisation sociale fédérée après la connexion de l'utilisateur avec Google One Tap. Cela vous permet de demander des portées supplémentaires selon les besoins et de mettre à jour l'ensemble de jetons stockés de l'utilisateur, sans exiger que les portées soient pré-remplies dans le connecteur Google Logto. Cette approche permet une autorisation incrémentielle, de sorte que les utilisateurs ne sont invités à accorder des permissions supplémentaires que lorsque votre application en a réellement besoin.

En savoir plus sur les [limitations de Google One Tap](https://developers.google.com/identity/gsi/web/guides/overview) dans la documentation officielle.

## Étape 8 : Tester et publier votre application \{#step-8-test-and-publish-your-app}

### Pour les applications internes \{#for-internal-apps}

Si votre type **Audience (Audience)** dans Google est défini sur **Interne**, votre application ne sera disponible qu'aux utilisateurs Google Workspace de votre organisation. Vous pouvez tester avec n'importe quel compte de votre organisation.

### Pour les applications externes \{#for-external-apps}

Si votre type **Audience (Audience)** est **Externe** :

1. **Pendant le développement** : Accédez à **Écran de consentement OAuth > Utilisateurs de test** et ajoutez les adresses e-mail des utilisateurs de test. Seuls ces utilisateurs pourront se connecter avec votre application.
2. **Pour la production** : Cliquez sur **Publier l'application** dans la section écran de consentement OAuth pour la rendre disponible à toute personne disposant d'un compte Google.

:::note
Les applications avec des portées sensibles ou restreintes peuvent nécessiter une vérification par Google avant de pouvoir être publiées. Ce processus peut prendre plusieurs semaines.
:::
