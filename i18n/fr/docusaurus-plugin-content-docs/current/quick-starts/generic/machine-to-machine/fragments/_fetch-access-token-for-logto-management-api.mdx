import TabItem from '@theme/TabItem';
import Tabs from '@theme/Tabs';

import AccessTokenResponse from './_access-token-response.mdx';
import M2mAccessTokenNote from './_m2m-access-token-sub-note.mdx';

Logto fournit une ressource intégrée “Logto Management API”, il s'agit d'une ressource en lecture seule avec la permission `all` pour accéder à Logto Management API, vous pouvez la voir dans votre liste de ressources API.
L’indicateur de ressource API suit le modèle `https://{your-tenant-id}.logto.app/api` , et ce sera la valeur de ressource à utiliser dans le corps de la requête de jeton d’accès.

<img
  alt="Détails de Logto Management API"
  src="/img/assets/logto-management-api.png"
  width="600px"
/>

Avant d’accéder à Logto Management API, assurez-vous que votre application M2M a été assignée à des rôles M2M incluant la permission `all` de cette ressource intégrée “Logto Management API”.

:::info
Logto fournit également un rôle M2M préconfiguré “Logto Management API access” pour les nouveaux locataires créés, auquel la permission all de la ressource Logto Management API a déjà été attribuée. Vous pouvez l’utiliser directement sans configurer manuellement les permissions. Ce rôle préconfiguré peut également être modifié et supprimé selon les besoins.
:::

Maintenant, rassemblez tout ce que nous avons et envoyez la requête :

:::info
Depuis la version v1.30.1, Logto propose un SDK officiel Node.js `@logto/api` pour vous aider à interagir facilement avec Logto Management API.
:::

<Tabs groupId="interact-with-m-api">

<TabItem value="with-@logto-api-sdk" label="Node.js avec le SDK `@logto/api`">

#### Logto Cloud \{#logto-cloud}

```js
import { createManagementApi } from '@logto/api/management';

const { apiClient, clientCredentials } = createManagementApi('your-tenant-id', {
  clientId: 'your-client-id',
  clientSecret: 'your-client-secret',
});

const { value } = await clientCredentials.getAccessToken();
console.log('Access token:', value);

// Ou vous pouvez même ignorer la récupération du jeton d’accès et effectuer directement des appels API
const response = await apiClient.GET('/api/users');
console.log(response.data);
```

#### Auto-hébergé / OSS \{#self-hosted-oss}

Les utilisateurs OSS doivent utiliser `default` comme identifiant de locataire, et également fournir les configurations `baseUrl` et `apiIndicator`.

```js
const { apiClient, clientCredentials } = createManagementApi('default', {
  clientId: 'your-client-id',
  clientSecret: 'your-client-secret',
  // highlight-start
  baseUrl: 'https://your.logto.endpoint',
  apiIndicator: 'https://default.logto.app/api',
  // highlight-end
});
```

</TabItem>

<TabItem value="nodejs" label="Node.js">

```js
const logtoEndpoint = 'https://your.logto.endpoint'; // Remplacez par votre endpoint Logto
const tokenEndpoint = `${logtoEndpoint}/oidc/token`;
const applicationId = 'your-application-id';
const applicationSecret = 'your-application-secret';
const tenantId = 'your-tenant-id';

const fetchAccessToken = async () => {
  return await fetch(tokenEndpoint, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      Authorization: `Basic ${Buffer.from(`${applicationId}:${applicationSecret}`).toString(
        'base64'
      )}`,
    },
    body: new URLSearchParams({
      grant_type: 'client_credentials',
      resource: `https://${tenantId}.logto.app/api`,
      scope: 'all',
    }).toString(),
  });
};
```

:::caution
Pour les utilisateurs Logto Cloud : lorsque vous interagissez avec Logto Management API, vous ne pouvez pas utiliser de domaine personnalisé, utilisez l’endpoint Logto par défaut `https://{your_tenant_id}.logto.app/oidc/token` pour obtenir des jetons d’accès.
:::

<AccessTokenResponse />
<M2mAccessTokenNote />

</TabItem>

<TabItem value="curl" label="cURL">

```bash
curl --location \
  --request POST 'https://your.logto.endpoint' \
  --header 'Authorization: Basic ${your_auth_string}' \
  --header 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode 'grant_type=client_credentials' \
  --data-urlencode 'resource=https://${tenantId}.logto.app/api' \
  --data-urlencode 'scope=all'
```

N’oubliez pas de remplacer les valeurs réelles par les vôtres.

:::caution
Pour les utilisateurs Logto Cloud : lorsque vous interagissez avec Logto Management API, vous ne pouvez pas utiliser de domaine personnalisé, utilisez l’endpoint Logto par défaut `https://{your_tenant_id}.logto.app/oidc/token` pour obtenir des jetons d’accès.
:::

<AccessTokenResponse />
<M2mAccessTokenNote />

</TabItem>

</Tabs>
