---
id: federated-token-set
title: Drittanbieter-Token-Speicherung & API-Zugriff
sidebar_label: Drittanbieter-Token-Speicherung
---

import Availability from '@components/Availability';

<Availability cloud oss={{ major: 1, minor: 31 }} />

Das Drittanbieter-Token-Set (auch bekannt als f√∂deriertes Token-Set) ist ein Geheimnistyp, der im [Secret Vault](/secret-vault) von Logto gespeichert wird, um Zugangstokens (Zugangstoken (Access token)) und Auffrischungstokens (Auffrischungstoken (Refresh token)), die von Drittanbieter-Identit√§tsanbietern ausgestellt wurden, sicher zu verwalten. Wenn sich ein Benutzer √ºber einen Social- oder Enterprise SSO-Connector authentifiziert, speichert Logto die ausgestellten Tokens im Vault. Diese Tokens k√∂nnen sp√§ter abgerufen werden, um im Namen des Benutzers auf Drittanbieter-APIs zuzugreifen, ohne dass eine erneute Authentifizierung erforderlich ist.

## H√§ufige Anwendungsf√§lle \{#common-use-cases}

Diese F√§higkeit ist essenziell f√ºr moderne Anwendungen wie KI-Agenten, SaaS-Plattformen, Produktivit√§tstools und Kundenanwendungen, die im Namen der Benutzer mit Drittanbieterdiensten interagieren m√ºssen. Hier einige praktische Beispiele:

**üìÖ Kalenderverwaltungs-Apps**: Nachdem sich ein Benutzer mit Google anmeldet, kann deine Produktivit√§ts-App automatisch seine Kalendereintr√§ge synchronisieren, neue Meetings erstellen und Einladungen versenden, ohne erneut nach einer Authentifizierung zu fragen.

**ü§ñ KI-Assistenten**: Ein KI-Agent kann auf die GitHub-Repositories eines Benutzers zugreifen, um Code zu analysieren, Pull Requests zu erstellen oder Issues zu verwalten. Alles mit der einmaligen Zustimmung des Benutzers w√§hrend der Anmeldung oder Kontoverkn√ºpfung.

**üìä Analyse-Dashboards**: SaaS-Plattformen k√∂nnen Daten aus den verbundenen Social-Media-Konten der Benutzer (Facebook, LinkedIn) abrufen, um Einblicke und Berichte zu generieren, ohne den Arbeitsablauf durch wiederholte Login-Aufforderungen zu unterbrechen.

## Drittanbieter-Token-Speicherung aktivieren \{#enable-third-party-token-storage}

### Social Connectors \{#social-connectors}

Diese Funktion ist f√ºr [Social Connectors](/connectors/social-connectors) verf√ºgbar, die die Token-Speicherung unterst√ºtzen. Drittanbieter-Tokens k√∂nnen w√§hrend der [sozialen Anmeldung](/end-user-flows/sign-up-and-sign-in/social-sign-in), [sozialen Kontoverkn√ºpfung](/end-user-flows/account-settings/by-account-api#link-a-new-social-connection) und [beim Erneuern von Tokens f√ºr Drittanbieter-API-Zugriff](/secret-vault/federated-token-set#reauthentication-and-token-renewal) gespeichert werden. Aktuell unterst√ºtzte Connectors sind: [GitHub](/integrations/github), [Google](/integrations/google), [Facebook](/integrations/facebook), [Standard OAuth 2.0](/integrations/oauth2) und [Standard OIDC](/integrations/oidc). Die Unterst√ºtzung f√ºr weitere Connectors wird schrittweise eingef√ºhrt.

1. Navigiere zu <CloudLink to="/connectors/social">Konsole > Connectors > Social Connectors</CloudLink>.
2. W√§hle den Social Connector aus, f√ºr den du die Drittanbieter-Token-Speicherung aktivieren m√∂chtest.
3. Folge den Einrichtungsanleitungen, um den Connector zu konfigurieren, einschlie√ülich der Hinzuf√ºgung der erforderlichen Berechtigungen (Scopes), um auf bestimmte Drittanbieter-APIs zuzugreifen.
4. Aktiviere auf der Seite ‚ÄûEinstellungen‚Äú die Option **Tokens f√ºr dauerhaften API-Zugriff speichern**.

### Enterprise SSO Connectors \{#enterprise-sso-connectors}

Die Token-Speicherung ist f√ºr alle OIDC [Enterprise Connectors](/connectors/enterprise-connectors) verf√ºgbar. Zugangstokens (Zugangstoken (Access token)) und Auffrischungstokens (Auffrischungstoken (Refresh token)) k√∂nnen w√§hrend des [Enterprise Single Sign-On](/end-user-flows/enterprise-sso) gespeichert werden. Aktuell unterst√ºtzte Connectors sind: [Google Workspace](/integrations/google-workspace), [Microsoft Entra ID (OIDC)](/integrations/entra-id-oidc), [Okta](/integrations/okta) und [OIDC (Enterprise)](/integrations/oidc-sso).

1. Navigiere zu <CloudLink to="/enterprise-sso">Konsole > Enterprise SSO</CloudLink>.
2. W√§hle den Enterprise SSO Connector aus, f√ºr den du die Drittanbieter-Token-Speicherung aktivieren m√∂chtest.
3. Folge den Einrichtungsanleitungen, um den Connector zu konfigurieren, einschlie√ülich der Hinzuf√ºgung der erforderlichen Berechtigungen (Scopes), um auf bestimmte Drittanbieter-APIs zuzugreifen.
4. Aktiviere im Tab ‚ÄûSSO-Erfahrung‚Äú die Option **Tokens f√ºr dauerhaften API-Zugriff speichern**.

Stelle sicher, dass du deine √Ñnderungen speicherst.

## Token-Speicherung \{#token-storage}

Sobald die Drittanbieter-Token-Speicherung aktiviert ist, speichert Logto automatisch die Zugangstokens (Zugangstoken (Access token)) und Auffrischungstokens (Auffrischungstoken (Refresh token)), die vom f√∂derierten Identit√§tsanbieter ausgestellt wurden, wann immer sich ein Benutzer √ºber einen Social- oder Enterprise SSO-Connector authentifiziert. Dies umfasst:

- [Soziale Anmeldung und Registrierung](/end-user-flows/sign-up-and-sign-in/social-sign-in)
- [Enterprise SSO Anmeldung und Registrierung](/end-user-flows/enterprise-sso)
- [Soziale Kontoverkn√ºpfung √ºber Account API](/end-user-flows/account-settings/by-account-api#link-a-new-social-connection)

Die gespeicherten Tokens sind mit der Social- oder Enterprise SSO-Identit√§t des Benutzers verkn√ºpft, sodass sie sp√§ter f√ºr den API-Zugriff abgerufen werden k√∂nnen, ohne dass eine erneute Authentifizierung erforderlich ist.

### √úberpr√ºfung des Token-Speicherstatus \{#checking-token-storage-status}

Du kannst den Drittanbieter-Token-Speicherstatus eines Benutzers in der Logto-Konsole √ºberpr√ºfen:

1. Navigiere zu <CloudLink to="/users">Konsole > Benutzer</CloudLink>.
2. Klicke auf den Benutzer, den du √ºberpr√ºfen m√∂chtest. Dies f√ºhrt dich zur Detailseite des Benutzers.
3. Scrolle zum Abschnitt **Verbindungen**. Dieser Bereich listet alle Social- und Enterprise SSO-Verbindungen auf, die mit dem Benutzer verkn√ºpft sind.
4. Jeder Eintrag zeigt ein Token-Status-Label, das angibt, ob Tokens f√ºr diese Verbindung gespeichert sind.
5. Klicke auf den Verbindungseintrag, um weitere Details anzuzeigen, einschlie√ülich der gespeicherten Zugangstoken-Metadaten und der Verf√ºgbarkeit eines Auffrischungstokens (falls vorhanden).

Du kannst auch die Drittanbieter-Identit√§ten und den Token-Speicherstatus eines Benutzers √ºber die Management API √ºberpr√ºfen:

- `GET /api/users/{userId}/identities/{target}?includeTokenSecret=true`: Ruft die Social-Identit√§t eines Benutzers und den damit verbundenen Token-Speicherstatus f√ºr einen bestimmten Connector-Target (z. B. `github`, `google` usw.) ab.
- `GET /api/users/{userId}/sso-identities/{ssoConnectorId}?includeTokenSecret=true`: Ruft die Enterprise SSO-Identit√§t eines Benutzers und den damit verbundenen Token-Speicherstatus f√ºr eine bestimmte SSO-Connector-ID ab.

### Token-Speicherstatus \{#token-storage-status}

- **Aktiv**: Das Zugangstoken (Zugangstoken (Access token)) ist gespeichert und aktiv.
- **Abgelaufen**: Das Zugangstoken (Zugangstoken (Access token)) ist gespeichert, aber abgelaufen. Wenn ein Auffrischungstoken (Auffrischungstoken (Refresh token)) verf√ºgbar ist, kann damit ein neues Zugangstoken (Zugangstoken (Access token)) abgerufen werden.
- **Inaktiv**: F√ºr diese Verbindung ist kein Zugangstoken (Zugangstoken (Access token)) gespeichert. Dies kann passieren, wenn der Benutzer sich nicht √ºber diese Verbindung authentifiziert hat oder die Token-Speicherung gel√∂scht wurde.
- **Nicht anwendbar**: Der Connector unterst√ºtzt keine Token-Speicherung.

### Token-Metadaten \{#token-metadata}

Aus Gr√ºnden der Datenintegrit√§t und Sicherheit werden alle Tokens vor der Speicherung im Secret Vault verschl√ºsselt. Die tats√§chlichen Token-Werte sind nur f√ºr den Endbenutzer mit entsprechender Autorisierung zug√§nglich. Entwickler k√∂nnen hingegen nur die Metadaten des Token-Sets abrufen, um den Status der gespeicherten Tokens zu verstehen, ohne sensible Inhalte offenzulegen.

- `createdAt`: Der Zeitstempel, zu dem die Verbindung erstmals hergestellt und das Token-Set initial im Secret Vault gespeichert wurde.
- `updatedAt`: Der Zeitpunkt der letzten Aktualisierung des Token-Sets.
  - Wenn kein Auffrischungstoken (Auffrischungstoken (Refresh token)) verf√ºgbar ist, entspricht dieser Wert **createdAt**.
  - Wenn ein Auffrischungstoken (Auffrischungstoken (Refresh token)) vorhanden ist, spiegelt dieser Wert den letzten Zeitpunkt wider, zu dem das Zugangstoken (Zugangstoken (Access token)) erneuert wurde.
- `hasRefreshToken`: Gibt an, ob ein Auffrischungstoken (Auffrischungstoken (Refresh token)) verf√ºgbar ist.
  Wenn der Connector Offline-Zugriff unterst√ºtzt und die Autorisierungsanfrage entsprechend konfiguriert ist, speichert Logto das Auffrischungstoken (Auffrischungstoken (Refresh token)), wenn es vom Identit√§tsanbieter zusammen mit dem Zugangstoken (Zugangstoken (Access token)) ausgestellt wird.
  Wenn das Zugangstoken (Zugangstoken (Access token)) abl√§uft und ein g√ºltiges Auffrischungstoken (Auffrischungstoken (Refresh token)) existiert, versucht Logto automatisch, ein neues Zugangstoken (Zugangstoken (Access token)) mit dem gespeicherten Auffrischungstoken (Auffrischungstoken (Refresh token)) zu erhalten, wann immer der Benutzer Zugriff auf den verbundenen Anbieter anfordert.
- `expiresAt`: Die gesch√§tzte Ablaufzeit des Zugangstokens (Zugangstoken (Access token)) in **Sekunden**.
  Dies wird basierend auf dem `expires_in`-Wert berechnet, der vom Token-Endpunkt des Identit√§tsanbieters zur√ºckgegeben wird. (Dieses Feld ist nur verf√ºgbar, wenn der Anbieter `expires_in` in der Token-Antwort enth√§lt.)
- `scope`: Die Berechtigung (Scope) des Zugangstokens (Zugangstoken (Access token)), die die vom Identit√§tsanbieter gew√§hrten Berechtigungen angibt.
  Dies ist n√ºtzlich, um zu verstehen, welche Aktionen mit dem gespeicherten Zugangstoken (Zugangstoken (Access token)) durchgef√ºhrt werden k√∂nnen. (Dieses Feld ist nur verf√ºgbar, wenn der Anbieter `scope` in der Token-Antwort enth√§lt.)
- `tokenType`: Der Typ des Zugangstokens (Zugangstoken (Access token)), typischerweise "Bearer".
  (Dieses Feld ist nur verf√ºgbar, wenn der Anbieter `token_type` in der Token-Antwort enth√§lt.)

## Token-Abruf \{#token-retrieval}

Sobald die Token-Speicherung aktiviert und Tokens sicher im Secret Vault von Logto gespeichert sind, k√∂nnen Endbenutzer ihre Drittanbieter-Zugangstokens (Zugangstoken (Access token)) aus deiner Client-Anwendung abrufen, indem sie die [User Account API](/end-user-flows/account-settings/by-account-api) von Logto integrieren.

- `GET /my-account/identities/:target/access-token`: Ruft das Zugangstoken (Zugangstoken (Access token)) f√ºr eine Social-Identit√§t ab, indem der Connector-Target angegeben wird (z. B. github, google).

- `GET /my-account/sso-identities/:connectorId/access-token`: Ruft das Zugangstoken (Zugangstoken (Access token)) f√ºr eine Enterprise SSO-Identit√§t ab, indem die Connector-ID angegeben wird.

:::info
Um Drittanbieter-Zugangstokens (Zugangstoken (Access token)) abzurufen, musst du zuerst die Account API f√ºr Endbenutzer unter <CloudLink to="/sign-in-experience/account-center">Konsole > Anmeldung & Konto > Account Center</CloudLink> aktivieren. Erfahre, wie du die [Account API aktivierst](/end-user-flows/account-settings/by-account-api#how-to-enable-account-api) und [sie mit einem von Logto ausgestellten Zugangstoken (Zugangstoken (Access token)) aufrufst](/end-user-flows/account-settings/by-account-api#access-account-api-using-access-token).
:::

### Token-Rotation \{#token-rotation}

Die Endpunkte zum Token-Abruf liefern:

- `200` OK: Wenn das Zugangstoken (Zugangstoken (Access token)) erfolgreich abgerufen wurde und noch g√ºltig ist.
- `404` Nicht gefunden: Wenn der Benutzer keine Social- oder Enterprise SSO-Identit√§t mit dem angegebenen Target oder der Connector-ID hat oder wenn das Zugangstoken (Zugangstoken (Access token)) nicht gespeichert ist.
- `401` Nicht autorisiert: Wenn das Zugangstoken (Zugangstoken (Access token)) abgelaufen ist.

Wenn das Zugangstoken (Zugangstoken (Access token)) abgelaufen ist und ein Auffrischungstoken (Auffrischungstoken (Refresh token)) verf√ºgbar ist, versucht Logto automatisch, das Zugangstoken (Zugangstoken (Access token)) zu erneuern und gibt das neue Zugangstoken (Zugangstoken (Access token)) in der Antwort zur√ºck. Die Token-Speicherung im Secret Vault wird ebenfalls mit dem neuen Zugangstoken (Zugangstoken (Access token)) und den zugeh√∂rigen Metadaten aktualisiert.

## Token-Speicherung l√∂schen \{#token-storage-deletion}

Die Drittanbieter-Token-Speicherung ist direkt mit den Social- oder Enterprise SSO-Verbindungen jedes Benutzers verkn√ºpft. Das bedeutet, dass das gespeicherte Token-Set in folgenden F√§llen automatisch gel√∂scht wird:

- Die zugeh√∂rige Social- oder Enterprise SSO-Identit√§t wird aus dem Benutzerkonto entfernt.
- Das Benutzerkonto wird aus deinem Mandanten gel√∂scht.
- Der Social- oder Enterprise SSO-Connector wird aus deinem Mandanten gel√∂scht.

### Tokens widerrufen \{#revoking-tokens}

Du kannst das Drittanbieter-Token-Set eines Benutzers auch manuell l√∂schen, um den Zugriff zu widerrufen:

- √úber die Konsole:
  Navigiere zur Identit√§tsdetailseite des Benutzers. Scrolle zum Abschnitt **Zugangstoken (Zugangstoken (Access token))** (falls Token-Speicherung verf√ºgbar ist) und klicke am Ende des Abschnitts auf die Schaltfl√§che **Tokens l√∂schen**.
- √úber die Management API:
  - `DELETE /api/secret/:id`: L√∂scht ein bestimmtes Geheimnis anhand seiner ID, die du aus den Identit√§tsdetails des Benutzers erh√§ltst.

Das Widerrufen des Token-Sets zwingt den Benutzer, sich erneut beim Drittanbieter zu authentifizieren, um ein neues Zugangstoken (Zugangstoken (Access token)) zu erhalten, bevor er wieder auf Drittanbieter-APIs zugreifen kann.

## Reauthentifizierung und Token-Erneuerung \{#reauthentication-and-token-renewal}

In Szenarien, in denen ein gespeichertes Zugangstoken (Zugangstoken (Access token)) abgelaufen ist oder eine Anwendung zus√§tzliche API-Berechtigungen (Scopes) anfordern muss, k√∂nnen Endbenutzer sich beim Drittanbieter erneut authentifizieren, um ein neues Zugangstoken (Zugangstoken (Access token)) zu erhalten ‚Äì ohne sich erneut bei Logto anmelden zu m√ºssen.
Dies kann √ºber die [Social Verification API](https://openapi.logto.io/operation/operation-createverificationbysocial) von Logto erfolgen, die es Benutzern erm√∂glicht, einen f√∂derierten Social-Autorisierungsfluss erneut zu starten und ihr gespeichertes Token-Set zu aktualisieren.

:::note
Das erneute Initiieren der f√∂derierten Autorisierung ist derzeit auf Social Connectors beschr√§nkt.
F√ºr Enterprise SSO Connectors erfordern Reauthentifizierung und Token-Erneuerung, dass der Benutzer erneut einen vollst√§ndigen Logto-Authentifizierungsfluss durchl√§uft, da eine direkte Reautorisierung mit dem Enterprise SSO-Anbieter nach der Anmeldung derzeit nicht unterst√ºtzt wird.
:::

```mermaid
sequenceDiagram
    autonumber

    participant User as Benutzer
    participant Logto as Logto
    participant Provider as Drittanbieter

    User->>Logto: post /api/verification/social
    Logto->>User: Weiterleitung zum Drittanbieter
    User->>Provider: Authentifizieren und autorisieren
    Provider->>User: Weiterleitung zur√ºck mit Autorisierungscode
    User->>Logto: post /api/verification/social/verify mit Autorisierungscode
    Logto->>User: R√ºckgabe der Social Verification ID
    User->>Logto: patch /my-account/identities/:target/access-token
```

1. Der Benutzer startet eine Social Verification-Anfrage, indem er den Endpunkt `POST /api/verification/social` aufruft. Der Benutzer kann benutzerdefinierte Berechtigungen (Scopes) angeben, um zus√§tzliche Berechtigungen vom Drittanbieter anzufordern.

   ```sh
   curl -X POST https://<your-logto-domain>/api/verification/social \
     -H "Authorization: Bearer <access_token>" \
     -H "Content-Type: application/json" \
     -d '{
       "state": "<state>",
       "connectorId": "<logto_connectorId>",
       "redirectUri": "<redirect_uri>",
       "scope": "<custom_scope>"
     }'
   ```

   - **authorization header**: Das vom Logto ausgestellte Zugangstoken (Zugangstoken (Access token)) des Benutzers.
   - **connectorId**: Die Social Connector ID in Logto.
   - **redirectUri**: Die URI, zu der der Benutzer nach der Authentifizierung zur√ºck zu deiner Anwendung geleitet wird. Diese URI muss in den Anwendungseinstellungen des Anbieters registriert werden.
   - **scope**: (Optional) Benutzerdefinierte Berechtigungen (Scopes), um zus√§tzliche Berechtigungen vom Drittanbieter anzufordern. Wenn nicht angegeben, werden die in der Connector-Konfiguration hinterlegten Standard-Berechtigungen verwendet.

2. Logto erstellt einen neuen Social Verification-Datensatz und gibt die Social Verification ID zusammen mit der Autorisierungs-URL zur√ºck, um den Benutzer zum Drittanbieter zur Authentifizierung weiterzuleiten.

   Die Antwort sieht wie folgt aus:

   ```json
   {
     "verificationRecordId": "<social_verification_id>",
     "authorizationUri": "<authorization_url>",
     "expiresAt": "<expiration_time>"
   }
   ```

3. Leite den Benutzer zur Autorisierungs-URL weiter. Der Benutzer authentifiziert sich beim Drittanbieter und erteilt die Berechtigungen.

4. Der Drittanbieter leitet den Benutzer mit einem Autorisierungscode zur√ºck zu deiner Client-Anwendung.

5. Verarbeite den Autorisierungs-Callback, indem du den Autorisierungscode an den Verification-Endpunkt von Logto weiterleitest:

   ```sh
   curl -X POST https://<your-logto-domain>/api/verification/social/verify \
     -H "Authorization: Bearer <access_token>" \
     -d '{
       "verificationRecordId": "<social_verification_id>",
       "connectorData": {
         "code": "<authorization_code>",
         "state": "<state>",
         "redirectUri": "<redirect_uri>"
       }
     }'
   ```

   - **authorization header**: Das vom Logto ausgestellte Zugangstoken (Zugangstoken (Access token)) des Benutzers.
   - **verificationRecordId**: Die im vorherigen Schritt zur√ºckgegebene Social Verification ID.
   - **connectorData**: Der Autorisierungscode und alle weiteren Daten, die vom Drittanbieter w√§hrend des Callbacks zur√ºckgegeben wurden.

   :::note
   Vergiss nicht, den `state`-Parameter zu validieren, um CSRF-Angriffe zu verhindern.
   :::

6. Logto √ºberpr√ºft den Autorisierungscode und tauscht ihn gegen ein neues Zugangstoken (Zugangstoken (Access token)) und Auffrischungstoken (Auffrischungstoken (Refresh token)) vom Drittanbieter aus und gibt dann die Social Verification ID in der Antwort zur√ºck.

7. Aktualisiere abschlie√üend die Token-Speicherung des Benutzers, indem du den Endpunkt `PATCH /my-account/identities/:target/access-token` mit der Social Verification ID aufrufst:

   ```sh
   curl -X PATCH https://<your-logto-domain>/my-account/identities/<target>/access-token \
     -H "Authorization: Bearer <access_token>" \
     -H "Content-Type: application/json" \
     -d '{
       "socialVerificationId": "<social_verification_id>"
     }'
   ```

   - **authorization header**: Das vom Logto ausgestellte Zugangstoken (Zugangstoken (Access token)) des Benutzers.
   - **socialVerificationId**: Die im vorherigen Schritt zur√ºckgegebene verifizierte Social Verification Record ID.

   Dadurch wird das Token-Set des Benutzers im Secret Vault von Logto mit dem neuen Zugangstoken (Zugangstoken (Access token)) und Auffrischungstoken (Auffrischungstoken (Refresh token)) aktualisiert, sodass der Benutzer auf Drittanbieter-APIs zugreifen kann, ohne sich erneut bei Logto anmelden zu m√ºssen.

   Das aktualisierte Zugangstoken (Zugangstoken (Access token)) wird zur√ºckgegeben.
