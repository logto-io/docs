---
sidebar_position: 6
sidebar_label: Zugangstokens in der API validieren
---

import TabItem from '@theme/TabItem';
import Tabs from '@theme/Tabs';

import DotNetAddValidationLogic from './dotnet/_add-validation-logic.mdx';
import DotNetApplyMiddleware from './dotnet/_apply-middleware.mdx';
import DotNetInit from './dotnet/_init.mdx';
import GoAddValidationLogic from './go/_add-validation-logic.mdx';
import GoApplyMiddleware from './go/_apply-middleware.mdx';
import GoInit from './go/_init.mdx';
import JavaAddValidationLogic from './java/_add-validation-logic.mdx';
import JavaApplyMiddleware from './java/_apply-middleware.mdx';
import JavaInit from './java/_init.mdx';
import NodeAddValidationLogic from './nodejs/_add-validation-logic.mdx';
import NodeApplyMiddleware from './nodejs/_apply-middleware.mdx';
import NodeInit from './nodejs/_init.mdx';
import PhpAddValidationLogic from './php/_add-validation-logic.mdx';
import PhpApplyMiddleware from './php/_apply-middleware.mdx';
import PhpInit from './php/_init.mdx';
import PythonAddValidationLogic from './python/_add-validation-logic.mdx';
import PythonApplyMiddleware from './python/_apply-middleware.mdx';
import PythonInit from './python/_init.mdx';
import RubyAddValidationLogic from './ruby/_add-validation-logic.mdx';
import RubyApplyMiddleware from './ruby/_apply-middleware.mdx';
import RubyInit from './ruby/_init.mdx';
import RustAddValidationLogic from './rust/_add-validation-logic.mdx';
import RustApplyMiddleware from './rust/_apply-middleware.mdx';
import RustInit from './rust/_init.mdx';

# Wie du Zugangstokens in deinem API-Service oder Backend validierst

Die Validierung von Zugangstokens (Access tokens) ist ein entscheidender Bestandteil der Durchsetzung der [rollenbasierten Zugangskontrolle (RBAC)](/authorization/role-based-access-control) in Logto. Diese Anleitung führt dich durch die Überprüfung von von Logto ausgestellten JWTs in deinem Backend / deiner API, einschließlich der Prüfung von Signatur, Aussteller (Issuer), Zielgruppe (Audience), Ablauf, Berechtigungen (Scopes) und Organisationskontext.

## Bevor du beginnst \{#before-you-start}

- Diese Anleitung setzt voraus, dass du mit den RBAC-Konzepten von Logto vertraut bist.
- Wenn du API-Ressourcen schützt, wird vorausgesetzt, dass du die Anleitung [Globale API-Ressourcen schützen](/authorization/global-api-resources) durchlaufen hast.
- Wenn du In-App-Funktionen oder Workflows (Nicht-API-Berechtigungen) schützt, wird vorausgesetzt, dass du die Anleitung [Organisations-(Nicht-API)-Berechtigungen schützen](/authorization/organization-permissions) durchlaufen hast.
- Wenn du API-Ressourcen auf Organisationsebene schützt, wird vorausgesetzt, dass du die Anleitung [API-Ressourcen auf Organisationsebene schützen](/authorization/organization-level-api-resources) durchlaufen hast.

## Schritt 1: Konstanten und Hilfsfunktionen initialisieren \{#step-1-initialize-constants-and-utilities}

Definiere die notwendigen Konstanten und Hilfsfunktionen in deinem Code, um die Token-Extraktion und -Validierung zu handhaben. Eine gültige Anfrage muss einen `Authorization`-Header in der Form `Bearer <access_token>` enthalten.

<Tabs groupId="api-language">
  <TabItem value="node" label="Node.js">
    <NodeInit />
  </TabItem>
  <TabItem value="python" label="Python">
    <PythonInit />
  </TabItem>
  <TabItem value="go" label="Go">
    <GoInit />
  </TabItem>
  <TabItem value="java" label="Java">
    <JavaInit />
  </TabItem>
  <TabItem value="dotnet" label=".NET">
    <DotNetInit />
  </TabItem>
  <TabItem value="php" label="PHP">
    <PhpInit />
  </TabItem>
  <TabItem value="ruby" label="Ruby">
    <RubyInit />
  </TabItem>
  <TabItem value="rust" label="Rust">
    <RustInit />
  </TabItem>
</Tabs>

## Schritt 2: Informationen zu deinem Logto-Tenant abrufen \{#step-2-retrieve-info-about-your-logto-tenant}

Du benötigst die folgenden Werte, um von Logto ausgestellte Tokens zu validieren:

- JSON Web Key Set (JWKS) URI: Die URL zu den öffentlichen Schlüsseln von Logto, die zur Überprüfung der JWT-Signaturen verwendet werden.
- Aussteller (Issuer): Der erwartete Wert des Ausstellers (die OIDC-URL von Logto).

Finde zunächst den Endpunkt deines Logto-Tenants. Du findest ihn an verschiedenen Stellen:

- In der Logto-Konsole unter **Einstellungen** → **Domains**.
- In den Anwendungseinstellungen, die du in Logto konfiguriert hast, unter **Einstellungen** → **Endpoints & Credentials**.

### Abruf vom OpenID Connect Discovery Endpoint \{#fetch-from-openid-connect-discovery-endpoint}

Diese Werte können vom OpenID Connect Discovery Endpoint von Logto abgerufen werden:

```
https://<your-logto-endpoint>/oidc/.well-known/openid-configuration
```

Hier ein Beispiel für eine Antwort (andere Felder zur Übersichtlichkeit ausgelassen):

```json
{
  "jwks_uri": "https://your-tenant.logto.app/oidc/jwks",
  "issuer": "https://your-tenant.logto.app/oidc"
}
```

### Im Code fest hinterlegen (nicht empfohlen) \{#hardcode-in-your-code-not-recommended}

Da Logto keine Anpassung der JWKS-URI oder des Issuers erlaubt, kannst du diese Werte in deinem Code fest hinterlegen. Für Produktionsanwendungen wird dies jedoch nicht empfohlen, da dies den Wartungsaufwand erhöht, falls sich Konfigurationen in Zukunft ändern.

- JWKS URI: `https://<your-logto-endpoint>/oidc/jwks`
- Issuer: `https://<your-logto-endpoint>/oidc`

## Schritt 3: Das Token und die Berechtigungen validieren \{#step-3-validate-the-token-and-permissions}

Nachdem du das Token extrahiert und die OIDC-Konfiguration abgerufen hast, prüfe Folgendes:

- **Signatur:** Das JWT muss gültig und von Logto signiert sein (über JWKS).
- **Aussteller (Issuer):** Muss mit dem Aussteller deines Logto-Tenants übereinstimmen.
- **Zielgruppe (Audience):** Muss mit dem in Logto registrierten Ressourcenindikator der API oder dem Organisationskontext übereinstimmen, falls zutreffend.
- **Ablauf:** Das Token darf nicht abgelaufen sein.
- **Berechtigungen (Scopes):** Das Token muss die erforderlichen Berechtigungen (Scopes) für deine API / Aktion enthalten. Scopes sind durch Leerzeichen getrennte Zeichenfolgen im `scope`-Anspruch.
- **Organisationskontext:** Wenn du API-Ressourcen auf Organisationsebene schützt, prüfe den Anspruch `organization_id`.

Siehe [JSON Web Token](https://auth.wiki/jwt), um mehr über die Struktur und Ansprüche von JWTs zu erfahren.

### Was bei jedem Berechtigungsmodell zu prüfen ist \{#what-to-check-for-each-permission-model}

Die Ansprüche und Validierungsregeln unterscheiden sich je nach Berechtigungsmodell:

| Berechtigungsmodell                     | Audience-Anspruch (`aud`)                                              | Organisations-Anspruch (`organization_id`) | Zu prüfende Berechtigungen (`scope`) |
| --------------------------------------- | ---------------------------------------------------------------------- | ------------------------------------------ | ------------------------------------ |
| Globale API-Ressourcen                  | API-Ressourcenindikator                                                | _Nicht vorhanden_                          | API-Ressourcen-Berechtigungen        |
| Organisation (Nicht-API) Berechtigungen | `urn:logto:organization:<id>` (Organisationskontext im `aud`-Anspruch) | _Nicht vorhanden_                          | Organisationsberechtigungen          |
| API-Ressourcen auf Organisationsebene   | API-Ressourcenindikator                                                | Organisations-ID (muss zur Anfrage passen) | API-Ressourcen-Berechtigungen        |

<small>
  Für Nicht-API-Organisationsberechtigungen wird der Organisationskontext durch den `aud`-Anspruch
  dargestellt (z. B. `urn:logto:organization:abc123`). Der Anspruch `organization_id` ist nur bei
  Tokens für API-Ressourcen auf Organisationsebene vorhanden.
</small>

:::tip
Validiere immer sowohl die Berechtigungen (Scopes) als auch den Kontext (Audience, Organisation) für sichere Multi-Tenant-APIs.
:::

### Die Validierungslogik hinzufügen \{#add-the-validation-logic}

<Tabs groupId="api-language">
  <TabItem value="node" label="Node.js">
    <NodeAddValidationLogic />
  </TabItem>
  <TabItem value="python" label="Python">
    <PythonAddValidationLogic />
  </TabItem>
  <TabItem value="go" label="Go">
    <GoAddValidationLogic />
  </TabItem>
  <TabItem value="java" label="Java">
    <JavaAddValidationLogic />
  </TabItem>
  <TabItem value="dotnet" label=".NET">
    <DotNetAddValidationLogic />
  </TabItem>
  <TabItem value="php" label="PHP">
    <PhpAddValidationLogic />
  </TabItem>
  <TabItem value="ruby" label="Ruby">
    <RubyAddValidationLogic />
  </TabItem>
  <TabItem value="rust" label="Rust">
    <RustAddValidationLogic />
  </TabItem>
</Tabs>

## Schritt 4: Middleware auf deine API anwenden \{#step-4-apply-middleware-to-your-api}

Wende die Middleware auf deine geschützten API-Routen an.

<Tabs groupId="api-language">
  <TabItem value="node" label="Node.js">
    <NodeApplyMiddleware />
  </TabItem>
  <TabItem value="python" label="Python">
    <PythonApplyMiddleware />
  </TabItem>
  <TabItem value="go" label="Go">
    <GoApplyMiddleware />
  </TabItem>
  <TabItem value="java" label="Java">
    <JavaApplyMiddleware />
  </TabItem>
  <TabItem value="dotnet" label=".NET">
    <DotNetApplyMiddleware />
  </TabItem>
  <TabItem value="php" label="PHP">
    <PhpApplyMiddleware />
  </TabItem>
  <TabItem value="ruby" label="Ruby">
    <RubyApplyMiddleware />
  </TabItem>
  <TabItem value="rust" label="Rust">
    <RustApplyMiddleware />
  </TabItem>
</Tabs>

## Schritt 5: Deine Implementierung testen \{#step-5-test-your-implementation}

Teste deine API mit gültigen und ungültigen Tokens, um sicherzustellen:

- Gültige Tokens werden akzeptiert und gewähren Zugriff.
- Gib `401 Unauthorized` für ungültige / fehlende Tokens zurück. Gib `403 Forbidden` für gültige Tokens zurück, denen die erforderlichen Berechtigungen oder der Kontext fehlen.

## Verwandte Ressourcen \{#related-resources}

<Url href="/developers/custom-token-claims">Token-Ansprüche anpassen</Url>
<Url href="https://auth.wiki/de/jwt">JSON Web Token (JWT)</Url>
<Url href="https://openid.net/specs/openid-connect-discovery-1_0.html">
  OpenID Connect Discovery
</Url>
<Url href="https://www.rfc-editor.org/rfc/rfc8707.html">RFC 8707: Ressourcenindikatoren</Url>
