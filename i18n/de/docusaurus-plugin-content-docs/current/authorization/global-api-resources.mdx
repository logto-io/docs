---
sidebar_position: 3
---

import illustration from '@site/docs/authorization/assets/rbac-global-api-resources.png';
import AuthorizationRequestExample from '@site/docs/authorization/fragments/AuthorizationRequestExample';
import ClientCredentialsRequestExample from '@site/docs/authorization/fragments/ClientCredentialsRequestExample';
import TokenRequestExample from '@site/docs/authorization/fragments/TokenRequestExample';
import TabItem from '@theme/TabItem';
import Tabs from '@theme/Tabs';

# Globale API-Ressourcen sch√ºtzen

export const resource = 'https://api.your-app.com';

Sch√ºtze produktweite APIs mit rollenbasierter Zugangskontrolle (RBAC) in Logto. Weise globale Rollen und Berechtigungen zu, um den Zugriff f√ºr alle Benutzer und Clients in deiner Anwendung zu steuern.

## Was sind globale API-Ressourcen? \{#what-are-global-api-resources}

Globale API-Ressourcen sind Endpunkte oder Dienste in deiner Anwendung, die f√ºr alle Benutzer zug√§nglich sind, unabh√§ngig von Organisation oder Mandant. Dies sind typischerweise √∂ffentlich zug√§ngliche APIs, zentrale Produktdienste oder jeder Endpunkt, der nicht auf eine bestimmte Organisation beschr√§nkt ist.

**Anwendungsf√§lle sind unter anderem**

- √ñffentliche APIs oder Endpunkte, die von deiner gesamten Nutzerbasis geteilt werden.
- Microservices, die nicht an Multi-Tenancy gebunden sind.
- Zentrale Anwendungs-APIs (z. B. `/api/users`, `/api/products`), die von allen Kunden genutzt werden.

Logto erm√∂glicht es dir, diese APIs mit OAuth 2.1 in Kombination mit flexibler, rollenbasierter Zugangskontrolle abzusichern.

## So funktioniert es in Logto \{#how-it-works-in-logto}

- **API-Ressourcen und Berechtigungen werden global registriert:** Jede API, die du sch√ºtzen m√∂chtest, wird mit einem eindeutigen Ressourcenindikator (URI) und einem Satz von Berechtigungen (Scopes) definiert, die den Zugriff steuern.
- **Der Zugriff wird durch globale Rollen gesteuert:** Du kannst Berechtigungen Rollen zuweisen, die dann Benutzern oder Clients zugeordnet werden.
- **Getrennt von organisationsbezogenen Berechtigungen:** Globale API-Ressourcen haben keinen Organisationskontext. Sie k√∂nnen jedoch zusammen mit Organisationsrollen verwendet werden, um bei Bedarf eine zus√§tzliche Kontextebene bereitzustellen. Um organisationsbezogene APIs zu sch√ºtzen, siehe [Organisationsbezogene API-Ressourcen sch√ºtzen](/authorization/organization-level-api-resources).

<img src={illustration} alt="Globale API-Ressourcen RBAC" style={{ maxWidth: '100%' }} />

### √úberblick √ºber die Implementierung \{#implementation-overview}

1. **Registriere deine API-Ressource** und definiere deren Berechtigungen in Logto.
2. **Definiere Rollen** mit den notwendigen Berechtigungen f√ºr den Zugriff auf die API.
3. **Weise Rollen** Benutzern oder Clients zu.
4. **Nutze OAuth 2.0 Autorisierungsfl√ºsse**, um Zugangstokens f√ºr die API zu erhalten (der resource-Parameter muss mit dem registrierten API-Identifier √ºbereinstimmen).
5. **Validiere Zugangstokens** in deiner API, um Berechtigungen durchzusetzen.

### Ressourcenindikatoren verstehen \{#understanding-resource-indicators}

Logto modelliert API-Ressourcen gem√§√ü [RFC 8707: Resource Indicators for OAuth 2.0](https://www.rfc-editor.org/rfc/rfc8707.html). Ein **Ressourcenindikator (resource indicator)** ist eine URI, die die angeforderte Ziel-API oder den Dienst eindeutig identifiziert.

**Wichtige Punkte**

- Ressourcenindikatoren m√ºssen absolute URIs sein (z. B. `https://api.example.com`)
- Kein Fragmentbestandteil; vermeide nach M√∂glichkeit Query-Strings.
- Ressourcenindikatoren erm√∂glichen zielgruppenbeschr√§nkte Tokens und unterst√ºtzen Multi-API-Architekturen.

**Beispiel**

- Management API: `https://my-tenant.logto.app/api`
- Eigene globale API: `https://api.yourapp.com`

### Autorisierungsfluss: Authentifizierung und Absicherung deiner API \{#authorization-flow-authenticating-and-securing-your-api}

Der folgende Ablauf gilt sowohl f√ºr interaktive Benutzer-Authentifizierung (Browser/App) als auch f√ºr Backend-Maschine-zu-Maschine (M2M)-Szenarien.

Beachte, dass der Ablauf nicht alle Details zu erforderlichen Parametern oder Headern enth√§lt, sondern sich auf die wichtigsten Schritte konzentriert. Lies weiter, um zu sehen, wie der Ablauf in der Praxis funktioniert.

```mermaid
sequenceDiagram
    participant Client
    participant Logto
    participant API as API-Ressource

    alt Benutzer-Authentifizierung
        Client->>Logto: GET /oidc/auth
        Logto->>Logto: Leitet Benutzer zur Anmeldeseite weiter
        Logto->>Client: Leitet zur√ºck mit `authorization_code`
        alt Verwende authorization_code grant
            Client->>Logto: POST /oidc/token mit `grant_type=authorization_code`<br/>und `resource`-Parameter
        else Verwende refresh_token grant
            Client->>Logto: POST /oidc/token mit `grant_type=authorization_code`
            Logto->>Client: Gibt Auffrischungstoken zur√ºck
            Client->>Logto: POST /oidc/token mit `grant_type=refresh_token`<br/>und `resource`-Parameter
        end
    else Maschine-zu-Maschine (M2M) Client-Authentifizierung
        Client->>Logto: POST /oidc/token mit `grant_type=client_credentials`<br/>und `resource`-Parameter
    end

    Logto->>Client: Gibt Zugangstoken (JSON Web Token) zur√ºck
    Client->>API: Anfrage mit Bearer-Token
    API->>API: Validiert Zugangstoken

    alt Token ist g√ºltig
      API->>Client: Gibt gesch√ºtzte Ressourcendaten zur√ºck
    else Token ist ung√ºltig
      API->>Client: 401 Nicht autorisiert
    end
```

_Benutzer-Authentifizierung = Browser/App. M2M = Backend-Dienst oder Skript mit Client-Credentials._

:::note
Der `resource`-Parameter muss exakt mit dem in Logto registrierten API-Identifier (Ressourcenindikator) √ºbereinstimmen.
:::

## Implementierungsschritte \{#implementation-steps}

### Registriere deine API-Ressourcen \{#register-your-api-resources}

1. Gehe zu <CloudLink to="/api-resources">Konsole ‚Üí API-Ressourcen</CloudLink>.
2. Erstelle eine neue API-Ressource (z. B. `https://api.yourapp.com/org`) und definiere deren Berechtigungen (Scopes).

F√ºr vollst√§ndige Konfigurationsschritte siehe [API-Ressourcen mit Berechtigungen definieren](/authorization/role-based-access-control#define-api-resources-with-permissions).

### Globale Rollen einrichten \{#set-up-global-roles}

1. Gehe zu <CloudLink to="/roles">Konsole ‚Üí Rollen</CloudLink>.
2. Erstelle Rollen, die deinen API-Berechtigungen entsprechen (z. B. `read:products`, `write:products`).
3. Weise diese Rollen Benutzern oder Clients zu, die Zugriff auf die API ben√∂tigen.

F√ºr vollst√§ndige Konfigurationsschritte siehe [Globale Rollen verwenden](/authorization/role-based-access-control#configure-global-roles).

### Zugangstokens f√ºr globale API-Ressourcen erhalten \{#obtain-access-tokens-for-global-api-resources}

Bevor auf eine globale API-Ressource zugegriffen werden kann, muss dein Client ein Zugangstoken erhalten. Logto stellt [JSON Web Tokens (JWTs)](https://auth.wiki/jwt) als Zugangstokens f√ºr globale API-Ressourcen aus. Dies geschieht typischerweise √ºber den [OAuth 2.0 Authorization Code Flow](https://auth.wiki/authorization-code-flow), [Auffrischungstoken-Flow](https://auth.wiki/refresh-token) oder den [Client-Credentials-Flow](https://auth.wiki/client-credentials-flow).

#### Authorization Code oder Auffrischungstoken-Flow \{#authorization-code-or-refresh-token-flow}

Alle offiziellen Logto SDKs unterst√ºtzen das Abrufen von Zugangstokens f√ºr globale API-Ressourcen direkt √ºber den Auffrischungstoken-Flow. Auch eine Standard-OAuth 2.0 / OIDC-Clientbibliothek kann f√ºr diesen Flow verwendet werden.

<Tabs groupId="user-client">
<TabItem value="logto-sdk" label="Logto SDK">

Beim Initialisieren des Logto-Clients f√ºge den Ressourcenindikator zum `resources`-Parameter (Array) hinzu und die gew√ºnschten Berechtigungen (Scopes) zum `scopes`-Parameter.

Sobald der Benutzer authentifiziert ist, √ºbergib den Ressourcenindikator im `resource`-Parameter oder einem √§hnlich benannten Parameter, wenn das Zugangstoken angefordert wird (z. B. beim Aufruf von `getAccessToken()`).

Details zu jedem SDK findest du in den [Schnellstarts](/quick-starts).

</TabItem>
<TabItem value="oauth-client" label="OAuth 2.0 / OIDC client library">

Beim Konfigurieren deines OAuth 2.0-Clients oder beim Initialisieren des Authorization Code Flows stelle sicher, dass du den `resource`-Parameter und die gew√ºnschten Scopes in der Autorisierungsanfrage einf√ºgst.

Einige Bibliotheken unterst√ºtzen den `resource`-Parameter nicht nativ, erlauben aber in der Regel das Hinzuf√ºgen zus√§tzlicher Parameter zur Autorisierungsanfrage. Pr√ºfe die Dokumentation deiner Bibliothek f√ºr Details.

Hier ein nicht-normatives Beispiel f√ºr die Autorisierungsanfrage mit den Parametern `resource` und `scope`:

<AuthorizationRequestExample resource={resource} scope="read:products write:products" />

Nach erfolgreicher Authentifizierung erh√§ltst du einen Authorization Code. Tausche diesen Code gegen ein Zugangstoken, indem du eine POST-Anfrage an Logtos `/oidc/token`-Endpunkt stellst und den `resource`-Parameter im Anfragek√∂rper angibst.

Hier ein nicht-normatives Beispiel f√ºr die Token-Anfrage mit dem Grant-Typ authorization_code:

<TokenRequestExample grantType="authorization_code" resource={resource} />

Du kannst auch den Grant-Typ `refresh_token` verwenden, um ohne Benutzerinteraktion ein neues Zugangstoken zu erhalten, solange der `resource`-Parameter in der Anfrage enthalten ist.

Hier ein nicht-normatives Beispiel f√ºr die Token-Anfrage mit dem Grant-Typ refresh_token:

<TokenRequestExample grantType="refresh_token" resource={resource} />

</TabItem>
</Tabs>

#### Client-Credentials-Flow \{#client-credentials-flow}

F√ºr Maschine-zu-Maschine (M2M)-Szenarien kannst du den Client-Credentials-Flow verwenden, um ein Zugangstoken f√ºr deine globale API-Ressource zu erhalten. Durch eine POST-Anfrage an Logtos `/oidc/token`-Endpunkt kannst du ein Zugangstoken mit deiner Client-ID und deinem Secret anfordern.

Es gibt zwei wichtige Parameter, die in der Anfrage enthalten sein m√ºssen:

- `resource`: Die URI des Ressourcenindikators der API, auf die du zugreifen m√∂chtest (z. B. `https://api.yourapp.com`).
- `scope`: Die Berechtigungen, die du f√ºr die API anfordern m√∂chtest (z. B. `read:products write:products`).

Hier ein nicht-normatives Beispiel f√ºr die Token-Anfrage mit dem Grant-Typ client_credentials:

<ClientCredentialsRequestExample
  resource="https://api.yourapp.com"
  scope="read:products write:products"
/>

### JWT-Zugangstokens in deiner API validieren \{#validating-jwt-access-tokens-in-your-api}

Von Logto ausgestellte JWTs enthalten Anspr√ºche, die deine API zur Durchsetzung der Autorisierung verwenden kann.

Wenn deine API eine Anfrage mit einem von Logto ausgestellten Zugangstoken erh√§lt, solltest du:

- Die Signatur des Tokens √ºberpr√ºfen (mit Logtos JWKs).
- Sicherstellen, dass das Token nicht abgelaufen ist (`exp`-Anspruch).
- Pr√ºfen, dass der `iss` (Aussteller) mit deinem Logto-Endpunkt √ºbereinstimmt.
- Sicherstellen, dass der `aud` (Zielgruppe) mit dem registrierten API-Ressourcenindikator √ºbereinstimmt (z. B. `https://api.yourapp.com`).
- Den `scope`-Anspruch (durch Leerzeichen getrennt) auf erforderliche Berechtigungen pr√ºfen.

F√ºr Schritt-f√ºr-Schritt- und sprachspezifische Anleitungen siehe [Zugangstokens validieren](/authorization/validate-access-tokens).

### Optional: Benutzerberechtigungs√§nderung behandeln \{#optional-handle-user-permission-change}

:::info
üë∑ In Arbeit. üöß
:::

## Best Practices und Sicherheitstipps \{#best-practices-and-security-tips}

- **Berechtigungen gesch√§ftsorientiert halten:** Verwende klare Namen, die echten Aktionen entsprechen.
- **Token-Ablauf kurz halten:** Reduziert das Risiko bei Token-Leakage.
- **Vergebene Scopes begrenzen:** Gib Tokens nur die Berechtigungen, die sie tats√§chlich ben√∂tigen.
- **Zielgruppenbeschr√§nkung nutzen:** √úberpr√ºfe immer den `aud`-Anspruch, um Missbrauch zu verhindern.

## FAQs \{#faqs}

<details>
<summary>

### Was, wenn mein Client den resource-Parameter nicht unterst√ºtzt? \{#what-if-my-client-doesn-t-support-the-resource-parameter}

</summary>

Lege eine Standard-API-Ressource in der Logto-Konsole fest. Tokens verwenden diese Zielgruppe, wenn im Token-Request kein resource-Parameter angegeben ist.

</details>

<details>
<summary>

### Warum erhalte ich 401 Nicht autorisiert von meiner API? \{#why-do-i-get-401-unauthorized-from-my-api}

</summary>

√úberpr√ºfe die folgenden h√§ufigen Probleme:

- **Token-Signatur**: Stelle sicher, dass dein Backend die korrekten JWKs von Logto abruft
- **Token-Ablauf**: Stelle sicher, dass das Token nicht abgelaufen ist (`exp`-Anspruch)
- **Zielgruppe**: Pr√ºfe, ob der `aud`-Anspruch mit deinem registrierten API-Ressourcenindikator √ºbereinstimmt
- **Erforderliche Scopes**: Stelle sicher, dass das Token die notwendigen Berechtigungen im `scope`-Anspruch enth√§lt

</details>

<details>
<summary>

### Wie kann ich ohne vollst√§ndigen Client testen? \{#how-do-i-test-without-a-full-client}

</summary>

Nutze ein [pers√∂nliches Zugangstoken](/user-management/personal-access-token), um authentifizierte Aufrufe zu simulieren. So kannst du deine API-Endpunkte testen, ohne einen vollst√§ndigen OAuth-Flow in deiner Client-Anwendung zu implementieren.

</details>

<details>
<summary>

### Kann ich Scope-Pr√§fixe oder Kurzformen bei der Berechtigungsanfrage verwenden? \{#can-i-use-scope-prefixes-or-shortened-versions}

</summary>

Nein. Scope-Namen m√ºssen **exakt** mit den in deiner API-Ressource definierten Berechtigungsnamen √ºbereinstimmen. Pr√§fixe und Kurzformen funktionieren nicht als Platzhalter.

**Beispiel:**

Wenn deine API-Ressource definiert:

- `read:elections`
- `write:elections`

Musst du anfordern:

```swift
scopes: ["read:elections", "write:elections"]
```

Das funktioniert **NICHT**:

```swift
scopes: ["read", "write"]  // ‚ùå Stimmt nicht mit den Berechtigungsnamen √ºberein
```

</details>

## Weiterf√ºhrende Literatur \{#further-reading}

<Url href="/authorization/validate-access-tokens">Zugangstokens validieren</Url>
<Url href="/use-cases/authorization/rbac-in-practice">
  RBAC in der Praxis: Sichere Autorisierung f√ºr deine Anwendung implementieren
</Url>
<Url href="/developers/custom-token-claims">Token-Anspr√ºche anpassen</Url>
<Url href="https://www.rfc-editor.org/rfc/rfc8707.html">RFC 8707: Ressourcenindikatoren</Url>
