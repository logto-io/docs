import TabItem from '@theme/TabItem';
import Tabs from '@theme/Tabs';

프레임워크에 따라 서로 다른 JWT 라이브러리를 사용합니다. 필요한 의존성을 설치하세요:

<Tabs groupId="api-framework">
  <TabItem value="spring-boot" label="Spring Boot">

`pom.xml`에 추가하세요:

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.security</groupId>
    <artifactId>spring-security-oauth2-resource-server</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.security</groupId>
    <artifactId>spring-security-oauth2-jose</artifactId>
</dependency>
```

  </TabItem>
  <TabItem value="quarkus" label="Quarkus">

`pom.xml`에 추가하세요:

```xml
<dependency>
    <groupId>io.quarkus</groupId>
    <artifactId>quarkus-smallrye-jwt</artifactId>
</dependency>
<dependency>
    <groupId>io.quarkus</groupId>
    <artifactId>quarkus-resteasy-reactive</artifactId>
</dependency>
```

  </TabItem>
  <TabItem value="micronaut" label="Micronaut">

`pom.xml`에 추가하세요:

```xml
<dependency>
    <groupId>io.micronaut.security</groupId>
    <artifactId>micronaut-security-jwt</artifactId>
</dependency>
<dependency>
    <groupId>io.micronaut</groupId>
    <artifactId>micronaut-http-server-netty</artifactId>
</dependency>
```

  </TabItem>
  <TabItem value="vertx-web" label="Vert.x Web">

`pom.xml`에 추가하세요:

```xml
<dependency>
    <groupId>io.vertx</groupId>
    <artifactId>vertx-web</artifactId>
</dependency>
<dependency>
    <groupId>io.vertx</groupId>
    <artifactId>vertx-auth-jwt</artifactId>
</dependency>
<dependency>
    <groupId>io.vertx</groupId>
    <artifactId>vertx-web-client</artifactId>
</dependency>
```

  </TabItem>
</Tabs>

그런 다음, 액세스 토큰 (Access token)을 검증하는 미들웨어를 구현하세요:

<Tabs groupId="api-framework">
  <TabItem value="spring-boot" label="Spring Boot">

```java title="JwtSecurityConfig.java"
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.oauth2.jwt.JwtDecoder;
import org.springframework.security.oauth2.jwt.NimbusJwtDecoder;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
@EnableWebSecurity
public class JwtSecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(authz -> authz
                .requestMatchers("/api/protected/**").authenticated()
                .anyRequest().permitAll()
            )
            .oauth2ResourceServer(oauth2 -> oauth2
                .jwt(jwt -> jwt.decoder(jwtDecoder()))
            );
        return http.build();
    }

    @Bean
    public JwtDecoder jwtDecoder() {
        return NimbusJwtDecoder.withJwkSetUri(AuthConstants.JWKS_URI)
            .build();
    }
}
```

```java title="JwtValidator.java"
import org.springframework.security.oauth2.jwt.Jwt;
import org.springframework.stereotype.Component;
import java.util.Arrays;
import java.util.List;

@Component
public class JwtValidator {

    public void verifyPayload(Jwt jwt) {
        // 권한 모델에 따라 검증 로직을 구현하세요
        // 아래 권한 모델 섹션에서 자세히 설명합니다
    }
}
```

  </TabItem>
  <TabItem value="quarkus" label="Quarkus">

```java title="JwtVerificationFilter.java"
import org.eclipse.microprofile.jwt.JsonWebToken;
import jakarta.enterprise.context.ApplicationScoped;
import jakarta.inject.Inject;
import jakarta.ws.rs.container.ContainerRequestContext;
import jakarta.ws.rs.container.ContainerRequestFilter;
import jakarta.ws.rs.ext.Provider;

@Provider
@ApplicationScoped
public class JwtVerificationFilter implements ContainerRequestFilter {

    @Inject
    JsonWebToken jwt;

    @Override
    public void filter(ContainerRequestContext requestContext) {
        if (requestContext.getUriInfo().getPath().startsWith("/api/protected")) {
            try {
                verifyPayload(jwt);

                // 컨트롤러에서 접근할 수 있도록 JWT를 컨텍스트에 저장
                requestContext.setProperty("auth", jwt);

            } catch (AuthorizationException e) {
                requestContext.abortWith(
                    jakarta.ws.rs.core.Response.status(e.getStatusCode())
                        .entity("{\"error\": \"" + e.getMessage() + "\"}")
                        .build()
                );
            } catch (Exception e) {
                requestContext.abortWith(
                    jakarta.ws.rs.core.Response.status(401)
                        .entity("{\"error\": \"Invalid token\"}")
                        .build()
                );
            }
        }
    }

    private void verifyPayload(JsonWebToken jwt) {
        // 권한 모델에 따라 검증 로직을 구현하세요
        // 아래 권한 모델 섹션에서 자세히 설명합니다
    }
}
```

  </TabItem>
  <TabItem value="micronaut" label="Micronaut">

```java title="application.yml"
micronaut:
  security:
    authentication: bearer
    token:
      jwt:
        signatures:
          jwks:
            logto:
              url: ${JWKS_URI:https://your-tenant.logto.app/oidc/jwks}
```

```java title="JwtClaimsValidator.java"
import io.micronaut.security.token.Claims;
import io.micronaut.security.token.validator.TokenValidator;
import jakarta.inject.Singleton;
import org.reactivestreams.Publisher;
import reactor.core.publisher.Mono;

@Singleton
public class JwtClaimsValidator implements TokenValidator {

    @Override
    public Publisher<Boolean> validateToken(String token, Claims claims) {
        return Mono.fromCallable(() -> {
            try {
                verifyPayload(claims);
                return true;
            } catch (AuthorizationException e) {
                throw new RuntimeException(e.getMessage());
            }
        });
    }

    private void verifyPayload(Claims claims) {
        // 권한 모델에 따라 검증 로직을 구현하세요
        // 아래 권한 모델 섹션에서 자세히 설명합니다
    }
}
```

  </TabItem>
  <TabItem value="vertx-web" label="Vert.x Web">

```java title="JwtAuthHandler.java"
import io.vertx.core.Future;
import io.vertx.core.Handler;
import io.vertx.core.json.JsonObject;
import io.vertx.ext.auth.jwt.JWTAuth;
import io.vertx.ext.auth.jwt.JWTAuthOptions;
import io.vertx.ext.web.RoutingContext;
import io.vertx.ext.web.client.WebClient;

public class JwtAuthHandler implements Handler<RoutingContext> {

    private final JWTAuth jwtAuth;
    private final WebClient webClient;

    public JwtAuthHandler(io.vertx.core.Vertx vertx) {
        this.webClient = WebClient.create(vertx);
        this.jwtAuth = JWTAuth.create(vertx, new JWTAuthOptions());

        // JWKS를 가져와 JWT 인증 구성
        fetchJWKS().onSuccess(jwks -> {
            // JWKS 구성 (단순화됨 - 실제로는 적절한 JWKS 파서가 필요할 수 있음)
        });
    }

    @Override
    public void handle(RoutingContext context) {
        String authHeader = context.request().getHeader("Authorization");
        if (authHeader == null || !authHeader.startsWith("Bearer ")) {
            context.response()
                .setStatusCode(401)
                .putHeader("Content-Type", "application/json")
                .end("{\"error\": \"Authorization header missing or invalid\"}");
            return;
        }

        String token = authHeader.substring(7);
        jwtAuth.authenticate(new JsonObject().put("token", token))
            .onSuccess(user -> {
                try {
                    JsonObject principal = user.principal();
                    verifyPayload(principal);

                    // 핸들러에서 접근할 수 있도록 JWT principal을 컨텍스트에 저장
                    context.put("auth", principal);
                    context.next();

                } catch (AuthorizationException e) {
                    context.response()
                        .setStatusCode(e.getStatusCode())
                        .putHeader("Content-Type", "application/json")
                        .end("{\"error\": \"" + e.getMessage() + "\"}");
                } catch (Exception e) {
                    context.response()
                        .setStatusCode(401)
                        .putHeader("Content-Type", "application/json")
                        .end("{\"error\": \"Invalid token\"}");
                }
            })
            .onFailure(err -> {
                context.response()
                    .setStatusCode(401)
                    .putHeader("Content-Type", "application/json")
                    .end("{\"error\": \"Invalid token\"}");
            });
    }

    private Future<JsonObject> fetchJWKS() {
        return webClient.getAbs(AuthConstants.JWKS_URI)
            .send()
            .map(response -> response.bodyAsJsonObject());
    }

    private void verifyPayload(JsonObject principal) {
        // 권한 모델에 따라 검증 로직을 구현하세요
        // 아래 권한 모델 섹션에서 자세히 설명합니다
    }
}
```

  </TabItem>
</Tabs>

권한 모델에 따라 서로 다른 검증 로직을 적용해야 할 수 있습니다:

<Tabs groupId="permission-models">
<TabItem value="global-api-resources" label="글로벌 API 리소스">

<Tabs groupId="api-framework">
  <TabItem value="spring-boot" label="Spring Boot">

```java title="JwtValidator.java"
private void verifyPayload(Jwt jwt) {
    // audience 클레임이 API 리소스 지표와 일치하는지 확인
    List<String> audiences = jwt.getAudience();
    if (!audiences.contains("https://your-api-resource-indicator")) {
        throw new AuthorizationException("Invalid audience");
    }

    // 글로벌 API 리소스에 필요한 스코프 확인
    List<String> requiredScopes = Arrays.asList("api:read", "api:write"); // 실제 필요한 스코프로 교체
    String scopes = jwt.getClaimAsString("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient scope");
    }
}
```

  </TabItem>
  <TabItem value="quarkus" label="Quarkus">

```java title="JwtVerificationFilter.java"
private void verifyPayload(JsonWebToken jwt) {
    // audience 클레임이 API 리소스 지표와 일치하는지 확인
    if (!jwt.getAudience().contains("https://your-api-resource-indicator")) {
        throw new AuthorizationException("Invalid audience");
    }

    // 글로벌 API 리소스에 필요한 스코프 확인
    List<String> requiredScopes = Arrays.asList("api:read", "api:write"); // 실제 필요한 스코프로 교체
    String scopes = jwt.getClaim("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient scope");
    }
}
```

  </TabItem>
  <TabItem value="micronaut" label="Micronaut">

```java title="JwtClaimsValidator.java"
private void verifyPayload(Claims claims) {
    // audience 클레임이 API 리소스 지표와 일치하는지 확인
    List<String> audiences = (List<String>) claims.get("aud");
    if (audiences == null || !audiences.contains("https://your-api-resource-indicator")) {
        throw new AuthorizationException("Invalid audience");
    }

    // 글로벌 API 리소스에 필요한 스코프 확인
    List<String> requiredScopes = Arrays.asList("api:read", "api:write"); // 실제 필요한 스코프로 교체
    String scopes = (String) claims.get("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient scope");
    }
}
```

  </TabItem>
  <TabItem value="vertx-web" label="Vert.x Web">

```java title="JwtAuthHandler.java"
private void verifyPayload(JsonObject principal) {
    // audience 클레임이 API 리소스 지표와 일치하는지 확인
    JsonArray audiences = principal.getJsonArray("aud");
    if (audiences == null || !audiences.contains("https://your-api-resource-indicator")) {
        throw new AuthorizationException("Invalid audience");
    }

    // 글로벌 API 리소스에 필요한 스코프 확인
    List<String> requiredScopes = Arrays.asList("api:read", "api:write"); // 실제 필요한 스코프로 교체
    String scopes = principal.getString("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient scope");
    }
}
```

  </TabItem>
</Tabs>

</TabItem>
<TabItem value="organization-permissions" label="조직 (Organization) (비-API) 권한">

<Tabs groupId="api-framework">
  <TabItem value="spring-boot" label="Spring Boot">

```java title="JwtValidator.java"
private void verifyPayload(Jwt jwt) {
    // audience 클레임이 조직 포맷과 일치하는지 확인
    List<String> audiences = jwt.getAudience();
    boolean hasOrgAudience = audiences.stream()
        .anyMatch(aud -> aud.startsWith("urn:logto:organization:"));

    if (!hasOrgAudience) {
        throw new AuthorizationException("Invalid audience for organization permissions");
    }

    // 조직 ID가 컨텍스트와 일치하는지 확인 (요청 컨텍스트에서 추출 필요)
    String expectedOrgId = "your-organization-id"; // 요청 컨텍스트에서 추출
    String expectedAud = "urn:logto:organization:" + expectedOrgId;
    if (!audiences.contains(expectedAud)) {
        throw new AuthorizationException("Organization ID mismatch");
    }

    // 필요한 조직 스코프 확인
    List<String> requiredScopes = Arrays.asList("invite:users", "manage:settings"); // 실제 필요한 스코프로 교체
    String scopes = jwt.getClaimAsString("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient organization scope");
    }
}
```

  </TabItem>
  <TabItem value="quarkus" label="Quarkus">

```java title="JwtVerificationFilter.java"
private void verifyPayload(JsonWebToken jwt) {
    // audience 클레임이 조직 포맷과 일치하는지 확인
    boolean hasOrgAudience = jwt.getAudience().stream()
        .anyMatch(aud -> aud.startsWith("urn:logto:organization:"));

    if (!hasOrgAudience) {
        throw new AuthorizationException("Invalid audience for organization permissions");
    }

    // 조직 ID가 컨텍스트와 일치하는지 확인 (요청 컨텍스트에서 추출 필요)
    String expectedOrgId = "your-organization-id"; // 요청 컨텍스트에서 추출
    String expectedAud = "urn:logto:organization:" + expectedOrgId;
    if (!jwt.getAudience().contains(expectedAud)) {
        throw new AuthorizationException("Organization ID mismatch");
    }

    // 필요한 조직 스코프 확인
    List<String> requiredScopes = Arrays.asList("invite:users", "manage:settings"); // 실제 필요한 스코프로 교체
    String scopes = jwt.getClaim("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient organization scope");
    }
}
```

  </TabItem>
  <TabItem value="micronaut" label="Micronaut">

```java title="JwtClaimsValidator.java"
private void verifyPayload(Claims claims) {
    // audience 클레임이 조직 포맷과 일치하는지 확인
    List<String> audiences = (List<String>) claims.get("aud");
    boolean hasOrgAudience = audiences != null && audiences.stream()
        .anyMatch(aud -> aud.startsWith("urn:logto:organization:"));

    if (!hasOrgAudience) {
        throw new AuthorizationException("Invalid audience for organization permissions");
    }

    // 조직 ID가 컨텍스트와 일치하는지 확인 (요청 컨텍스트에서 추출 필요)
    String expectedOrgId = "your-organization-id"; // 요청 컨텍스트에서 추출
    String expectedAud = "urn:logto:organization:" + expectedOrgId;
    if (!audiences.contains(expectedAud)) {
        throw new AuthorizationException("Organization ID mismatch");
    }

    // 필요한 조직 스코프 확인
    List<String> requiredScopes = Arrays.asList("invite:users", "manage:settings"); // 실제 필요한 스코프로 교체
    String scopes = (String) claims.get("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient organization scope");
    }
}
```

  </TabItem>
  <TabItem value="vertx-web" label="Vert.x Web">

```java title="JwtAuthHandler.java"
private void verifyPayload(JsonObject principal) {
    // audience 클레임이 조직 포맷과 일치하는지 확인
    JsonArray audiences = principal.getJsonArray("aud");
    boolean hasOrgAudience = false;
    if (audiences != null) {
        for (Object aud : audiences) {
            if (aud.toString().startsWith("urn:logto:organization:")) {
                hasOrgAudience = true;
                break;
            }
        }
    }

    if (!hasOrgAudience) {
        throw new AuthorizationException("Invalid audience for organization permissions");
    }

    // 조직 ID가 컨텍스트와 일치하는지 확인 (요청 컨텍스트에서 추출 필요)
    String expectedOrgId = "your-organization-id"; // 요청 컨텍스트에서 추출
    String expectedAud = "urn:logto:organization:" + expectedOrgId;
    if (!audiences.contains(expectedAud)) {
        throw new AuthorizationException("Organization ID mismatch");
    }

    // 필요한 조직 스코프 확인
    List<String> requiredScopes = Arrays.asList("invite:users", "manage:settings"); // 실제 필요한 스코프로 교체
    String scopes = principal.getString("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient organization scope");
    }
}
```

  </TabItem>
</Tabs>

</TabItem>
<TabItem value="organization-level-api-resources" label="조직 수준 API 리소스">

<Tabs groupId="api-framework">
  <TabItem value="spring-boot" label="Spring Boot">

```java title="JwtValidator.java"
private void verifyPayload(Jwt jwt) {
    // audience 클레임이 API 리소스 지표와 일치하는지 확인
    List<String> audiences = jwt.getAudience();
    if (!audiences.contains("https://your-api-resource-indicator")) {
        throw new AuthorizationException("Invalid audience for organization-level API resources");
    }

    // 조직 ID가 컨텍스트와 일치하는지 확인 (요청 컨텍스트에서 추출 필요)
    String expectedOrgId = "your-organization-id"; // 요청 컨텍스트에서 추출
    String orgId = jwt.getClaimAsString("organization_id");
    if (!expectedOrgId.equals(orgId)) {
        throw new AuthorizationException("Organization ID mismatch");
    }

    // 조직 수준 API 리소스에 필요한 스코프 확인
    List<String> requiredScopes = Arrays.asList("api:read", "api:write"); // 실제 필요한 스코프로 교체
    String scopes = jwt.getClaimAsString("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient organization-level API scopes");
    }
}
```

  </TabItem>
  <TabItem value="quarkus" label="Quarkus">

```java title="JwtVerificationFilter.java"
private void verifyPayload(JsonWebToken jwt) {
    // audience 클레임이 API 리소스 지표와 일치하는지 확인
    if (!jwt.getAudience().contains("https://your-api-resource-indicator")) {
        throw new AuthorizationException("Invalid audience for organization-level API resources");
    }

    // 조직 ID가 컨텍스트와 일치하는지 확인 (요청 컨텍스트에서 추출 필요)
    String expectedOrgId = "your-organization-id"; // 요청 컨텍스트에서 추출
    String orgId = jwt.getClaim("organization_id");
    if (!expectedOrgId.equals(orgId)) {
        throw new AuthorizationException("Organization ID mismatch");
    }

    // 조직 수준 API 리소스에 필요한 스코프 확인
    List<String> requiredScopes = Arrays.asList("api:read", "api:write"); // 실제 필요한 스코프로 교체
    String scopes = jwt.getClaim("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient organization-level API scopes");
    }
}
```

  </TabItem>
  <TabItem value="micronaut" label="Micronaut">

```java title="JwtClaimsValidator.java"
private void verifyPayload(Claims claims) {
    // audience 클레임이 API 리소스 지표와 일치하는지 확인
    List<String> audiences = (List<String>) claims.get("aud");
    if (audiences == null || !audiences.contains("https://your-api-resource-indicator")) {
        throw new AuthorizationException("Invalid audience for organization-level API resources");
    }

    // 조직 ID가 컨텍스트와 일치하는지 확인 (요청 컨텍스트에서 추출 필요)
    String expectedOrgId = "your-organization-id"; // 요청 컨텍스트에서 추출
    String orgId = (String) claims.get("organization_id");
    if (!expectedOrgId.equals(orgId)) {
        throw new AuthorizationException("Organization ID mismatch");
    }

    // 조직 수준 API 리소스에 필요한 스코프 확인
    List<String> requiredScopes = Arrays.asList("api:read", "api:write"); // 실제 필요한 스코프로 교체
    String scopes = (String) claims.get("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient organization-level API scopes");
    }
}
```

  </TabItem>
  <TabItem value="vertx-web" label="Vert.x Web">

```java title="JwtAuthHandler.java"
private void verifyPayload(JsonObject principal) {
    // audience 클레임이 API 리소스 지표와 일치하는지 확인
    JsonArray audiences = principal.getJsonArray("aud");
    if (audiences == null || !audiences.contains("https://your-api-resource-indicator")) {
        throw new AuthorizationException("Invalid audience for organization-level API resources");
    }

    // 조직 ID가 컨텍스트와 일치하는지 확인 (요청 컨텍스트에서 추출 필요)
    String expectedOrgId = "your-organization-id"; // 요청 컨텍스트에서 추출
    String orgId = principal.getString("organization_id");
    if (!expectedOrgId.equals(orgId)) {
        throw new AuthorizationException("Organization ID mismatch");
    }

    // 조직 수준 API 리소스에 필요한 스코프 확인
    List<String> requiredScopes = Arrays.asList("api:read", "api:write"); // 실제 필요한 스코프로 교체
    String scopes = principal.getString("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient organization-level API scopes");
    }
}
```

  </TabItem>
</Tabs>

</TabItem>
</Tabs>
