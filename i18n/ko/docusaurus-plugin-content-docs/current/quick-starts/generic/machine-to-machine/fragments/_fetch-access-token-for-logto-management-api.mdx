import TabItem from '@theme/TabItem';
import Tabs from '@theme/Tabs';

import AccessTokenResponse from './_access-token-response.mdx';
import M2mAccessTokenNote from './_m2m-access-token-sub-note.mdx';

Logto는 내장된 “Logto Management API” 리소스를 제공합니다. 이 리소스는 Logto Management API에 접근할 수 있는 `all` 권한 (Permission)이 부여된 읽기 전용 리소스입니다. API 리소스 목록에서 확인할 수 있습니다.  
리소스 API 지표는 `https://{your-tenant-id}.logto.app/api` 형식이며, 이는 액세스 토큰 (Access token) 요청 본문에서 사용할 리소스 값입니다.

<img alt="Logto Management API details" src="/img/assets/logto-management-api.png" width="600px" />

Logto Management API에 접근하기 전에, 반드시 M2M 앱에 이 내장 “Logto Management API” 리소스의 `all` 권한 (Permission)이 포함된 M2M 역할 (Role)이 할당되어 있어야 합니다.

:::info
Logto는 새로 생성된 테넌트에 대해 미리 구성된 “Logto Management API access” M2M 역할 (Role)을 제공합니다. 이 역할에는 이미 Logto Management API 리소스의 all 권한 (Permission)이 할당되어 있습니다. 별도의 권한 설정 없이 바로 사용할 수 있습니다. 이 미리 구성된 역할은 필요에 따라 수정 및 삭제할 수 있습니다.
:::

이제 모든 준비가 끝났으니, 요청을 전송해봅시다:

:::info
v1.30.1 버전부터 Logto는 Logto Management API와 쉽게 상호작용할 수 있도록 공식 `@logto/api` Node.js SDK를 제공합니다.
:::

<Tabs groupId="interact-with-m-api">

<TabItem value="with-@logto-api-sdk" label="Node.js with `@logto/api` SDK">

#### Logto Cloud \{#logto-cloud}

```js
import { createManagementApi } from '@logto/api/management';

const { apiClient, clientCredentials } = createManagementApi('your-tenant-id', {
  clientId: 'your-client-id',
  clientSecret: 'your-client-secret',
});

const { value } = await clientCredentials.getAccessToken();
console.log('Access token:', value);

// 또는 액세스 토큰 (Access token) 획득을 생략하고 바로 API 호출도 가능합니다
const response = await apiClient.GET('/api/users');
console.log(response.data);
```

#### 셀프 호스팅 / OSS \{#self-hosted-oss}

OSS 사용자는 테넌트 ID로 `default`를 사용해야 하며, `baseUrl`과 `apiIndicator` 설정도 제공해야 합니다.

```js
const { apiClient, clientCredentials } = createManagementApi('default', {
  clientId: 'your-client-id',
  clientSecret: 'your-client-secret',
  // highlight-start
  baseUrl: 'https://your.logto.endpoint',
  apiIndicator: 'https://default.logto.app/api',
  // highlight-end
});
```

</TabItem>

<TabItem value="nodejs" label="Node.js">

```js
const logtoEndpoint = 'https://your.logto.endpoint'; // Logto 엔드포인트로 교체하세요
const tokenEndpoint = `${logtoEndpoint}/oidc/token`;
const applicationId = 'your-application-id';
const applicationSecret = 'your-application-secret';
const tenantId = 'your-tenant-id';

const fetchAccessToken = async () => {
  return await fetch(tokenEndpoint, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      Authorization: `Basic ${Buffer.from(`${applicationId}:${applicationSecret}`).toString(
        'base64'
      )}`,
    },
    body: new URLSearchParams({
      grant_type: 'client_credentials',
      resource: `https://${tenantId}.logto.app/api`,
      scope: 'all',
    }).toString(),
  });
};
```

:::caution
Logto Cloud 사용자: Logto Management API와 상호작용할 때는 커스텀 도메인을 사용할 수 없습니다. 액세스 토큰 (Access token) 발급을 위해 기본 Logto 엔드포인트 `https://{your_tenant_id}.logto.app/oidc/token`을 사용하세요.
:::

<AccessTokenResponse />
<M2mAccessTokenNote />

</TabItem>

<TabItem value="curl" label="cURL">

```bash
curl --location \
  --request POST 'https://your.logto.endpoint' \
  --header 'Authorization: Basic ${your_auth_string}' \
  --header 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode 'grant_type=client_credentials' \
  --data-urlencode 'resource=https://${tenantId}.logto.app/api' \
  --data-urlencode 'scope=all'
```

실제 값은 본인 환경에 맞게 교체해야 합니다.

:::caution
Logto Cloud 사용자: Logto Management API와 상호작용할 때는 커스텀 도메인을 사용할 수 없습니다. 액세스 토큰 (Access token) 발급을 위해 기본 Logto 엔드포인트 `https://{your_tenant_id}.logto.app/oidc/token`을 사용하세요.
:::

<AccessTokenResponse />
<M2mAccessTokenNote />

</TabItem>

</Tabs>
