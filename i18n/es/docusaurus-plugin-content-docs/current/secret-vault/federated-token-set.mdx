---
id: federated-token-set
title: Almacenamiento de tokens de terceros y acceso a API
sidebar_label: Almacenamiento de tokens de terceros
---

import Availability from '@components/Availability';

<Availability cloud oss={{ major: 1, minor: 31 }} />

El conjunto de tokens de terceros (tambi茅n conocido como conjunto de tokens federados) es un tipo de secreto almacenado en el [b贸veda de secretos](/secret-vault) de Logto, utilizado para gestionar de forma segura los tokens de acceso y actualizaci贸n emitidos por proveedores de identidad de terceros. Cuando un usuario se autentica a trav茅s de un conector social o de SSO empresarial, Logto almacena los tokens emitidos en la b贸veda. Estos tokens pueden recuperarse posteriormente para acceder a APIs de terceros en nombre del usuario, sin requerir una nueva autenticaci贸n.

## Casos de uso comunes \{#common-use-cases}

Esta capacidad es esencial para aplicaciones modernas como agentes de IA, plataformas SaaS, herramientas de productividad y aplicaciones para clientes que necesitan interactuar con servicios de terceros en nombre de los usuarios. Aqu铆 tienes algunos ejemplos pr谩cticos:

** Aplicaciones de gesti贸n de calendarios**: Despu茅s de que un usuario inicie sesi贸n con Google, tu aplicaci贸n de productividad puede sincronizar autom谩ticamente sus eventos de calendario, crear nuevas reuniones y enviar invitaciones sin pedirle que se autentique de nuevo.

** Asistentes de IA**: Un agente de IA puede acceder a los repositorios de GitHub de un usuario para analizar c贸digo, crear pull requests o gestionar incidencias. Todo con el consentimiento 煤nico del usuario durante el inicio de sesi贸n o la vinculaci贸n de cuentas.

** Paneles de an谩lisis**: Las plataformas SaaS pueden extraer datos de las cuentas de redes sociales conectadas de los usuarios (Facebook, LinkedIn) para generar informes y an谩lisis sin interrumpir su flujo de trabajo con solicitudes de inicio de sesi贸n repetidas.

## Habilitar el almacenamiento de tokens de terceros \{#enable-third-party-token-storage}

### Conectores sociales \{#social-connectors}

Esta funci贸n est谩 disponible para [conectores sociales](/connectors/social-connectors) que admiten almacenamiento de tokens. Los tokens de terceros pueden almacenarse durante el [inicio de sesi贸n social](/end-user-flows/sign-up-and-sign-in/social-sign-in), [vinculaci贸n de cuentas sociales](/end-user-flows/account-settings/by-account-api#link-a-new-social-connection) y [al renovar tokens para acceso a API de terceros](/secret-vault/federated-token-set#reauthentication-and-token-renewal). Los conectores actualmente soportados incluyen: [GitHub](/integrations/github), [Google](/integrations/google), [Facebook](/integrations/facebook), [OAuth 2.0 est谩ndar](/integrations/oauth2) y [OIDC est谩ndar](/integrations/oidc). El soporte para conectores adicionales se implementar谩 gradualmente.

1. Navega a <CloudLink to="/connectors/social">Consola > Conectores > Conectores sociales</CloudLink>.
2. Selecciona el conector social para el que deseas habilitar el almacenamiento de tokens de terceros.
3. Sigue los tutoriales de configuraci贸n para configurar el conector, incluyendo la adici贸n de los alcances necesarios para acceder a APIs de terceros espec铆ficas.
4. En la p谩gina "Configuraci贸n", habilita la opci贸n **Almacenar tokens para acceso persistente a API**.

### Conectores de SSO empresarial \{#enterprise-sso-connectors}

El almacenamiento de tokens est谩 disponible para todos los [conectores empresariales OIDC](/connectors/enterprise-connectors). Los tokens de acceso y actualizaci贸n pueden almacenarse durante el [inicio de sesi贸n 煤nico empresarial](/end-user-flows/enterprise-sso). Los conectores actualmente soportados incluyen: [Google Workspace](/integrations/google-workspace), [Microsoft Entra ID (OIDC)](/integrations/entra-id-oidc), [Okta](/integrations/okta) y [OIDC (Enterprise)](/integrations/oidc-sso).

1. Navega a <CloudLink to="/enterprise-sso">Consola > SSO empresarial</CloudLink>.
2. Selecciona el conector de SSO empresarial para el que deseas habilitar el almacenamiento de tokens de terceros.
3. Sigue los tutoriales de configuraci贸n para configurar el conector, incluyendo la adici贸n de los alcances necesarios para acceder a APIs de terceros espec铆ficas.
4. En la pesta帽a "Experiencia SSO", habilita la opci贸n **Almacenar tokens para acceso persistente a API**.

Aseg煤rate de guardar los cambios.

## Almacenamiento de tokens \{#token-storage}

Una vez habilitado el almacenamiento de tokens de terceros, Logto almacena autom谩ticamente los tokens de acceso y actualizaci贸n emitidos por el proveedor de identidad federado cada vez que un usuario se autentica a trav茅s de un conector social o de SSO empresarial. Esto incluye:

- [Inicio de sesi贸n y registro social](/end-user-flows/sign-up-and-sign-in/social-sign-in)
- [Inicio de sesi贸n y registro SSO empresarial](/end-user-flows/enterprise-sso)
- [Vinculaci贸n de cuentas sociales a trav茅s de Account API](/end-user-flows/account-settings/by-account-api#link-a-new-social-connection)

Los tokens almacenados se adjuntan a la identidad social o de SSO empresarial del usuario, permiti茅ndole recuperarlos posteriormente para acceder a APIs sin requerir una nueva autenticaci贸n.

### Comprobaci贸n del estado de almacenamiento de tokens \{#checking-token-storage-status}

Puedes comprobar el estado de almacenamiento de tokens de terceros de un usuario en la Consola de Logto:

1. Navega a <CloudLink to="/users">Consola > Usuarios</CloudLink>.
2. Haz clic en el usuario que deseas inspeccionar. Esto te llevar谩 a la p谩gina de detalles del usuario.
3. Despl谩zate hasta la secci贸n **Conexiones**. Esta 谩rea muestra todas las conexiones sociales y de SSO empresarial asociadas al usuario.
4. Cada entrada de conexi贸n muestra una etiqueta de estado de token que indica si los tokens est谩n almacenados para esa conexi贸n.
5. Haz clic en la entrada de la conexi贸n para ver m谩s detalles, incluyendo los metadatos del token de acceso almacenado y la disponibilidad del token de actualizaci贸n (si est谩 disponible).

Tambi茅n puedes comprobar las identidades de terceros del usuario y el estado de almacenamiento de tokens a trav茅s de la Management API:

- `GET /api/users/{userId}/identities/{target}?includeTokenSecret=true`: Recupera la identidad social de un usuario y el estado de almacenamiento de tokens asociado a la identidad por un conector espec铆fico (por ejemplo, `github`, `google`, etc.).
- `GET /api/users/{userId}/sso-identities/{ssoConnectorId}?includeTokenSecret=true`: Recupera la identidad SSO empresarial de un usuario y el estado de almacenamiento de tokens asociado a la identidad por un ID de conector SSO dado.

### Estado de almacenamiento de tokens \{#token-storage-status}

- **Activo**: El token de acceso est谩 almacenado y activo.
- **Expirado**: El token de acceso est谩 almacenado pero ha expirado. Si hay un token de actualizaci贸n disponible, puede usarse para obtener un nuevo token de acceso.
- **Inactivo**: No hay token de acceso almacenado para esta conexi贸n. Esto puede ocurrir si el usuario no se ha autenticado a trav茅s de esta conexi贸n o si el almacenamiento de tokens ha sido eliminado.
- **No aplicable**: El conector no admite almacenamiento de tokens.

### Metadatos del token \{#token-metadata}

Para la integridad y seguridad de los datos, todos los tokens se cifran antes de almacenarse en la b贸veda de secretos. Los valores reales de los tokens solo son accesibles para el usuario final con la autorizaci贸n adecuada. Los desarrolladores, por otro lado, solo pueden recuperar los metadatos del conjunto de tokens para comprender el estado de los tokens almacenados sin exponer contenido sensible.

- `createdAt`: La marca de tiempo cuando se estableci贸 la conexi贸n por primera vez y el conjunto de tokens se almacen贸 inicialmente en la b贸veda de secretos.
- `updatedAt`: La 煤ltima vez que se actualiz贸 el conjunto de tokens.
  - Si no hay token de actualizaci贸n disponible, este valor ser谩 igual a **createdAt**.
  - Si hay un token de actualizaci贸n presente, este valor refleja la 煤ltima vez que se actualiz贸 el token de acceso.
- `hasRefreshToken`: Indica si hay un token de actualizaci贸n disponible.
  Si el conector admite acceso offline y la solicitud de autorizaci贸n est谩 correctamente configurada, Logto almacena el token de actualizaci贸n cuando es emitido por el proveedor de identidad junto con el token de acceso.
  Cuando el token de acceso expira y existe un token de actualizaci贸n v谩lido, Logto intenta autom谩ticamente obtener un nuevo token de acceso usando el token de actualizaci贸n almacenado cada vez que el usuario solicita acceso al proveedor conectado.
- `expiresAt`: El tiempo estimado de expiraci贸n del token de acceso en **segundos**.
  Esto se calcula en base al valor `expires_in` devuelto por el endpoint de tokens del proveedor de identidad. (Este campo solo est谩 disponible si el proveedor incluye `expires_in` en la respuesta del token.)
- `scope`: El alcance del token de acceso, indicando los permisos concedidos por el proveedor de identidad.
  Esto es 煤til para entender qu茅 acciones pueden realizarse con el token de acceso almacenado. (Este campo solo est谩 disponible si el proveedor incluye `scope` en la respuesta del token.)
- `tokenType`: El tipo de token de acceso, normalmente "Bearer".
  (Este campo solo est谩 disponible si el proveedor incluye `token_type` en la respuesta del token.)

## Recuperaci贸n de tokens \{#token-retrieval}

Una vez habilitado el almacenamiento de tokens y los tokens est茅n almacenados de forma segura en la b贸veda de secretos de Logto, los usuarios finales pueden recuperar sus tokens de acceso de terceros desde tu aplicaci贸n cliente integr谩ndose con la [Account API](/end-user-flows/account-settings/by-account-api) de Logto.

- `GET /my-account/identities/:target/access-token`: Recupera el token de acceso para una identidad social especificando el conector (por ejemplo, github, google).

- `GET /my-account/sso-identities/:connectorId/access-token`: Recupera el token de acceso para una identidad SSO empresarial especificando el ID del conector.

:::info
Para recuperar tokens de acceso de terceros, primero debes habilitar la Account API para usuarios finales en <CloudLink to="/sign-in-experience/account-center">Consola > Inicio de sesi贸n y cuenta > Centro de cuentas</CloudLink>. Aprende c贸mo [habilitar la Account API](/end-user-flows/account-settings/by-account-api#how-to-enable-account-api) y [acceder a ella usando un token de acceso emitido por Logto](/end-user-flows/account-settings/by-account-api#access-account-api-using-access-token).
:::

### Rotaci贸n de tokens \{#token-rotation}

Los endpoints de recuperaci贸n de tokens devuelven:

- `200` OK: Si el token de acceso se recupera correctamente y sigue siendo v谩lido.
- `404` No encontrado: Si el usuario no tiene una identidad social o SSO empresarial asociada con el conector o ID especificado, o si el token de acceso no est谩 almacenado.
- `401` No autorizado: Si el token de acceso ha expirado.

Si el token de acceso ha expirado y hay un token de actualizaci贸n disponible, Logto intenta autom谩ticamente renovar el token de acceso y devuelve el nuevo token de acceso en la respuesta. El almacenamiento de tokens en la b贸veda de secretos tambi茅n se actualiza con el nuevo token de acceso y sus metadatos.

## Eliminaci贸n del almacenamiento de tokens \{#token-storage-deletion}

El almacenamiento de tokens de terceros est谩 directamente vinculado a cada conexi贸n social o de SSO empresarial del usuario. Esto significa que el conjunto de tokens almacenado se eliminar谩 autom谩ticamente en los siguientes casos:

- Se elimina la identidad social o de SSO empresarial asociada de la cuenta del usuario.
- Se elimina la cuenta de usuario de tu tenant.
- Se elimina el conector social o de SSO empresarial de tu tenant.

### Revocaci贸n de tokens \{#revoking-tokens}

Tambi茅n puedes eliminar manualmente el conjunto de tokens de terceros de un usuario para revocar el acceso:

- Desde la Consola:
  Navega a la p谩gina de detalles de la identidad del usuario. Despl谩zate hasta la secci贸n **Token de acceso** (si el almacenamiento de tokens est谩 disponible) y haz clic en el bot贸n **Eliminar tokens** al final de la secci贸n.
- V铆a Management API:
  - `DELETE /api/secret/:id`: Elimina un secreto espec铆fico por su ID, que puede obtenerse desde los detalles de la identidad del usuario.

Revocar el conjunto de tokens obligar谩 al usuario a autenticarse de nuevo con el proveedor de terceros para obtener un nuevo token de acceso antes de poder acceder nuevamente a las APIs de terceros.

## Reautenticaci贸n y renovaci贸n de tokens \{#reauthentication-and-token-renewal}

En escenarios donde un token de acceso almacenado ha expirado o cuando una aplicaci贸n necesita solicitar alcances adicionales de API, los usuarios finales pueden reautenticarse con el proveedor de terceros para obtener un nuevo token de acceso, sin necesidad de iniciar sesi贸n en Logto nuevamente.
Esto puede lograrse a trav茅s de la [API de verificaci贸n social](https://openapi.logto.io/operation/operation-createverificationbysocial) de Logto, que permite a los usuarios reiniciar un flujo de autorizaci贸n social federada y actualizar su conjunto de tokens almacenado.

:::note
La reiniciaci贸n de la autorizaci贸n federada est谩 actualmente limitada a conectores sociales.
Para conectores de SSO empresarial, la reautenticaci贸n y renovaci贸n de tokens requieren que el usuario inicie un flujo completo de autenticaci贸n de Logto nuevamente, ya que la reautorizaci贸n directa con el proveedor de SSO empresarial no est谩 soportada tras el inicio de sesi贸n.
:::

```mermaid
sequenceDiagram
    autonumber

    participant User as Usuario
    participant Logto as Logto
    participant Provider as Proveedor de terceros

    User->>Logto: post /api/verification/social
    Logto->>User: Redirigir a proveedor de terceros
    User->>Provider: Autenticar y autorizar
    Provider->>User: Redirigir de vuelta con c贸digo de autorizaci贸n
    User->>Logto: post /api/verification/social/verify con c贸digo de autorizaci贸n
    Logto->>User: Devolver el ID de verificaci贸n social
    User->>Logto: patch /my-account/identities/:target/access-token
```

1. El usuario inicia una solicitud de verificaci贸n social llamando al endpoint `POST /api/verification/social`. El usuario puede especificar alcances personalizados para solicitar permisos adicionales al proveedor de terceros.

   ```sh
   curl -X POST https://<your-logto-domain>/api/verification/social \
     -H "Authorization: Bearer <access_token>" \
     -H "Content-Type: application/json" \
     -d '{
       "state": "<state>",
       "connectorId": "<logto_connectorId>",
       "redirectUri": "<redirect_uri>",
       "scope": "<custom_scope>"
     }'
   ```

   - **authorization header**: El token de acceso del usuario emitido por Logto.
   - **connectorId**: El ID del conector social en Logto.
   - **redirectUri**: El URI al que redirigir al usuario de vuelta a tu aplicaci贸n despu茅s de la autenticaci贸n. Deber谩s registrar este URI en la configuraci贸n de la aplicaci贸n del proveedor.
   - **scope**: (Opcional) Alcances personalizados para solicitar permisos adicionales al proveedor de terceros. Si no se especifica, se usar谩n los alcances predeterminados configurados en el conector.

2. Logto crea un nuevo registro de verificaci贸n social y devuelve el ID de verificaci贸n social junto con la URL de autorizaci贸n para redirigir al usuario al proveedor de terceros para autenticaci贸n.

   La respuesta tendr谩 el siguiente aspecto:

   ```json
   {
     "verificationRecordId": "<social_verification_id>",
     "authorizationUri": "<authorization_url>",
     "expiresAt": "<expiration_time>"
   }
   ```

3. Redirige al usuario a la URL de autorizaci贸n. El usuario se autentica con el proveedor de terceros y concede permisos.

4. El proveedor de terceros redirige al usuario de vuelta a tu aplicaci贸n cliente con un c贸digo de autorizaci贸n.

5. Maneja el callback de autorizaci贸n reenviando el c贸digo de autorizaci贸n al endpoint de verificaci贸n de Logto:

   ```sh
   curl -X POST https://<your-logto-domain>/api/verification/social/verify \
     -H "Authorization: Bearer <access_token>" \
     -d '{
       "verificationRecordId": "<social_verification_id>",
       "connectorData": {
         "code": "<authorization_code>",
         "state": "<state>",
         "redirectUri": "<redirect_uri>"
       }
     }'
   ```

   - **authorization header**: El token de acceso del usuario emitido por Logto.
   - **verificationRecordId**: El ID de verificaci贸n social devuelto en el paso anterior.
   - **connectorData**: El c贸digo de autorizaci贸n y cualquier otro dato devuelto por el proveedor de terceros durante el callback.

   :::note
   No olvides validar el par谩metro `state` para prevenir ataques CSRF.
   :::

6. Logto verifica el c贸digo de autorizaci贸n y lo intercambia por un nuevo token de acceso y token de actualizaci贸n del proveedor de terceros, luego devuelve el ID de verificaci贸n social en la respuesta.

7. Finalmente, actualiza el almacenamiento de tokens del usuario llamando al endpoint `PATCH /my-account/identities/:target/access-token` con el ID de verificaci贸n social:

   ```sh
   curl -X PATCH https://<your-logto-domain>/my-account/identities/<target>/access-token \
     -H "Authorization: Bearer <access_token>" \
     -H "Content-Type: application/json" \
     -d '{
       "socialVerificationId": "<social_verification_id>"
     }'
   ```

   - **authorization header**: El token de acceso del usuario emitido por Logto.
   - **socialVerificationId**: El ID de registro de verificaci贸n social verificado devuelto en el paso anterior.

   Esto actualizar谩 el almacenamiento del conjunto de tokens del usuario en la b贸veda de secretos de Logto con el nuevo token de acceso y token de actualizaci贸n, permitiendo al usuario acceder a APIs de terceros sin necesidad de iniciar sesi贸n en Logto nuevamente.

   El token de acceso actualizado ser谩 devuelto.
