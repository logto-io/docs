---
description: Aprende cómo usar la Account API para gestionar usuarios
sidebar_position: 1
---

# Configuración de cuenta mediante Account API

## ¿Qué es la Account API de Logto? \{#what-is-logto-account-api}

La Account API de Logto es un conjunto completo de APIs que otorga a los usuarios finales acceso directo a la API sin necesidad de pasar por la Management API. Aquí tienes los aspectos destacados:

- Acceso directo: La Account API permite a los usuarios finales acceder y gestionar directamente sus propios perfiles de cuenta sin requerir el uso intermedio de la Management API.
- Gestión de perfil de usuario e identidades: Los usuarios pueden gestionar completamente sus perfiles y configuraciones de seguridad, incluyendo la capacidad de actualizar información de identidad como correo electrónico, teléfono y contraseña, así como gestionar conexiones sociales. El soporte para MFA y SSO estará disponible próximamente.
- Control de acceso global: Los administradores tienen control total y global sobre la configuración de acceso y pueden personalizar cada campo.
- Autorización sin fricciones: ¡La autorización es más fácil que nunca! Simplemente usa `client.getAccessToken()` para obtener un token de acceso opaco para OP (Logto), y adjúntalo al encabezado Authorization como `Bearer <access_token>`.

Con la Account API de Logto, puedes construir un sistema personalizado de gestión de cuentas como una página de perfil totalmente integrada con Logto.

Algunos casos de uso frecuentes se listan a continuación:

- Recuperar el perfil de usuario
- Actualizar el perfil de usuario
- Actualizar la contraseña del usuario
- Actualizar las identidades del usuario, incluyendo correo electrónico, teléfono y conexiones sociales
- Gestionar factores de MFA (verificaciones)

Para obtener más información sobre las APIs disponibles, visita [Referencia de Logto Account API](https://openapi.logto.io/group/endpoint-my-account) y [Referencia de Logto Verification API](https://openapi.logto.io/group/endpoint-verifications).

:::note

Las funciones de visualización de cuentas SSO y eliminación de cuentas están actualmente disponibles a través de las Management APIs de Logto. Consulta [Configuración de cuenta mediante Management API](/end-user-flows/account-settings/by-management-api) para detalles de implementación.

:::

## Cómo habilitar la Account API \{#how-to-enable-account-api}

Navega a <CloudLink to="/sign-in-experience/account-center">Consola > Inicio de sesión y cuenta > Centro de cuentas</CloudLink>.

La Account API está desactivada por defecto, por lo que sus controles de acceso están bloqueados. Activa **Habilitar Account API** para encenderla.

Una vez habilitada, configura los permisos por campo para identificadores, datos de perfil y acceso a tokens de terceros. Cada campo admite `Off`, `ReadOnly` o `Edit`; el valor predeterminado es `Off`.

1. **Campos de seguridad**:
   - Los campos incluyen: correo electrónico principal, teléfono principal, identidades sociales, contraseña y MFA.
   - Antes de que los usuarios finales editen estos campos, deben verificar su identidad mediante contraseña, correo electrónico o SMS para obtener un ID de registro de verificación válido por 10 minutos. Consulta [Obtener un ID de registro de verificación](#get-a-verification-record-id).
   - Para usar claves de acceso WebAuthn para MFA, añade los dominios de tu aplicación front-end a **WebAuthn Related Origins** para que el centro de cuentas y la experiencia de inicio de sesión puedan compartir claves de acceso. Consulta [Vincular una nueva clave de acceso WebAuthn](#link-a-new-webauthn-passkey).
2. **Campos de perfil**:
   - Los campos incluyen: nombre de usuario, nombre, avatar, [perfil](/user-management/user-data#profile) (otros atributos estándar de perfil) y [datos personalizados](/user-management/user-data#custom-data).
   - Los usuarios finales pueden editar estos campos sin verificación adicional.
3. **Secret vault**: Para conectores sociales y empresariales OIDC u OAuth, el [secret vault](/secret-vault/federated-token-set) de Logto almacena de forma segura los tokens de acceso y actualización de terceros después de la autenticación. Las aplicaciones pueden entonces llamar a APIs externas, como sincronizar eventos de Google Calendar, sin pedir a los usuarios que inicien sesión de nuevo. La recuperación de tokens estará disponible automáticamente una vez que la Account API esté habilitada.

## Cómo acceder a la Account API \{#how-to-access-account-api}

:::note
Para asegurar que el token de acceso tenga los permisos apropiados, asegúrate de haber configurado correctamente los alcances correspondientes en tu configuración de Logto.

Por ejemplo, para la API `POST /api/my-account/primary-email`, necesitas configurar el alcance `email`; para la API `POST /api/my-account/primary-phone`, necesitas configurar el alcance `phone`.

```ts
import { type LogtoConfig, UserScope } from '@logto/js';

const config: LogtoConfig = {
  // ...otras opciones
  // Añade los alcances apropiados que se ajusten a tus casos de uso.
  scopes: [
    UserScope.Email, // Para las APIs `{POST,DELETE} /api/my-account/primary-email`
    UserScope.Phone, // Para las APIs `{POST,DELETE} /api/my-account/primary-phone`
    UserScope.CustomData, // Para gestionar datos personalizados
    UserScope.Address, // Para gestionar dirección
    UserScope.Identities, // Para APIs relacionadas con identidad y MFA
    UserScope.Profile, // Para gestionar el perfil de usuario
  ],
};
```

:::

### Obtener un token de acceso \{#fetch-an-access-token}

Después de configurar el SDK en tu aplicación, puedes usar el método `client.getAccessToken()` para obtener un token de acceso. Este token es un token opaco (token opaco) que puede usarse para acceder a la Account API.

Si no estás usando el SDK oficial, debes establecer el `resource` como vacío para la solicitud de concesión de token de acceso a `/oidc/token`.

### Acceder a la Account API usando el token de acceso \{#access-account-api-using-access-token}

Debes incluir el token de acceso en el campo `Authorization` de los encabezados HTTP con el formato Bearer (`Bearer YOUR_TOKEN`) al interactuar con la Account API.

Aquí tienes un ejemplo para obtener la información de la cuenta de usuario:

```bash
curl https://[tenant-id].logto.app/api/my-account \
  -H 'authorization: Bearer <access_token>'
```

## Gestionar información básica de la cuenta \{#manage-basic-account-information}

### Recuperar información de la cuenta de usuario \{#retrieve-user-account-information}

Para obtener los datos del usuario, puedes usar el endpoint [`GET /api/my-account`](https://openapi.logto.io/operation/operation-getprofile).

```bash
curl https://[tenant-id].logto.app/api/my-account \
  -H 'authorization: Bearer <access_token>'
```

El cuerpo de la respuesta sería así:

```json
{
  "id": "...",
  "username": "...",
  "name": "...",
  "avatar": "..."
}
```

Los campos de la respuesta pueden variar dependiendo de la configuración del centro de cuentas.

### Actualizar información básica de la cuenta \{#update-basic-account-information}

La información básica de la cuenta incluye el nombre de usuario, nombre, avatar, datos personalizados y otra información de perfil.

Para actualizar **username, name, avatar y customData** puedes usar el endpoint [`PATCH /api/my-account`](https://openapi.logto.io/operation/operation-updateprofile).

```bash
curl -X PATCH https://[tenant-id].logto.app/api/my-account \
  -H 'authorization: Bearer <access_token>' \
  -H 'content-type: application/json' \
  --data-raw '{"username":"...","name":"...","avatar":"..."}'
```

Para actualizar otra información de perfil, incluyendo **familyName, givenName, middleName, nickname, profile (URL de la página de perfil), website, gender, birthdate, zoneinfo, locale y address**, puedes usar el endpoint [`PATCH /api/my-account/profile`](https://openapi.logto.io/operation/operation-updateotherprofile).

```bash
curl -X PATCH https://[tenant-id].logto.app/api/my-account/profile \
  -H 'authorization: Bearer <access_token>' \
  -H 'content-type: application/json' \
  --data-raw '{"familyName":"...","givenName":"..."}'
```

## Gestionar identificadores y otra información sensible \{#manage-identifiers-and-other-sensitive-information}

Por razones de seguridad, la Account API requiere una capa adicional de autorización para operaciones que involucren identificadores y otra información sensible.

### Obtener un ID de registro de verificación \{#get-a-verification-record-id}

Primero, necesitas obtener un **ID de registro de verificación** con una expiración de 10 minutos (TTL). Esto puede usarse para verificar la identidad del usuario antes de actualizar información sensible. Esto significa que una vez que un usuario verifica exitosamente su identidad mediante contraseña, código de verificación por correo electrónico o código de verificación por SMS, tiene 10 minutos para actualizar sus datos relacionados con autenticación, incluyendo identificadores, credenciales, vinculación de cuentas sociales y MFA.

Para obtener un ID de registro de verificación, puedes [verificar la contraseña del usuario](#verify-the-users-password) o [enviar un código de verificación al correo electrónico o teléfono del usuario](#verify-by-sending-a-verification-code-to-the-users-email-or-phone).

#### Verificar la contraseña del usuario \{#verify-the-users-password}

```bash
curl -X POST https://[tenant-id].logto.app/api/verifications/password \
  -H 'authorization: Bearer <access_token>' \
  -H 'content-type: application/json' \
  --data-raw '{"password":"..."}'
```

El cuerpo de la respuesta sería así:

```json
{
  "verificationRecordId": "...",
  "expiresAt": "..."
}
```

#### Verificar enviando un código de verificación al correo electrónico o teléfono del usuario \{#verify-by-sending-a-verification-code-to-the-users-email-or-phone}

:::note
Para usar este método, necesitas [configurar el conector de correo electrónico](/connectors/email-connectors/) o [conector de SMS](/connectors/sms-connectors/), y asegurarte de que la plantilla `UserPermissionValidation` esté configurada.
:::

Tomando el correo electrónico como ejemplo, solicita un nuevo código de verificación y obtén el ID de registro de verificación:

```bash
curl -X POST https://[tenant-id].logto.app/api/verifications/verification-code \
  -H 'authorization: Bearer <access_token>' \
  -H 'content-type: application/json' \
  --data-raw '{"identifier":{"type":"email","value":"..."}}'
```

El cuerpo de la respuesta sería así:

```json
{
  "verificationRecordId": "...",
  "expiresAt": "..."
}
```

Al recibir el código de verificación, puedes usarlo para actualizar el estado de verificación del registro.

```bash
curl -X POST https://[tenant-id].logto.app/api/verifications/verification-code/verify \
  -H 'authorization: Bearer <access_token>' \
  -H 'content-type: application/json' \
  --data-raw '{"identifier":{"type":"email","value":"..."},"verificationId":"...","code":"123456"}'
```

Después de verificar el código, ahora puedes usar el ID de registro de verificación para actualizar el identificador del usuario.

Para obtener más información sobre verificaciones, consulta [Verificación de seguridad mediante Account API](/end-user-flows/security-verification).

### Enviar solicitud con ID de registro de verificación \{#send-request-with-verification-record-id}

Al enviar una solicitud para actualizar el identificador del usuario, debes incluir el ID de registro de verificación en el encabezado de la solicitud con el campo `logto-verification-id`.

### Actualizar la contraseña del usuario \{#update-users-password}

Para actualizar la contraseña del usuario, puedes usar el endpoint [`POST /api/my-account/password`](https://openapi.logto.io/operation/operation-updatepassword).

```bash
curl -X POST https://[tenant-id].logto.app/api/my-account/password \
  -H 'authorization: Bearer <access_token>' \
  -H 'logto-verification-id: <verification_record_id>' \
  -H 'content-type: application/json' \
  --data-raw '{"password":"..."}'
```

### Actualizar o vincular un nuevo correo electrónico \{#update-or-link-new-email}

:::note
Para usar este método, necesitas [configurar el conector de correo electrónico](/connectors/email-connectors/), y asegurarte de que la plantilla `BindNewIdentifier` esté configurada.
:::

Para actualizar o vincular un nuevo correo electrónico, primero debes demostrar la propiedad del correo.

Llama al endpoint [`POST /api/verifications/verification-code`](https://openapi.logto.io/operation/operation-createverificationbyverificationcode) para solicitar un código de verificación.

```bash
curl -X POST https://[tenant-id].logto.app/api/verifications/verification-code \
  -H 'authorization: Bearer <access_token>' \
  -H 'content-type: application/json' \
  --data-raw '{"identifier":{"type":"email","value":"..."}}'
```

Encontrarás un `verificationId` en la respuesta y recibirás un código de verificación en el correo electrónico; úsalo para verificar el correo.

```bash
curl -X POST https://[tenant-id].logto.app/api/verifications/verification-code/verify \
  -H 'authorization: Bearer <access_token>' \
  -H 'content-type: application/json' \
  --data-raw '{"identifier":{"type":"email","value":"..."},"verificationId":"...","code":"..."}'
```

Después de verificar el código, ahora puedes llamar a [`PATCH /api/my-account/primary-email`](https://openapi.logto.io/operation/operation-updateprimaryemail) para actualizar el correo electrónico del usuario, estableciendo el `verificationId` en el cuerpo de la solicitud como `newIdentifierVerificationRecordId`.

```bash
curl -X POST https://[tenant-id].logto.app/api/my-account/primary-email \
  -H 'authorization: Bearer <access_token>' \
  -H 'logto-verification-id: <verification_record_id>' \
  -H 'content-type: application/json' \
  --data-raw '{"email":"...","newIdentifierVerificationRecordId":"..."}'
```

### Eliminar el correo electrónico del usuario \{#remove-the-users-email}

Para eliminar el correo electrónico del usuario, puedes usar el endpoint [`DELETE /api/my-account/primary-email`](https://openapi.logto.io/operation/operation-deleteprimaryemail).

```bash
curl -X DELETE https://[tenant-id].logto.app/api/my-account/primary-email \
  -H 'authorization: Bearer <access_token>' \
  -H 'logto-verification-id: <verification_record_id>'
```

### Gestionar teléfono \{#manage-phone}

:::note
Para usar este método, necesitas [configurar el conector de SMS](/connectors/sms-connectors/), y asegurarte de que la plantilla `BindNewIdentifier` esté configurada.
:::

Similar a la actualización de correo electrónico, puedes usar el endpoint [`PATCH /api/my-account/primary-phone`](https://openapi.logto.io/operation/operation-updateprimaryphone) para actualizar o vincular un nuevo teléfono. Y usa el endpoint [`DELETE /api/my-account/primary-phone`](https://openapi.logto.io/operation/operation-deleteprimaryphone) para eliminar el teléfono del usuario.

### Vincular una nueva conexión social \{#link-a-new-social-connection}

Para vincular una nueva conexión social, primero debes solicitar una URL de autorización con [`POST /api/verifications/social`](https://openapi.logto.io/operation/operation-createverificationbysocial).

```bash
curl -X POST https://[tenant-id].logto.app/api/verifications/social \
  -H 'authorization: Bearer <access_token>' \
  -H 'content-type: application/json' \
  --data-raw '{"connectorId":"...","redirectUri":"...","state":"..."}'
```

- `connectorId`: El ID del [conector social](/connectors/social-connectors/).
- `redirectUri`: La URI de redirección después de que el usuario autorice la aplicación; debes alojar una página web en esta URL y capturar el callback.
- `state`: El estado que se devolverá después de que el usuario autorice la aplicación; es una cadena aleatoria que se utiliza para prevenir ataques CSRF.

En la respuesta, encontrarás un `verificationRecordId`, guárdalo para uso posterior.

Después de que el usuario autorice la aplicación, recibirás un callback en el `redirectUri` con el parámetro `state`. Luego puedes usar el endpoint [`POST /api/verifications/social/verify`](https://openapi.logto.io/operation/operation-verifyverificationbysocial) para verificar la conexión social.

```bash
curl -X POST https://[tenant-id].logto.app/api/verifications/social/verify \
  -H 'authorization: Bearer <access_token>' \
  -H 'content-type: application/json' \
  --data-raw '{"connectorData":"...","verificationRecordId":"..."}'
```

El `connectorData` es la información devuelta por el conector social después de que el usuario autoriza la aplicación; necesitas analizar y obtener los parámetros de consulta del `redirectUri` en tu página de callback y envolverlos como JSON en el campo `connectorData`.

Finalmente, puedes usar el endpoint [`POST /api/my-account/identities`](https://openapi.logto.io/operation/operation-adduseridentities) para vincular la conexión social.

```bash
curl -X POST https://[tenant-id].logto.app/api/my-account/identities \
  -H 'authorization: Bearer <access_token>' \
  -H 'logto-verification-id: <verification_record_id>' \
  -H 'content-type: application/json' \
  --data-raw '{"newIdentifierVerificationRecordId":"..."}'
```

### Eliminar una conexión social \{#remove-a-social-connection}

Para eliminar una conexión social, puedes usar el endpoint [`DELETE /api/my-account/identities`](https://openapi.logto.io/operation/operation-deleteidentity).

```bash
curl -X DELETE https://[tenant-id].logto.app/api/my-account/identities/[connector_target_id] \
  -H 'authorization: Bearer <access_token>' \
  -H 'logto-verification-id: <verification_record_id>'
```

### Vincular una nueva clave de acceso WebAuthn \{#link-a-new-webauthn-passkey}

:::note
Recuerda [habilitar MFA y WebAuthn](/end-user-flows/mfa) primero.
:::

:::note
Para usar este método, necesitas habilitar el campo `mfa` en la [configuración del centro de cuentas](#how-to-enable-account-api).
:::

**Paso 1: Añade el origen de tu app front-end a los orígenes relacionados**

Las claves de acceso WebAuthn están vinculadas a un hostname específico llamado **Relying Party ID (RP ID)**. Solo las aplicaciones alojadas en el origen del RP ID pueden registrar o autenticar con esas claves de acceso.

Dado que tu aplicación front-end llama a la Account API desde un dominio diferente al de las páginas de autenticación de Logto, necesitas configurar **Related Origins** para permitir operaciones de claves de acceso entre orígenes.

**Cómo determina Logto el RP ID:**

- **Configuración por defecto**: Si solo usas el dominio por defecto de Logto `https://[tenant-id].logto.app`, el RP ID es `[tenant-id].logto.app`
- **Dominio personalizado**: Si has configurado un [dominio personalizado](/logto-cloud/custom-domain) como `https://auth.example.com`, el RP ID será `auth.example.com`

**Configura Related Origins:**

Usa el endpoint [`PATCH /api/account-center`](https://openapi.logto.io/operation/operation-updateaccountcentersettings) para añadir el origen de tu aplicación front-end. Por ejemplo, si el centro de cuentas de tu app se ejecuta en `https://account.example.com`:

```bash
curl -X PATCH https://[tenant-id].logto.app/api/account-center \
  -H 'authorization: Bearer <access_token>' \
  -H 'content-type: application/json' \
  --data-raw '{"webauthnRelatedOrigins":["https://account.example.com"]}'
```

Para obtener más información sobre los orígenes relacionados, consulta la documentación de [Related Origin Requests](https://passkeys.dev/docs/advanced/related-origins/).

**Paso 2: Solicita nuevas opciones de registro**

Usa el endpoint [`POST /api/verifications/web-authn/registration`](https://openapi.logto.io/operation/operation-generatewebauthnregistrationoptions) para solicitar el registro de una nueva clave de acceso. Logto permite que cada cuenta de usuario registre múltiples claves de acceso.

```bash
curl -X POST https://[tenant-id].logto.app/api/verifications/web-authn/registration \
  -H 'authorization: Bearer <access_token>' \
  -H 'content-type: application/json'
```

Recibirás una respuesta como:

```json
{
  "registrationOptions": "...",
  "verificationRecordId": "...",
  "expiresAt": "..."
}
```

**Paso 3: Registra la clave de acceso en el navegador local**

Tomando [`@simplewebauthn/browser`](https://simplewebauthn.dev/) como ejemplo, puedes usar la función `startRegistration` para registrar la clave de acceso en el navegador local.

```ts
import { startRegistration } from '@simplewebauthn/browser';

// ...
const response = await startRegistration({
  optionsJSON: registrationOptions, // Los datos devueltos por el servidor en el paso 1
});
// Guarda la respuesta para usarla más adelante
```

**Paso 4: Verifica el registro de la clave de acceso**

Usa el endpoint [`POST /api/verifications/web-authn/registration/verify`](https://openapi.logto.io/operation/operation-verifywebauthnregistration) para verificar el registro de la clave de acceso.

Este paso verifica la firma criptográfica generada por el autenticador para asegurar que la clave de acceso fue creada legítimamente y no ha sido manipulada durante la transmisión.

```bash
curl -X POST https://[tenant-id].logto.app/api/verifications/web-authn/registration/verify \
  -H 'authorization: Bearer <access_token>' \
  -H 'content-type: application/json' \
  --data-raw '{"payload":"...","verificationRecordId":"..."}'
```

- `payload`: La respuesta del navegador local en el paso 2.
- `verificationRecordId`: El ID de registro de verificación devuelto por el servidor en el paso 1.

**Paso 5: Vincula la clave de acceso**

Finalmente, puedes vincular la clave de acceso a la cuenta del usuario usando el endpoint [`POST /api/my-account/mfa-verifications`](https://openapi.logto.io/operation/operation-addmfaverification).

```bash
curl -X POST https://[tenant-id].logto.app/api/my-account/mfa-verifications \
  -H 'authorization: Bearer <access_token>' \
  -H 'logto-verification-id: <verification_record_id>' \
  -H 'content-type: application/json' \
  --data-raw '{"type":"WebAuthn","newIdentifierVerificationRecordId":"..."}'
```

- `verification_record_id`: un ID de registro de verificación válido, otorgado al verificar el factor existente del usuario; puedes consultar la sección [Obtener un ID de registro de verificación](#get-a-verification-record-id) para más detalles.
- `type`: el tipo de factor MFA, actualmente solo se admite `WebAuthn`.
- `newIdentifierVerificationRecordId`: el ID de registro de verificación devuelto por el servidor en el paso 1.

### Gestionar claves de acceso WebAuthn existentes \{#manage-existing-webauthn-passkeys}

Para gestionar claves de acceso WebAuthn existentes, puedes usar el endpoint [`GET /api/my-account/mfa-verifications`](https://openapi.logto.io/operation/operation-getmfaverifications) para obtener las claves actuales y otros factores de verificación MFA.

```bash
curl https://[tenant-id].logto.app/api/my-account/mfa-verifications \
  -H 'authorization: Bearer <access_token>'
```

El cuerpo de la respuesta sería así:

```json
[
  {
    "id": "...",
    "type": "WebAuthn",
    "name": "...",
    "agent": "...",
    "createdAt": "...",
    "updatedAt": "..."
  }
]
```

- `id`: el ID de la verificación.
- `type`: el tipo de la verificación, `WebAuthn` para clave de acceso WebAuthn.
- `name`: el nombre de la clave de acceso, campo opcional.
- `agent`: el user agent de la clave de acceso.

Actualiza el nombre de la clave de acceso usando el endpoint [`PATCH /api/my-account/mfa-verifications/{verificationId}/name`](https://openapi.logto.io/operation/operation-updatemfaverificationname):

```bash
curl -X PATCH https://[tenant-id].logto.app/api/my-account/mfa-verifications/{verificationId}/name \
  -H 'authorization: Bearer <access_token>' \
  -H 'logto-verification-id: <verification_record_id>' \
  -H 'content-type: application/json' \
  --data-raw '{"name":"..."}'
```

Elimina la clave de acceso usando el endpoint [`DELETE /api/my-account/mfa-verifications/{verificationId}`](https://openapi.logto.io/operation/operation-deletemfaverification):

```bash
curl -X DELETE https://[tenant-id].logto.app/api/my-account/mfa-verifications/{verificationId} \
  -H 'authorization: Bearer <access_token>' \
  -H 'logto-verification-id: <verification_record_id>'
```

### Vincular un nuevo TOTP \{#link-a-new-totp}

:::note
Recuerda [habilitar MFA y TOTP](/end-user-flows/mfa) primero.
:::

:::note
Para usar este método, necesitas habilitar el campo `mfa` en la [configuración del centro de cuentas](#how-to-enable-account-api).
:::

**Paso 1: Generar un secreto TOTP**

Usa el endpoint [`POST /api/my-account/mfa-verifications/totp-secret/generate`](https://openapi.logto.io/operation/operation-generatetotpsecret) para generar un secreto TOTP.

```bash
curl -X POST https://[tenant-id].logto.app/api/my-account/mfa-verifications/totp-secret/generate \
  -H 'authorization: Bearer <access_token>' \
  -H 'content-type: application/json'
```

El cuerpo de la respuesta sería así:

```json
{
  "secret": "..."
}
```

**Paso 2: Muestra el secreto TOTP al usuario**

Usa el secreto para generar un código QR o muéstralo directamente al usuario. El usuario debe añadirlo a su app autenticadora (como Google Authenticator, Microsoft Authenticator o Authy).

El formato URI para el código QR debe ser:

```
otpauth://totp/[Issuer]:[Account]?secret=[Secret]&issuer=[Issuer]
```

Ejemplo:

```
otpauth://totp/YourApp:user@example.com?secret=JBSWY3DPEHPK3PXP&issuer=YourApp
```

**Paso 3: Vincula el factor TOTP**

Después de que el usuario haya añadido el secreto a su app autenticadora, debe verificarlo y vincularlo a su cuenta. Usa el endpoint [`POST /api/my-account/mfa-verifications`](https://openapi.logto.io/operation/operation-addmfaverification) para vincular el factor TOTP.

```bash
curl -X POST https://[tenant-id].logto.app/api/my-account/mfa-verifications \
  -H 'authorization: Bearer <access_token>' \
  -H 'logto-verification-id: <verification_record_id>' \
  -H 'content-type: application/json' \
  --data-raw '{"type":"Totp","secret":"..."}'
```

- `verification_record_id`: un ID de registro de verificación válido, otorgado al verificar el factor existente del usuario. Puedes consultar la sección [Obtener un ID de registro de verificación](#get-a-verification-record-id) para más detalles.
- `type`: debe ser `Totp`.
- `secret`: el secreto TOTP generado en el paso 1.

:::note
Un usuario solo puede tener un factor TOTP a la vez. Si el usuario ya tiene un factor TOTP, intentar añadir otro resultará en un error 422.
:::

### Gestionar códigos de respaldo \{#manage-backup-codes}

:::note
Recuerda [habilitar MFA y códigos de respaldo](/end-user-flows/mfa) primero.
:::

:::note
Para usar este método, necesitas habilitar el campo `mfa` en la [configuración del centro de cuentas](#how-to-enable-account-api).
:::

**Paso 1: Generar nuevos códigos de respaldo**

Usa el endpoint [`POST /api/my-account/mfa-verifications/backup-codes/generate`](https://openapi.logto.io/operation/operation-generatemyaccountbackupcodes) para generar un nuevo conjunto de 10 códigos de respaldo.

```bash
curl -X POST https://[tenant-id].logto.app/api/my-account/mfa-verifications/backup-codes/generate \
  -H 'authorization: Bearer <access_token>' \
  -H 'content-type: application/json'
```

El cuerpo de la respuesta sería así:

```json
{
  "codes": ["...", "...", "..."]
}
```

**Paso 2: Muestra los códigos de respaldo al usuario**

Antes de vincular los códigos de respaldo a la cuenta del usuario, debes mostrárselos y recomendarle que:

- Descargue o anote estos códigos inmediatamente
- Los almacene en un lugar seguro
- Entienda que cada código solo puede usarse una vez
- Sepa que estos códigos son su último recurso si pierde acceso a sus métodos MFA principales

Debes mostrar los códigos en un formato claro y fácil de copiar, y considerar ofrecer una opción de descarga (por ejemplo, como archivo de texto o PDF).

**Paso 3: Vincula los códigos de respaldo a la cuenta del usuario**

Usa el endpoint [`POST /api/my-account/mfa-verifications`](https://openapi.logto.io/operation/operation-addmfaverification) para vincular los códigos de respaldo a la cuenta del usuario.

```bash
curl -X POST https://[tenant-id].logto.app/api/my-account/mfa-verifications \
  -H 'authorization: Bearer <access_token>' \
  -H 'logto-verification-id: <verification_record_id>' \
  -H 'content-type: application/json' \
  --data-raw '{"type":"BackupCode","codes":["...","...","..."]}'
```

- `verification_record_id`: un ID de registro de verificación válido, otorgado al verificar el factor existente del usuario. Puedes consultar la sección [Obtener un ID de registro de verificación](#get-a-verification-record-id) para más detalles.
- `type`: debe ser `BackupCode`.
- `codes`: el array de códigos de respaldo generados en el paso anterior.

:::note

- Un usuario solo puede tener un conjunto de códigos de respaldo a la vez. Si se han usado todos los códigos, el usuario debe generar y vincular nuevos códigos.
- Los códigos de respaldo no pueden ser el único factor MFA. El usuario debe tener al menos otro factor MFA (como WebAuthn o TOTP) habilitado.
- Cada código de respaldo solo puede usarse una vez.

:::

**Ver códigos de respaldo existentes**

Para ver los códigos de respaldo existentes y su estado de uso, usa el endpoint [`GET /api/my-account/mfa-verifications/backup-codes`](https://openapi.logto.io/operation/operation-getbackupcodes):

```bash
curl https://[tenant-id].logto.app/api/my-account/mfa-verifications/backup-codes \
  -H 'authorization: Bearer <access_token>'
```

El cuerpo de la respuesta sería así:

```json
{
  "codes": [
    {
      "code": "...",
      "usedAt": null
    },
    {
      "code": "...",
      "usedAt": "2024-01-15T10:30:00.000Z"
    }
  ]
}
```

- `code`: el código de respaldo.
- `usedAt`: la marca de tiempo cuando se usó el código, `null` si aún no se ha usado.
