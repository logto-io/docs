---
sidebar_position: 4
sidebar_label: Conecta tu agente a APIs de terceros
---

# Conecta tu agente de IA a APIs de terceros

Esta gu铆a te muestra c贸mo habilitar que tu agente de IA acceda a APIs de terceros (por ejemplo, Google Calendar, GitHub, etc.) en nombre de los usuarios. Aprovechando los conectores sociales de Logto y el Secret Vault, puedes almacenar y gestionar de forma segura los tokens de acceso, permitiendo que tu agente realice tareas automatizadas sin pedir repetidamente a los usuarios que se vuelvan a autenticar.

Aprender谩s a:

- Configurar conectores sociales con almacenamiento de tokens de terceros.
- Solicitar permisos m铆nimos durante el inicio de sesi贸n inicial.
- Solicitar progresivamente permisos adicionales seg煤n sea necesario.
- Recuperar y usar los tokens almacenados para acceder a APIs de terceros.

## Por qu茅 tu agente de IA necesita acceso a APIs de terceros \{#why-your-ai-agent-needs-third-party-api-access}

Los agentes de IA se utilizan cada vez m谩s para automatizar tareas que requieren interacci贸n con servicios externos. Por ejemplo:

- ** Gesti贸n de calendarios**: Tu agente de IA puede programar reuniones autom谩ticamente, a帽adir eventos o ajustar citas en Google Calendar.
- ** Automatizaci贸n de correos electr贸nicos**: Enviar correos de seguimiento, organizar bandejas de entrada o redactar respuestas usando las APIs de Gmail.
- ** Gesti贸n de c贸digo**: Crear incidencias en GitHub, revisar pull requests o gestionar repositorios.
- ** Gesti贸n de archivos**: Subir, organizar o compartir archivos en Google Drive o Dropbox.

Para realizar estas tareas, tu agente de IA necesita acceso seguro a APIs de terceros autorizadas por el usuario, lo que implica manejar correctamente y de forma segura los tokens OAuth.

## C贸mo funciona \{#how-it-works}

Aqu铆 tienes una visi贸n general r谩pida del flujo:

```mermaid
sequenceDiagram
    participant Usuario
    participant Agente as Tu agente de IA
    participant Logto
    participant Google as Proveedor de terceros<br/>(por ejemplo, Google)

    rect rgba(200, 230, 200, 0.5)
        Note over Usuario, Google: El usuario otorga permisos al proveedor de terceros
        Usuario->>Agente: "A帽ade una reuni贸n a mi calendario ma帽ana a las 3pm"
        Agente->>Usuario: Se necesita acceso a Google Calendar, por favor autoriza
        Usuario->>Agente: Iniciar autorizaci贸n de Google
        Agente->>Logto: Iniciar verificaci贸n social
        Logto->>Google: Redirigir a Google
        Usuario->>Google: Autenticarse y otorgar permisos
        Google->>Logto: Devolver c贸digo de autorizaci贸n
        Logto->>Google: Intercambiar c贸digo por tokens
        Logto->>Logto: Almacenar tokens en Secret Vault
        Logto->>Agente: Devolver resultado de la verificaci贸n
    end

    rect rgba(200, 200, 230, 0.5)
        Note over Usuario, Google: Ejecuci贸n de tarea por el agente de IA
        Agente->>Logto: Recuperar token de acceso de Google
        Logto->>Agente: Devolver token de acceso
        Agente->>Google: Llamar a la API de Google Calendar
        Google->>Agente: Devolver 茅xito
        Agente->>Usuario: "隆Listo! He a帽adido la reuni贸n a tu calendario."
    end
```

1. **El usuario solicita una tarea**: El usuario pide al agente de IA que realice una tarea que requiere acceso a una API de terceros (por ejemplo, a帽adir un evento al calendario).
2. **Solicitud de autorizaci贸n**: El agente detecta la necesidad de acceso de terceros y solicita al usuario que autorice.
3. **Tokens almacenados**: Tras la autorizaci贸n del usuario, Logto almacena de forma segura los tokens de acceso y actualizaci贸n en el Secret Vault.
4. **Ejecuci贸n de la tarea**: El agente recupera el token almacenado y llama a la API de terceros para completar la tarea.

Una vez autorizado, el usuario puede realizar m煤ltiples tareas sin volver a autorizar. Logto almacena los tokens de forma segura y los renueva autom谩ticamente cuando es necesario, proporcionando una experiencia fluida para las interacciones continuas del agente de IA.

## Requisitos previos \{#prerequisites}

Antes de comenzar, aseg煤rate de tener:

- Un tenant de [Logto Cloud](https://cloud.logto.io) (o Logto autogestionado v1.31+)
- Una cuenta de proveedor de terceros con acceso a API (por ejemplo, [Google Cloud Console](https://console.cloud.google.com))
- Una aplicaci贸n de agente de IA integrada con Logto SDK (los usuarios pueden iniciar sesi贸n en tu agente de IA)

## Configura el conector social con almacenamiento de tokens \{#set-up-social-connector-with-token-storage}

Para habilitar que tu agente de IA acceda a APIs de terceros, necesitas configurar un conector social con el almacenamiento de tokens habilitado. Esto permite que Logto almacene y gestione los tokens de acceso cuando los usuarios autorizan servicios de terceros durante su interacci贸n con tu agente de IA.

Usemos Google como ejemplo:

1. Navega a <CloudLink to="/connectors/social">Consola > Conectores > Conectores sociales</CloudLink>.
2. Haz clic en **A帽adir conector social** y selecciona **Google**.
3. Sigue la [gu铆a de configuraci贸n del conector de Google](/integrations/google) para configurar tus credenciales de cliente OAuth.
4. En la configuraci贸n del conector:
   - Activa **Almacenar tokens para acceso persistente a la API** para guardar los tokens en el Secret Vault.
   - Configura **Prompts** para incluir `consent` y asegurar que los usuarios vean la solicitud de permisos.
   - Activa **Acceso offline** para recibir tokens de actualizaci贸n para acceso prolongado a la API.
5. Guarda los cambios.

:::info
No necesitas a帽adir este conector a tu experiencia de inicio de sesi贸n. El conector se usar谩 para autorizaci贸n bajo demanda cuando tu agente de IA necesite acceder a APIs de terceros, no para el inicio de sesi贸n del usuario.
:::

## Solicita autorizaci贸n y accede a APIs de terceros \{#request-authorization-and-access-third-party-apis}

Cuando tu agente de IA necesite acceder a una API de terceros (por ejemplo, Google Calendar), primero debe comprobar si el usuario ya ha autorizado el acceso. Si no es as铆, solicita al usuario que autorice.

:::info Habilita Account API
Antes de continuar, habilita el Account API en <CloudLink to="/sign-in-experience/account-center">Consola > Experiencia de inicio de sesi贸n > Centro de cuentas</CloudLink>. Aprende m谩s sobre [c贸mo habilitar Account API](/end-user-flows/account-settings/by-account-api#how-to-enable-account-api).
:::

### Paso 1: Comprueba si ya existe autorizaci贸n{step-1-check-for-existing-authorization} \{#step-1-check-for-existing-authorization}

Primero, intenta recuperar el token de acceso almacenado para ver si el usuario ya ha autorizado:

```tsx
async function getGoogleAccessToken(userAccessToken: string) {
  const response = await fetch(
    'https://[tenant-id].logto.app/my-account/identities/google/access-token',
    {
      headers: {
        Authorization: `Bearer ${userAccessToken}`,
      },
    }
  );

  return response.json();
}
```

### Paso 2: Solicita autorizaci贸n si es necesario{step-2-request-authorization-if-needed} \{#step-2-request-authorization-if-needed}

Si no existe token, el token ha expirado o necesitas ampliar el alcance del token de acceso, utiliza la [API de Verificaci贸n Social](/secret-vault/federated-token-set#reauthentication-and-token-renewal) de Logto para iniciar el flujo de autorizaci贸n:

```tsx
async function requestGoogleAuthorization(userAccessToken: string, scopes: string) {
  // Genera un estado aleatorio para protecci贸n CSRF
  const state = crypto.randomUUID();
  sessionStorage.setItem('oauth_state', state);

  // Inicia la verificaci贸n social
  const response = await fetch('https://[tenant-id].logto.app/api/verification/social', {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${userAccessToken}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      connectorId: '<google_connector_id>',
      state,
      redirectUri: 'https://your-ai-agent.com/callback',
      scope: scopes,
    }),
  });

  const { verificationRecordId, authorizationUri } = await response.json();

  // Guarda verificationRecordId para uso posterior
  sessionStorage.setItem('verificationRecordId', verificationRecordId);

  // Redirige al usuario a Google para autorizaci贸n
  window.location.href = authorizationUri;
}
```

### Paso 3: Gestiona el callback de autorizaci贸n{step-3-handle-the-authorization-callback} \{#step-3-handle-the-authorization-callback}

Despu茅s de que el usuario otorgue permisos, Google redirige de vuelta a tu app. Completa la verificaci贸n y almacena los tokens:

```tsx
async function handleAuthorizationCallback(
  userAccessToken: string,
  callbackParams: URLSearchParams
) {
  const verificationRecordId = sessionStorage.getItem('verificationRecordId');
  const storedState = sessionStorage.getItem('oauth_state');
  const code = callbackParams.get('code');
  const state = callbackParams.get('state');

  // Valida el estado para prevenir ataques CSRF
  if (state !== storedState) {
    throw new Error('Par谩metro de estado inv谩lido');
  }

  // Verifica la autorizaci贸n
  await fetch('https://[tenant-id].logto.app/api/verification/social/verify', {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${userAccessToken}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      verificationRecordId,
      connectorData: {
        code,
        state,
        redirectUri: 'https://your-ai-agent.com/callback',
      },
    }),
  });

  // Almacena los tokens en el Secret Vault de Logto
  await fetch('https://[tenant-id].logto.app/my-account/identities/google/access-token', {
    method: 'PUT',
    headers: {
      Authorization: `Bearer ${userAccessToken}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      verificationRecordId,
    }),
  });

  // Limpia
  sessionStorage.removeItem('verificationRecordId');
  sessionStorage.removeItem('oauth_state');
}
```

### Paso 4: Llama a la API de terceros{step-4-call-the-third-party-api} \{#step-4-call-the-third-party-api}

Ahora tu agente de IA puede recuperar el token y llamar a la API:

```tsx
async function addCalendarEvent(userAccessToken: string, eventDetails: EventDetails) {
  // Obt茅n el token de acceso de Google almacenado
  const tokenData = await getGoogleAccessToken(userAccessToken);

  if (!tokenData) {
    // El usuario no ha autorizado, solicita autorizaci贸n con alcance de calendario
    await requestGoogleAuthorization(
      userAccessToken,
      'https://www.googleapis.com/auth/calendar.events'
    );
    return; // Continuar谩 despu茅s de la redirecci贸n
  }

  // Llama a la API de Google Calendar
  const response = await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${tokenData.accessToken}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(eventDetails),
  });

  return response.json();
}
```

Logto gestiona la renovaci贸n de tokens autom谩ticamente. Si el token de acceso ha expirado pero existe un token de actualizaci贸n, Logto obtendr谩 un nuevo token de acceso de forma transparente cuando llames al endpoint de recuperaci贸n.

## Solicita permisos adicionales{request-additional-permissions} \{#request-additional-permissions}

A medida que tu agente de IA asuma m谩s tareas, puede que necesites solicitar permisos adicionales. Por ejemplo, si el usuario inicialmente autoriz贸 solo acceso de lectura al calendario pero ahora quiere crear eventos, necesitar谩s permisos de escritura.

### 驴Por qu茅 autorizaci贸n incremental?{why-incremental-authorization} \{#why-incremental-authorization}

- **Mejor experiencia de usuario**: Los usuarios son m谩s propensos a otorgar permisos cuando entienden por qu茅 se necesitan en contexto.
- **Mayor tasa de conversi贸n**: Menos permisos iniciales significan menos fricci贸n.
- **Generaci贸n de confianza**: Los usuarios conf铆an en aplicaciones que solo piden lo que realmente necesitan.

### Ejemplo: Actualizar de acceso de lectura a escritura{example-upgrading-from-read-to-write-access} \{#example-upgrading-from-read-to-write-access}

```tsx
async function createCalendarEvent(userAccessToken: string, eventDetails: EventDetails) {
  const tokenData = await getGoogleAccessToken(userAccessToken);

  if (!tokenData) {
    // A煤n no hay autorizaci贸n, solicita permiso de escritura en el calendario directamente
    await requestGoogleAuthorization(userAccessToken, 'https://www.googleapis.com/auth/calendar');
    return;
  }

  // Intenta crear el evento
  const response = await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${tokenData.accessToken}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(eventDetails),
  });

  if (response.status === 403) {
    // Permisos insuficientes, solicita alcance adicional
    await requestGoogleAuthorization(
      userAccessToken,
      'https://www.googleapis.com/auth/calendar' // Acceso completo al calendario
    );
    return;
  }

  return response.json();
}
```

:::tip
Al solicitar alcances adicionales, el usuario ver谩 una pantalla de consentimiento mostrando solo los nuevos permisos solicitados. Sus permisos existentes se conservar谩n.
:::

## Gestiona el estado de los tokens{manage-token-status} \{#manage-token-status}

La Consola de Logto proporciona visibilidad sobre el estado de los tokens para cada usuario:

1. Navega a <CloudLink to="/users">Consola > Gesti贸n de usuarios</CloudLink>.
2. Haz clic en un usuario para ver sus detalles.
3. Despl谩zate a la secci贸n **Conexiones** para ver todas las cuentas sociales vinculadas.
4. Cada conexi贸n muestra el estado del token:
   - **Activo**: El token de acceso es v谩lido y est谩 listo para usarse.
   - **Expirado**: El token de acceso ha expirado. Si existe un token de actualizaci贸n, se renovar谩 autom谩ticamente en la pr贸xima recuperaci贸n.
   - **Inactivo**: No hay tokens almacenados para esta conexi贸n.

## Mejores pr谩cticas de seguridad{security-best-practices} \{#security-best-practices}

Al construir agentes de IA que acceden a APIs de terceros, ten en cuenta estas pr谩cticas de seguridad:

- **Solicita alcances m铆nimos**: Solicita solo los permisos que tu agente realmente necesita.
- **Usa autorizaci贸n incremental**: Solicita permisos adicionales en contexto, no todos de una vez.
- **Gestiona la expiraci贸n de tokens de forma adecuada**: Siempre maneja los casos en los que los tokens puedan estar expirados o revocados.
- **Protege los tokens de acceso de usuario**: El token de acceso de Logto del usuario es la clave para recuperar los tokens de terceros. Prot茅gelo adecuadamente.
- **Audita el acceso a la API**: Registra cuando tu agente de IA accede a APIs de terceros para resoluci贸n de problemas y cumplimiento.

## Recursos relacionados{related-resources} \{#related-resources}

<Url href="/secret-vault/federated-token-set">Almacenamiento de tokens de terceros</Url>
<Url href="/connectors/social-connectors">Conectores sociales</Url>
<Url href="/end-user-flows/sign-up-and-sign-in/social-sign-in">Inicio de sesi贸n social</Url>
<Url href="/end-user-flows/account-settings/by-account-api">Account API</Url>
