---
sidebar_position: 3
---

import illustration from '@site/docs/authorization/assets/rbac-global-api-resources.png';
import AuthorizationRequestExample from '@site/docs/authorization/fragments/AuthorizationRequestExample';
import ClientCredentialsRequestExample from '@site/docs/authorization/fragments/ClientCredentialsRequestExample';
import TokenRequestExample from '@site/docs/authorization/fragments/TokenRequestExample';
import TabItem from '@theme/TabItem';
import Tabs from '@theme/Tabs';

# Protege recursos globales de API

export const resource = 'https://api.your-app.com';

Protege las APIs de todo el producto utilizando el control de acceso basado en roles (RBAC) en Logto. Asigna roles y permisos globales para controlar el acceso de todos los usuarios y clientes en tu aplicaci√≥n.

## ¬øQu√© son los recursos globales de API? \{#what-are-global-api-resources}

Los recursos globales de API son endpoints o servicios en tu aplicaci√≥n que son accesibles para todos los usuarios, sin importar la organizaci√≥n o el inquilino. Normalmente, estos son APIs p√∫blicos, servicios centrales del producto o cualquier endpoint que no est√© limitado a una organizaci√≥n espec√≠fica.

**Casos de uso incluyen**

- APIs p√∫blicas o endpoints compartidos entre toda tu base de usuarios.
- Microservicios que no est√°n ligados a la multi-tenencia.
- APIs centrales de la aplicaci√≥n (por ejemplo, `/api/users`, `/api/products`) utilizadas por todos los clientes.

Logto te permite asegurar estas APIs usando OAuth 2.1, combinado con un control de acceso flexible basado en roles.

## C√≥mo funciona en Logto \{#how-it-works-in-logto}

- **Los recursos de API y permisos se registran globalmente:** Cada API que deseas proteger se define con un indicador de recurso √∫nico (URI) y un conjunto de permisos (alcances) que controlan el acceso.
- **El acceso se controla mediante roles globales:** Puedes asignar permisos a roles, que luego se asignan a usuarios o clientes.
- **Separado de los permisos a nivel de organizaci√≥n:** Los recursos globales de API no tienen contexto de organizaci√≥n. Sin embargo, pueden usarse junto con roles de organizaci√≥n para proporcionar una capa adicional de contexto si es necesario. Para proteger APIs a nivel de organizaci√≥n, consulta [Proteger recursos de API a nivel de organizaci√≥n](/authorization/organization-level-api-resources).

<img src={illustration} alt="Recursos globales de API RBAC" style={{ maxWidth: '100%' }} />

### Resumen de la implementaci√≥n \{#implementation-overview}

1. **Registra tu recurso de API** y define sus permisos en Logto.
2. **Define roles** con los permisos necesarios para acceder a la API.
3. **Asigna roles** a usuarios o clientes.
4. **Utiliza los flujos de autorizaci√≥n OAuth 2.0** para obtener tokens de acceso para la API (el par√°metro resource debe coincidir con el identificador de API registrado).
5. **Valida los tokens de acceso** en tu API para hacer cumplir los permisos.

### Entendiendo los indicadores de recurso \{#understanding-resource-indicators}

Logto modela los recursos de API seg√∫n [RFC 8707: Indicadores de recurso para OAuth 2.0](https://www.rfc-editor.org/rfc/rfc8707.html). Un **indicador de recurso** es un URI que identifica de manera √∫nica la API o servicio objetivo solicitado.

**Puntos clave**

- Los indicadores de recurso deben ser URIs absolutas (por ejemplo, `https://api.example.com`)
- Sin componente de fragmento; evita usar cadenas de consulta cuando sea posible.
- Los indicadores de recurso permiten tokens restringidos por audiencia y soporte para arquitecturas multi-API.

**Ejemplo**

- Management API: `https://my-tenant.logto.app/api`
- API global personalizada: `https://api.yourapp.com`

### Flujo de autorizaci√≥n: autenticando y asegurando tu API \{#authorization-flow-authenticating-and-securing-your-api}

El siguiente flujo aplica tanto para la autenticaci√≥n interactiva de usuarios (navegador / app) como para escenarios backend m√°quina a m√°quina (M2M).

Ten en cuenta que el flujo no incluye todos los detalles sobre los par√°metros o encabezados requeridos, sino que se enfoca en los pasos clave involucrados. Contin√∫a leyendo para ver c√≥mo funciona el flujo en la pr√°ctica.

```mermaid
sequenceDiagram
    participant Cliente
    participant Logto
    participant API as Recurso de API

    alt Autenticaci√≥n de usuario
        Cliente->>Logto: GET /oidc/auth
        Logto->>Logto: Redirige al usuario a la p√°gina de inicio de sesi√≥n
        Logto->>Cliente: Redirige de vuelta con `authorization_code`
        alt Usar el grant de authorization_code
            Cliente->>Logto: POST /oidc/token con `grant_type=authorization_code`<br/>y par√°metro `resource`
        else Usar el grant de refresh_token
            Cliente->>Logto: POST /oidc/token con `grant_type=authorization_code`
            Logto->>Cliente: Devuelve refresh token
            Cliente->>Logto: POST /oidc/token con `grant_type=refresh_token`<br/>y par√°metro `resource`
        end
    else Autenticaci√≥n de cliente m√°quina a m√°quina (M2M)
        Cliente->>Logto: POST /oidc/token con `grant_type=client_credentials`<br/>y par√°metro `resource`
    end

    Logto->>Cliente: Devuelve token de acceso (JSON Web Token)
    Cliente->>API: Solicitud con token Bearer
    API->>API: Valida el token de acceso

    alt El token es v√°lido
      API->>Cliente: Devuelve datos del recurso protegido
    else El token no es v√°lido
      API->>Cliente: 401 No autorizado
    end
```

_Autenticaci√≥n de usuario = navegador / app. M2M = servicio backend o script usando credenciales de cliente._

:::note
El par√°metro `resource` debe coincidir exactamente con el identificador de API (indicador de recurso) que registraste en Logto.
:::

## Pasos de implementaci√≥n \{#implementation-steps}

### Registra tus recursos de API \{#register-your-api-resources}

1. Ve a <CloudLink to="/api-resources">Consola ‚Üí Recursos de API</CloudLink>.
2. Crea un nuevo recurso de API (por ejemplo, `https://api.yourapp.com/org`) y define sus permisos (alcances).

Para ver los pasos completos de configuraci√≥n, consulta [Definir recursos de API con permisos](/authorization/role-based-access-control#define-api-resources-with-permissions).

### Configura roles globales \{#set-up-global-roles}

1. Ve a <CloudLink to="/roles">Consola ‚Üí Roles</CloudLink>.
2. Crea roles que correspondan a los permisos de tu API (por ejemplo, `read:products`, `write:products`).
3. Asigna estos roles a los usuarios o clientes que necesiten acceso a la API.

Para ver los pasos completos de configuraci√≥n, consulta [Usar roles globales](/authorization/role-based-access-control#configure-global-roles).

### Obt√©n tokens de acceso para recursos globales de API \{#obtain-access-tokens-for-global-api-resources}

Antes de acceder a un recurso global de API, tu cliente debe obtener un token de acceso. Logto emite [JSON Web Tokens (JWTs)](https://auth.wiki/jwt) como tokens de acceso para recursos globales de API. Esto normalmente se realiza usando el [flujo de c√≥digo de autorizaci√≥n OAuth 2.0](https://auth.wiki/authorization-code-flow), [flujo de refresh token](https://auth.wiki/refresh-token), o el [flujo de credenciales de cliente](https://auth.wiki/client-credentials-flow).

#### Flujo de c√≥digo de autorizaci√≥n o refresh token \{#authorization-code-or-refresh-token-flow}

Todos los SDK oficiales de Logto admiten la obtenci√≥n de tokens de acceso para recursos globales de API usando el flujo de refresh token de forma predeterminada. Tambi√©n se puede usar una biblioteca cliente est√°ndar de OAuth 2.0 / OIDC para implementar este flujo.

<Tabs groupId="user-client">
<TabItem value="logto-sdk" label="Logto SDK">

Al inicializar el cliente Logto, a√±ade el indicador de recurso al par√°metro `resources` (array), luego a√±ade los permisos deseados (alcances) al par√°metro `scopes`.

Una vez que el usuario est√° autenticado, pasa el indicador de recurso en el par√°metro `resource` o en un par√°metro de nombre similar al solicitar el token de acceso (por ejemplo, llamando a `getAccessToken()`).

Para detalles sobre cada SDK, consulta los [Inicios r√°pidos](/quick-starts).

</TabItem>
<TabItem value="oauth-client" label="OAuth 2.0 / OIDC client library">

Al configurar tu cliente OAuth 2.0 o inicializar el flujo de c√≥digo de autorizaci√≥n, aseg√∫rate de incluir el par√°metro `resource` y los alcances deseados en la solicitud de autorizaci√≥n.

Algunas bibliotecas pueden no soportar el par√°metro `resource` de forma nativa, pero normalmente permiten pasar par√°metros adicionales en la solicitud de autorizaci√≥n. Consulta la documentaci√≥n de tu biblioteca para m√°s detalles.

Aqu√≠ tienes un ejemplo no normativo de la solicitud de autorizaci√≥n con los par√°metros `resource` y `scope`:

<AuthorizationRequestExample resource={resource} scope="read:products write:products" />

Una vez que el usuario est√° autenticado, recibir√°s un authorization code. Intercambia este c√≥digo por un token de acceso haciendo una solicitud POST al endpoint `/oidc/token` de Logto, incluyendo el par√°metro `resource` en el cuerpo de la solicitud.

Aqu√≠ tienes un ejemplo no normativo de la solicitud de token usando el grant type authorization_code:

<TokenRequestExample grantType="authorization_code" resource={resource} />

Tambi√©n puedes usar el grant type `refresh_token` para obtener un nuevo token de acceso sin interacci√≥n del usuario, siempre que el par√°metro `resource` est√© incluido en la solicitud.

Aqu√≠ tienes un ejemplo no normativo de la solicitud de token usando el grant type refresh_token:

<TokenRequestExample grantType="refresh_token" resource={resource} />

</TabItem>
</Tabs>

#### Flujo de credenciales de cliente \{#client-credentials-flow}

Para escenarios m√°quina a m√°quina (M2M), puedes usar el flujo de credenciales de cliente para obtener un token de acceso para tu recurso global de API. Haciendo una solicitud POST al endpoint `/oidc/token` de Logto, puedes solicitar un token de acceso usando tu client ID y secret.

Hay dos par√°metros clave que debes incluir en la solicitud:

- `resource`: El URI indicador de recurso de la API a la que deseas acceder (por ejemplo, `https://api.yourapp.com`).
- `scope`: Los permisos que deseas solicitar para la API (por ejemplo, `read:products write:products`).

Aqu√≠ tienes un ejemplo no normativo de la solicitud de token usando el grant type client_credentials:

<ClientCredentialsRequestExample
  resource="https://api.yourapp.com"
  scope="read:products write:products"
/>

### Validando tokens de acceso JWT en tu API \{#validating-jwt-access-tokens-in-your-api}

Los JWTs emitidos por Logto contienen reclamos que tu API puede usar para hacer cumplir la autorizaci√≥n.

Cuando tu API recibe una solicitud con un token de acceso emitido por Logto, debes:

- Verificar la firma del token (usando los JWKs de Logto).
- Confirmar que el token no ha expirado (reclamo `exp`).
- Comprobar que el `iss` (emisor) coincide con tu endpoint de Logto.
- Asegurarte de que el `aud` (audiencia) coincide con el identificador de recurso de API que registraste (por ejemplo, `https://api.yourapp.com`).
- Separar el reclamo `scope` (separado por espacios) y comprobar los permisos requeridos.

Para gu√≠as paso a paso y espec√≠ficas por lenguaje, consulta [C√≥mo validar tokens de acceso](/authorization/validate-access-tokens).

### Opcional: Manejar cambios de permisos de usuario \{#optional-handle-user-permission-change}

:::info
üë∑ Trabajo en progreso. üöß
:::

## Mejores pr√°cticas y consejos de seguridad \{#best-practices-and-security-tips}

- **Mant√©n los permisos orientados al negocio:** Usa nombres claros que correspondan a acciones reales.
- **Mant√©n la expiraci√≥n de los tokens corta:** Reduce el riesgo si un token se filtra.
- **Limita los alcances concedidos:** Solo otorga a los tokens los permisos que realmente necesitan.
- **Usa restricci√≥n de audiencia:** Verifica siempre el reclamo `aud` para evitar usos indebidos.

## Preguntas frecuentes \{#faqs}

<details>
<summary>

### ¬øQu√© pasa si mi cliente no soporta el par√°metro resource? \{#what-if-my-client-doesn-t-support-the-resource-parameter}

</summary>

Configura un recurso de API predeterminado en la Consola de Logto. Los tokens usar√°n esta audiencia por defecto cuando no se especifique el par√°metro resource en la solicitud de token.

</details>

<details>
<summary>

### ¬øPor qu√© recibo 401 No autorizado de mi API? \{#why-do-i-get-401-unauthorized-from-my-api}

</summary>

Verifica los siguientes problemas comunes:

- **Firma del token**: Aseg√∫rate de que tu backend obtiene los JWKs correctos de Logto
- **Expiraci√≥n del token**: Verifica que el token no haya expirado (reclamo `exp`)
- **Audiencia**: Confirma que el reclamo `aud` coincide con el indicador de recurso de API registrado
- **Alcances requeridos**: Verifica que el token contenga los permisos necesarios en el reclamo `scope`

</details>

<details>
<summary>

### ¬øC√≥mo pruebo sin un cliente completo? \{#how-do-i-test-without-a-full-client}

</summary>

Utiliza un [token de acceso personal](/user-management/personal-access-token) para simular llamadas autenticadas. Esto te permite probar los endpoints de tu API sin implementar un flujo OAuth completo en tu aplicaci√≥n cliente.

</details>

## Lecturas adicionales \{#further-reading}

<Url href="/authorization/validate-access-tokens">C√≥mo validar tokens de acceso</Url>
<Url href="/use-cases/authorization/rbac-in-practice">
  RBAC en la pr√°ctica: Implementando autorizaci√≥n segura para tu aplicaci√≥n
</Url>
<Url href="/developers/custom-token-claims">Personalizaci√≥n de reclamos de tokens</Url>
<Url href="https://www.rfc-editor.org/rfc/rfc8707.html">RFC 8707: Indicadores de recurso</Url>
