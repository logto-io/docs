## Paso 1: Crea un proyecto en Google Auth Platform \{#step-1-create-a-project-on-google-auth-platform}

Antes de poder usar Google como proveedor de autenticación, debes configurar un proyecto en Google Cloud Console para obtener credenciales de OAuth 2.0. Si ya tienes un proyecto, puedes omitir este paso.

1. Visita la [Google Cloud Console](https://console.cloud.google.com/) e inicia sesión con tu cuenta de Google.
2. Haz clic en el botón **Seleccionar un proyecto** en la barra superior del menú y luego haz clic en el botón **Nuevo proyecto** para crear un proyecto.
3. En tu proyecto recién creado, navega a **APIs y servicios > Pantalla de consentimiento OAuth** para configurar tu aplicación:
   - **Información de la aplicación**: Ingresa el **Nombre de la aplicación** y el **Correo electrónico de soporte** que se mostrarán en la página de consentimiento.
   - **Audiencia (Audience)**: Selecciona tu tipo de audiencia preferido:
     - **Interna (Internal)** - Solo para usuarios de Google Workspace dentro de tu organización.
     - **Externa (External)** - Para cualquier usuario de Google (requiere verificación para uso en producción).
   - **Información de contacto**: Proporciona direcciones de correo electrónico para que Google pueda notificarte sobre cualquier cambio en tu proyecto.
   - Marca **Acepto las políticas de Google** para finalizar la configuración básica.
4. Opcionalmente, ve a la sección **Branding** para editar la información del producto y subir el **Logo de tu aplicación**, que aparecerá en la pantalla de consentimiento OAuth para ayudar a los usuarios a reconocer tu app.

:::tip
Si eliges el tipo de audiencia **Externa (External)**, deberás agregar usuarios de prueba durante el desarrollo y publicar tu aplicación para su uso en producción.
:::

## Paso 2: Crea credenciales OAuth 2.0 \{#step-2-create-oauth-2-0-credentials}

Navega a la página de [Credenciales](https://console.cloud.google.com/apis/credentials) en Google Cloud Console y crea credenciales OAuth para tu aplicación.

1. Haz clic en **Crear credenciales > ID de cliente de OAuth**.
2. Selecciona **Aplicación web (Web application)** como tipo de aplicación.
3. Completa el **Nombre** de tu cliente OAuth. Esto te ayuda a identificar las credenciales y no se muestra a los usuarios finales.
4. Configura los URI autorizados:
   - **Orígenes JavaScript autorizados**: Agrega el origen de tu instancia Logto (por ejemplo, `https://tu-dominio-logto.com`)
   - **URI de redirección autorizados**: Agrega el **Callback URI** de Logto (cópialo desde tu conector de Google en Logto)
5. Haz clic en **Crear** para generar el cliente OAuth.

## Paso 3: Configura el conector de Logto con las credenciales \{#step-3-configure-logto-connector-with-credentials}

Después de crear el cliente OAuth, Google mostrará una ventana modal con tus credenciales:

1. Copia el **ID de cliente (Client ID)** y pégalo en el campo `clientId` en Logto.
2. Copia el **Secreto de cliente (Client secret)** y pégalo en el campo `clientSecret` en Logto.
3. Haz clic en **Guardar y Listo** en Logto para conectar tu sistema de identidad con Google.

:::warning
Mantén tu secreto de cliente seguro y nunca lo expongas en código del lado del cliente. Si se ve comprometido, genera uno nuevo de inmediato.
:::

## Paso 4: Configura los alcances (Scopes) \{#step-4-configure-scopes}

Los alcances (Alcances (Scopes)) definen los permisos que tu aplicación solicita a los usuarios y controlan a qué datos puede acceder tu app desde sus cuentas de Google.

### Configura los alcances en Google Cloud Console \{#configure-scopes-in-google-cloud-console}

1. Navega a **APIs y servicios > Pantalla de consentimiento OAuth > Alcances (Scopes)**.
2. Haz clic en **Agregar o quitar alcances (Add or Remove Scopes)** y selecciona solo los alcances que tu aplicación requiere:
   - **Autenticación (Authentication) (Obligatorio)**:
     - `https://www.googleapis.com/auth/userinfo.email`
     - `https://www.googleapis.com/auth/userinfo.profile`
     - `openid`
   - **Acceso a API (Opcional)**: Agrega cualquier alcance adicional necesario para tu app (por ejemplo, Drive, Calendar, YouTube). Explora la [Biblioteca de API de Google](https://console.cloud.google.com/apis/library) para encontrar servicios disponibles. Si tu app necesita acceso a APIs de Google más allá de los permisos básicos, primero habilita las APIs específicas que tu app usará (por ejemplo, Google Drive API, Gmail API, Calendar API) en la Biblioteca de API de Google.
3. Haz clic en **Actualizar (Update)** para confirmar la selección.
4. Haz clic en **Guardar y continuar (Save and Continue)** para aplicar los cambios.

### Configura los alcances en Logto \{#configure-scopes-in-logto}

Elige una o más de las siguientes opciones según tus necesidades:

**Opción 1: No se necesitan alcances de API adicionales**

- Deja el campo `Scopes` en tu conector de Google en Logto en blanco.
- Los alcances predeterminados `openid profile email` serán solicitados para asegurar que Logto pueda obtener correctamente la información básica del usuario.

**Opción 2: Solicitar alcances adicionales al iniciar sesión**

- Ingresa todos los alcances deseados en el campo **Scopes**, separados por espacios.
- Cualquier alcance que listes aquí sobrescribe los predeterminados, así que siempre incluye los alcances de autenticación: `https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile openid`.
- Usa URLs completas de los alcances. Ejemplo: `https://www.googleapis.com/auth/calendar.readonly`.

**Opción 3: Solicitar alcances incrementales más adelante**

- Después de que el usuario inicie sesión, puedes solicitar alcances adicionales bajo demanda reiniciando un flujo de autorización social federada y actualizando el conjunto de tokens almacenados del usuario.
- Estos alcances adicionales no necesitan ser rellenados en el campo `Scopes` de tu conector de Google en Logto, y se pueden lograr a través de la API de Verificación Social de Logto.

Siguiendo estos pasos, tu conector de Google en Logto solicitará exactamente los permisos que tu app necesita, ni más ni menos.

:::tip
Si tu app solicita estos alcances para acceder a la API de Google y realizar acciones, asegúrate de habilitar **Almacenar tokens para acceso persistente a la API** en el conector de Google en Logto. Consulta la siguiente sección para más detalles.
:::

## Paso 5: Personaliza los prompts de autenticación \{#step-5-customize-authentication-prompts}

Configura **Prompts** en Logto para controlar la experiencia de autenticación del usuario. Prompts es un arreglo de cadenas que especifica el tipo de interacción de usuario requerida:

- `none` - El servidor de autorización no muestra ninguna pantalla de autenticación ni de consentimiento. Devuelve un error si el usuario no está ya autenticado y no ha preconfigurado el consentimiento para los alcances solicitados. Úsalo para comprobar la autenticación y/o consentimiento existentes.
- `consent` - El servidor de autorización solicita el consentimiento del usuario antes de devolver información al cliente. Es necesario para habilitar el **acceso sin conexión (offline access)** para el acceso a la API de Google.
- `select_account` - El servidor de autorización solicita al usuario seleccionar una cuenta. Esto permite a los usuarios con varias cuentas de Google elegir cuál usar para la autenticación.

## Paso 6: Configuración general \{#step-6-general-settings}

Aquí tienes algunas configuraciones generales que no bloquearán la conexión con Google pero pueden afectar la experiencia de autenticación del usuario final.

### Sincronizar información de perfil \{#sync-profile-information}

En el conector de Google, puedes establecer la política para sincronizar la información de perfil, como nombres de usuario y avatares. Elige entre:

- **Sincronizar solo al registrarse**: La información del perfil se obtiene una vez cuando el usuario inicia sesión por primera vez.
- **Sincronizar siempre al iniciar sesión**: La información del perfil se actualiza cada vez que el usuario inicia sesión.

### Almacenar tokens para acceder a las APIs de Google (Opcional) \{#store-tokens-to-access-google-apis-optional}

Si deseas acceder a [APIs de Google](https://console.cloud.google.com/apis/library) y realizar acciones con la autorización del usuario (ya sea mediante inicio de sesión social o vinculación de cuentas), Logto necesita obtener alcances específicos de API y almacenar tokens.

1. Agrega los alcances requeridos en la configuración de la pantalla de consentimiento OAuth de Google Cloud Console y en el conector de Google en Logto.
2. Habilita **Almacenar tokens para acceso persistente a la API** en el conector de Google en Logto. Logto almacenará de forma segura los tokens de acceso y actualización de Google en el Secret Vault.
3. Para asegurar que se devuelvan tokens de actualización, configura tu conector de Google en Logto de la siguiente manera:
   - Establece **Prompts** para incluir `consent`
   - Habilita **Acceso sin conexión (Offline Access)**

:::warning
No necesitas agregar `offline_access` en el campo `Scope` de Logto; hacerlo puede causar un error. Google utiliza `access_type=offline` automáticamente cuando el acceso sin conexión está habilitado.
:::

## Paso 7: Habilita Google One Tap (Opcional) \{#step-7-enable-google-one-tap-optional}

[Google One Tap](https://developers.google.com/identity/gsi/web/guides/features) es una forma segura y simplificada de permitir que los usuarios inicien sesión en tu sitio web con su cuenta de Google usando una interfaz emergente.

Una vez que tengas configurado el conector de Google, verás una tarjeta para Google One Tap en la página de detalles del conector. Habilita Google One Tap activando el interruptor.

### Opciones de configuración de Google One Tap \{#google-one-tap-configuration-options}

- **Seleccionar automáticamente la credencial si es posible**: Inicia sesión automáticamente al usuario con la cuenta de Google si se cumplen [ciertas condiciones](https://developers.google.com/identity/gsi/web/guides/automatic-sign-in-sign-out).
- **Cancelar el prompt si el usuario hace clic/toca fuera**: Cierra el prompt de Google One Tap si el usuario hace clic o toca fuera del prompt. Si está deshabilitado, el usuario debe hacer clic en el botón de cerrar para descartar el prompt.
- **Habilitar la experiencia mejorada de One Tap en navegadores ITP**: Habilita la experiencia de usuario mejorada de Google One Tap en navegadores con Intelligent Tracking Prevention (ITP). Consulta [esta documentación](https://developers.google.com/identity/gsi/web/guides/features#upgraded_ux_on_itp_browsers) para más información.

:::warning
Asegúrate de agregar tu dominio en la sección **Orígenes JavaScript autorizados** en la configuración de tu cliente OAuth. De lo contrario, Google One Tap no podrá mostrarse.
:::

### Limitaciones importantes con Google One Tap \{#important-limitations-with-google-one-tap}

Si habilitas **Almacenar tokens para acceso persistente a la API** junto con **Google One Tap**, no recibirás automáticamente un token de acceso ni los alcances solicitados.

El inicio de sesión con Google One Tap (a diferencia del botón estándar "Iniciar sesión con Google") **no** emite un token de acceso OAuth. Solo devuelve un token de ID (un JWT firmado) que verifica la identidad del usuario, pero no otorga acceso a la API.

Para acceder a las APIs de Google con usuarios de Google One Tap, puedes usar la API de Verificación Social de Logto para reiniciar un flujo de autorización social federada después de que el usuario inicie sesión con Google One Tap. Esto te permite solicitar alcances adicionales según sea necesario y actualizar el conjunto de tokens almacenados del usuario, sin requerir que los alcances se prellen en el conector de Google en Logto. Este enfoque permite una autorización incremental, por lo que los usuarios solo reciben solicitudes de permisos adicionales cuando tu app realmente los necesita.

Obtén más información sobre las [limitaciones de Google One Tap](https://developers.google.com/identity/gsi/web/guides/overview) en la documentación oficial.

## Paso 8: Prueba y publica tu aplicación \{#step-8-test-and-publish-your-app}

### Para aplicaciones internas \{#for-internal-apps}

Si tu tipo de **Audiencia (Audience)** en Google está configurado como **Interna (Internal)**, tu aplicación solo estará disponible para usuarios de Google Workspace dentro de tu organización. Puedes probar usando cualquier cuenta de tu organización.

### Para aplicaciones externas \{#for-external-apps}

Si tu tipo de **Audiencia (Audience)** es **Externa (External)**:

1. **Durante el desarrollo**: Navega a **Pantalla de consentimiento OAuth > Usuarios de prueba (Test users)** y agrega las direcciones de correo electrónico de los usuarios de prueba. Solo estos usuarios podrán iniciar sesión con tu app.
2. **Para producción**: Haz clic en **Publicar aplicación (Publish App)** en la sección de pantalla de consentimiento OAuth para que esté disponible para cualquier persona con una cuenta de Google.

:::note
Las aplicaciones con alcances sensibles o restringidos pueden requerir la verificación de Google antes de poder publicarse. Este proceso puede tardar varias semanas.
:::
