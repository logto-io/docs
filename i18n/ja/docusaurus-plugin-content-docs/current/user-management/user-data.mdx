---
sidebar_position: 1
---

# ユーザーデータ構造

ユーザーはアイデンティティサービスの中核となるエンティティです。Logto では、 [OpenID Connect](https://auth.wiki/openid-connect) プロトコルに基づく基本的な認証 (Authentication) データとカスタムデータを含みます。

## ユーザープロファイル \{#user-profile}

各ユーザーは [すべてのユーザー情報](#property-reference) を含むプロファイルを持っています。

これは次の種類のデータで構成されています：

- [基本データ](/user-management/user-data#basic-data)：ユーザープロファイルからの基本情報です。ユーザー ID、ユーザー名、メールアドレス、電話番号、最終サインイン日時など、ソーシャル `identities` および `custom_data` を除くすべての _ユーザー_ のプロパティを格納します。
- [ソーシャルアイデンティティ](/user-management/user-data#social-identities)：Facebook、GitHub、WeChat などのソーシャルコネクターによるサインインから取得したユーザー情報を格納します。
- [カスタムデータ](/user-management/user-data#custom-data)：ユーザーが好む色や言語など、事前定義されたユーザープロパティに含まれていない追加情報を格納します。

以下は Facebook でサインインした際に取得されるユーザーデータのサンプルです：

```json
{
  "id": "iHXPuSb9eMzt",
  "username": null,
  "primaryEmail": null,
  "primaryPhone": null,
  "name": "John Doe",
  "avatar": "https://example.com/avatar.png",
  "customData": {
    "preferences": {
      "language": "en",
      "color": "#f236c9"
    }
  },
  "identities": {
    "facebook": {
      "userId": "106077000000000",
      "details": {
        "id": "106077000000000",
        "name": "John Doe",
        "email": "johndoe@logto.io",
        "avatar": "https://example.com/avatar.png"
      }
    }
  },
  "lastSignInAt": 1655799453171,
  "applicationId": "admin_console"
}
```

ユーザープロファイルは <CloudLink to="/users">Logto コンソール</CloudLink> または Logto Management API（例： [`GET /api/users/:userId`](https://openapi.logto.io/operation/operation-getuser)）で取得できます。

## 基本データ \{#basic-data}

ユーザーの _基本データ_ に含まれるすべてのプロパティを見ていきましょう。

### id \{#id}

_id_ は Logto 内でユーザーを識別するための一意な自動生成キーです。

### username \{#username}

_username_ は _ユーザー名_ とパスワードによるサインインに使用されます。

値はユーザーが最初に登録したユーザー名から取得されます。`null` の場合もあります。非 null の場合、128 文字以内で、英数字とアンダースコア（`_`）のみを含み、数字で始まってはいけません。大文字小文字は区別されます。

### primary_email \{#primary_email}

_primary_email_ はユーザーのメールアドレスで、メールアドレスとパスワード / 認証コードによるサインインに使用されます。

値は通常、ユーザーが最初に登録したメールアドレスから取得されます。`null` の場合もあります。最大長は 128 です。

ソーシャルまたはエンタープライズ SSO アイデンティティプロバイダーからの認証済みメールアドレスのみが `primary_email` として同期・保存されます。

### primary_phone \{#primary_phone}

_primary_phone_ はユーザーの電話番号で、電話番号とパスワード / SMS 認証コードによるサインインに使用されます。

値は通常、ユーザーが最初に登録した電話番号から取得されます。`null` の場合もあります。非 null の場合、 [国番号](https://en.wikipedia.org/wiki/List_of_country_calling_codes)（プラス記号 `+` を除く）で始まる数字を含む必要があります。

ソーシャルまたはエンタープライズ SSO アイデンティティプロバイダーからの認証済み電話番号のみが `primary_phone` として同期・保存されます。

### name \{#name}

_name_ はユーザーのフルネームです。最大長は 128 です。

### avatar \{#avatar}

_avatar_ はユーザーのアバター画像を指す URL です。最大長は 2048 です。

ユーザーが Google や Facebook などのソーシャルコネクターで登録した場合、その値はソーシャルユーザー情報から取得されることがあります。

:::note

このプロパティは [OpenID Connect](https://openid.net/connect/) 標準の `picture` クレーム (Claim) にマッピングされています。

:::

### profile \{#profile}

_profile_ には、ユーザーのプロパティに含まれていない追加の OpenID Connect [標準クレーム (Claim)](https://openid.net/specs/openid-connect-core-1_0.html#StandardClaims) が格納されます。

型定義は [こちらのファイル](https://github.com/logto-io/logto/blob/HEAD/packages/schemas/src/foundations/jsonb-types/users.ts#L6) で確認できます。以下は型定義のコピーです：

```tsx
type UserProfile = Partial<{
  familyName: string;
  givenName: string;
  middleName: string;
  nickname: string;
  preferredUsername: string;
  profile: string;
  website: string;
  gender: string;
  birthdate: string;
  zoneinfo: string;
  locale: string;
  address: Partial<{
    formatted: string;
    streetAddress: string;
    locality: string;
    region: string;
    postalCode: string;
    country: string;
  }>;
}>;
```

:::note

`Partial` はすべてのプロパティがオプションであることを意味します。

:::

他の標準クレーム (Claim) との違いとして、`profile` 内のプロパティは値が空でない場合のみ [ID トークン](https://auth.wiki/id-token) または userinfo エンドポイントのレスポンスに含まれます。他の標準クレーム (Claim) は値が空の場合 `null` を返します。

### application_id \{#application_id}

_application_id_ の値は、ユーザーが最初にサインインしたアプリケーションから取得されます。`null` の場合もあります。

### last_sign_in_at \{#last_sign_in_at}

_last_sign_in_at_ は、ユーザーが最後にサインインした日時（タイムゾーン付きのタイムスタンプ）です。

### created_at \{#created_at}

_created_at_ は、ユーザーがアカウントを登録した日時（タイムゾーン付きのタイムスタンプ）です。

### updated_at \{#updated_at}

_updated_at_ は、ユーザーのプロファイル情報が最後に更新された日時（タイムゾーン付きのタイムスタンプ）です。

### has_password \{#has_password}

_has_password_ は、ユーザーがパスワードを持っているかどうかを示すブール値です。このステータスは <CloudLink to="/users">コンソール > ユーザー管理</CloudLink> の詳細ページで新規設定やリセットを含めて確認・管理できます。

### password_encrypted \{#password_encrypted}

_password_encrypted_ は、ユーザーの暗号化されたパスワードを保存するために使用されます。

値はユーザーが最初に登録したパスワードから取得されます。`null` の場合もあります。非 null の場合、暗号化前の元の内容は 6 文字以上である必要があります。

### password_encryption_method \{#password_encryption_method}

_password_encryption_method_ は、ユーザーのパスワードを暗号化するために使用されます。値はユーザーがユーザー名とパスワードで登録した際に初期化されます。`null` の場合もあります。

Logto はデフォルトで [Argon2](https://en.wikipedia.org/wiki/Argon2) の実装 [node-argon2](https://github.com/ranisalt/node-argon2) を暗号化方式として使用しています。詳細はリファレンスを参照してください。

パスワードが `123456` のユーザーからの _password_encrypted_ および _password_encryption_method_ のサンプル：

```json
{
  "password_encryption_method": "Argon2i",
  "password_encrypted": "$argon2i$v=19$m=4096,t=10,p=1$aZzrqpSX45DOo+9uEW6XVw$O4MdirF0mtuWWWz68eyNAt2u1FzzV3m3g00oIxmEr0U"
}
```

### is_suspended \{#is_suspended}

_is_suspended_ は、ユーザーが停止されているかどうかを示すブール値です。この値は [Logto Management API](https://openapi.logto.io/operation/operation-updateuserissuspended) を呼び出すか、Logto コンソールで管理できます。

ユーザーが停止されると、事前に発行されたリフレッシュ トークンは即座に失効し、そのユーザーは Logto で認証 (Authentication) できなくなります。

### mfa_verification_factors \{#mfa_verification_factors}

_mfa_verification_factors_ は、ユーザーアカウントに紐づく [多要素認証 (MFA)](/end-user-flows/mfa) の方式を列挙した配列です。値には _Totp_（認証アプリ OTP）、_WebAuthn_（パスキー）、_BackupCode_ があります。

```tsx
mfaVerificationFactors: ("Totp" | "WebAuthn" | "BackupCode")[];
```

## ソーシャルアイデンティティ \{#social-identities}

_identities_ には、 [ソーシャルサインイン](/end-user-flows/sign-up-and-sign-in/social-sign-in)（[ソーシャルコネクター](/connectors/social-connectors) でのサインイン）から取得したユーザー情報が格納されます。各ユーザーの _identities_ は個別の JSON オブジェクトで保存されます。

ユーザー情報はソーシャルアイデンティティプロバイダー（ソーシャルネットワークプラットフォーム）によって異なりますが、通常は以下を含みます：

- アイデンティティプロバイダーの _target_（例："facebook" や "google"）
- このプロバイダーでのユーザーの一意識別子
- ユーザー名
- ユーザーの認証済みメール
- ユーザーのアバター

ユーザーアカウントはソーシャルサインインを通じて複数のソーシャルアイデンティティプロバイダーと連携できます。これらのプロバイダーから取得した対応するユーザー情報は _identities_ オブジェクトに保存されます。

Google と Facebook の両方でサインインしたユーザーの _identities_ サンプル：

```json
{
  "facebook": {
    "userId": "5110888888888888",
    "details": {
      "id": "5110888888888888",
      "name": "John Doe",
      "email": "johndoe@logto.io",
      "avatar": "https://example.com/avatar.png"
    }
  },
  "google": {
    "userId": "111000000000000000000",
    "details": {
      "id": "111000000000000000000",
      "name": "John Doe",
      "email": "johndoe@gmail.com",
      "avatar": "https://example.com/avatar.png"
    }
  }
}
```

## SSO アイデンティティ \{#sso-identities}

_sso_identities_ には、 [エンタープライズシングルサインオン (SSO)](/end-user-flows/enterprise-sso)（[エンタープライズコネクター](/connectors/enterprise-connectors) でのシングルサインオン）から取得したユーザー情報が格納されます。各ユーザーの _ssoIdentities_ は個別の JSON オブジェクトで保存されます。

SSO アイデンティティプロバイダーから同期されるデータは、エンタープライズコネクターで設定されたスコープによって異なります。TypeScript 型定義のコピーは以下の通りです：

```ts
type SSOIdentity = {
  issuer: string;
  identityId: string;
  detail: JsonObject; // See https://github.com/withtyped/withtyped/blob/master/packages/server/src/types.ts#L12
};
```

## カスタムデータ \{#custom-data}

_custom_data_ には、事前定義されたユーザープロパティに含まれていない追加のユーザー情報が格納されます。

_custom_data_ を使って以下のことができます：

- ユーザーが特定のアクション（例：ウェルカムページを見たかどうか）を実行したか記録する
- アプリケーションごとにユーザーの好みの言語や外観など、アプリ固有のデータをユーザープロファイルに保存する
- ユーザーに関連するその他任意のデータを管理する

Logto の管理者ユーザーの _custom_data_ サンプル：

```json
{
  "adminConsolePreferences": {
    "language": "en",
    "appearanceMode": "system",
    "experienceNoticeConfirmed": true
  },
  "customDataFoo": {
    "foo": "foo"
  },
  "customDataBar": {
    "bar": "bar"
  }
}
```

各ユーザーの _custom_data_ は個別の JSON オブジェクトで保存されます。

:::note

_custom_data_ に機密データを入れないでください。

:::

カスタムデータは、ユーザーサインイン後に [カスタム JWT トークンクレーム (Claim)](/developers/custom-token-claims) を通じてアクセスできます。JWT トークンは base64 エンコード（暗号化ではありません）され、ネットワーク上で頻繁に送信されるため、機密データが簡単に漏洩する可能性があります。

[Management API](https://openapi.logto.io/operation/operation-listusercustomdata) を使って _custom_data_ を含むユーザープロファイルを取得し、フロントエンドアプリや外部バックエンドサービスに送信することもできます。そのため、_custom_data_ に機密情報を入れるとデータ漏洩の原因となります。

それでも _custom_data_ に機密情報を入れたい場合は、まず暗号化することを推奨します。暗号化 / 復号は信頼できるバックエンドサービスなどでのみ行い、フロントエンドアプリでは避けてください。これにより、万が一ユーザーの _custom_data_ が漏洩した場合の損失を最小限に抑えられます。

**ユーザーカスタムデータの収集と更新方法**

- [ユーザープロファイル収集](/end-user-flows/collect-user-profile) 機能を使って、ユーザーサインアップ時にカスタムデータを収集する
- [Account API](/end-user-flows/account-settings/by-account-api) を使って、エンドユーザープロファイルやアカウント設定を実装する
  - [`GET /api/my-account`](https://openapi.logto.io/operation/operation-getprofile) で全ユーザーデータを取得
  - [`PATCH /api/my-account`](https://openapi.logto.io/operation/operation-updateprofile) でユーザーの _custom_data_ を更新
- [Management API](/user-management/manage-users/#manage-via-logto-management-api) を使ってユーザー管理や高度なカスタムフローを実装する
  - [`GET /api/users/{userId}`](https://openapi.logto.io/operation/operation-getuser) で全ユーザーデータを取得
  - [`PATCH /api/users/{userId}/custom-data`](https://openapi.logto.io/operation/operation-updateusercustomdata) でユーザーの _custom_data_ を更新
- サポートチームは <CloudLink to="/users">コンソール > ユーザー管理</CloudLink> で直接ユーザーの _custom_data_ を更新できます。[ユーザープロファイルの閲覧と更新](/user-management/manage-users/#view-and-update-the-user-profile) も参照してください。

更新は慎重に行ってください。ユーザーの _custom_data_ を更新すると、ストレージ内の元の内容が完全に上書きされます。

たとえば、_custom_data_ 更新 API の入力が次のような場合（元の _custom_data_ が前述のサンプルデータだと仮定）：

```json
{
  "customDataBaz": {
    "baz": "baz"
  }
}
```

更新後の新しい _custom_data_ の値は次のようになります：

```json
{
  "customDataBaz": {
    "baz": "baz"
  }
}
```

つまり、更新後のフィールド値は以前の値とは無関係です。

## プロパティリファレンス \{#property-reference}

次の DB ユーザーテーブルのカラム（_password_encrypted_ および _password_encryption_method_ を除く）はユーザープロファイルで表示されます。つまり、 [Management API](https://openapi.logto.io/operation/operation-getuser) で取得できます。

| Name                                                                                | Type      | Description                                  | Unique | Required |
| ----------------------------------------------------------------------------------- | --------- | -------------------------------------------- | ------ | -------- |
| [id](/user-management/user-data#id)                                                 | string    | 一意識別子                                   | ✅     | ✅       |
| [username](/user-management/user-data#username)                                     | string    | サインイン用ユーザー名                       | ✅     | ❌       |
| [primary_email](/user-management/user-data#primary_email)                           | string    | プライマリメールアドレス                     | ✅     | ❌       |
| [primary_phone](/user-management/user-data#primary_phone)                           | string    | プライマリ電話番号                           | ✅     | ❌       |
| [name](/user-management/user-data#name)                                             | string    | フルネーム                                   | ❌     | ❌       |
| [avatar](/user-management/user-data#avatar)                                         | string    | ユーザーのアバター画像の URL                 | ❌     | ❌       |
| [profile](/user-management/user-data#profile)                                       | object    | ユーザープロファイル                         | ❌     | ✅       |
| [identities](/user-management/user-data#social-identities)                          | object    | ソーシャルサインインから取得したユーザー情報 | ❌     | ✅       |
| [custom_data](/user-management/user-data#custom-data)                               | object    | カスタマイズ可能なプロパティの追加情報       | ❌     | ✅       |
| [application_id](/user-management/user-data#application_id)                         | string    | ユーザーが最初に登録したアプリケーション ID  | ❌     | ✅       |
| [last_sign_in_at](/user-management/user-data#last_sign_in_at)                       | date time | ユーザーが最後にサインインした日時           | ❌     | ✅       |
| [password_encrypted](/user-management/user-data#password_encrypted)                 | string    | 暗号化されたパスワード                       | ❌     | ❌       |
| [password_encryption_method](/user-management/user-data#password_encryption_method) | string    | パスワード暗号化方式                         | ❌     | ❌       |
| [is_suspended](/user-management/user-data#is_suspended)                             | bool      | ユーザー停止マーク                           | ❌     | ✅       |
| [mfa_verifications](/user-management/user-data#mfa_verification_factors)            | object[]  | MFA 検証要素                                 | ❌     | ✅       |

- **Unique**：データベーステーブルのプロパティ値の [一意性](https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-UNIQUE-CONSTRAINTS) を保証します。
- **Required**：データベーステーブルのプロパティ値が `null` であってはならないことを保証します。

## 関連リソース \{#related-resources}

<Url href="https://blog.logto.io/secure-hub-for-user-data/">ユーザーデータ移動時のセキュアハブ</Url>
