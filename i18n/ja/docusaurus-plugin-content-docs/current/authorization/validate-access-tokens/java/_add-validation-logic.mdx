import TabItem from '@theme/TabItem';
import Tabs from '@theme/Tabs';

フレームワークによって異なる JWT ライブラリを使用します。必要な依存関係をインストールしてください：

<Tabs groupId="api-framework">
  <TabItem value="spring-boot" label="Spring Boot">

`pom.xml` に追加してください：

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.security</groupId>
    <artifactId>spring-security-oauth2-resource-server</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.security</groupId>
    <artifactId>spring-security-oauth2-jose</artifactId>
</dependency>
```

  </TabItem>
  <TabItem value="quarkus" label="Quarkus">

`pom.xml` に追加してください：

```xml
<dependency>
    <groupId>io.quarkus</groupId>
    <artifactId>quarkus-smallrye-jwt</artifactId>
</dependency>
<dependency>
    <groupId>io.quarkus</groupId>
    <artifactId>quarkus-resteasy-reactive</artifactId>
</dependency>
```

  </TabItem>
  <TabItem value="micronaut" label="Micronaut">

`pom.xml` に追加してください：

```xml
<dependency>
    <groupId>io.micronaut.security</groupId>
    <artifactId>micronaut-security-jwt</artifactId>
</dependency>
<dependency>
    <groupId>io.micronaut</groupId>
    <artifactId>micronaut-http-server-netty</artifactId>
</dependency>
```

  </TabItem>
  <TabItem value="vertx-web" label="Vert.x Web">

`pom.xml` に追加してください：

```xml
<dependency>
    <groupId>io.vertx</groupId>
    <artifactId>vertx-web</artifactId>
</dependency>
<dependency>
    <groupId>io.vertx</groupId>
    <artifactId>vertx-auth-jwt</artifactId>
</dependency>
<dependency>
    <groupId>io.vertx</groupId>
    <artifactId>vertx-web-client</artifactId>
</dependency>
```

  </TabItem>
</Tabs>

次に、アクセス トークン (Access token) を検証するミドルウェアを実装します：

<Tabs groupId="api-framework">
  <TabItem value="spring-boot" label="Spring Boot">

```java title="JwtSecurityConfig.java"
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.oauth2.jwt.JwtDecoder;
import org.springframework.security.oauth2.jwt.NimbusJwtDecoder;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
@EnableWebSecurity
public class JwtSecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(authz -> authz
                .requestMatchers("/api/protected/**").authenticated()
                .anyRequest().permitAll()
            )
            .oauth2ResourceServer(oauth2 -> oauth2
                .jwt(jwt -> jwt.decoder(jwtDecoder()))
            );
        return http.build();
    }

    @Bean
    public JwtDecoder jwtDecoder() {
        return NimbusJwtDecoder.withJwkSetUri(AuthConstants.JWKS_URI)
            .build();
    }
}
```

```java title="JwtValidator.java"
import org.springframework.security.oauth2.jwt.Jwt;
import org.springframework.stereotype.Component;
import java.util.Arrays;
import java.util.List;

@Component
public class JwtValidator {

    public void verifyPayload(Jwt jwt) {
        // 権限 (Permission) モデルに基づく検証ロジックをここに実装してください
        // この内容は下記の権限 (Permission) モデルのセクションで説明します
    }
}
```

  </TabItem>
  <TabItem value="quarkus" label="Quarkus">

```java title="JwtVerificationFilter.java"
import org.eclipse.microprofile.jwt.JsonWebToken;
import jakarta.enterprise.context.ApplicationScoped;
import jakarta.inject.Inject;
import jakarta.ws.rs.container.ContainerRequestContext;
import jakarta.ws.rs.container.ContainerRequestFilter;
import jakarta.ws.rs.ext.Provider;

@Provider
@ApplicationScoped
public class JwtVerificationFilter implements ContainerRequestFilter {

    @Inject
    JsonWebToken jwt;

    @Override
    public void filter(ContainerRequestContext requestContext) {
        if (requestContext.getUriInfo().getPath().startsWith("/api/protected")) {
            try {
                verifyPayload(jwt);

                // JWT をコンテキストに保存し、コントローラーでアクセス可能にする
                requestContext.setProperty("auth", jwt);

            } catch (AuthorizationException e) {
                requestContext.abortWith(
                    jakarta.ws.rs.core.Response.status(e.getStatusCode())
                        .entity("{\"error\": \"" + e.getMessage() + "\"}")
                        .build()
                );
            } catch (Exception e) {
                requestContext.abortWith(
                    jakarta.ws.rs.core.Response.status(401)
                        .entity("{\"error\": \"Invalid token\"}")
                        .build()
                );
            }
        }
    }

    private void verifyPayload(JsonWebToken jwt) {
        // 権限 (Permission) モデルに基づく検証ロジックをここに実装してください
        // この内容は下記の権限 (Permission) モデルのセクションで説明します
    }
}
```

  </TabItem>
  <TabItem value="micronaut" label="Micronaut">

```java title="application.yml"
micronaut:
  security:
    authentication: bearer
    token:
      jwt:
        signatures:
          jwks:
            logto:
              url: ${JWKS_URI:https://your-tenant.logto.app/oidc/jwks}
```

```java title="JwtClaimsValidator.java"
import io.micronaut.security.token.Claims;
import io.micronaut.security.token.validator.TokenValidator;
import jakarta.inject.Singleton;
import org.reactivestreams.Publisher;
import reactor.core.publisher.Mono;

@Singleton
public class JwtClaimsValidator implements TokenValidator {

    @Override
    public Publisher<Boolean> validateToken(String token, Claims claims) {
        return Mono.fromCallable(() -> {
            try {
                verifyPayload(claims);
                return true;
            } catch (AuthorizationException e) {
                throw new RuntimeException(e.getMessage());
            }
        });
    }

    private void verifyPayload(Claims claims) {
        // 権限 (Permission) モデルに基づく検証ロジックをここに実装してください
        // この内容は下記の権限 (Permission) モデルのセクションで説明します
    }
}
```

  </TabItem>
  <TabItem value="vertx-web" label="Vert.x Web">

```java title="JwtAuthHandler.java"
import io.vertx.core.Future;
import io.vertx.core.Handler;
import io.vertx.core.json.JsonObject;
import io.vertx.ext.auth.jwt.JWTAuth;
import io.vertx.ext.auth.jwt.JWTAuthOptions;
import io.vertx.ext.web.RoutingContext;
import io.vertx.ext.web.client.WebClient;

public class JwtAuthHandler implements Handler<RoutingContext> {

    private final JWTAuth jwtAuth;
    private final WebClient webClient;

    public JwtAuthHandler(io.vertx.core.Vertx vertx) {
        this.webClient = WebClient.create(vertx);
        this.jwtAuth = JWTAuth.create(vertx, new JWTAuthOptions());

        // JWKS を取得し、JWT 認証を設定
        fetchJWKS().onSuccess(jwks -> {
            // JWKS を設定（簡略化 - 適切な JWKS パーサーが必要な場合があります）
        });
    }

    @Override
    public void handle(RoutingContext context) {
        String authHeader = context.request().getHeader("Authorization");
        if (authHeader == null || !authHeader.startsWith("Bearer ")) {
            context.response()
                .setStatusCode(401)
                .putHeader("Content-Type", "application/json")
                .end("{\"error\": \"Authorization header missing or invalid\"}");
            return;
        }

        String token = authHeader.substring(7);
        jwtAuth.authenticate(new JsonObject().put("token", token))
            .onSuccess(user -> {
                try {
                    JsonObject principal = user.principal();
                    verifyPayload(principal);

                    // JWT principal をコンテキストに保存し、ハンドラーでアクセス可能にする
                    context.put("auth", principal);
                    context.next();

                } catch (AuthorizationException e) {
                    context.response()
                        .setStatusCode(e.getStatusCode())
                        .putHeader("Content-Type", "application/json")
                        .end("{\"error\": \"" + e.getMessage() + "\"}");
                } catch (Exception e) {
                    context.response()
                        .setStatusCode(401)
                        .putHeader("Content-Type", "application/json")
                        .end("{\"error\": \"Invalid token\"}");
                }
            })
            .onFailure(err -> {
                context.response()
                    .setStatusCode(401)
                    .putHeader("Content-Type", "application/json")
                    .end("{\"error\": \"Invalid token\"}");
            });
    }

    private Future<JsonObject> fetchJWKS() {
        return webClient.getAbs(AuthConstants.JWKS_URI)
            .send()
            .map(response -> response.bodyAsJsonObject());
    }

    private void verifyPayload(JsonObject principal) {
        // 権限 (Permission) モデルに基づく検証ロジックをここに実装してください
        // この内容は下記の権限 (Permission) モデルのセクションで説明します
    }
}
```

  </TabItem>
</Tabs>

権限 (Permission) モデルに応じて、異なる検証ロジックを採用する必要があります：

<Tabs groupId="permission-models">
<TabItem value="global-api-resources" label="グローバル API リソース">

<Tabs groupId="api-framework">
  <TabItem value="spring-boot" label="Spring Boot">

```java title="JwtValidator.java"
private void verifyPayload(Jwt jwt) {
    // audience クレームが API リソースインジケーターと一致するか確認
    List<String> audiences = jwt.getAudience();
    if (!audiences.contains("https://your-api-resource-indicator")) {
        throw new AuthorizationException("Invalid audience");
    }

    // グローバル API リソースに必要なスコープを確認
    List<String> requiredScopes = Arrays.asList("api:read", "api:write"); // 実際の必要スコープに置き換えてください
    String scopes = jwt.getClaimAsString("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient scope");
    }
}
```

  </TabItem>
  <TabItem value="quarkus" label="Quarkus">

```java title="JwtVerificationFilter.java"
private void verifyPayload(JsonWebToken jwt) {
    // audience クレームが API リソースインジケーターと一致するか確認
    if (!jwt.getAudience().contains("https://your-api-resource-indicator")) {
        throw new AuthorizationException("Invalid audience");
    }

    // グローバル API リソースに必要なスコープを確認
    List<String> requiredScopes = Arrays.asList("api:read", "api:write"); // 実際の必要スコープに置き換えてください
    String scopes = jwt.getClaim("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient scope");
    }
}
```

  </TabItem>
  <TabItem value="micronaut" label="Micronaut">

```java title="JwtClaimsValidator.java"
private void verifyPayload(Claims claims) {
    // audience クレームが API リソースインジケーターと一致するか確認
    List<String> audiences = (List<String>) claims.get("aud");
    if (audiences == null || !audiences.contains("https://your-api-resource-indicator")) {
        throw new AuthorizationException("Invalid audience");
    }

    // グローバル API リソースに必要なスコープを確認
    List<String> requiredScopes = Arrays.asList("api:read", "api:write"); // 実際の必要スコープに置き換えてください
    String scopes = (String) claims.get("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient scope");
    }
}
```

  </TabItem>
  <TabItem value="vertx-web" label="Vert.x Web">

```java title="JwtAuthHandler.java"
private void verifyPayload(JsonObject principal) {
    // audience クレームが API リソースインジケーターと一致するか確認
    JsonArray audiences = principal.getJsonArray("aud");
    if (audiences == null || !audiences.contains("https://your-api-resource-indicator")) {
        throw new AuthorizationException("Invalid audience");
    }

    // グローバル API リソースに必要なスコープを確認
    List<String> requiredScopes = Arrays.asList("api:read", "api:write"); // 実際の必要スコープに置き換えてください
    String scopes = principal.getString("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient scope");
    }
}
```

  </TabItem>
</Tabs>

</TabItem>
<TabItem value="organization-permissions" label="組織 (Organization)（非 API）権限">

<Tabs groupId="api-framework">
  <TabItem value="spring-boot" label="Spring Boot">

```java title="JwtValidator.java"
private void verifyPayload(Jwt jwt) {
    // audience クレームが組織 (Organization) 形式と一致するか確認
    List<String> audiences = jwt.getAudience();
    boolean hasOrgAudience = audiences.stream()
        .anyMatch(aud -> aud.startsWith("urn:logto:organization:"));

    if (!hasOrgAudience) {
        throw new AuthorizationException("Invalid audience for organization permissions");
    }

    // 組織 ID がコンテキストと一致するか確認（リクエストコンテキストから取得する必要があります）
    String expectedOrgId = "your-organization-id"; // リクエストコンテキストから取得
    String expectedAud = "urn:logto:organization:" + expectedOrgId;
    if (!audiences.contains(expectedAud)) {
        throw new AuthorizationException("Organization ID mismatch");
    }

    // 必要な組織スコープを確認
    List<String> requiredScopes = Arrays.asList("invite:users", "manage:settings"); // 実際の必要スコープに置き換えてください
    String scopes = jwt.getClaimAsString("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient organization scope");
    }
}
```

  </TabItem>
  <TabItem value="quarkus" label="Quarkus">

```java title="JwtVerificationFilter.java"
private void verifyPayload(JsonWebToken jwt) {
    // audience クレームが組織 (Organization) 形式と一致するか確認
    boolean hasOrgAudience = jwt.getAudience().stream()
        .anyMatch(aud -> aud.startsWith("urn:logto:organization:"));

    if (!hasOrgAudience) {
        throw new AuthorizationException("Invalid audience for organization permissions");
    }

    // 組織 ID がコンテキストと一致するか確認（リクエストコンテキストから取得する必要があります）
    String expectedOrgId = "your-organization-id"; // リクエストコンテキストから取得
    String expectedAud = "urn:logto:organization:" + expectedOrgId;
    if (!jwt.getAudience().contains(expectedAud)) {
        throw new AuthorizationException("Organization ID mismatch");
    }

    // 必要な組織スコープを確認
    List<String> requiredScopes = Arrays.asList("invite:users", "manage:settings"); // 実際の必要スコープに置き換えてください
    String scopes = jwt.getClaim("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient organization scope");
    }
}
```

  </TabItem>
  <TabItem value="micronaut" label="Micronaut">

```java title="JwtClaimsValidator.java"
private void verifyPayload(Claims claims) {
    // audience クレームが組織 (Organization) 形式と一致するか確認
    List<String> audiences = (List<String>) claims.get("aud");
    boolean hasOrgAudience = audiences != null && audiences.stream()
        .anyMatch(aud -> aud.startsWith("urn:logto:organization:"));

    if (!hasOrgAudience) {
        throw new AuthorizationException("Invalid audience for organization permissions");
    }

    // 組織 ID がコンテキストと一致するか確認（リクエストコンテキストから取得する必要があります）
    String expectedOrgId = "your-organization-id"; // リクエストコンテキストから取得
    String expectedAud = "urn:logto:organization:" + expectedOrgId;
    if (!audiences.contains(expectedAud)) {
        throw new AuthorizationException("Organization ID mismatch");
    }

    // 必要な組織スコープを確認
    List<String> requiredScopes = Arrays.asList("invite:users", "manage:settings"); // 実際の必要スコープに置き換えてください
    String scopes = (String) claims.get("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient organization scope");
    }
}
```

  </TabItem>
  <TabItem value="vertx-web" label="Vert.x Web">

```java title="JwtAuthHandler.java"
private void verifyPayload(JsonObject principal) {
    // audience クレームが組織 (Organization) 形式と一致するか確認
    JsonArray audiences = principal.getJsonArray("aud");
    boolean hasOrgAudience = false;
    if (audiences != null) {
        for (Object aud : audiences) {
            if (aud.toString().startsWith("urn:logto:organization:")) {
                hasOrgAudience = true;
                break;
            }
        }
    }

    if (!hasOrgAudience) {
        throw new AuthorizationException("Invalid audience for organization permissions");
    }

    // 組織 ID がコンテキストと一致するか確認（リクエストコンテキストから取得する必要があります）
    String expectedOrgId = "your-organization-id"; // リクエストコンテキストから取得
    String expectedAud = "urn:logto:organization:" + expectedOrgId;
    if (!audiences.contains(expectedAud)) {
        throw new AuthorizationException("Organization ID mismatch");
    }

    // 必要な組織スコープを確認
    List<String> requiredScopes = Arrays.asList("invite:users", "manage:settings"); // 実際の必要スコープに置き換えてください
    String scopes = principal.getString("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient organization scope");
    }
}
```

  </TabItem>
</Tabs>

</TabItem>
<TabItem value="organization-level-api-resources" label="組織レベルの API リソース">

<Tabs groupId="api-framework">
  <TabItem value="spring-boot" label="Spring Boot">

```java title="JwtValidator.java"
private void verifyPayload(Jwt jwt) {
    // audience クレームが API リソースインジケーターと一致するか確認
    List<String> audiences = jwt.getAudience();
    if (!audiences.contains("https://your-api-resource-indicator")) {
        throw new AuthorizationException("Invalid audience for organization-level API resources");
    }

    // 組織 ID がコンテキストと一致するか確認（リクエストコンテキストから取得する必要があります）
    String expectedOrgId = "your-organization-id"; // リクエストコンテキストから取得
    String orgId = jwt.getClaimAsString("organization_id");
    if (!expectedOrgId.equals(orgId)) {
        throw new AuthorizationException("Organization ID mismatch");
    }

    // 組織レベルの API リソースに必要なスコープを確認
    List<String> requiredScopes = Arrays.asList("api:read", "api:write"); // 実際の必要スコープに置き換えてください
    String scopes = jwt.getClaimAsString("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient organization-level API scopes");
    }
}
```

  </TabItem>
  <TabItem value="quarkus" label="Quarkus">

```java title="JwtVerificationFilter.java"
private void verifyPayload(JsonWebToken jwt) {
    // audience クレームが API リソースインジケーターと一致するか確認
    if (!jwt.getAudience().contains("https://your-api-resource-indicator")) {
        throw new AuthorizationException("Invalid audience for organization-level API resources");
    }

    // 組織 ID がコンテキストと一致するか確認（リクエストコンテキストから取得する必要があります）
    String expectedOrgId = "your-organization-id"; // リクエストコンテキストから取得
    String orgId = jwt.getClaim("organization_id");
    if (!expectedOrgId.equals(orgId)) {
        throw new AuthorizationException("Organization ID mismatch");
    }

    // 組織レベルの API リソースに必要なスコープを確認
    List<String> requiredScopes = Arrays.asList("api:read", "api:write"); // 実際の必要スコープに置き換えてください
    String scopes = jwt.getClaim("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient organization-level API scopes");
    }
}
```

  </TabItem>
  <TabItem value="micronaut" label="Micronaut">

```java title="JwtClaimsValidator.java"
private void verifyPayload(Claims claims) {
    // audience クレームが API リソースインジケーターと一致するか確認
    List<String> audiences = (List<String>) claims.get("aud");
    if (audiences == null || !audiences.contains("https://your-api-resource-indicator")) {
        throw new AuthorizationException("Invalid audience for organization-level API resources");
    }

    // 組織 ID がコンテキストと一致するか確認（リクエストコンテキストから取得する必要があります）
    String expectedOrgId = "your-organization-id"; // リクエストコンテキストから取得
    String orgId = (String) claims.get("organization_id");
    if (!expectedOrgId.equals(orgId)) {
        throw new AuthorizationException("Organization ID mismatch");
    }

    // 組織レベルの API リソースに必要なスコープを確認
    List<String> requiredScopes = Arrays.asList("api:read", "api:write"); // 実際の必要スコープに置き換えてください
    String scopes = (String) claims.get("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient organization-level API scopes");
    }
}
```

  </TabItem>
  <TabItem value="vertx-web" label="Vert.x Web">

```java title="JwtAuthHandler.java"
private void verifyPayload(JsonObject principal) {
    // audience クレームが API リソースインジケーターと一致するか確認
    JsonArray audiences = principal.getJsonArray("aud");
    if (audiences == null || !audiences.contains("https://your-api-resource-indicator")) {
        throw new AuthorizationException("Invalid audience for organization-level API resources");
    }

    // 組織 ID がコンテキストと一致するか確認（リクエストコンテキストから取得する必要があります）
    String expectedOrgId = "your-organization-id"; // リクエストコンテキストから取得
    String orgId = principal.getString("organization_id");
    if (!expectedOrgId.equals(orgId)) {
        throw new AuthorizationException("Organization ID mismatch");
    }

    // 組織レベルの API リソースに必要なスコープを確認
    List<String> requiredScopes = Arrays.asList("api:read", "api:write"); // 実際の必要スコープに置き換えてください
    String scopes = principal.getString("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient organization-level API scopes");
    }
}
```

  </TabItem>
</Tabs>

</TabItem>
</Tabs>
