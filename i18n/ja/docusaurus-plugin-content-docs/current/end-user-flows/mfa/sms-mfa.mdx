---
sidebar_position: 4
sidebar_label: MFA のための SMS
---

# MFA のための SMS 認証

Logto は、SMS ベースの多要素認証 (MFA) 機能をサポートしており、ユーザーの登録済み電話番号にワンタイム認証コードを送信することでアカウントのセキュリティを強化します。SMS MFA は第 2 の認証要素として機能し、他の MFA 要素（TOTP、パスキー、バックアップコードなど）と組み合わせて、柔軟な二要素認証オプションを提供できます。

## 概念 \{#concepts}

SMS 認証（電話番号認証とも呼ばれます）は、最も利用しやすい MFA 方法の一つです。携帯電話の普及を活用し、一時的なワンタイム認証コードをテキストメッセージでユーザーのデバイスに直接送信します。追加のソフトウェアインストールが必要なアプリベースの認証器とは異なり、SMS MFA はすべてのモバイルデバイスに標準搭載されている既存のメッセージングインフラを利用するため、ユーザーは特別な設定なしですぐに利用できます。

## MFA のための SMS 認証を設定する \{#configure-sms-verification-for-mfa}

**ステップ 1: SMS コネクターとテンプレートの設定**

1. <CloudLink to="/connectors/passwordless">
     コンソール > コネクター > メールおよび SMS コネクター
   </CloudLink> に移動します
2. 適切な SMS コネクター（Twilio、SMS Aero など）を選択します
3. 接続パラメーターを設定します
4. MFA 用の SMS テンプレートを専用の usageType で設定します
   - MFA 検証用は `MfaVerification` usageType
   - MFA バインド用は `BindMFA` usageType
5. コネクターの動作をテストし、正しくメッセージが配信されることを確認します
6. プロバイダーごとの設定手順は [SMS コネクター](/connectors/sms-connectors) を参照してください

**ステップ 2: MFA のための SMS を有効化する**

1. <CloudLink to="/mfa">コンソール > 多要素認証</CloudLink> に移動します
2. 「SMS 認証コード」要素を有効化します。SMS MFA は他の MFA 要素（TOTP、パスキー、バックアップコード）と組み合わせて利用することを推奨します（単一要素依存の低減のため）。
3. 希望する MFA ポリシー（必須 / 任意）を設定します
4. 設定変更を保存します

:::note 重要な利用上の注意

1. **サインイン方法の制限**：SMS 認証コードは [サインイン方法 (1FA)](/end-user-flows/sign-up-and-sign-in/sign-in) と MFA 要素 (2FA) の両方として同時に利用できません。SMS 実装ごとに 1 つの認証フローを選択してください。

2. **サインアップ方法の互換性**：SMS 認証コードはサインアップ方法と MFA の両方で同時に利用できます。Logto は選択した MFA ポリシーに基づき、同じ電話番号で 2 回 SMS 認証を要求しないようエンドユーザー登録フローを最適化します。

3. **パスワードリカバリーとの互換性**：SMS 認証コードは [パスワードを忘れた場合](/end-user-flows/sign-up-and-sign-in/reset-password) と MFA の両方で同時に利用できますが、この組み合わせは **推奨されません**。この設定では、ユーザーがパスワードリセット用の SMS 認証を利用してパスワードを変更し、その後新しいパスワードで 1FA、同じ SMS 方法で MFA 検証を行うことで MFA を回避できる可能性があり、MFA のセキュリティ効果が低下します。

:::

## SMS MFA 設定フロー \{#sms-mfa-setup-flows}

MFA 設定プロンプトは、ユーザー登録時またはサインイン後に表示されます（設定した [MFA ポリシー](/end-user-flows/mfa/configure-mfa#global-mfa-configuration) による）。また、ユーザーは [アカウント設定ページ](/end-user-flows/account-settings/by-account-api#manage-phone) から SMS MFA を有効化できます。

SMS MFA 設定フローは以下の要素に影響されます：

- **MFA 主要要素の数**：主要要素が複数ある場合、ユーザーはどれを設定するか選択する必要があります。主要要素とはバックアップコード以外の MFA 方法です。
- **バックアップコードの有効化**：有効化されている場合、主要 MFA 要素の設定後に自動でバックアップコードが生成され、ユーザーに保存を促します。
- **サインアップ識別子の設定**：電話番号が [サインアップ識別子](/end-user-flows/sign-up-and-sign-in/sign-up#set-up-the-sign-up-identifier) として利用され、登録時に SMS 認証コードで既に認証済みの場合、その番号は自動的に MFA 要素としてバインドされ、追加認証は不要です。他の主要要素が存在する場合、UI には「2 段階認証を追加」オプションが表示され（スキップ可能）、MFA が有効であることも明示されます。
- **既存ユーザーデータ**：既存ユーザーがサインイン後に MFA を設定する場合、まず主要認証を完了し、その後 MFA 設定に進みます。アカウントに既に認証済みの主要電話番号がある場合、上記サインアップ識別子の場合と同様の挙動となります。

以下は、よくある SMS MFA バインドシナリオ 3 例です。

### シナリオ 1: 電話番号を MFA のみに利用（典型的なフロー） \{#scenario-1-phone-number-only-used-for-mfa-typical-flow}

電話番号がサインアップ識別子ではなく、MFA のみで利用する場合は標準の設定手順に従います：

- SMS MFA 要素が 1 つだけの場合、その要素の設定 UI を直接表示します。
- 主要 MFA 要素が複数ある場合、「MFA を設定」リストページを表示し、ユーザーにどの要素を設定するか選択させます。

**例：**

<details>
  <summary>
    サインアップ: `メールアドレス + メール認証コード + パスワード` | MFA: `SMS 認証コード +
    バックアップコード`
  </summary>
  <img src="/img/assets/sms-mfa-setup-scenario-1-1.png" alt="SMS MFA 設定フロー 1-1" />
</details>

<details>
  <summary>
    サインアップ: `メールアドレス + メール認証コード + パスワード` | MFA: `SMS 認証コード + パスキー
    + 認証アプリ OTP + バックアップコード`
  </summary>
  <img src="/img/assets/sms-mfa-setup-scenario-1-2.png" alt="SMS MFA 設定フロー 1-2" />
</details>

### シナリオ 2: 電話番号がサインアップ識別子として認証済み \{#scenario-2-phone-verified-as-the-sign-up-identifier}

電話番号がサインアップ識別子で、登録時に SMS コードで既に認証済みの場合、その番号は MFA 要素として自動バインドされ、追加認証は不要です。

**例：**

<details>
  <summary>
    サインアップ: `電話番号 + SMS 認証コード + パスワード` | MFA: `SMS 認証コード +
    バックアップコード`
  </summary>
  <img src="/img/assets/sms-mfa-setup-scenario-2.png" alt="SMS MFA 設定フロー 2" />
</details>

### シナリオ 3: 電話番号は認証済みだが主要要素が複数ある場合 \{#scenario-3-phone-verified-but-multiple-primary-factors-available}

電話番号がサインアップ時に認証済み（サインアップ識別子として）で、かつアカウントに複数の主要 MFA 要素（例：SMS + パスキーや認証アプリ）がある場合、UI で「2 段階認証を追加」プロンプトが表示されます。ユーザーは追加要素を設定するかスキップできます。このプロンプトは MFA が既に有効であることも伝えます。

**例：**

<details>
  <summary>
    サインアップ: `電話番号 + SMS 認証コード + パスワード` | MFA: `SMS 認証コード + パスキー +
    認証アプリ OTP + バックアップコード`
  </summary>
  <img src="/img/assets/sms-mfa-setup-scenario-3.png" alt="SMS MFA 設定フロー 3" />
</details>

## SMS MFA 認証フロー \{#sms-mfa-verification-flows}

SMS MFA が有効なユーザーがサインインする際、主要認証 (1FA) を正常に完了した後、第 2 の認証要素 (2FA) として SMS 認証コードによる本人確認が求められます。

複数の MFA 要素が利用可能な場合、ユーザーは設定済みの要素から選択できます。どの MFA 要素を最初にプロンプトするかは [MFA 設定](/end-user-flows/mfa/configure-mfa#mfa-verification-flow) で指定した優先順位に従います。

**例：**

<details>
  <summary>
    サインイン: `メールアドレス + パスワード` | MFA: `SMS 認証コード（前回利用） / 認証アプリ OTP /
    バックアップコード`
  </summary>
  <img src="/img/assets/sms-mfa-verification-flow.png" alt="SMS MFA 認証フロー" />
</details>

## エラー処理 \{#error-handling}

1. **電話番号がバインドされていない**

   - エラーコード: `session.mfa.mfa_factor_not_enabled`
   - 対応: まず電話番号をバインドするよう案内

2. **認証コードが間違っている**

   - エラーコード: `verification_code.code_mismatch`
   - 対応: 再入力を促し、再試行回数を制限

3. **認証コードの有効期限切れ**

   - エラーコード: `verification_code.expired`
   - 対応: 新しい認証コードの再送信を促す

4. **送信レート制限超過**
   - エラーコード: `connector.rate_limit_exceeded`
   - 対応: 待機時間を表示し、再送信を制限
