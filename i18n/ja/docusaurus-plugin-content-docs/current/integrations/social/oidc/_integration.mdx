## OIDC アプリの作成 \{#create-your-oidc-app}

このページを開いた時点で、接続したいソーシャルアイデンティティプロバイダーが決まっていることを前提としています。最初に行うべきことは、そのアイデンティティプロバイダーが OIDC プロトコルをサポートしているかを確認することです。これは有効なコネクターを構成するための前提条件です。その後、アイデンティティプロバイダーの手順に従って、OIDC 認可用の関連アプリを登録・作成してください。

## コネクターの構成 \{#configure-your-connector}

セキュリティ上の理由から「認可コード (Authorization Code)」グラントタイプのみをサポートしており、これは Logto のシナリオに完全に適合します。

`clientId` と `clientSecret` は OIDC アプリの詳細ページで確認できます。

_clientId_：クライアント ID は、認可サーバーへの登録時にクライアントアプリケーションを識別する一意の識別子です。この ID は、認可サーバーがクライアントアプリケーションのアイデンティティを確認し、発行されたアクセス トークンを特定のクライアントアプリケーションに関連付けるために使用されます。

_clientSecret_：クライアントシークレットは、登録時に認可サーバーからクライアントアプリケーションに発行される秘密鍵です。クライアントアプリケーションは、この秘密鍵を使用して、アクセス トークンを要求する際に認可サーバーに対して自身を認証します。クライアントシークレットは機密情報と見なされ、常に安全に保管する必要があります。

_tokenEndpointAuthMethod_：トークンエンドポイント認証方式は、クライアントアプリケーションがアクセス トークンを要求する際に認可サーバーに対して自身を認証するために使用されます。サポートされている方式を確認するには、OAuth 2.0 サービスプロバイダーの OpenID Connect ディスカバリエンドポイントで利用可能な `token_endpoint_auth_methods_supported` フィールドを参照するか、OAuth 2.0 サービスプロバイダーが提供する関連ドキュメントを参照してください。

_clientSecretJwtSigningAlgorithm (オプション)_：`tokenEndpointAuthMethod` が `client_secret_jwt` の場合のみ必要です。クライアントシークレット JWT 署名アルゴリズムは、トークンリクエスト時にクライアントアプリケーションが認可サーバーに送信する JWT に署名するために使用されます。

_scope_：スコープパラメーターは、クライアントアプリケーションがアクセスを要求するリソースと権限のセットを指定するために使用されます。スコープパラメーターは通常、特定の権限を表す値をスペース区切りで並べたリストとして定義されます。例えば、スコープ値が "read write" の場合、クライアントアプリケーションがユーザーデータの読み取りおよび書き込みアクセスを要求していることを示します。

`authorizationEndpoint`、`tokenEndpoint`、`jwksUri`、`issuer` は、OpenID プロバイダーの構成情報として見つけることが期待されます。これらはソーシャルベンダーのドキュメントで確認できるはずです。

_authenticationEndpoint_：このエンドポイントは認証 (Authentication) プロセスを開始するために使用されます。認証 (Authentication) プロセスは通常、ユーザーがログインし、クライアントアプリケーションがリソースへのアクセスを許可することを含みます。

_tokenEndpoint_：このエンドポイントは、クライアントアプリケーションが要求されたリソースにアクセスするために使用できる ID トークンを取得するために使用されます。クライアントアプリケーションは通常、トークンエンドポイントにグラントタイプと認可コードを含むリクエストを送信し、ID トークンを受け取ります。

_jwksUri_：これは、ソーシャルアイデンティティプロバイダー（略して IdP）の JSON Web Key Set (JWKS) を取得できる URL エンドポイントです。JWKS は、IdP が認証 (Authentication) プロセス中に発行する JSON Web Token (JWT) に署名および検証するために使用する暗号鍵のセットです。`jwksUri` は、リライングパーティ (RP) が IdP によって署名された JWT の公開鍵を取得するために使用され、RP は IdP から受け取った JWT の真正性と完全性を検証できます。

_issuer_：これは、RP が IdP から受け取った JWT を検証するために使用する IdP の一意の識別子です。JWT には `iss` [クレーム](https://www.rfc-editor.org/rfc/rfc7519#section-4) として含まれています（ID トークンは常に JWT です）。issuer の値は、IdP の認可サーバーの URL と一致する必要があり、RP が信頼する URI である必要があります。RP が JWT を受け取ると、`iss` クレームを確認して、それが信頼できる IdP によって発行されたものであり、RP で使用することを意図していることを確認します。

`jwksUri` と `issuer` を組み合わせることで、RP は認証 (Authentication) プロセス中にエンドユーザーのアイデンティティを安全に検証できます。`jwksUri` から取得した公開鍵を使用して、RP は IdP が発行した JWT の真正性と完全性を検証できます。issuer の値により、RP は信頼できる IdP によって発行された JWT のみを受け入れ、JWT が RP で使用されることを保証します。

認証リクエストは常に必要なため、`authRequestOptionalConfig` でオプション設定をまとめて指定できます。詳細は [OIDC 認証リクエスト](https://openid.net/specs/openid-connect-core-1_0.html#AuthRequest) を参照してください。また、この設定に `nonce` が含まれていないことに気付くかもしれません。`nonce` は各リクエストごとに一意である必要があるため、nonce の生成はコード実装側に任せています。ご安心ください。前述の `jwksUri` と `issuer` も `idTokenVerificationConfig` に含まれています。

標準の OIDC プロトコルがインプリシットフローやハイブリッドフローもサポートしているのに、Logto コネクターが認可フローのみをサポートしている理由が気になるかもしれません。インプリシットフローやハイブリッドフローは認可フローよりもセキュリティが低いことが判明しています。Logto はセキュリティを重視しているため、多少利便性が劣るものの、ユーザーに最高レベルのセキュリティを提供するために認可フローのみをサポートしています。

`responseType` と `grantType` は「認可コード (Authorization Code)」フローでのみ固定値となるため、オプション扱いとし、デフォルト値が自動的に設定されます。

:::note

すべてのフロータイプに対して、カスタマイズパラメーターを格納するためのオプションの `customConfig` キーを用意しています。
各ソーシャルアイデンティティプロバイダーは OIDC 標準プロトコルに独自のバリエーションを持つ場合があります。ご希望のソーシャルアイデンティティプロバイダーが OIDC 標準プロトコルに厳密に準拠している場合、`customConfig` を気にする必要はありません。

:::

## 設定タイプ \{#config-types}

| 名前                      | 型                        | 必須  |
| ------------------------- | ------------------------- | ----- |
| scope                     | string                    | True  |
| clientId                  | string                    | True  |
| clientSecret              | string                    | True  |
| authorizationEndpoint     | string                    | True  |
| tokenEndpoint             | string                    | True  |
| idTokenVerificationConfig | IdTokenVerificationConfig | True  |
| authRequestOptionalConfig | AuthRequestOptionalConfig | False |
| customConfig              | Record\<string, string>   | False |

| AuthRequestOptionalConfig のプロパティ | 型     | 必須  |
| -------------------------------------- | ------ | ----- |
| responseType                           | string | False |
| tokenEndpoint                          | string | False |
| responseMode                           | string | False |
| display                                | string | False |
| prompt                                 | string | False |
| maxAge                                 | string | False |
| uiLocales                              | string | False |
| idTokenHint                            | string | False |
| loginHint                              | string | False |
| acrValues                              | string | False |

| IdTokenVerificationConfig のプロパティ | 型                                 | 必須  |
| -------------------------------------- | ---------------------------------- | ----- |
| jwksUri                                | string                             | True  |
| issuer                                 | string \| string[]                 | False |
| audience                               | string \| string[]                 | False |
| algorithms                             | string[]                           | False |
| clockTolerance                         | string \| number                   | False |
| crit                                   | Record\<string, string \| boolean> | False |
| currentDate                            | Date                               | False |
| maxTokenAge                            | string \| number                   | False |
| subject                                | string                             | False |
| typ                                    | string                             | False |

`IdTokenVerificationConfig` の詳細については [こちら](https://github.com/panva/jose/blob/main/docs/jwt/verify/interfaces/JWTVerifyOptions.md) を参照してください。

## 一般設定 \{#general-settings}

ここでは、アイデンティティプロバイダーへの接続を妨げることはありませんが、エンドユーザーの認証 (Authentication) 体験に影響を与える可能性のある一般的な設定を紹介します。

### ソーシャルボタンの名前とロゴ \{#social-button-name-and-logo}

ログインページにソーシャルボタンを表示したい場合は、ソーシャルアイデンティティプロバイダーの **名前** と **ロゴ**（ダークモード・ライトモード）を設定できます。これにより、ユーザーがソーシャルログインオプションを認識しやすくなります。

### アイデンティティプロバイダー名 \{#identity-provider-name}

各ソーシャルコネクターには、ユーザーアイデンティティを区別するための一意のアイデンティティプロバイダー (IdP) 名があります。一般的なコネクターは固定の IdP 名を使用しますが、カスタムコネクターは一意の値が必要です。詳細は [IdP 名について](https://docs.logto.io/connectors/connector-data-structure#target-identity-provider-name) をご覧ください。

### プロフィール情報の同期 \{#sync-profile-information}

OIDC コネクターでは、ユーザー名やアバターなどのプロフィール情報の同期ポリシーを設定できます。以下から選択可能です：

- **サインアップ時のみ同期**：ユーザーが初めてサインインしたときにプロフィール情報を一度だけ取得します。
- **サインイン時に常に同期**：ユーザーがサインインするたびにプロフィール情報を更新します。

### サードパーティ API へのトークン保存（オプション） \{#store-tokens-to-access-third-party-apis-optional}

アイデンティティプロバイダーの API にアクセスし、ユーザーの認可のもとで操作（ソーシャルサインインやアカウント連携経由）を行いたい場合、Logto は特定の API スコープを取得し、トークンを保存する必要があります。

1. 上記の手順に従い、**scope** フィールドに必要なスコープを追加します
2. Logto OIDC コネクターで **API への永続的なトークン保存** を有効にします。Logto はアクセス トークンを Secret Vault に安全に保存します。
3. **標準** の OAuth/OIDC アイデンティティプロバイダーの場合、リフレッシュ トークンを取得するには `offline_access` スコープを含める必要があり、ユーザーへの同意プロンプトの繰り返しを防ぎます。

:::warning
クライアントシークレットは安全に保管し、クライアントサイドのコードで絶対に公開しないでください。漏洩した場合は、アイデンティティプロバイダーのアプリ設定で直ちに新しいものを発行してください。
:::

## OIDC コネクターの活用 \{#utilize-the-oidc-connector}

OIDC コネクターを作成し、アイデンティティプロバイダーと接続したら、エンドユーザーフローに組み込むことができます。ニーズに合ったオプションを選択してください：

### ソーシャルサインインボタンの有効化 \{#enable-social-sign-in-button}

1. Logto コンソールで <CloudLink to="/sign-in-experience/sign-up-and-sign-in">サインイン体験 > サインアップとサインイン</CloudLink> に移動します。
2. **ソーシャルサインイン** セクションで OIDC コネクターを追加し、ユーザーがアイデンティティプロバイダーで認証 (Authentication) できるようにします。

[ソーシャルサインイン体験](https://docs.logto.io/end-user-flows/sign-up-and-sign-in/social-sign-in) について詳しく学ぶことができます。

### ソーシャルアカウントの連携・解除 \{#link-or-unlink-a-social-account}

Account API を利用して、アプリ内でサインイン済みユーザーがソーシャルアカウントを連携・解除できるカスタムアカウントセンターを構築できます。[Account API チュートリアルに従う](https://docs.logto.io/end-user-flows/account-settings/by-account-api#link-a-new-social-connection)

:::tip
ソーシャルサインインを有効にせず、アカウント連携や API アクセスのためだけに OIDC コネクターを有効にすることも可能です。
:::

### アイデンティティプロバイダー API へのアクセスと操作 \{#access-identity-provider-apis-and-perform-actions}

アプリケーションは Secret Vault から保存されたアクセス トークンを取得し、アイデンティティプロバイダーの API を呼び出してバックエンドタスクを自動化できます。具体的な機能は、アイデンティティプロバイダーと要求したスコープによって異なります。API アクセス用の保存トークン取得ガイドを参照してください。

## ユーザーのソーシャルアイデンティティ管理 \{#manage-user-s-social-identity}

ユーザーがソーシャルアカウントを連携した後、管理者は Logto コンソールでその接続を管理できます：

1. <CloudLink to="/users">Logto コンソール > ユーザー管理</CloudLink>
   に移動し、ユーザーのプロフィールを開きます。
2. **ソーシャル接続** セクションでアイデンティティプロバイダー項目を見つけ、**管理** をクリックします。
3. このページで管理者はユーザーのソーシャル接続を管理し、ソーシャルアカウントから付与・同期されたすべてのプロフィール情報やアクセス トークンの状態を確認できます。

:::note
一部のアイデンティティプロバイダーのアクセス トークンレスポンスには、特定のスコープ情報が含まれていない場合があります。そのため、Logto ではユーザーが付与した権限リストを直接表示できません。ただし、ユーザーが認可時に要求されたスコープに同意していれば、アプリケーションは OIDC API にアクセスする際に対応する権限を持ちます。
:::
