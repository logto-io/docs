## ステップ 1: Facebook App Dashboard でアプリをセットアップする \{#step-1-set-up-an-app-on-facebook-app-dashboard}

Facebook を認証 (Authentication) プロバイダーとして利用する前に、Facebook デベロッパープラットフォームでアプリをセットアップし、OAuth 2.0 資格情報を取得する必要があります。

1. まだアカウントがない場合は、 [Facebook デベロッパーとして登録](https://developers.facebook.com/docs/development/register/) してください。
2. [アプリ](https://developers.facebook.com/apps) ページにアクセスします。
3. 既存のアプリをクリックするか、必要に応じて [新しいアプリを作成](https://developers.facebook.com/docs/development/create-an-app) します。

:::tip
ユースケースは、アプリが Meta とどのようにやり取りするかの主要な方法であり、アプリで利用可能な API、機能、権限、プロダクトを決定します。ソーシャル認証 (Authentication) のみ（メールアドレスと public_profile の取得）が必要な場合は「Authentication and request data from users with Facebook Login」を選択してください。Facebook API へのアクセスが必要な場合は、希望するユースケースを選択してください。ほとんどのユースケースは、アプリ作成後に「Facebook Login for business」の統合もサポートしています。
:::

4. アプリ作成後、アプリダッシュボードページで **Use cases > Facebook Login > Settings** または **Facebook Login for business > Settings** に移動します。
5. **Valid OAuth Redirect URIs** に Logto の **Callback URI** を入力します（Logto の Facebook コネクターからコピーしてください）。ユーザーが Facebook でサインインした後、ここに認可コード付きでリダイレクトされ、Logto が認証 (Authentication) を完了します。
6. **Use cases** に移動し、ユースケースの **Customize** をクリックしてスコープを追加します。Logto で Facebook サインインを実装するには `email` と `public_profile` の追加を推奨します（必須）。

## ステップ 2: クライアント資格情報で Logto コネクターをセットアップする \{#step-2-set-up-logto-connector-with-client-credentials}

1. Facebook App Dashboard で、サイドバーの **App settings > Basic** をクリックします。
2. パネルに **App ID** と **App secret** が表示されます。
3. App secret 入力欄の横にある **Show** ボタンをクリックして内容を表示し、コピーします。
4. Logto の Facebook コネクター設定を行います：
   - `clientId` フィールドに **App ID** を入力します。
   - `clientSecret` フィールドに **App secret** を入力します。
   - Logto で **Save and Done** をクリックし、アイデンティティシステムと Facebook を接続します。

## ステップ 3: スコープを設定する \{#step-3-configure-scopes}

スコープは、アプリがユーザーから要求する権限を定義し、Facebook アカウントからどのプライベートデータにアクセスできるかを制御します。

### Facebook App Dashboard でスコープを設定する \{#configure-scopes-in-facebook-app-dashboard}

1. **Facebook App Dashboard > Use cases** に移動し、**Customize** ボタンをクリックします。
2. アプリが必要とするスコープのみを追加します。ユーザーは Facebook の同意画面でこれらの権限を確認し、承認します：
   - **認証 (Authentication) 用（必須）**：`email` と `public_profile`
   - **API アクセス用（任意）**：アプリが必要とする追加スコープ（例：Threads API へのアクセスには `threads_content_publish`、`threads_read_replies` など）。利用可能なサービスは [Meta Developer Documentation](https://developers.facebook.com/docs/) を参照してください。

### Logto でスコープを設定する \{#configure-scopes-in-logto}

ニーズに応じて、以下のいずれかの方法を選択してください：

**オプション 1: 追加の API スコープが不要な場合**

- Logto の Facebook コネクターの `Scopes` フィールドを空欄のままにします。
- デフォルトのスコープ `email public_profile` がリクエストされ、Logto が基本的なユーザー情報を正しく取得できます。

**オプション 2: サインイン時に追加スコープをリクエストする場合**

- 必要なすべてのスコープを **Scopes** フィールドにスペース区切りで入力します。
- ここに入力したスコープがデフォルトを上書きするため、必ず認証 (Authentication) 用スコープ `email public_profile` も含めてください。

**オプション 3: 後からインクリメンタルスコープをリクエストする場合**

- ユーザーがサインインした後、フェデレーテッドソーシャル認可 (Authorization) フローを再実行し、ユーザーの保存済みトークンセットを更新することで、必要に応じて追加スコープをリクエストできます。
- これらの追加スコープは Logto の Facebook コネクターの `Scopes` フィールドに入力する必要はなく、Logto の Social Verification API を通じて実現できます。

これらの手順に従うことで、Logto Facebook コネクターはアプリに必要な権限のみをリクエストします。

:::tip
アプリが Facebook API へのアクセスやアクション実行のためにこれらのスコープをリクエストする場合は、Logto Facebook コネクターで **Store tokens for persistent API access** を有効にしてください。詳細は次のセクションを参照してください。
:::

## ステップ 4: 一般設定 \{#step-4-general-settings}

Facebook への接続を妨げることはありませんが、エンドユーザーの認証 (Authentication) 体験に影響する可能性のある一般的な設定を紹介します。

### プロフィール情報の同期 \{#sync-profile-information}

Facebook コネクターでは、ユーザー名やアバターなどのプロフィール情報の同期ポリシーを設定できます。以下から選択してください：

- **サインアップ時のみ同期**：ユーザーが初めてサインインしたときにプロフィール情報を一度だけ取得します。
- **サインイン時に常に同期**：ユーザーがサインインするたびにプロフィール情報を更新します。

### Facebook API へのアクセス用トークンの保存（任意） \{#store-tokens-to-access-facebook-apis-optional}

Facebook API へのアクセスやユーザー認可によるアクション実行（ソーシャルサインインまたはアカウント連携経由）を行いたい場合、Logto は特定の API スコープを取得し、トークンを保存する必要があります。

1. 上記の手順に従って必要なスコープを追加します。
2. Logto Facebook コネクターで **Store tokens for persistent API access** を有効にします。Logto は Facebook アクセストークンを Secret Vault に安全に保存します。

:::note
Facebook はリフレッシュトークンを提供していません。ただし、トークン保存が有効な場合、Logto はユーザー認証 (Authentication) 時に自動的に長期間有効なアクセストークン（60日間）をリクエストします。この期間中、ユーザーは手動でアクセストークンを取り消すことができますが、そうでなければ Facebook API へのアクセスに再認可は不要です。注意：`offline_access` を `Scope` フィールドに追加しないでください。エラーの原因となる場合があります。
:::

## ステップ 5: Facebook のテストユーザーでサインインをテストする（任意） \{#step-5-test-sign-in-with-facebook-s-test-users-optional}

テスト、開発者、管理者ユーザーアカウントを使ってアプリでのサインインをテストできます。また、アプリを公開して任意の Facebook ユーザーがサインインできるようにすることも可能です。

1. Facebook App Dashboard で、サイドバーの **App roles > Test Users** をクリックします。
2. **Create test users** ボタンをクリックしてテストユーザーを作成します。
3. 既存のテストユーザーの **Options** ボタンをクリックすると、「名前とパスワードの変更」などの操作が可能です。

## ステップ 6: Facebook サインイン設定を公開する \{#step-6-publish-facebook-sign-in-settings}

通常、テスト、管理者、開発者ユーザーのみがアプリでサインインできます。プロダクション環境で一般の Facebook ユーザーがアプリでサインインできるようにするには、アプリを公開する必要があります。

1. Facebook App Dashboard で、サイドバーの **Publish** をクリックします。
2. 必要に応じて **Privacy Policy URL** と **User data deletion** フィールドを入力します。
3. 右下の **Save changes** ボタンをクリックします。
4. アプリ上部バーの **Live** スイッチボタンをクリックします。
