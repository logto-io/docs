## WeChat オープンプラットフォームでモバイルアプリを作成する \{#create-a-mobile-app-in-the-wechat-open-platform}

:::tip

すでに完了しているセクションはスキップできます。

:::

### アカウントを作成する \{#create-an-account}

https://open.weixin.qq.com/ を開き、右上の「Sign Up」ボタンをクリックして、サインアッププロセスを完了します。

### モバイルアプリを作成する \{#create-a-mobile-app}

作成したアカウントでサインインします。「Mobile Application」（移动应用）タブで、大きな緑色の「Create a mobile app」（创建移动应用）ボタンをクリックします。

<img src="/img/assets/app-tabs.png" alt="アプリタブ" />

申請フォームに必要な情報を入力しましょう。

<img src="/img/assets/create-mobile-app.png" alt="モバイルアプリ作成" />

#### 基本情報 \{#basic-info}

ほとんどは直感的に入力できますが、いくつかのヒントを紹介します：

- WeChat サインインをテストしたいだけで、アプリが App Store にない場合は、「App is available」セクションで「No」を選択して「App download link」をスキップできます。
- 「App operation flow chart」は少し難しそうに見えます。経験上、シンプルなフローチャートといくつかのアプリのスクリーンショットを用意すると審査通過の可能性が高まります。

「Next step」をクリックして進みます。

#### プラットフォーム情報 \{#platform-info}

iOS と Android のいずれか、または両方のプラットフォームを設定して、Logto と WeChat ネイティブサインインを統合できます。

**iOS アプリ**

「iOS app」（iOS 应用）にチェックを入れ、アプリの対象デバイスタイプも選択します。

<img src="/img/assets/platform.png" alt="アプリプラットフォーム" />

App Store での公開を「No」にした場合は、「AppStore download address」の入力を省略できます。

_Bundle ID_、_Test version Bundle ID_、_Universal Links_ を入力します（実際には 1 つのリンクだけで十分です 😂）。

:::note

_Bundle ID_ と _Test version Bundle ID_ は同じ値でも構いません。

:::

:::tip

WeChat のネイティブサインインにはユニバーサルリンクが必要です。まだ設定していない場合や分からない場合は、 [Apple 公式ドキュメント](https://developer.apple.com/ios/universal-links/) を参照してください。

:::

**Android アプリ**

「Android app」（Android 应用）にチェックを入れます。

<img src="/img/assets/platform-android-app.png" alt="Android アプリプラットフォーム" />

_Application Signing Signature_（应用签名）と _Application Package Name_（应用包名）を入力します。

:::note

署名を取得するにはアプリに署名する必要があります。詳細は [Sign your app](https://developer.android.com/studio/publish/app-signing) を参照してください。

:::

署名が完了したら、`signingReport` タスクを実行して署名情報を取得できます。

```bash
./gradlew your-android-project:signingReport
```

該当ビルドバリアントのレポート内の `MD5` 値が _Application Signing Signature_（应用签名）となりますが、値からセミコロンをすべて削除し、小文字にしてください。

例：`1A:2B:3C:4D` → `1a2b3c4d`

#### 審査結果を待つ \{#waiting-for-the-review-result}

プラットフォーム情報の入力が終わったら、「Submit Review」をクリックして続行します。通常、審査は早く、1～2日以内に終了します。

審査基準は一定ではなく、審査担当者は毎回ランダムに割り当てられているようです。最初はリジェクトされることもありますが、諦めずに現状を説明し、どのように修正すればよいか審査担当者に尋ねてみてください。

## アプリで WeChat ネイティブサインインを有効にする \{#enable-wechat-native-sign-in-in-your-app}

### iOS \{#ios}

アプリに <MainSiteUrl href="/quick-starts/swift">Logto iOS SDK</MainSiteUrl> を統合済みであることを前提とします。この場合、非常にシンプルで、WeChat SDK のドキュメントを読む必要すらありません：

**1. Xcode プロジェクトでユニバーサルリンクと URL スキームを設定する**

Xcode プロジェクト → Signing & Capabilities タブで「Associated Domains」機能を追加し、事前に設定したユニバーサルリンクを追加します。

<img src="/img/assets/universal-link.png" alt="ユニバーサルリンク" />

次に「Info」タブに移動し、WeChat App ID を使って [カスタム URL スキーム](https://developer.apple.com/documentation/xcode/defining-a-custom-url-scheme-for-your-app) を追加します。

<img src="/img/assets/custom-url-scheme.png" alt="カスタム URL スキーム" />

最後に `Info.plist` を開き、`LSApplicationQueriesSchemes` の下に `weixinULAPI` と `weixin` を追加します。

<img src="/img/assets/plist.png" alt="Plist" />

:::note

これらの手順はあまり合理的ではありませんが、私たちが見つけた最小限の動作構成です。詳細は [公式ガイド（魔法のような）](https://developers.weixin.qq.com/doc/oplatform/en/Mobile_App/Access_Guide/iOS.html) を参照してください。

:::

**2. `LogtoSocialPluginWechat` を Xcode プロジェクトに追加する**

フレームワークを追加します：

<img src="/img/assets/add-framework.png" alt="フレームワーク追加" />

そして Build Settings > Linking > Other Linker Flags に `-ObjC` を追加します：

<img src="/img/assets/linker-flags.png" alt="リンカーフラグ" />

:::note

このプラグインには WeChat Open SDK 1.9.2 が含まれています。プラグインをインポートすれば `import WechatOpenSDK` を直接利用できます。

:::

**3. プラグインを `LogtoClient` の初期化オプションに追加する**

```swift
let logtoClient = LogtoClient(
  useConfig: config,
  socialPlugins: [LogtoSocialPluginWechat()]
)
```

**4. `onOpenURL` を適切に処理する**

:::note

`LogtoClient.handle(url:)` 関数は有効化したすべてのネイティブコネクターを処理します。1 回呼び出すだけで十分です。

:::

```swift
// SwiftUI
YourRootView()
  .onOpenURL { url in
      LogtoClient.handle(url: url)
  }

// または AppDelegate
func application(_ app: UIApplication, open url: URL, options: /*...*/) -> Bool {
  LogtoClient.handle(url: url)
}
```

### Android \{#android}

アプリに <MainSiteUrl href="/quick-starts/android">Logto Android SDK</MainSiteUrl> を統合済みであることを前提とします。この場合、非常にシンプルで、WeChat SDK のドキュメントを読む必要すらありません：

**1. プロジェクトに `Wechat Open SDK` を追加する**

`mavenCentral()` リポジトリが Gradle プロジェクトのリポジトリに含まれていることを確認します：

```kotlin
repositories {
  // ...
  mavenCentral()
}
```

Wechat Open SDK を依存関係に追加します：

```kotlin
dependencies {
  // ...
  api("com.tencent.mm.opensdk:wechat-sdk-android:6.8.0")  // kotlin-script
  // または
  api 'com.tencent.mm.opensdk:wechat-sdk-android:6.8.0'   // groovy-script
}
```

**2. プロジェクトに `WXEntryActivity` を導入する**

パッケージルートの下に `wxapi` パッケージを作成し、その中に `WXEntryActivity` を追加します（例：`com.sample.app` の場合）：

```kotlin
// WXEntryActivity.kt
package com.sample.app.wxapi

import io.logto.sdk.android.auth.social.wechat.WechatSocialResultActivity

class WXEntryActivity: WechatSocialResultActivity()
```

```java
// WXEntryActivity.java
package com.sample.app.wxapi

import io.logto.sdk.android.auth.social.wechat.WechatSocialResultActivity

public class WXEntryActivity extends WechatSocialResultActivity {}
```

プロジェクト内での `WXEntryActivity` の最終的な配置は次のようになります（Kotlin の例）：

```bash
src/main/kotlin/com/sample/app/wxapi/WXEntryActivity.kt
```

**3. `AndroidManifest.xml` を修正する**

`AndroidManifest.xml` に次の行を追加します：

```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
  package="com.sample.app">

  <application>
    <!-- 追加する行 -->
    <activity android:name=".wxapi.WXEntryActivity" android:exported="true"/>
  </application>

</manifest>
```
