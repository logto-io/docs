---
sidebar_position: 1
---

# Структура данных пользователя

Пользователи являются основными сущностями в сервисе идентификации. В Logto они включают базовые данные аутентификации на основе протокола [OpenID Connect](https://auth.wiki/openid-connect), а также пользовательские данные.

## Профиль пользователя \{#user-profile}

Каждый пользователь имеет профиль, содержащий [всю информацию о пользователе](#property-reference).

Он состоит из следующих типов данных:

- [Базовые данные](/user-management/user-data#basic-data): это основная информация из профиля пользователя. Она хранит все остальные свойства _пользователя_, кроме социальных `identities` и `custom_data`, такие как идентификатор пользователя, имя пользователя, электронная почта, номер телефона и время последнего входа пользователя.
- [Социальные идентификаторы](/user-management/user-data#social-identities): хранит информацию о пользователе, полученную из социального входа (т.е. вход через социальный коннектор), например, Facebook, GitHub и WeChat.
- [Пользовательские данные](/user-management/user-data#custom-data): хранит дополнительную информацию о пользователе, не указанную в предопределенных свойствах пользователя, такую как предпочитаемый цвет и язык пользователя.

Вот пример данных пользователя, полученных при входе через Facebook:

```json
{
  "id": "iHXPuSb9eMzt",
  "username": null,
  "primaryEmail": null,
  "primaryPhone": null,
  "name": "John Doe",
  "avatar": "https://example.com/avatar.png",
  "customData": {
    "preferences": {
      "language": "en",
      "color": "#f236c9"
    }
  },
  "identities": {
    "facebook": {
      "userId": "106077000000000",
      "details": {
        "id": "106077000000000",
        "name": "John Doe",
        "email": "johndoe@logto.io",
        "avatar": "https://example.com/avatar.png"
      }
    }
  },
  "lastSignInAt": 1655799453171,
  "applicationId": "admin_console"
}
```

Вы можете запросить профиль пользователя, используя <CloudLink to="/users">Logto Console</CloudLink> или Logto Management API, например, [`GET /api/users/:userId`](https://openapi.logto.io/operation/operation-getuser).

## Базовые данные \{#basic-data}

Давайте рассмотрим все свойства _базовых данных_ пользователя.

### id \{#id}

_id_ — это уникальный автоматически сгенерированный ключ для идентификации пользователя в Logto.

### username \{#username}

_username_ используется для входа с _username_ и паролем.

Его значение берется из имени пользователя, с которым пользователь впервые зарегистрировался. Оно может быть `null`. Его ненулевое значение не должно превышать 128 символов, содержать только буквы, цифры и подчеркивания (`_`), и НЕ начинаться с цифры. Оно чувствительно к регистру.

### primary_email \{#primary_email}

_primary_email_ — это адрес электронной почты пользователя, используемый для входа с электронной почтой и паролем / кодом подтверждения.

Его значение обычно берется из адреса электронной почты, с которым пользователь впервые зарегистрировался. Оно может быть `null`. Его максимальная длина — 128.

### primary_phone \{#primary_phone}

_primary_phone_ — это номер телефона пользователя, используемый для входа с номером телефона и паролем / кодом подтверждения из SMS.

Его значение обычно берется из номера телефона, с которым пользователь впервые зарегистрировался. Оно может быть `null`. Его ненулевое значение должно содержать цифры с префиксом [кода страны](https://en.wikipedia.org/wiki/List_of_country_calling_codes) (исключая знак плюс `+`).

### name \{#name}

_name_ — это полное имя пользователя. Его максимальная длина — 128.

### avatar \{#avatar}

_avatar_ — это URL, указывающий на изображение аватара пользователя. Его максимальная длина — 2048.

Если пользователь регистрируется через социальный коннектор, такой как Google или Facebook, его значение может быть получено из социальной информации о пользователе.

:::note

Это свойство сопоставляется с утверждением `picture` в стандарте [OpenID Connect](https://openid.net/connect/).

:::

### profile \{#profile}

_profile_ хранит дополнительные стандартные утверждения [OpenID Connect](https://openid.net/specs/openid-connect-core-1_0.html#StandardClaims), которые не включены в свойства пользователя.

Его определение типа можно найти в [этом файле](https://github.com/logto-io/logto/blob/HEAD/packages/schemas/src/foundations/jsonb-types/users.ts#L6). Вот копия определения типа:

```tsx
type UserProfile = Partial<{
  familyName: string;
  givenName: string;
  middleName: string;
  nickname: string;
  preferredUsername: string;
  profile: string;
  website: string;
  gender: string;
  birthdate: string;
  zoneinfo: string;
  locale: string;
  address: Partial<{
    formatted: string;
    streetAddress: string;
    locality: string;
    region: string;
    postalCode: string;
    country: string;
  }>;
}>;
```

:::note

`Partial` означает, что все свойства являются необязательными.

:::

Отличие от других стандартных утверждений заключается в том, что свойства в `profile` будут включены в [ID токен](https://auth.wiki/id-token) или ответ конечной точки userinfo только тогда, когда их значения не пусты, в то время как другие стандартные утверждения вернут `null`, если значения пусты.

### application_id \{#application_id}

Значение _application_id_ берется из приложения, в которое пользователь впервые вошел. Оно может быть `null`.

### last_sign_in_at \{#last_sign_in_at}

_last_sign_in_at_ — это временная метка с часовым поясом, когда пользователь в последний раз вошел в систему.

### created_at \{#created_at}

_created_at_ — это временная метка с часовым поясом, когда пользователь зарегистрировал учетную запись.

### updated_at \{#updated_at}

_updated_at_ — это временная метка с часовым поясом, когда информация профиля пользователя была обновлена в последний раз.

### has_password \{#has_password}

_has_password_ — это логическое значение, указывающее, есть ли у пользователя пароль. Вы можете просмотреть и управлять этим статусом, включая установку нового или сброс пароля на странице деталей <CloudLink to="/users">Console > User management</CloudLink>.

### password_encrypted \{#password_encrypted}

_password_encrypted_ используется для хранения зашифрованного пароля пользователя.

Его значение берется из пароля, с которым пользователь впервые зарегистрировался. Оно может быть `null`. Если его значение не `null`, его исходное содержимое до шифрования должно быть не менее шести символов.

### password_encryption_method \{#password_encryption_method}

_password_encryption_method_ используется для шифрования пароля пользователя. Его значение инициализируется, когда пользователь регистрируется с именем пользователя и паролем. Оно может быть `null`.

Logto использует реализацию [Argon2](https://en.wikipedia.org/wiki/Argon2) [node-argon2](https://github.com/ranisalt/node-argon2) в качестве метода шифрования по умолчанию; см. справку для получения подробной информации, если вам интересно.

Пример _password_encrypted_ и _password_encryption_method_ от пользователя, чей пароль `123456`:

```json
{
  "password_encryption_method": "Argon2i",
  "password_encrypted": "$argon2i$v=19$m=4096,t=10,p=1$aZzrqpSX45DOo+9uEW6XVw$O4MdirF0mtuWWWz68eyNAt2u1FzzV3m3g00oIxmEr0U"
}
```

### is_suspended \{#is_suspended}

_is_suspended_ — это логическое значение, указывающее, заблокирован ли пользователь или нет. Значение можно управлять, вызывая [Logto Management API](https://openapi.logto.io/operation/operation-updateuserissuspended) или используя Logto Console.

Как только пользователь заблокирован, предварительно выданные токены обновления будут немедленно отозваны, и пользователь больше не сможет пройти аутентификацию через Logto.

### mfa_verification_factors \{#mfa_verification_factors}

_mfa_verification_factors_ — это массив, перечисляющий методы [многофакторной аутентификации](/end-user-flows/mfa) (MFA), связанные с учетной записью пользователя. Возможные значения включают: _Totp_ (OTP приложения-аутентификатора), _WebAuthn_ (Passkey) и _BackupCode_.

```tsx
mfaVerificationFactors: ("Totp" | "WebAuthn" | "BackupCode")[];
```

## Социальные идентификаторы \{#social-identities}

_identities_ содержит информацию о пользователе, полученную из [социального входа](/end-user-flows/sign-up-and-sign-in/social-sign-in) (т.е. вход через [социальный коннектор](/connectors/social-connectors)). Каждое _identities_ пользователя хранится в отдельном JSON-объекте.

Информация о пользователе варьируется в зависимости от провайдера социальной идентификации (т.е. платформы социальной сети) и обычно включает следующее:

- _target_ провайдера идентификации, например, "facebook" или "google"
- Уникальный идентификатор пользователя для этого провайдера
- Имя пользователя
- Подтвержденная электронная почта пользователя
- Аватар пользователя

Учетная запись пользователя может быть связана с несколькими провайдерами социальной идентификации через социальный вход; соответствующая информация о пользователе, полученная от этих провайдеров, будет храниться в объекте _identities_.

Пример _identities_ от пользователя, который вошел через Google и Facebook:

```json
{
  "facebook": {
    "userId": "5110888888888888",
    "details": {
      "id": "5110888888888888",
      "name": "John Doe",
      "email": "johndoe@logto.io",
      "avatar": "https://example.com/avatar.png"
    }
  },
  "google": {
    "userId": "111000000000000000000",
    "details": {
      "id": "111000000000000000000",
      "name": "John Doe",
      "email": "johndoe@gmail.com",
      "avatar": "https://example.com/avatar.png"
    }
  }
}
```

## SSO идентификаторы \{#sso-identities}

_sso_identities_ содержит информацию о пользователе, полученную из [Корпоративного единого входа (SSO)](/end-user-flows/enterprise-sso) (т.е. вход через [корпоративный коннектор](/connectors/enterprise-connectors)). Каждое _ssoIdentities_ пользователя хранится в отдельном JSON-объекте.

Данные, синхронизированные с провайдером SSO, зависят от областей, настроенных в корпоративном коннекторе для запроса. Вот копия определения типа TypeScript:

```ts
type SSOIdentity = {
  issuer: string;
  identityId: string;
  detail: JsonObject; // См. https://github.com/withtyped/withtyped/blob/master/packages/server/src/types.ts#L12
};
```

## Пользовательские данные \{#custom-data}

_custom_data_ хранит дополнительную информацию о пользователе, не указанную в предопределенных свойствах пользователя.

Вы можете использовать _custom_data_ для выполнения следующих действий:

- Записывать, были ли выполнены пользователем определенные действия, такие как просмотр приветственной страницы.
- Хранить данные, специфичные для приложения, в профиле пользователя, такие как предпочитаемый язык и внешний вид пользователя для каждого приложения.
- Поддерживать другие произвольные данные, связанные с пользователем.

Пример _custom_data_ от администратора в Logto:

```json
{
  "adminConsolePreferences": {
    "language": "en",
    "appearanceMode": "system",
    "experienceNoticeConfirmed": true
  },
  "customDataFoo": {
    "foo": "foo"
  },
  "customDataBar": {
    "bar": "bar"
  }
}
```

Каждое _custom_data_ пользователя хранится в отдельном JSON-объекте.

Примечание: НЕ размещайте конфиденциальные данные в _custom_data_.

Вы можете получить профиль пользователя, содержащий _custom_data_, используя [Management API](https://openapi.logto.io/operation/operation-listusercustomdata) и отправить его на фронтенд-приложения или внешние серверные службы. Поэтому размещение конфиденциальной информации в _custom_data_ может привести к утечке данных.

Если вы все же хотите разместить конфиденциальную информацию в _custom_data_, мы рекомендуем сначала зашифровать ее. Шифруйте / расшифровывайте ее только в доверенной стороне, такой как ваши серверные службы, и избегайте этого на фронтенд-приложениях. Это минимизирует потери, если _custom_data_ ваших пользователей будет случайно утечена.

Вы можете обновить _custom_data_ пользователя, используя [Logto Console](/user-management/manage-users/#view-and-update-the-user-profile) или [Logto Management API](/user-management/manage-users/#manage-via-logto-management-api), например, [`PATCH /api/users/:userId`](https://openapi.logto.io/operation/operation-getuser).

Обновляйте осторожно

Обновление _custom_data_ пользователя полностью перезапишет его исходное содержимое в хранилище.

Например, если ваш ввод при вызове API обновления _custom_data_ выглядит так (предположим, что исходное _custom_data_ — это предыдущие показанные примерные данные):

```json
{
  "customDataBaz": {
    "baz": "baz"
  }
}
```

тогда новое значение _custom_data_ после обновления будет:

```json
{
  "customDataBaz": {
    "baz": "baz"
  }
}
```

То есть обновленное значение поля не имеет отношения к предыдущему значению.

## Справочник по свойствам \{#property-reference}

Следующие столбцы таблицы пользователей БД (кроме _password_encrypted_ и _password_encryption_method_) видны в профиле пользователя, что означает, что вы можете запросить их, используя [Management API](https://openapi.logto.io/operation/operation-getuser).

| Имя                                                                                 | Тип       | Описание                                                        | Уникальное | Обязательно |
| ----------------------------------------------------------------------------------- | --------- | --------------------------------------------------------------- | ---------- | ----------- |
| [id](/user-management/user-data#id)                                                 | string    | Уникальный идентификатор                                        | ✅         | ✅          |
| [username](/user-management/user-data#username)                                     | string    | Имя пользователя для входа                                      | ✅         | ❌          |
| [primary_email](/user-management/user-data#primary_email)                           | string    | Основная электронная почта                                      | ✅         | ❌          |
| [primary_phone](/user-management/user-data#primary_phone)                           | string    | Основной номер телефона                                         | ✅         | ❌          |
| [name](/user-management/user-data#name)                                             | string    | Полное имя                                                      | ❌         | ❌          |
| [avatar](/user-management/user-data#avatar)                                         | string    | URL, указывающий на изображение аватара                         | ❌         | ❌          |
| [profile](/user-management/user-data#profile)                                       | object    | Профиль пользователя                                            | ❌         | ✅          |
| [identities](/user-management/user-data#social-identities)                          | object    | Информация о пользователе из социального входа                  | ❌         | ✅          |
| [custom_data](/user-management/user-data#custom-data)                               | object    | Дополнительная информация в настраиваемых свойствах             | ❌         | ✅          |
| [application_id](/user-management/user-data#application_id)                         | string    | ID приложения, в которое пользователь впервые зарегистрировался | ❌         | ✅          |
| [last_sign_in_at](/user-management/user-data#last_sign_in_at)                       | date time | Временная метка последнего входа пользователя                   | ❌         | ✅          |
| [password_encrypted](/user-management/user-data#password_encrypted)                 | string    | Зашифрованный пароль                                            | ❌         | ❌          |
| [password_encryption_method](/user-management/user-data#password_encryption_method) | string    | Метод шифрования пароля                                         | ❌         | ❌          |
| [is_suspended](/user-management/user-data#is_suspended)                             | bool      | Метка блокировки пользователя                                   | ❌         | ✅          |
| [mfa_verifications](/user-management/user-data#mfa_verification_factors)            | object[]  | Факторы проверки MFA                                            | ❌         | ✅          |

- **Уникальное**: Обеспечивает [уникальность](https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-UNIQUE-CONSTRAINTS) значений, введенных в свойство таблицы базы данных.
- **Обязательно**: Обеспечивает, что значения, введенные в свойство таблицы базы данных, не могут быть `null`.

## Связанные ресурсы \{#related-resources}

<Url href="https://blog.logto.io/secure-hub-for-user-data/">
  Безопасный хаб для данных пользователей в движении
</Url>
