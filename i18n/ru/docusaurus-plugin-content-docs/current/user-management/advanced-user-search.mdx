---
sidebar_position: 3
---

# Расширенный поиск пользователей

Прямое использование Management API для использования расширенных условий поиска пользователей.

## Выполнение запроса на поиск \{#perform-a-search-request}

Используйте [`GET /api/users`](https://openapi.logto.io/operation/operation-getuser) для поиска пользователей. Обратите внимание, что это Management API, которое требует аутентификации, как и другие. См. [Взаимодействие с Management API](/integrate-logto/interact-with-management-api) для рецепта взаимодействия.

### Пример \{#sample}

**Запрос**

```bash
curl \
  --location \
  --request GET \
  'http://<your-logto-endpoint>/api/users?search=%25alice%25'

```

**Ответ**

Массив сущностей `User`.

```json
[
  {
    "id": "MgUzzDsyX0iB",
    "username": "alice_123",
    "primaryEmail": "alice@some.email.domain",
    "primaryPhone": null,
    "name": null,
    "avatar": null
    // ...
  }
]
```

### Параметры \{#parameters}

Запрос на поиск состоит из следующих ключей параметров:

- Ключевые слова поиска: `search`, `search.*`
- Режим поиска для полей: `mode`, `mode.*` (значение по умолчанию `'like'`, доступные `['exact', 'like', 'similar_to', 'posix']`)
- Режим соединения: `joint` или `jointMode` (значение по умолчанию `'or'`, доступные `['or', 'and']`)
- Чувствительность к регистру: `isCaseSensitive` (значение по умолчанию `false`)

Этот API имеет [пагинацию](/integrate-logto/interact-with-management-api/#managing-paginated-api-responses).

Давайте рассмотрим их на примерах. Все параметры поиска будут отформатированы как конструктор `URLSearchParams`.

:::warning

Режим поиска по умолчанию установлен на `like`, который использует [приблизительное сопоставление строк](https://en.wikipedia.org/wiki/Approximate_string_matching) ("нечеткий поиск").

:::

:::note

Все режимы нечеткого поиска поддерживают сопоставление только одного значения на поле. Если вам нужно сопоставить несколько значений для одного поля, следует использовать режим "exact". См. [Точное совпадение и чувствительность к регистру](/user-management/advanced-user-search#exact-match-and-case-sensitivity) для подробностей.

:::

### Базовый нечеткий поиск \{#basic-fuzzy-search}

Если вы хотите выполнить нечеткий поиск по всем доступным полям, просто укажите значение для ключа `search`. Он будет использовать [оператор `like`](https://www.postgresql.org/docs/current/functions-matching.html#FUNCTIONS-LIKE):

```javascript
new URLSearchParams([['search', '%foo%']]);
```

Этот поиск будет проходить по всем доступным полям в поиске пользователей, т.е. `id`, `primaryEmail`, `primaryPhone`, `username`, `name`.

### Указание полей \{#specify-fields}

Что если вы хотите ограничить поиск только в `name`? Чтобы найти кого-то, у кого в имени есть `foo`, просто используйте символ `.` для указания поля:

```javascript
new URLSearchParams([['search.name', '%foo%']]);
```

Помните, что вложенные поля не поддерживаются, например, `search.name.first` приведет к ошибке.

Вы также можете указать несколько полей одновременно:

```javascript
new URLSearchParams([
  ['search.name', '%foo%'],
  ['search.primaryEmail', '%@gmail.com'],
]);
```

Это означает поиск пользователей, у которых в имени есть `foo` **ИЛИ** их электронная почта заканчивается на `@gmail.com`.

### Изменение режима соединения \{#changing-the-joint-mode}

Если вы хотите, чтобы API возвращал только результаты, удовлетворяющие ВСЕМ условиям, установите режим соединения на `and`:

```javascript
new URLSearchParams([
  ['search.name', '%foo%'],
  ['search.primaryEmail', '%@gmail.com'],
  ['joint', 'and'],
]);
```

Это означает поиск пользователей, у которых в имени есть `foo` **И** их электронная почта заканчивается на `@gmail.com`.

### Точное совпадение и чувствительность к регистру \{#exact-match-and-case-sensitivity}

Допустим, вы хотите найти тех, чье имя точно "Alice". Вы можете установить `mode.name` для использования точного совпадения.

```javascript
new URLSearchParams([
  ['search.name', 'Alice'],
  ['mode.name', 'exact'],
]);
```

Вы можете заметить, что это имеет тот же эффект при использовании режима `like` (по умолчанию) по сравнению с указанием `exact`. Одно различие заключается в том, что режим `exact` использует `=` для сравнения, в то время как `like` использует `like` или `ilike`. Теоретически `=` должен иметь лучшую производительность.

Кроме того, в режиме `exact` вы можете передавать несколько значений для сопоставления, и они будут соединены с помощью `or`:

```javascript
new URLSearchParams([
  ['search.name', 'Alice'],
  ['search.name', 'Bob'],
  ['mode.name', 'exact'],
]);
```

Это будет соответствовать пользователям с именем "Alice" **ИЛИ** "Bob".

По умолчанию поиск не чувствителен к регистру. Чтобы быть более точным, установите поиск как чувствительный к регистру:

```javascript
new URLSearchParams([
  ['search.name', 'Alice'],
  ['search.name', 'Bob'],
  ['mode.name', 'exact'],
  ['isCaseSensitive', 'true'],
]);
```

Обратите внимание, что `isCaseSensitive` является глобальной настройкой. Таким образом, КАЖДОЕ поле будет следовать ей.

### Регулярное выражение (RegEx) \{#regular-expression-regex}

PostgreSQL поддерживает два типа регулярных выражений, [similar to](https://www.postgresql.org/docs/current/functions-matching.html#FUNCTIONS-SIMILARTO-REGEXP) и [posix](https://www.postgresql.org/docs/current/functions-matching.html#FUNCTIONS-POSIX-REGEXP). Установите `mode` на `similar_to` или `posix` для поиска по регулярным выражениям:

```javascript
new URLSearchParams([
  ['search', '^T.?m Scot+$'],
  ['mode', 'posix'],
]);
```

> Обратите внимание, что режим similar_to работает только в поисках с учетом регистра.

### Переопределение режима сопоставления \{#match-mode-override}

По умолчанию все ключевые слова будут наследовать режим сопоставления от общего поиска:

```javascript
new URLSearchParams([
  ['search', '^T.?m Scot+$'],
  ['mode', 'posix'],
  ['search.primaryEmail', 'tom%'], // Режим Posix
  ['joint', 'and'],
]);
```

Чтобы переопределить для конкретного поля:

```javascript
new URLSearchParams([
  ['search', '^T.?m Scot+$'],
  ['mode', 'posix'],
  ['search.primaryEmail', 'tom%'], // Режим Like
  ['mode.primaryEmail', 'like'],
  ['search.phone', '0{3,}'], // Режим Posix
  ['joint', 'and'],
]);
```
