---
description: Узнайте, как использовать Account API для управления пользователями
sidebar_position: 2
---

# Настройки аккаунта через Account API

## Что такое Logto Account API \{#what-is-logto-account-api}

Logto Account API — это обширный набор API, который предоставляет конечным пользователям прямой доступ к API без необходимости использования Management API. Вот основные моменты:

- Прямой доступ: Account API позволяет конечным пользователям напрямую получать доступ и управлять своим профилем аккаунта без необходимости использования Management API.
- Управление профилем пользователя и идентификациями: Пользователи могут полностью управлять своими профилями и настройками безопасности, включая возможность обновления информации об идентификации, такой как электронная почта, телефон и пароль, а также управление социальными связями. Поддержка MFA и SSO скоро появится.
- Глобальное управление доступом: Администратор имеет полный глобальный контроль над настройками доступа и может настраивать каждое поле.
- Бесшовная авторизация: Авторизация стала проще, чем когда-либо! Просто используйте `client.getAccessToken()`, чтобы получить непрозрачный токен доступа для OP (Logto), и прикрепите его к заголовку Authorization как `Bearer <access_token>`.

С помощью Logto Account API вы можете создать систему управления аккаунтом, такую как страница профиля, полностью интегрированную с Logto.

Некоторые часто используемые функции перечислены ниже:

- Получение профиля пользователя
- Обновление профиля пользователя
- Обновление пароля пользователя
- Обновление идентификаций пользователя, включая электронную почту, телефон и социальные связи

Чтобы узнать больше о доступных API, посетите [Logto Account API Reference](https://openapi.logto.io/group/endpoint-my-account) и [Logto Verification API Reference](https://openapi.logto.io/group/endpoint-verifications).

:::note
Специальные Account API для следующих настроек скоро появятся: MFA, SSO, Пользовательские данные и Удаление аккаунта. В это время вы можете реализовать эти функции, используя Logto Management API. См. [Настройки аккаунта через Management API](/end-user-flows/account-settings/by-management-api) для получения более подробной информации.
:::

## Как включить Account API \{#how-to-enable-account-api}

По умолчанию Account API отключен. Чтобы его включить, вам нужно использовать [Management API](/integrate-logto/interact-with-management-api) для обновления глобальных настроек.

Конечная точка API `/api/account-center` может использоваться для получения и обновления настроек центра аккаунтов, вы можете использовать её для включения или отключения Account API и настройки полей.

Пример запроса:

```bash
curl -X PATCH https://[tenant-id].logto.app/api/account-center \
  -H 'authorization: Bearer <access_token for Logto Management API>' \
  -H 'content-type: application/json' \
  --data-raw '{"enabled":true,"fields":{"username":"Edit"}}'
```

Поле `enabled` используется для включения или отключения Account API, а поле `fields` используется для настройки полей, значение может быть `Off`, `Edit`, `ReadOnly`. Значение по умолчанию — `Off`. Список полей:

- `name`: Поле имени.
- `avatar`: Поле аватара.
- `profile`: Поле профиля, включая его подполе.
- `username`: Поле имени пользователя.
- `email`: Поле электронной почты.
- `phone`: Поле телефона.
- `password`: Поле пароля, при получении вернёт `true`, если пользователь установил пароль, иначе `false`.
- `social`: Социальные связи.

Узнайте больше о деталях API в [Logto Management API Reference](https://openapi.logto.io/group/endpoint-account-center).

## Как получить доступ к Account API \{#how-to-access-account-api}

### Получение токена доступа \{#fetch-an-access-token}

После настройки SDK в вашем приложении вы можете использовать метод `client.getAccessToken()`, чтобы получить токен доступа. Этот токен является непрозрачным токеном, который можно использовать для доступа к Account API.

Если вы не используете официальный SDK, вам следует установить `resource` в пустое значение для запроса на предоставление токена доступа к `/oidc/token`.

### Доступ к Account API с использованием токена доступа \{#access-account-api-using-access-token}

Вы должны поместить токен доступа в поле `Authorization` HTTP-заголовков в формате Bearer (`Bearer YOUR_TOKEN`), когда вы взаимодействуете с Account API.

Пример получения информации об аккаунте пользователя:

```bash
curl https://[tenant-id].logto.app/api/my-account \
  -H 'authorization: Bearer <access_token>'
```

## Управление основной информацией об аккаунте \{#manage-basic-account-information}

### Получение информации об аккаунте пользователя \{#retrieve-user-account-information}

```bash
curl https://[tenant-id].logto.app/api/my-account \
  -H 'authorization: Bearer <access_token>'
```

Тело ответа будет выглядеть следующим образом:

```json
{
  "id": "...",
  "username": "...",
  "name": "...",
  "avatar": "..."
}
```

Поля ответа могут варьироваться в зависимости от настроек центра аккаунтов.

### Обновление основной информации об аккаунте \{#update-basic-account-information}

Основная информация об аккаунте включает имя пользователя, имя, аватар и профиль.

Чтобы обновить имя пользователя, имя и аватар, вы можете использовать конечную точку `PATCH /api/my-account`.

```bash
curl -X PATCH https://[tenant-id].logto.app/api/my-account \
  -H 'authorization: Bearer <access_token>' \
  -H 'content-type: application/json' \
  --data-raw '{"username":"...","name":"...","avatar":"..."}'
```

Чтобы обновить профиль, вы можете использовать конечную точку `PATCH /api/my-account/profile`.

```bash
curl -X PATCH https://[tenant-id].logto.app/api/my-account/profile \
  -H 'authorization: Bearer <access_token>' \
  -H 'content-type: application/json' \
  --data-raw '{"familyName":"...","givenName":"..."}'
```

## Управление идентификаторами и другой конфиденциальной информацией \{#manage-identifiers-and-other-sensitive-information}

По соображениям безопасности Account API требует дополнительного уровня авторизации для операций, связанных с идентификаторами и другой конфиденциальной информацией.

### Получение идентификатора записи проверки \{#get-a-verification-record-id}

Сначала вам нужно получить идентификатор записи проверки, который можно использовать для проверки личности пользователя при обновлении идентификаторов.

Чтобы получить идентификатор записи проверки, вы можете проверить пароль пользователя или отправить код проверки на электронную почту или телефон пользователя.

#### Проверка пароля пользователя \{#verify-the-users-password}

```bash
curl -X POST https://[tenant-id].logto.app/api/verifications/password \
  -H 'authorization: Bearer <access_token>' \
  -H 'content-type: application/json' \
  --data-raw '{"password":"..."}'
```

Тело ответа будет выглядеть следующим образом:

```json
{
  "verificationRecordId": "...",
  "expiresAt": "..."
}
```

#### Проверка с отправкой кода проверки на электронную почту или телефон пользователя \{#verify-by-sending-a-verification-code-to-the-users-email-or-phone}

:::note
Чтобы использовать этот метод, вам нужно [настроить email-коннектор](/connectors/email-connectors/) или [SMS-коннектор](/connectors/sms-connectors/), и убедиться, что шаблон `UserPermissionValidation` настроен.
:::

Возьмем электронную почту в качестве примера, запросите новый код проверки и получите идентификатор записи проверки:

```bash
curl -X POST https://[tenant-id].logto.app/api/verifications/verification-code \
  -H 'authorization: Bearer <access_token>' \
  -H 'content-type: application/json' \
  --data-raw '{"identifier":{"type":"email","value":"..."}}'
```

Тело ответа будет выглядеть следующим образом:

```json
{
  "verificationRecordId": "...",
  "expiresAt": "..."
}
```

После получения кода проверки вы можете использовать его для обновления статуса проверки записи.

```bash
curl -X PATCH https://[tenant-id].logto.app/api/verifications/verification-code/verify \
  -H 'authorization: Bearer <access_token>' \
  -H 'content-type: application/json' \
  --data-raw '{"identifier":{"type":"email","value":"..."},"verificationId":"...","code":"123456"}'
```

После проверки кода вы можете использовать идентификатор записи проверки для обновления идентификатора пользователя.

### Отправка запроса с идентификатором записи проверки \{#send-request-with-verification-record-id}

При отправке запроса на обновление идентификатора пользователя вам нужно прикрепить идентификатор записи проверки к заголовку запроса с полем `logto-verification-id`.

### Обновление или привязка новой электронной почты \{#update-or-link-new-email}

:::note
Чтобы использовать этот метод, вам нужно [настроить email-коннектор](/connectors/email-connectors/), и убедиться, что шаблон `BindNewIdentifier` настроен.
:::

Чтобы обновить или привязать новую электронную почту, сначала нужно подтвердить владение электронной почтой.

Вызовите конечную точку `POST /api/verifications/verification-code`, чтобы запросить код проверки.

```bash
curl -X POST https://[tenant-id].logto.app/api/verifications/verification-code \
  -H 'authorization: Bearer <access_token>' \
  -H 'content-type: application/json' \
  --data-raw '{"identifier":{"type":"email","value":"..."}}'
```

Вы найдете `verificationId` в ответе и получите код проверки на электронную почту, используйте его для проверки электронной почты.

```bash
curl -X PATCH https://[tenant-id].logto.app/api/verifications/verification-code/verify \
  -H 'authorization: Bearer <access_token>' \
  -H 'content-type: application/json' \
  --data-raw '{"identifier":{"type":"email","value":"..."},"verificationId":"...","code":"..."}'
```

После проверки кода вы можете обновить электронную почту пользователя, установите `verificationId` в тело запроса как `newIdentifierVerificationRecordId`.

```bash
curl -X PATCH https://[tenant-id].logto.app/api/my-account/primary-email \
  -H 'authorization: Bearer <access_token>' \
  -H 'logto-verification-id: <verification_record_id>' \
  -H 'content-type: application/json' \
  --data-raw '{"email":"...","newIdentifierVerificationRecordId":"..."}'
```

### Удаление электронной почты пользователя \{#remove-the-users-email}

Чтобы удалить электронную почту пользователя, вы можете использовать конечную точку `DELETE /api/my-account/primary-email`.

```bash
curl -X DELETE https://[tenant-id].logto.app/api/my-account/primary-email \
  -H 'authorization: Bearer <access_token>' \
  -H 'logto-verification-id: <verification_record_id>'
```

### Управление телефоном \{#manage-phone}

:::note
Чтобы использовать этот метод, вам нужно [настроить SMS-коннектор](/connectors/sms-connectors/), и убедиться, что шаблон `BindNewIdentifier` настроен.
:::

Аналогично обновлению электронной почты, вы можете использовать конечную точку `PATCH /api/my-account/primary-phone` для обновления или привязки нового телефона. И использовать конечную точку `DELETE /api/my-account/primary-phone` для удаления телефона пользователя.

### Привязка новой социальной связи \{#link-a-new-social-connection}

Чтобы привязать новую социальную связь, сначала вам нужно запросить URL авторизации:

```bash
curl -X POST https://[tenant-id].logto.app/api/verifications/social \
  -H 'authorization: Bearer <access_token>' \
  -H 'content-type: application/json' \
  --data-raw '{"connectorId":"...","redirectUri":"...","state":"..."}'
```

- `connectorId`: ID [социального коннектора](/connectors/social-connectors/).
- `redirectUri`: URI перенаправления после того, как пользователь авторизует приложение, вы должны разместить веб-страницу по этому URL и захватить обратный вызов.
- `state`: Состояние, которое будет возвращено после того, как пользователь авторизует приложение, это случайная строка, используемая для предотвращения CSRF-атак.

В ответе вы найдете `verificationRecordId`, сохраните его для дальнейшего использования.

После того, как пользователь авторизует приложение, вы получите обратный вызов на `redirectUri` с параметром `state`. Затем вы можете использовать конечную точку `POST /api/verifications/social/verify`, чтобы проверить социальную связь.

```bash
curl -X POST https://[tenant-id].logto.app/api/verifications/social/verify \
  -H 'authorization: Bearer <access_token>' \
  -H 'content-type: application/json' \
  --data-raw '{"connectorData":"...","verificationRecordId":"..."}'
```

`connectorData` — это данные, возвращаемые социальным коннектором после того, как пользователь авторизует приложение, вам нужно разобрать и получить параметры запроса из `redirectUri` на вашей странице обратного вызова и обернуть их в JSON как значение поля `connectorData`.

Наконец, вы можете использовать конечную точку `POST /api/my-account/identities`, чтобы привязать социальную связь.

```bash
curl -X POST https://[tenant-id].logto.app/api/my-account/identities \
  -H 'authorization: Bearer <access_token>' \
  -H 'logto-verification-id: <verification_record_id>' \
  -H 'content-type: application/json' \
  --data-raw '{"newIdentifierVerificationRecordId":"..."}'
```

### Удаление социальной связи \{#remove-a-social-connection}

Чтобы удалить социальную связь, вы можете использовать конечную точку `DELETE /api/my-account/identities`.

```bash
curl -X DELETE https://[tenant-id].logto.app/api/my-account/identities/[connector_target_id] \
  -H 'authorization: Bearer <access_token>' \
  -H 'logto-verification-id: <verification_record_id>'
```
