---
id: core-sdk-convention
title: Основные соглашения SDK
sidebar_label: Основные соглашения SDK
sidebar_position: 3
---

# Основные соглашения SDK

## Основные соглашения \{#basic-conventions}

- Ядро должно содержать только функции, не зависящие от платформы.
- Ядро должно называться как `{$language}` и находиться в корневом каталоге репозитория. Например, `logto/js/js`, `logto/kotlin/kotlin`.
- Пакет ядра должен называться как `{$language}` в области Logto. Например, `@logto/js`, `io.logto.sdk:kotlin`.

## Основные требования \{#basic-requirements}

Любой основной SDK должен содержать:

- Типы
- Утилитарные функции
- Основные функции

### Типы \{#types}

<details>
  <summary>

### OidcConfigResponse \{#oidcconfigresponse}

</summary>

Конфигурация провайдера идентификации, которую можно получить через API `/oidc/.well-known/openid-configuration`.

**Свойства**

| Имя                   | Тип      |
| --------------------- | -------- |
| authorizationEndpoint | `string` |
| tokenEndpoint         | `string` |
| endSessionEndpoint    | `string` |
| revocationEndpoint    | `string` |
| jwksUri               | `string` |
| issuer                | `string` |

</details>

<details>
  <summary>

### CodeTokenResponse \{#codetokenresponse}

</summary>

Данные ответа от `/oidc/token` (по коду авторизации).

**Свойства**

| Имя          | Тип      | Обязательно |
| ------------ | -------- | ----------- |
| accessToken  | `string` | ✅          |
| refreshToken | `string` |             |
| idToken      | `string` | ✅          |
| scope        | `string` | ✅          |
| expiresIn    | `number` | ✅          |

</details>

<details>
  <summary>

### RefreshTokenResponse \{#refreshtokenresponse}

</summary>

Данные ответа от `/oidc/token` (по токену обновления) при обновлении токенов с помощью токена обновления.

**Свойства**

| Имя          | Тип      | Обязательно |
| ------------ | -------- | ----------- |
| accessToken  | `string` | ✅          |
| refreshToken | `string` | ✅          |
| idToken      | `string` |             |
| scope        | `string` | ✅          |
| expiresIn    | `number` | ✅          |

</details>

<details>
  <summary>

### IdTokenClaims \{#idtokenclaims}

</summary>

Утверждения, содержащиеся в ID токене.

**Свойства**

| Имя      | Тип      | Обязательно |
| -------- | -------- | ----------- |
| sub      | `string` | ✅          |
| aud      | `string` | ✅          |
| exp      | `number` | ✅          |
| iat      | `number` | ✅          |
| iss      | `string` | ✅          |
| atHash   | `string` |             |
| username | `string` |             |
| name     | `string` |             |
| avatar   | `string` |             |

</details>

### Утилитарные функции \{#utility-functions}

<details>
  <summary>

### generateCodeVerifier \{#generatecodeverifier}

</summary>

Генерация проверочного кода.  
Длина проверочного кода жестко задана как 64.  
Возвращаемое значение ДОЛЖНО быть зашифровано в строку формата base64, безопасную для URL.

**Ссылка**

- [PKCE](https://oauth.net/2/pkce/)

**Параметры**

Нет.

**Тип возвращаемого значения**

`string`

</details>

<details id="generatecodeverifier">
  <summary>

### generateCodeChallenge \{#generatecodechallenge}

</summary>

Генерация вызова кода на основе проверочного кода.  
Этот метод шифрует проверочный код и возвращает результат в формате URL-безопасного Base64.  
Мы жестко задаем алгоритм шифрования как `SHA-256` в Logto V1.

**Ссылка**

- [PKCE](https://oauth.net/2/pkce/)

**Параметры**

| Имя          | Тип      | Примечания                                   |
| ------------ | -------- | -------------------------------------------- |
| codeVerifier | `string` | Сгенерировано с помощью generateCodeVerifier |

**Тип возвращаемого значения**

`string`

</details>

<details>
  <summary>

### generateState \{#generatestate}

</summary>

"State" используется для предотвращения атаки CSRF.  
Длина "state" жестко задана как 64.  
Возвращаемая строка ДОЛЖНА быть зашифрована в строку формата base64, безопасную для URL.

**Ссылка**

- [CSRF](https://datatracker.ietf.org/doc/html/rfc6749#section-10.12)

**Параметры**

Нет.

**Тип возвращаемого значения**

`string`

</details>

<details>
  <summary>

### decodeIdToken \{#decodeidtoken}

</summary>

Декодирование ID токена без проверки секрета.  
Возвращает `IdTokenClaims`, который содержит все утверждения токена в разделе payload.

**Параметры**

| Имя   | Тип      |
| ----- | -------- |
| token | `string` |

**Тип возвращаемого значения**

`IdTokenClaims`

**Исключения**

- `token` не является допустимым JWT.

</details>

<details>
  <summary>

### verifyIdToken \{#verifyidtoken}

</summary>

Проверка, является ли ID токен легальным.

**Проверка ключа подписи**

OIDC поддерживает JSON Web Key Set.
Эта функция принимает объект `JsonWebKeySet` из сторонней библиотеки (jose) для проверки.

```json
// Пример JsonWebKeySet
{
  "keys": [
    {
      "kty": "RSA",
      "use": "sig",
      "kid": "xxxx",
      "e": "xxxx",
      "n": "xxxx"
    }
  ]
}
```

**Проверка утверждений**

- Проверка, что `iss` в ID токене соответствует эмитенту этого токена.
- Проверка, что `aud` (аудитория) утверждение равно идентификатору клиента.
- Проверка, что текущее время меньше времени истечения срока действия.
- Проверка, что время выпуска (`iat`) не превышает +/- 1 минуты от текущего времени.

**Ссылка**

- [OpenID connect core - ID Token Validation](https://openid.net/specs/openid-connect-core-1_0.html#IDTokenValidation)

**Параметры**

| Имя      | Тип             |
| -------- | --------------- |
| idToken  | `string`        |
| clientId | `string`        |
| issuer   | `string`        |
| jwks     | `JsonWebKeySet` |

**Тип возвращаемого значения**

`void`

**Исключения**

- Ошибка проверки ключа подписи
- Ошибка проверки утверждений

</details>

<details>
  <summary>

### verifyAndParseCodeFromCallbackUri \{#verifyandparsecodefromcallbackuri}

</summary>

Проверка, является ли callbackUri входа легальным, и возврат `code`, извлеченного из callbackUri.

**Проверка Callback URI**

- Проверка, что `callbackUri` начинается с `redirectUri`
- Проверка, что в `callbackUri` нет `error` (См. [Error Response](https://datatracker.ietf.org/doc/html/rfc6749#section-4.1.2.1) в redirect URI).
- Проверка, что `callbackUri` содержит `state`, который должен быть равен значению `state`, указанному в `generateSignInUri`.
- Проверка, что `callbackUri` содержит параметр `code`, который будет использоваться при запросе к `/oidc/token` (по токену обновления).

**Параметры**

| Имя         | Тип      |
| ----------- | -------- |
| callbackUri | `string` |
| redirectUri | `string` |
| state       | `string` |

**Тип возвращаемого значения**

`string`

**Исключения**

- Ошибки проверок

</details>

### Основные функции \{#core-functions}

<details>
  <summary>

### fetchOidcConfig \{#fetchoidcconfig}

</summary>

Возвращает `OidcConfigResponse` при запросе к `/oidc/.well-known/openid-configuration`.

**Параметры**

| Имя      | Тип      | Примечания                  |
| -------- | -------- | --------------------------- |
| endpoint | `string` | Конечная точка OIDC сервиса |

**Тип возвращаемого значения**

`OidcConfigResponse`

**Исключения**

- Ошибка получения

</details>

<details>
  <summary>

### generateSignInUri \{#generatesigninuri}

</summary>

**Параметры**

| Имя                   | Тип        | Обязательно | Примечания                                                          |
| --------------------- | ---------- | ----------- | ------------------------------------------------------------------- |
| authorizationEndpoint | `string`   | ✅          |                                                                     |
| clientId              | `string`   | ✅          |                                                                     |
| redirectUri           | `string`   | ✅          |                                                                     |
| codeChallenge         | `string`   | ✅          |                                                                     |
| state                 | `string`   | ✅          |                                                                     |
| scopes                | `string[]` |             | Реализация может варьироваться в зависимости от спецификаций языка. |
| resources             | `string[]` |             | Реализация может варьироваться в зависимости от спецификаций языка. |
| prompt                | `string`   |             | По умолчанию: `consent`.                                            |

URL будет сгенерирован на основе `authorizationEndpoint` и будет содержать следующие параметры запроса:

**Параметры запроса URL для входа**

| Ключ запроса          | Обязательно | Примечания                                                                                                          |
| --------------------- | ----------- | ------------------------------------------------------------------------------------------------------------------- |
| client_id             | ✅          |                                                                                                                     |
| redirect_uri          | ✅          |                                                                                                                     |
| code_challenge        | ✅          |                                                                                                                     |
| code_challenge_method | ✅          | Жестко задано как S256.                                                                                             |
| state                 | ✅          |                                                                                                                     |
| scope                 | ✅          | область всегда содержит openid и offline_access, даже если входная область предоставляет null или пустое значение.  |
| resource              |             | Мы можем добавить ресурс в uri более одного раза, сервер преобразует их в список. Например, `resource=a&resource=b` |
| response_type         | ✅          | Жестко задано как code.                                                                                             |
| prompt                | ✅          |                                                                                                                     |

**Тип возвращаемого значения**

`string`

</details>

<details>
  <summary>

### generateSignOutUri \{#generatesignouturi}

</summary>

**Параметры**

| Имя                   | Тип      | Обязательно |
| --------------------- | -------- | ----------- |
| endSessionEndpoint    | `string` | ✅          |
| idToken               | `string` | ✅          |
| postLogoutRedirectUri | `string` |             |

URL, который будет сгенерирован, будет основан на `endSessionEndpoint` и будет содержать следующие параметры запроса:

**Параметры запроса URL для выхода**

| Ключ запроса             | Обязательно | Примечания                                 |
| ------------------------ | ----------- | ------------------------------------------ |
| id_token_hint            | ✅          | введенный параметр `idToken`               |
| post_logout_redirect_uri |             | введенный параметр `postLogoutRedirectUri` |

**Тип возвращаемого значения**

`string`

</details>

<details>
  <summary>

### fetchTokenByAuthorizationCode \{#fetchtokenbyauthorizationcode}

</summary>

Получение токена (`CodeTokenResponse`) при запросе к `/oidc/token` (по коду авторизации).

**Параметры**

| Имя           | Тип      | Обязательно |
| ------------- | -------- | ----------- |
| tokenEndpoint | `string` | ✅          |
| code          | `string` | ✅          |
| codeVerifier  | `string` | ✅          |
| clientId      | `string` | ✅          |
| redirectUri   | `string` | ✅          |
| resource      | `string` |             |

**HTTP Запрос**

- Конечная точка: `/oidc/token`
- Метод: `POST`
- Content-Type: `application/x-www-form-urlencoded`
- Данные:

| Ключ запроса  | Тип                            | Обязательно |
| ------------- | ------------------------------ | ----------- |
| grant_type    | `string: 'authorization_code'` | ✅          |
| code          | `string`                       | ✅          |
| code_verifier | `string`                       | ✅          |
| client_id     | `string`                       | ✅          |
| redirect_uri  | `string`                       | ✅          |
| resource      | `string`                       |             |

**Тип возвращаемого значения**

`CodeTokenResponse`

**Исключения**

- Ошибка получения

</details>

<details>
  <summary>

### fetchTokenByRefreshToken \{#fetchtokenbyrefreshtoken}

</summary>

Получение токена (`RefreshTokenTokenResponse`) через `/oidc/token` (по токену обновления).

**Параметры**

| Имя           | Тип        | Обязательно |
| ------------- | ---------- | ----------- |
| tokenEndpoint | `string`   | ✅          |
| clientId      | `string`   | ✅          |
| refreshToken  | `string`   | ✅          |
| resource      | `string`   |             |
| scopes        | `string[]` |             |

**HTTP Запрос**

- Конечная точка: `/oidc/token`
- Метод: `POST`
- Content-Type: `application/x-www-form-urlencoded`
- Данные:

| Ключ запроса  | Тип                       | Обязательно | Примечания                                                                  |
| ------------- | ------------------------- | ----------- | --------------------------------------------------------------------------- |
| grant_type    | `string: 'refresh_token'` | ✅          |                                                                             |
| refresh_token | `string`                  | ✅          |                                                                             |
| client_id     | `string`                  | ✅          |                                                                             |
| resource      | `string`                  |             |                                                                             |
| scope         | `string`                  |             | мы объединяем значения `scopes` с пробелом для создания этой строки `scope` |

**Тип возвращаемого значения**

`RefreshTokenTokenResponse`

**Исключения**

- Ошибка получения

</details>

<details>
  <summary>

### revoke \{#revoke}

</summary>

Запрос к API `/oidc/token/revocation` для уведомления сервера авторизации о том, что ранее полученный токен обновления или токен доступа больше не нужен.

**Параметры**

| Имя                | Тип      | Примечания       |
| ------------------ | -------- | ---------------- |
| revocationEndpoint | `string` |                  |
| clientId           | `string` |                  |
| token              | `string` | токен для отзыва |

**HTTP Запрос**

- Конечная точка: `/oidc/token/revocation`
- Метод: `POST`
- Content-Type: `application/x-www-form-urlencoded`
- Данные:

| Ключ запроса | Тип      |
| ------------ | -------- |
| client_id    | `string` |
| token        | `string` |

**Тип возвращаемого значения**

`void`

**Исключения**

- Ошибка отзыва

</details>
