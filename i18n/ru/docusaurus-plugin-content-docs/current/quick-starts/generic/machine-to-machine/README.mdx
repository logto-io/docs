---
slug: /quick-starts/m2m
sidebar_label: Машина-машина
sidebar_custom_props:
  description: Обеспечивает прямую связь между машинами.
---

import TabItem from '@theme/TabItem';
import Tabs from '@theme/Tabs';

import AppIdentifierSrc from '../../assets/api-identifier.png';
import AppNote from '../../fragments/_app-note.mdx';

import AccessLogtoManagementApiUsingAccessToken from './fragments/_access-logto-management-api-using-access-token.mdx';
import AccessTokenUsage from './fragments/_access-token-usage.mdx';
import BasicsAboutAccessTokenRequest from './fragments/_basics-about-access-token-request.mdx';
import FetchAccessTokenForLogtoManagementApi from './fragments/_fetch-access-token-for-logto-management-api.mdx';
import M2mAccessTokenSubNote from './fragments/_m2m-access-token-sub-note.mdx';
import M2mRoleAssignment from './fragments/_m2m-role-assignment.mdx';

# Машина-машина: Аутентификация с Logto

<AppNote type="Machine-to-machine" />

## Введение \{#intro}

Машина-машина (M2M) — это распространенная практика аутентификации, если у вас есть приложение (не пользователь), которое должно напрямую взаимодействовать с ресурсами (обычно, использование M2M приложения не требует взаимодействия с пользователем, поэтому у него нет интерфейса). Например, сервис API, который обновляет пользовательские данные в Logto, сервис статистики, который извлекает ежедневные заказы и т.д.

Поскольку Logto использует RBAC в качестве политики контроля доступа, назначение M2M ролей для M2M приложений необходимо для защиты вашего API, который требует прямого взаимодействия с сервисом.

:::info
Чтобы узнать о нашем текущем RBAC и разнице между пользовательской ролью и M2M ролью, см. [Настройка ролей](/authorization/role-based-access-control/configure-roles) для получения дополнительной информации.
:::

Существует два распространенных случая использования приложений машина-машина в Logto:

1. **Доступ к Logto Management API**: В этом случае вам нужно назначить M2M роль, которая включает разрешение `all` из встроенного Logto Management API для вашего M2M приложения.
2. **Доступ к вашему ресурсу API**: В этом случае вам нужно назначить M2M роли, которые включают разрешения из ваших ресурсов API для вашего M2M приложения.

<M2mRoleAssignment />

Теперь давайте пройдем весь процесс от начала до конца. Для ясности мы разделим шаги для доступа к Logto Management API и другим ресурсам API. И мы предполагаем, что вы уже создали M2M приложение в Logto.

## Получение токена доступа \{#fetch-an-access-token}

### Основы запроса токена доступа \{#basics-about-access-token-request}

<BasicsAboutAccessTokenRequest />

Пример запроса токена доступа:

```http
POST /oidc/token HTTP/1.1
Host: your.logto.endpoint
Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW
Content-Type: application/x-www-form-urlencoded

grant_type=client_credentials
&resource=https://shopping.api
&scope=read:products write:products
```

### Запрос токена доступа \{#request-an-access-token}

:::note
В следующей демонстрации замените `https://your.logto.endpoint` на целевой Logto endpoint. Для Logto Cloud это будет `https://{your-tenant-id}.logto.app`.
:::

<Tabs>

<TabItem value="Logto Management API" label="Для Logto Management API">
  <FetchAccessTokenForLogtoManagementApi />
</TabItem>

<TabItem value="API resource" label="Для вашего ресурса API">
В вашем списке ресурсов API найдите идентификатор API, к которому приложение должно получить доступ. Если вы не добавили ресурс API в Logto или не знаете, что такое ресурс API, см. [Ресурс API](/authorization/api-resources).

<img
  alt="Идентификатор API"
  src={AppIdentifierSrc}
  width="600px"
  style={{ paddingBottom: '12px' }}
/>

Предположим, что у нас есть разрешения `read:products` и `write:products` под этим ресурсом API "Online Shopping".

Перед доступом к вашему ресурсу API убедитесь, что вашему M2M приложению назначены M2M роли, которые включают разрешения из вашего ресурса API.

Теперь соберите все, что у нас есть, и отправьте запрос:

<Tabs>

<TabItem value="Node.js" label="Node.js">

```js
const logtoEndpoint = 'https://your.logto.endpoint';
const tokenEndpoint = `${logtoEndpoint}/oidc/token`;
const applicationId = 'your-application-id';
const applicationSecret = 'your-application-secret';

const fetchAccessToken = async () => {
  return await fetch(tokenEndpoint, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      Authorization: `Basic ${Buffer.from(`${applicationId}:${applicationSecret}`).toString(
        'base64'
      )}`,
    },
    body: new URLSearchParams({
      grant_type: 'client_credentials',
      resource: 'https://shopping.api',
      scope: 'read:products write:products',
    }).toString(),
  });
};
```

</TabItem>

<TabItem value="cURL" label="cURL">

```bash
curl --location \
  --request POST 'https://your.logto.endpoint/oidc/token' \
  --header 'Authorization: Basic ${your_auth_string}' \
  --header 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode 'grant_type=client_credentials' \
  --data-urlencode 'resource=https://shopping.api' \
  --data-urlencode 'scope=read:products write:products'
```

</TabItem>

</Tabs>

</TabItem>
</Tabs>

### Ответ с токеном доступа \{#access-token-response}

Успешный ответ с телом будет выглядеть следующим образом:

```json
{
  "access_token": "eyJhbG...2g", // Используйте этот токен для доступа к Logto Management API
  "expires_in": 3600, // Время истечения токена в секундах
  "token_type": "Bearer", // Тип аутентификации для вашего запроса при использовании токена доступа
  "scope": "all" // область действия `all` для Logto Management API
}
```

<M2mAccessTokenSubNote />

## Доступ к ресурсу с использованием токена доступа \{#access-resource-using-access-token}

<AccessTokenUsage />

<Tabs>

<TabItem value="Logto Management API" label="Взаимодействие с Logto Management API">
  <AccessLogtoManagementApiUsingAccessToken />
</TabItem>

<TabItem value="Your API resource" label="Взаимодействие с вашим ресурсом API">
Использование запрошенного токена доступа с ресурсом API `https://shopping.api` для получения всех продуктов в API покупок:

<Tabs>
<TabItem value="Node.js" label="Node.js">

```js
const apiEndpoint = 'https://your.api.endpoint';
const accessToken = 'eyJhb...2g'; // Токен доступа

const fetchProducts = async () => {
  return await fetch(`${apiEndpoint}/products`, {
    method: 'GET',
    headers: {
      Authorization: `Bearer ${accessToken}`,
    },
  });
};
```

</TabItem>

<TabItem value="cURL" label="cURL">

```bash
curl --location \
  --request GET 'https://your.api.endpoint/products' \
  --header 'Authorization: Bearer eyJhbG...2 # Токен доступа
```

</TabItem>
</Tabs>
</TabItem>
</Tabs>

## Аутентификация \{#authentication}

Если вы защищаете свои собственные ресурсы API, отличные от Logto Management API, не забудьте реализовать аутентификацию для вашего ресурса. См. [Защита вашего API](/authorization/api-resources/protect-your-api/#validate-authorization-tokens-for-api-requests) для получения подробной информации.
