### Совместимость версий SDK \{#sdk-version-compatibility}

| Версия Logto SDK | Версия Dart SDK   | Совместимость с Dart 3.0 |
| ---------------- | ----------------- | ------------------------ |
| < 2.0.0          | >= 2.17.6 < 3.0.0 | false                    |
| >= 2.0.0 < 3.0.0 | >= 3.0.0          | true                     |
| >= 3.0.0         | >= 3.6.0          | true                     |

### Настройка flutter_secure_storage \{#flutter_secure_storage-set-up}

В основе этого SDK используется [flutter_secure_storage](https://pub.dev/packages/flutter_secure_storage) для реализации кроссплатформенного постоянного безопасного хранения токенов.

- Keychain используется для iOS
- AES шифрование используется для Android.

#### Настройка версии Android \{#config-android-version}

Установите android:minSdkVersion на `>= 18` в файле `android/app/build.gradle` вашего проекта.

```kotlin title="build.gradle"
  android {
      ...

      defaultConfig {
          ...
          minSdkVersion 18
          ...
      }
  }
```

#### Отключение автоматического резервного копирования на Android \{#disable-auto-backup-on-android}

По умолчанию Android выполняет резервное копирование данных на Google Drive. Это может вызвать исключение `java.security.InvalidKeyException:Failed` при развертывании ключа. Чтобы избежать этого,

1. Чтобы отключить автоматическое резервное копирование, перейдите в файл манифеста вашего приложения и установите атрибуты `android:allowBackup` и `android:fullBackupContent` в `false`.

   ```xml title="AndroidManifest.xml"
   <manifest ... >
       ...
       <application
         android:allowBackup="false"
         android:fullBackupContent="false"
         ...
       >
           ...
       </application>
   </manifest>

   ```

2. Исключите `sharedprefs` из `FlutterSecureStorage`.

   Если вам нужно сохранить `android:fullBackupContent` для вашего приложения, а не отключать его, вы можете исключить директорию `sharedprefs` из резервного копирования.
   Подробнее см. в [документации Android](https://developer.android.com/identity/data/autobackup#IncludingFiles).

   > В вашем файле AndroidManifest.xml добавьте атрибут android:fullBackupContent в элемент `<application>`, как показано в следующем примере. Этот атрибут указывает на XML-файл, содержащий правила резервного копирования.

   ```xml title="AndroidManifest.xml"
   <application ...
     android:fullBackupContent="@xml/backup_rules">
   </application>
   ```

   > Создайте XML-файл с именем `@xml/backup_rules` в директории `res/xml/`. В этом файле добавьте правила с элементами `<include>` и `<exclude>`. Следующий пример выполняет резервное копирование всех общих настроек, кроме device.xml:

   ```xml title="@xml/backup_rules"
   <?xml version="1.0" encoding="utf-8"?>
   <full-backup-content>
     <exclude domain="sharedpref" path="FlutterSecureStorage"/>
   </full-backup-content>
   ```

Пожалуйста, ознакомьтесь с [flutter_secure_storage](https://pub.dev/packages/flutter_secure_storage#configure-android-version) для получения более подробной информации.

### Настройка flutter_web_auth_2 \{#flutter_web_auth_2-set-up}

В основе этого SDK используется [flutter_web_auth_2](https://pub.dev/packages/flutter_web_auth_2) для аутентификации пользователей с Logto. Этот пакет предоставляет простой способ аутентификации пользователей с Logto, используя системный webview или браузер.

Этот плагин использует `ASWebAuthenticationSession` на iOS 12+ и macOS 10.15+, `SFAuthenticationSession` на iOS 11, `Chrome Custom Tabs` на Android и открывает новое окно в Web.

- iOS: Дополнительная настройка не требуется

- Android: Зарегистрируйте URL обратного вызова на Android

  Чтобы захватить URL обратного вызова со страницы входа Logto, вам нужно зарегистрировать ваш redirectUri для входа в файл `AndroidManifest.xml`.

  ```xml title="AndroidManifest.xml"
    <manifest>
      <application>
          <activity
            android:name="com.linusu.flutter_web_auth_2.CallbackActivity"
            android:exported="true">
            <intent-filter android:label="flutter_web_auth_2">
            <action android:name="android.intent.action.VIEW" />
            <category android:name="android.intent.category.DEFAULT" />
            <category android:name="android.intent.category.BROWSABLE" />
            <data android:scheme="YOUR_CALLBACK_URL_SCHEME_HERE" />
            </intent-filter>
          </activity>
      </application>
    </manifest>
  ```

- Веб-браузер: Создайте конечную точку для обработки URL обратного вызова

  Если вы используете веб-платформу, вам нужно создать конечную точку для обработки URL обратного вызова и отправить его обратно в приложение, используя API `postMessage`.

  ```html title="callback.html"
  <!doctype html>
  <title>Аутентификация завершена</title>
  <p>Аутентификация завершена. Если это не произошло автоматически, пожалуйста, закройте окно.</p>
  <script>
    function postAuthenticationMessage() {
      const message = {
        'flutter-web-auth-2': window.location.href,
      };

      if (window.opener) {
        window.opener.postMessage(message, window.location.origin);
        window.close();
      } else if (window.parent && window.parent !== window) {
        window.parent.postMessage(message, window.location.origin);
      } else {
        localStorage.setItem('flutter-web-auth-2', window.location.href);
        window.close();
      }
    }

    postAuthenticationMessage();
  </script>
  ```

Пожалуйста, ознакомьтесь с руководством по настройке в пакете [flutter_web_auth_2](https://pub.dev/packages/flutter_web_auth_2#setup) для получения более подробной информации.
