---
slug: /quick-starts/wordpress
sidebar_label: WordPress
sidebar_custom_props:
  description: WordPress — это бесплатная и открытая система управления контентом.
---

import FurtherReadings from '../../fragments/_further-readings.md';

# Добавление аутентификации в ваше приложение на WordPress

Этот учебник покажет вам, как интегрировать Logto в ваш сайт на [WordPress](https://wordpress.org).

## Предварительные требования \{#prerequisites}

- Аккаунт в [Logto Cloud](https://cloud.logto.io) или [самостоятельно размещенный Logto](/introduction/set-up-logto-oss).
- Созданное традиционное приложение Logto.
- Проект на WordPress: следуйте официальному [руководству по установке WordPress](https://wordpress.org/support/article/how-to-install-wordpress/), чтобы настроить ваш сайт на WordPress перед продолжением.

## Интеграция \{#integration}

### Установка плагина \{#install-the-plugin}

Мы будем использовать плагин [OpenID Connect Generic](https://wordpress.org/plugins/generic-openid-connect/) для интеграции Logto через протокол OIDC в ваш сайт на WordPress.

1. Войдите на ваш сайт WordPress.
2. Перейдите в "Плагины" и нажмите "Добавить новый".
3. Найдите "OpenID Connect Generic" и установите плагин от daggerhart.
4. Активируйте плагин.

### Настройка перенаправления URI \{#configure-redirect-uri}

Сначала давайте настроим перенаправление URI. Вы можете найти его в настройках плагина, прокрутите вниз до раздела "Notes" и скопируйте значение "Redirect URI".

Переключитесь на страницу сведений о приложении в Logto Console. Добавьте Redirect URI и нажмите "Сохранить изменения".

### Настройка плагина \{#set-up-the-plugin}

Обратитесь к следующей таблице для получения необходимых сведений о настройке:

| Поле плагина                  | Описание                                                                                                                                                                                                     |
| ----------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Client ID                     | ID вашего приложения Logto                                                                                                                                                                                   |
| Client Secret                 | Секрет вашего приложения Logto                                                                                                                                                                               |
| OpenID Scope                  | Введите `email profile openid offline_access`                                                                                                                                                                |
| Login Endpoint URL            | URL конечной точки авторизации вашего приложения Logto, который является https://[tenant-id].logto.app/oidc/auth, вы можете нажать "show endpoint details" на странице приложения Logto, чтобы получить URL. |
| Userinfo Endpoint URL         | URL конечной точки userinfo вашего приложения Logto, который является https://[tenant-id].logto.app/oidc/me.                                                                                                 |
| Token Validation Endpoint URL | URL конечной точки проверки токена вашего приложения Logto, который является https://[tenant-id].logto.app/oidc/token.                                                                                       |
| End Session Endpoint URL      | URL конечной точки завершения сессии вашего приложения Logto, который является https://[tenant-id].logto.app/oidc/session/end.                                                                               |
| Identity Key                  | Уникальный ключ в ID токене, содержащий идентичность пользователя, это может быть email или sub, в зависимости от вашей настройки.                                                                           |
| Nickname Key                  | Ключ в ID токене, содержащий никнейм пользователя, вы можете установить его на sub и изменить позже.                                                                                                         |

### Контрольная точка: тестирование вашего приложения \{#checkpoint-test-your-application}

Теперь вы можете протестировать ваше приложение:

1. Выйдите из вашего сайта WordPress.
2. Посетите страницу входа WordPress и нажмите кнопку "Sign in with Logto".
3. Вы будете перенаправлены на страницу входа Logto.
4. Войдите в систему с вашим аккаунтом Logto.
5. Вы будете перенаправлены обратно на сайт WordPress и автоматически войдете в систему.

## Сопоставление ролей \{#roles-mapping}

WordPress имеет встроенную систему управления ролями пользователей, которая определяет, какие действия (возможности) пользователь может выполнять на сайте. Стандартные роли пользователей включают Администратора, Редактора, Автора, Участника и Подписчика, каждая из которых имеет свой набор возможностей.

Logto использует управление доступом на основе ролей (RBAC) в качестве модели авторизации, используя "области" как наименьшую единицу разрешения. Эти области определяют конкретные действия, которые аутентифицированный пользователь может выполнять в приложении. Однако WordPress работает на другом принципе управления разрешениями пользователей, полагаясь на предопределенные "роли", которые объединяют различные возможности.

Учитывая это фундаментальное различие, мы предлагаем создать специальные роли в Logto, которые соответствуют ролям, определенным в WordPress. Эти роли могут не иметь никаких областей, они используются только как ссылка для сопоставления пользователей с ролями WordPress.

### Предварительные требования \{#prerequisites-1}

- Настройте роли в Logto, которые соответствуют ролям в WordPress. Например, если у вас есть роль 'editor' в WordPress, создайте роль 'group:editors' в Logto.

### Реализация сопоставления ролей \{#implement-role-mapping}

Для реализации сопоставления ролей мы добавим пользовательский код в файл `functions.php` темы WordPress. Это включает использование хука действия `wp_login`, который срабатывает при входе пользователя. Вот пошаговое руководство по настройке:

### Шаг 1: доступ к файлу functions.php вашей темы \{#step-1-access-your-themes-functionsphp}

Откройте файл `functions.php` вашей темы. Вы можете получить доступ к этому файлу через панель администратора WordPress, перейдя в Внешний вид > Редактор тем и выбрав `functions.php` из списка файлов справа. Или в исходном коде, перейдите в директорию вашей темы WordPress и найдите файл `functions.php`. Этот файл позволяет добавлять пользовательские PHP-функции, расширяющие функциональность вашего сайта на WordPress.

### Шаг 2: напишите функцию сопоставления ролей \{#step-2-write-the-role-mapping-function}

Ниже приведен простой пример функции, которую вы можете добавить в functions.php. Эта функция будет срабатывать при входе пользователя и назначать роли на основе утверждения `roles`, полученного из Logto.

```php
function logto_handler($user_login, $user = null) {
	if (!$user) {
		$user = get_user_by('login', $user_login);
	}

	$oidc_claims = get_user_meta($user->ID, 'openid-connect-generic-last-user-claim', true);

	if (in_array('group:editors', $oidc_claims['roles'])) {
		$user->set_role('editor');
	} else {
		$user->set_role('subscriber');
	}
}

add_action('wp_login', 'logto_handler', 10, 2);
```

### Шаг 3: понимание кода и его настройка \{#step-3-understanding-the-code-and-customizing-it}

- Функция `logto_handler`: Эта функция принимает два параметра: `$user_login` (имя пользователя) и `$user` (объект пользователя). Она извлекает роли из Logto, которые хранятся в метаданных пользователя как `openid-connect-generic-last-user-claim`, сопоставляет эту роль с соответствующей ролью WordPress и назначает ее пользователю.

- `add_action`: Эта строка связывает функцию `logto_handler` с действием `wp_login`, которое срабатывает после входа пользователя. `10` — это приоритет (по умолчанию), а `2` указывает количество аргументов, которые принимает функция.

Пример выше назначает роль 'editor' пользователям, аутентифицированным через Logto с ролью `group:editors`. Однако в реальном сценарии вам, вероятно, потребуется реализовать больше видов сопоставления ролей.

Вы можете найти список ролей WordPress и их возможностей [здесь](https://wordpress.org/support/article/roles-and-capabilities/).

### Шаг 4: тестирование вашей настройки \{#step-4-test-your-setup}

Теперь давайте протестируем функцию сопоставления ролей, войдя в систему с пользователем, который имеет роль `group:editors` в Logto. После входа проверьте роль пользователя в WordPress, чтобы убедиться, что сопоставление работает правильно.

## Дополнительные материалы \{#further-readings}

<FurtherReadings />
