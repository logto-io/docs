---
slug: /quick-starts/flutter-flow
sidebar_label: FlutterFlow
sidebar_custom_props:
  description: FlutterFlow — это фреймворк с низким кодом для создания гибридных приложений на Flutter.
---

import InitCustomAuthManagerCode from './code-snippets/_flutter-flow-auth-manager-init.md';
import AuthUserProviderCode from './code-snippets/_flutter-flow-auth-user-provider.md';
import FlutterSecureStorageCode from './code-snippets/_flutter-secure-storage.md';
import FlutterWebAuthCode from './code-snippets/_flutter-web-auth.md';
import flutterFlowCustomAuth from './flutter-flow-custom-authentication.png';
import flutterFlowGitHub from './flutter-flow-github-push.png';

# Настройка FlutterFlow CustomAuthManager с использованием Logto SDK

FlutterFlow имеет встроенную функцию [кастомной аутентификации](https://docs.flutterflow.io/data-and-backend/custom-authentication), которая позволяет аутентифицировать пользователей с использованием вашего собственного бэкенда. Однако встроенный поток кастомной аутентификации был разработан для работы с одним вызовом API аутентификации. Если вы используете стороннего провайдера идентификации (IdP), запрос аутентификации может быть выполнен только с использованием типа гранта `Resource Owner Password Credentials`, который не рекомендуется для использования в производственной среде. Подробнее см. [Устаревший тип гранта ropc](https://blog.logto.io/deprecated-ropc-grant-type/).

Стандартный поток аутентификации OpenID Connect (OIDC) включает несколько шагов, таких как авторизация, обмен токенами и получение информации о пользователе. Чтобы реализовать стандартный поток аутентификации OIDC с IdP, таким как Logto, вам нужно настроить класс `CustomAuthManager` в FlutterFlow.

Этот учебник покажет вам, как настроить класс `CustomAuthManager` в FlutterFlow с использованием Logto [Flutter SDK](../flutter/README.mdx). Вы можете воспользоваться Logto SDK для стандартного потока аутентификации OIDC, сохраняя при этом преимущества конструктора интерфейса FlutterFlow.

:::tip

- Пакет Logto SDK доступен на [pub.dev](https://pub.dev/packages/logto_dart_sdk) и в [репозитории GitHub Logto](https://github.com/logto-io/dart).
- SDK в настоящее время подходит только для платформ Android и iOS.

:::

## Предварительные требования \{#prerequisites}

- Аккаунт [Logto Cloud](https://cloud.logto.io) или [самостоятельно размещенный Logto](/introduction/set-up-logto-oss).
- Создайте приложение Logto Flutter.
- Проект FlutterFlow.

## Включение кастомного кода в FlutterFlow \{#enable-flutterflow-custom-code}

Чтобы настроить класс `CustomAuthManager`, вам нужно включить функцию кастомного кода в FlutterFlow. Следуйте руководству [Управление кастомным кодом в GitHub](https://docs.flutterflow.io/customizing-your-app/manage-custom-code-in-github), чтобы синхронизировать ваш проект FlutterFlow с GitHub.

:::note
Управление кастомным кодом в GitHub — это премиум-функция в FlutterFlow. Вам нужно обновить ваш план FlutterFlow до профессионального, чтобы включить эту функцию.
:::

После этого у вас будет три разных ветки в вашем репозитории GitHub FlutterFlow:

1. `main`: Основная ветка для проекта flutter. Вам понадобится эта ветка для развертывания вашего проекта.
2. `flutterflow`: Ветка, в которую `FlutterFlow` будет синхронизировать изменения из редактора FlutterFlow.
3. `develop`: Ветка, в которой вы можете изменять ваш кастомный код.

## Создание интерфейса в FlutterFlow \{#create-your-ui-in-flutterflow}

Сначала создайте ваш интерфейс в FlutterFlow. Вы можете следовать [документации FlutterFlow](https://docs.flutterflow.io/), чтобы создать интерфейс в соответствии с вашими требованиями. Для этого учебника, в минимальных требованиях, мы создадим две страницы:

1. Простая домашняя страница с кнопкой входа.
2. Страница профиля пользователя для отображения информации о пользователе и кнопкой выхода.

Перейдите на страницу `App Settings` -> `Authentication` и включите кастомную аутентификацию. Это создаст класс `CustomAuthManager` в вашем проекте FlutterFlow.

<center>
  <img src={flutterFlowCustomAuth} alt="Кастомная аутентификация FlutterFlow" />
</center>

Когда интерфейс будет готов, перейдите на страницу `integrations` -> `GitHub` и нажмите кнопку `Push to Repository`, чтобы отправить изменения в ветку `flutterflow`.

<center>
  <img src={flutterFlowGitHub} alt="Отправка в GitHub FlutterFlow" />
</center>

## Настройка CustomAuthManager \{#customize-the-customauthmanager}

Переключитесь на ветку `develop` в вашем репозитории GitHub и объедините последние изменения из ветки `flutterflow`. Включая ваши страницы интерфейса и предварительно созданный класс `CustomAuthManager`.

### Установка зависимости Logto SDK \{#install-logto-sdk-dependency}

Добавьте зависимость Logto SDK в ваш проект.

```bash
  flutter pub add logto_dart_sdk
```

:::note
Опциональный пакет Http:

Клиент Logto требует http-клиент для выполнения вызовов API. Вы можете использовать пакет `http` или любой другой пакет http-клиента по вашему выбору.

```bash
  flutter pub add http
```

:::

### Обновление UserProvider \{#update-the-userprovider}

Добавьте класс `OpenIdClaims` в класс `CustomAuthUserProvider` для хранения информации о пользователе.

> Класс `OpenIdClaims` является частью Logto SDK, который предоставит утверждения `id_token` для аутентифицированного пользователя.

<AuthUserProviderCode />

### Инициализация клиента logto в CustomAuthManager \{#init-the-logto-client-in-customauthmanager}

Инициализируйте клиент Logto в классе `CustomAuthManager`.

<InitCustomAuthManagerCode />

Метод `initialize` инициализирует клиент Logto и обновляет текущий поток пользователей с состоянием аутентификации пользователя, сохраненным в локальном хранилище.

> Logto SDK использует пакет [flutter_secure_storage](https://pub.dev/packages/flutter_secure_storage) для безопасного хранения информации об аутентификации пользователя.

### Реализация метода входа \{#implement-the-sign-in-method}

Вызов метода `LogtoClient.signIn` инициирует стандартный поток аутентификации OIDC. Страница входа Logto будет открыта в веб-просмотре с использованием [flutter_web_auth](https://pub.dev/packages/flutter_web_auth).

```dart
// lib/auth/custom_auth/custom_auth_manager.dart

Future<FlutterFlowAuthAuthUser?> signIn(
    String redirectUri,
  ) async {
    await logtoClient.signIn(redirectUri);

    var idTokenClaims = await logtoClient.idTokenClaims;

    return _updateCurrentUser(
      loggedIn: idTokenClaims != null,
      uid: idTokenClaims?.subject,
      idToken: idTokenClaims,
    );
  }

```

LogtoClient будет обрабатывать шаги авторизации, обмена токенами и получения информации о пользователе. После аутентификации пользователя `idTokenClaims` будет сохранен в локальном хранилище.
Получите `idTokenClaims` от LogtoClient и обновите текущий поток пользователей.

### Реализация метода выхода \{#implement-the-sign-out-method}

```dart
// lib/auth/custom_auth/custom_auth_manager.dart

Future signOut() async {
    await logtoClient.signOut();

    flutterFlowAuthAuthUserSubject.add(
      FlutterFlowAuthAuthUser(loggedIn: false),
    );
  }
```

### Обновление утилитных методов аутентификации \{#update-the-auth-util-methods}

- Добавьте геттер `authManager` для доступа к экземпляру `CustomAuthManager`.
- Добавьте геттер `currentUserUid` для получения текущего идентификатора пользователя.
- Добавьте геттер `currentUserData` для получения текущих данных пользователя.
- Добавьте геттер `logtoClient` для доступа к экземпляру клиента Logto.

```dart
// lib/auth/custom_auth/auth_util.dart

import 'package:logto_dart_sdk/logto_client.dart';
import 'package:logto_dart_sdk/src/modules/id_token.dart';

import 'custom_auth_manager.dart';

export 'custom_auth_manager.dart';

final _authManager = CustomAuthManager();
CustomAuthManager get authManager => _authManager;
String get currentUserUid => currentUser?.uid ?? '';
OpenIdClaims? get currentUserData => currentUser?.idToken;
LogtoClient get logtoClient => _authManager.logtoClient;
```

## Интеграция кастомной аутентификации в ваш интерфейс \{#integrate-the-custom-authentication-in-your-ui}

### Домашняя страница \{#home-page}

Вызовите метод `authManager.signIn`, чтобы инициировать поток аутентификации, когда пользователь нажимает на кнопку входа.

> `redirectUri` — это URL-адрес обратного вызова, который будет использоваться для захвата обратного вызова авторизации со страницы входа Logto.
> Подробнее о redirectUri см. в [Flutter SDK](../flutter/README.mdx#implement-sign-in).

```dart
// lib/pages/home_page/home_page_widget.dart

final redirectUri = 'io.logto://callback';

// ...

FFButtonWidget(
  onPressed: () async {
    GoRouter.of(context).prepareAuthEvent();

    await authManager.signIn(redirectUri);

    context.replaceNamed('user');
  },
  text: 'Sign In',
  // ...
)
```

### Страница профиля пользователя \{#user-profile-page}

Используйте геттеры утилит аутентификации для доступа к текущим данным пользователя и экземпляру клиента Logto.

```dart
// lib/pages/user/user_widget.dart

import '/auth/custom_auth/auth_util.dart';

// ...

children: [
  Text(
    'User ID: $currentUserUid',
  ),
  Text(
    'Display Name: ${currentUserData?.name}',
  ),
  Text(
    'Username: ${currentUserData?.username}',
  ),
  Text(
    'Email: ${currentUserData?.emailVerified ?? currentUserData?.email}',
  ),
]

```

Реализуйте метод выхода, когда пользователь нажимает на кнопку выхода.

```dart
// lib/pages/user/user_widget.dart

FFButtonWidget(
  onPressed: () async {
    await authManager.signOut();

    context.replaceNamed('HomePage');
  },
  text: 'Sign Out',
  // ...
)
```

## Дополнительные материалы \{#further-readings}

Logto SDK предоставляет больше методов для взаимодействия с Logto API. Вы можете дополнительно настроить класс `CustomAuthManager` для реализации дополнительных функций.

- [Профиль пользователя](../flutter/README.mdx#get-user-information)
- [Ресурсы API и организации](../flutter/README.mdx#api-resources-and-organizations)

## Устранение неполадок с зависимостями \{#dependency-troubleshooting}

<FlutterSecureStorageCode />

<FlutterWebAuthCode />
