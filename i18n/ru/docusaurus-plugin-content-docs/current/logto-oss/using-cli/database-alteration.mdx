---
description: Как развернуть изменения в базе данных.
sidebar_position: 3
---

import TabItem from '@theme/TabItem';
import Tabs from '@theme/Tabs';

# Изменение базы данных

При разработке новых функций или рефакторинге существующих иногда неизбежно приходится изменять схемы базы данных.

Это может звучать пугающе, так как, как правило, вам нужно:

- Дважды проверить разницу между двумя или более версиями
- Изменить базу данных безопасным и обратно совместимым способом
- Подготовиться к возможным сбоям, например, иметь скрипт отката
- Постепенно заменить работающие экземпляры Logto на новую версию

**Эй, мы тоже разработчики, и мы знаем, что это неприятно делать все эти рискованные, но обязательные вещи.** Так почему бы не передать их кому-то, кто не совершит ошибку, например, CLI?

Теперь ваш процесс обновления будет следующим:

- Запустите `logto db alt deploy` из любого места, где есть доступ к базе данных
- Постепенно заменяйте работающие экземпляры Logto на новую версию

Давайте начнем!

## Определение версии для развертывания \{#determine-the-version-to-deploy}

Если у вас установлен Logto CLI глобально, **настоятельно рекомендуется** обновить CLI до последней версии перед развертыванием, чтобы получить все доступные изменения базы данных. Затем выполните команду:

<Tabs groupId="cmd">

  <TabItem value="cli" label="CLI">

```bash
logto db alteration deploy
```

  </TabItem>
  <TabItem value="npx" label="npx">

```bash
npx @logto/cli db alteration deploy
```

  </TabItem>

</Tabs>

Если ваша база данных актуальна, вы увидите следующее сообщение:

```bash
[info] Found 0 alteration to deploy
```

Если у вас есть неразвернутые изменения, CLI предложит вам выбрать нужную версию:

```bash
? Choose the alteration target version (Use arrow keys)
> 1.2.0
  1.0.0
```

Теоретически, версия для развертывания должна соответствовать версии вашего экземпляра Logto. В то же время, вы можете использовать команду с указанием целевой версии:

<Tabs groupId="cmd">

  <TabItem value="cli" label="CLI">

```bash
logto db alteration deploy 1.2.0
```

  </TabItem>
  <TabItem value="npx" label="npx">

```bash
npx @logto/cli db alteration deploy 1.2.0
```

  </TabItem>

</Tabs>

Это полезно, когда вы хотите выполнить изменения в не-TTY конвейере, просто не забудьте передать URL базы данных, используя `--db-url`. См. [Развертывание и конфигурация](/logto-oss/deployment-and-configuration/) для настройки задания изменения в вашем кластере.

:::note
Для каждого скрипта изменения Logto CLI выполнит весь скрипт в транзакции. Поэтому, если развертывание не удалось, вы можете легко продолжить с той же командой после устранения проблемы.
:::

## Откат изменений \{#rollback-alterations}

Наши скрипты изменений также содержат скрипт `down`, который может откатить изменения. Чтобы откатить статус базы данных до определенной версии, замените `1.0.0` на вашу целевую версию и выполните команду ниже:

<Tabs groupId="cmd">

  <TabItem value="cli" label="CLI">

```bash
logto db alteration rollback 1.0.0
```

  </TabItem>
  <TabItem value="npx" label="npx">

```bash
npx @logto/cli db alteration rollback 1.0.0
```

  </TabItem>

</Tabs>

:::note
Вы можете найти все скрипты изменений [в этом каталоге](https://github.com/logto-io/logto/tree/master/packages/schemas/alterations).
:::

## Для участников \{#for-contributors}

В основной ветке репозитория Logto могут содержаться неопубликованные скрипты изменений. Вам может потребоваться вручную развернуть "next" изменения, выполнив:

<Tabs groupId="cmd">

  <TabItem value="cli" label="CLI">

```bash
logto db alteration deploy next
```

  </TabItem>
  <TabItem value="npx" label="npx">

```bash
npx @logto/cli db alteration deploy next
```

  </TabItem>

</Tabs>

Если вы разрабатываете функцию, требующую изменений в базе данных, помимо обновления схемы базы данных, вам также нужно предоставить скрипт в следующем формате:

```bash
next-[timestamp]-what-to-do.ts
```

Проверьте [этот каталог](https://github.com/logto-io/logto/tree/master/packages/schemas/alterations) для справки.
