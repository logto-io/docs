{/* Используется для генерации руководств по социальным SAML, только для целей обратной совместимости. */}

### Создание учетной записи социального IdP и регистрация SAML приложения (IdP)

Давайте рассмотрим конфигурации SAML коннектора.

Прежде чем начать, вы можете перейти к провайдеру социальной идентификации, который поддерживает протокол SAML, и создать свою учетную запись. Okta, OneLogin, Salesforce и некоторые другие платформы поддерживают аутентификацию на основе протокола SAML.

Если ваш IdP требует шифрования SAML утверждения и получения подписанных запросов аутентификации, вам следует сгенерировать ваш закрытый ключ и соответствующий сертификат, используя алгоритм RSA. Сохраните закрытый ключ для использования вашим SP и загрузите сертификат в IdP.

Вам также нужно настроить URL ACS (Assertion Consumer Service) как `${your_logto_origin}/api/authn/saml/${connector_id}` для обработки SAML утверждения от IdP. Вы можете найти ваш `connectorId` на странице деталей SAML коннектора в Административной консоли Logto.

:::note
Согласно текущему дизайну Logto, мы поддерживаем только Redirect-binding для отправки запроса аутентификации и POST-binding для получения SAML утверждения. Хотя это может показаться не очень крутым, мы считаем, что текущий дизайн может справиться с большинством ваших случаев использования. Если у вас возникнут проблемы, не стесняйтесь обращаться!
:::

### Настройка SAML коннектора (SP)

В этом разделе мы подробно рассмотрим каждый атрибут.

#### entityID `Обязательный`

`entityID` (т.е. `issuer`) — это идентификатор сущности. Он используется для идентификации вашей сущности (SAML SP сущности) и сопоставления эквивалентности в каждом SAML запросе / ответе.

#### signInEndpoint `Обязательный`

Конечная точка IdP, на которую вы отправляете SAML запросы аутентификации. Обычно вы можете найти это значение на странице деталей IdP (т.е. `SSO URL` или `Login URL` IdP).

#### x509Certificate `Обязательный`

x509 сертификат, сгенерированный из закрытого ключа IdP, IdP должен иметь это значение в наличии.

Содержимое сертификата начинается с заголовка `-----BEGIN CERTIFICATE-----` и заканчивается хвостом `-----END CERTIFICATE-----`.

#### idpMetadataXml `Обязательный`

Поле используется для размещения содержимого из вашего XML файла метаданных IdP.

:::note

XML парсер, который мы используем, не поддерживает кастомизированные пространства имен.
Если метаданные IdP содержат пространство имен, вам следует удалить их вручную.
Для пространства имен XML файла, см. [справочник](http://www.xmlmaster.org/en/article/d01/c10/).

:::

#### assertionConsumerServiceUrl `Обязательный`

URL сервиса потребления утверждений (ACS) — это конечная точка SP для получения POST запросов SAML утверждений от IdP. Как мы упоминали в предыдущей части, это обычно настраивается в настройках IdP, но некоторые IdP получают это значение из SAML запросов аутентификации, поэтому мы также добавляем это значение как обязательное поле. Его значение должно выглядеть как `${your_logto_origin}/api/authn/saml/${connector_id}`.

#### signAuthnRequest

Булево значение, которое контролирует, должен ли SAML запрос аутентификации быть подписан, его значение по умолчанию — `false`.

#### encryptAssertion

`encryptAssertion` — это булево значение, которое указывает, будет ли IdP шифровать SAML утверждение, значение по умолчанию — `false`.

:::note

Атрибуты `signAuthnRequest` и `encryptAssertion` должны соответствовать соответствующим параметрам настройки IdP, иначе будет выдана ошибка, показывающая, что конфигурация не соответствует.
Все SAML ответы должны быть подписаны.

:::

#### requestSignatureAlgorithm

Это должно соответствовать алгоритмам подписи IdP, чтобы Logto мог проверить подпись SAML утверждения. Его значение должно быть либо `http://www.w3.org/2000/09/xmldsig#rsa-sha1`, `http://www.w3.org/2001/04/xmldsig-more#rsa-sha256` или `http://www.w3.org/2001/04/xmldsig-more#rsa-sha512`, и значение по умолчанию — `http://www.w3.org/2001/04/xmldsig-more#rsa-sha256`.

#### messageSigningOrder

`messageSigningOrder` указывает порядок подписания и шифрования IdP, его значение должно быть либо `sign-then-encrypt` или `encrypt-then-sign`, и значение по умолчанию — `sign-then-encrypt`.

#### privateKey и privateKeyPass

`privateKey` — это необязательное значение и требуется, когда `signAuthnRequest` равно `true`.

`privateKeyPass` — это пароль, который вы установили при создании `privateKey`, требуется при необходимости.

Если `signAuthnRequest` равно `true`, соответствующий сертификат, сгенерированный из `privateKey`, требуется IdP для проверки подписи.

#### encPrivateKey и encPrivateKeyPass

`encPrivateKey` — это необязательное значение и требуется, когда `encryptAssertion` равно `true`.

`encPrivateKeyPass` — это пароль, который вы установили при создании `encPrivateKey`, требуется при необходимости.

Если `encryptAssertion` равно `true`, соответствующий сертификат, сгенерированный из `encPrivateKey`, требуется IdP для шифрования SAML утверждения.

:::note

Для генерации ключей и сертификатов `openssl` — это замечательный инструмент. Вот пример командной строки, которая может быть полезной:

```bash
openssl genrsa -passout pass:${privateKeyPassword} -out ${encryptPrivateKeyFilename}.pem 4096
openssl req -new -x509 -key ${encryptPrivateKeyFilename}.pem -out ${encryptionCertificateFilename}.cer -days 3650
```

Файлы `privateKey` и `encPrivateKey` должны быть закодированы в схеме `pkcs1` как строка pem, что означает, что файлы закрытых ключей должны начинаться с `-----BEGIN RSA PRIVATE KEY-----` и заканчиваться `-----END RSA PRIVATE KEY-----`.

:::

#### nameIDFormat

`nameIDFormat` — это необязательный атрибут, который объявляет формат идентификатора имени, который будет отвечать. Значение может быть среди `urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified`, `urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress`, `urn:oasis:names:tc:SAML:1.1:nameid-format:X509SubjectName`, `urn:oasis:names:tc:SAML:2.0:nameid-format:persistent` и `urn:oasis:names:tc:SAML:2.0:nameid-format:transient`, и значение по умолчанию — `urn:oasis:names:tc:SAML:2.0:nameid-format:unspecified`.

#### timeout

`timeout` — это временная толерантность для проверки времени, так как время между вашей сущностью SP и сущностью IdP может отличаться, а сетевое соединение также может вызвать задержку. Единица измерения — миллисекунды, и значение по умолчанию — 5000 (т.е. 5с).

#### profileMap

Logto также предоставляет поле `profileMap`, которое пользователи могут настроить для сопоставления профилей социальных поставщиков, которые обычно не являются стандартными. Каждый ключ `profileMap` — это стандартное имя поля профиля пользователя Logto, а соответствующее значение должно быть именем поля социального профиля. На текущем этапе Logto интересует только 'id', 'name', 'avatar', 'email' и 'phone' из социального профиля, только 'id' является обязательным, а остальные поля являются необязательными.

#### Типы конфигурации

| Имя                         | Тип                                                                                                                                                                                                                                                                                                   | Обязательный | Значение по умолчанию                                   |
| --------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------ | ------------------------------------------------------- |
| signInEndpoint              | string                                                                                                                                                                                                                                                                                                | true         |                                                         |
| x509certificate             | string                                                                                                                                                                                                                                                                                                | true         |                                                         |
| idpMetadataXml              | string                                                                                                                                                                                                                                                                                                | true         |                                                         |
| entityID                    | string                                                                                                                                                                                                                                                                                                | true         |                                                         |
| assertionConsumerServiceUrl | string                                                                                                                                                                                                                                                                                                | true         |                                                         |
| messageSigningOrder         | `encrypt-then-sign` \| `sign-then-encrypt`                                                                                                                                                                                                                                                            | false        | `sign-then-encrypt`                                     |
| requestSignatureAlgorithm   | `http://www.w3.org/2000/09/xmldsig#rsa-sha1` \| `http://www.w3.org/2001/04/xmldsig-more#rsa-sha256` \| `http://www.w3.org/2001/04/xmldsig-more#rsa-sha512`                                                                                                                                            | false        | `http://www.w3.org/2001/04/xmldsig-more#rsa-sha256`     |
| signAuthnRequest            | boolean                                                                                                                                                                                                                                                                                               | false        | false                                                   |
| encryptAssertion            | boolean                                                                                                                                                                                                                                                                                               | false        | false                                                   |
| privateKey                  | string                                                                                                                                                                                                                                                                                                | false        |                                                         |
| privateKeyPass              | string                                                                                                                                                                                                                                                                                                | false        |                                                         |
| nameIDFormat                | `urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified` \| `urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress` \| `urn:oasis:names:tc:SAML:1.1:nameid-format:X509SubjectName` \| `urn:oasis:names:tc:SAML:2.0:nameid-format:persistent` \| `urn:oasis:names:tc:SAML:2.0:nameid-format:transient` | false        | `urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified` |
| timeout                     | number                                                                                                                                                                                                                                                                                                | false        | 5000                                                    |
| profileMap                  | ProfileMap                                                                                                                                                                                                                                                                                            | false        |                                                         |

| Поля ProfileMap | Тип    | Обязательный | Значение по умолчанию |
| --------------- | ------ | ------------ | --------------------- |
| id              | string | false        | id                    |
| name            | string | false        | name                  |
| avatar          | string | false        | avatar                |
| email           | string | false        | email                 |
| phone           | string | false        | phone                 |

### Справочник

- [Профили для OASIS Security Assertion Markup Language (SAML) V2.0](http://docs.oasis-open.org/security/saml/v2.0/saml-profiles-2.0-os.pdf)
- [samlify - Высококонфигурируемая библиотека Node.js SAML 2.0 для единого входа](https://github.com/tngan/samlify)
