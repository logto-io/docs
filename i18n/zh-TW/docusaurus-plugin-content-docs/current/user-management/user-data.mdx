---
sidebar_position: 1
---

# 使用者資料結構

使用者是身分服務的核心實體。在 Logto 中，使用者資料包含基於 [OpenID Connect](https://auth.wiki/openid-connect) 協議的基本驗證 (Authentication) 資料，以及自訂資料。

## 使用者檔案 \{#user-profile}

每個使用者都有一份檔案，包含[所有使用者資訊](#property-reference)。

其內容包含以下類型的資料：

- [基本資料](/user-management/user-data#basic-data)：來自使用者檔案的基本資訊。儲存除了社交 `identities` 和 `custom_data` 以外的所有 _使用者_ 屬性，例如使用者 ID、使用者名稱、電子郵件、手機號碼，以及最近一次登入時間。
- [社交身分](/user-management/user-data#social-identities)：儲存從社交登入（即透過社交連接器登入）取得的使用者資訊，例如 Facebook、GitHub 和 WeChat。
- [自訂資料](/user-management/user-data#custom-data)：儲存未列於預設使用者屬性中的額外資訊，例如使用者偏好的顏色和語言。

以下是一個從 Facebook 登入取得的使用者資料範例：

```json
{
  "id": "iHXPuSb9eMzt",
  "username": null,
  "primaryEmail": null,
  "primaryPhone": null,
  "name": "John Doe",
  "avatar": "https://example.com/avatar.png",
  "customData": {
    "preferences": {
      "language": "en",
      "color": "#f236c9"
    }
  },
  "identities": {
    "facebook": {
      "userId": "106077000000000",
      "details": {
        "id": "106077000000000",
        "name": "John Doe",
        "email": "johndoe@logto.io",
        "avatar": "https://example.com/avatar.png"
      }
    }
  },
  "lastSignInAt": 1655799453171,
  "applicationId": "admin_console"
}
```

你可以透過 <CloudLink to="/users">Logto Console</CloudLink> 或 Logto Management API 查詢使用者檔案，例如 [`GET /api/users/:userId`](https://openapi.logto.io/operation/operation-getuser)。

## 基本資料 \{#basic-data}

以下將逐一說明 _基本資料_ 中的所有屬性。

### id \{#id}

_id_ 是 Logto 中用來唯一識別使用者的自動產生鍵值。

### username \{#username}

_username_ 用於以 _使用者名稱_ 和密碼登入。

其值來自使用者首次註冊時填寫的使用者名稱。可能為 `null`。非 null 值長度不得超過 128 字元，只能包含英文字母、數字和底線（`_`），且不得以數字開頭。區分大小寫。

### primary_email \{#primary_email}

_primary_email_ 是使用者的電子郵件地址，用於以電子郵件和密碼 / 驗證碼登入。

其值通常來自使用者首次註冊時填寫的電子郵件地址。可能為 `null`。最大長度為 128。

只有經過驗證的電子郵件地址（來自社交或企業級單一登入 (SSO) 身分提供者）才能同步並儲存為 `primary_email`。

### primary_phone \{#primary_phone}

_primary_phone_ 是使用者的手機號碼，用於以手機號碼和密碼 / 簡訊驗證碼登入。

其值通常來自使用者首次註冊時填寫的手機號碼。可能為 `null`。非 null 值應包含以[國碼](https://en.wikipedia.org/wiki/List_of_country_calling_codes)（不含加號 `+`）開頭的數字。

只有經過驗證的手機號碼（來自社交或企業級單一登入 (SSO) 身分提供者）才能同步並儲存為 `primary_phone`。

### name \{#name}

_name_ 是使用者的全名。最大長度為 128。

### avatar \{#avatar}

_avatar_ 是指向使用者頭像圖片的 URL。最大長度為 2048。

若使用者透過 Google、Facebook 等社交連接器註冊，該值可能來自社交使用者資訊。

:::note

此屬性對應 [OpenID Connect](https://openid.net/connect/) 標準中的 `picture` 宣告 (Claim)。

:::

### profile \{#profile}

_profile_ 儲存額外的 OpenID Connect [標準宣告 (Standard Claims)](https://openid.net/specs/openid-connect-core-1_0.html#StandardClaims)，這些宣告未包含於使用者屬性中。

其型別定義可參考[這個檔案](https://github.com/logto-io/logto/blob/HEAD/packages/schemas/src/foundations/jsonb-types/users.ts#L6)。以下為型別定義內容：

```tsx
type UserProfile = Partial<{
  familyName: string;
  givenName: string;
  middleName: string;
  nickname: string;
  preferredUsername: string;
  profile: string;
  website: string;
  gender: string;
  birthdate: string;
  zoneinfo: string;
  locale: string;
  address: Partial<{
    formatted: string;
    streetAddress: string;
    locality: string;
    region: string;
    postalCode: string;
    country: string;
  }>;
}>;
```

:::note

`Partial` 代表所有屬性皆為選填。

:::

與其他標準宣告不同的是，`profile` 中的屬性僅在其值不為空時，才會包含於 [ID 權杖 (ID token)](https://auth.wiki/id-token) 或 userinfo 端點回應中；而其他標準宣告若值為空則會回傳 `null`。

### application_id \{#application_id}

_application_id_ 的值來自使用者首次登入的應用程式。可能為 `null`。

### last_sign_in_at \{#last_sign_in_at}

_last_sign_in_at_ 為使用者最近一次登入時的帶時區時間戳記。

### created_at \{#created_at}

_created_at_ 為使用者註冊帳號時的帶時區時間戳記。

### updated_at \{#updated_at}

_updated_at_ 為使用者檔案資訊最近一次更新時的帶時區時間戳記。

### has_password \{#has_password}

_has_password_ 是布林值，表示使用者是否有設定密碼。你可以在 <CloudLink to="/users">Console > 使用者管理</CloudLink> 詳細頁面檢視與管理此狀態，包括設定新密碼或重設密碼。

### password_encrypted \{#password_encrypted}

_password_encrypted_ 用於儲存使用者加密後的密碼。

其值來自使用者首次註冊時填寫的密碼。可能為 `null`。若非 null，則加密前的原始內容至少需六個字元。

### password_encryption_method \{#password_encryption_method}

_password_encryption_method_ 用於加密使用者密碼。其值於使用者以使用者名稱和密碼註冊時初始化。可能為 `null`。

Logto 預設使用 [Argon2](https://en.wikipedia.org/wiki/Argon2) 的 [node-argon2](https://github.com/ranisalt/node-argon2) 實作作為加密方法；如有興趣可參考相關說明。

以下為密碼為 `123456` 的使用者 _password_encrypted_ 與 _password_encryption_method_ 範例：

```json
{
  "password_encryption_method": "Argon2i",
  "password_encrypted": "$argon2i$v=19$m=4096,t=10,p=1$aZzrqpSX45DOo+9uEW6XVw$O4MdirF0mtuWWWz68eyNAt2u1FzzV3m3g00oIxmEr0U"
}
```

### is_suspended \{#is_suspended}

_is_suspended_ 是布林值，表示使用者是否被停用。可透過 [Logto Management API](https://openapi.logto.io/operation/operation-updateuserissuspended) 或 Logto Console 管理此值。

一旦使用者被停用，先前授予的重新整理權杖 (Refresh tokens) 會立即失效，且該使用者將無法再通過 Logto 驗證。

### mfa_verification_factors \{#mfa_verification_factors}

_mfa_verification_factors_ 是一個陣列，列出與使用者帳號關聯的[多重要素驗證 (MFA, Multi-factor authentication)](/end-user-flows/mfa) 方法。可能的值包括：_Totp_（驗證器 App OTP）、_WebAuthn_（Passkey）、_BackupCode_。

```tsx
mfaVerificationFactors: ("Totp" | "WebAuthn" | "BackupCode")[];
```

## 社交身分 \{#social-identities}

_identities_ 包含從[社交登入](/end-user-flows/sign-up-and-sign-in/social-sign-in)（即透過[社交連接器](/connectors/social-connectors)登入）取得的使用者資訊。每個使用者的 _identities_ 以獨立 JSON 物件儲存。

使用者資訊依社交身分提供者（即社群平台）而異，通常包含以下內容：

- 身分提供者的 _target_，如 "facebook" 或 "google"
- 使用者在該提供者下的唯一識別碼
- 使用者名稱
- 使用者已驗證的電子郵件
- 使用者頭像

使用者帳號可透過社交登入綁定多個社交身分提供者，從這些提供者取得的對應資訊將儲存在 _identities_ 物件中。

以下為同時以 Google 與 Facebook 登入的使用者 _identities_ 範例：

```json
{
  "facebook": {
    "userId": "5110888888888888",
    "details": {
      "id": "5110888888888888",
      "name": "John Doe",
      "email": "johndoe@logto.io",
      "avatar": "https://example.com/avatar.png"
    }
  },
  "google": {
    "userId": "111000000000000000000",
    "details": {
      "id": "111000000000000000000",
      "name": "John Doe",
      "email": "johndoe@gmail.com",
      "avatar": "https://example.com/avatar.png"
    }
  }
}
```

## SSO 身分 \{#sso-identities}

_sso_identities_ 包含從[企業級單一登入 (Enterprise SSO)](/end-user-flows/enterprise-sso)（即透過企業連接器進行單一登入 (SSO, Single Sign-On) 登入](/connectors/enterprise-connectors)）取得的使用者資訊。每個使用者的 _ssoIdentities_ 以獨立 JSON 物件儲存。

從 SSO 身分提供者同步的資料取決於企業連接器所設定的權限範圍 (Scopes)。以下為 TypeScript 型別定義：

```ts
type SSOIdentity = {
  issuer: string;
  identityId: string;
  detail: JsonObject; // 參見 https://github.com/withtyped/withtyped/blob/master/packages/server/src/types.ts#L12
};
```

## 自訂資料 \{#custom-data}

_custom_data_ 儲存未列於預設使用者屬性中的額外資訊。

你可以利用 _custom_data_ 完成以下事項：

- 記錄使用者是否已執行特定動作，例如是否看過歡迎頁。
- 在使用者檔案中儲存應用程式專屬資料，例如每個應用程式的偏好語言與外觀。
- 維護與使用者相關的其他任意資料。

以下為 Logto 管理員使用者的 _custom_data_ 範例：

```json
{
  "adminConsolePreferences": {
    "language": "en",
    "appearanceMode": "system",
    "experienceNoticeConfirmed": true
  },
  "customDataFoo": {
    "foo": "foo"
  },
  "customDataBar": {
    "bar": "bar"
  }
}
```

每個使用者的 _custom_data_ 以獨立 JSON 物件儲存。

:::note

請勿將敏感資料放入 _custom_data_。

:::

自訂資料可透過[自訂 JWT 權杖宣告 (Custom JWT token claims)](/developers/custom-token-claims) 在使用者登入後存取，而 JWT 權杖僅以 base64 編碼（未加密），且經常在網路間傳輸，任何敏感資料都容易外洩。

你也可能透過 [Management API](https://openapi.logto.io/operation/operation-listusercustomdata) 取得包含 _custom_data_ 的使用者檔案，並傳送給前端應用程式或外部後端服務。因此，將敏感資訊放入 _custom_data_ 可能導致資料外洩。

若你仍需將敏感資訊放入 _custom_data_，建議先加密，且僅在可信任的後端服務進行加解密，避免於前端應用程式處理。如此可將 _custom_data_ 外洩時的損失降至最低。

**如何收集與更新使用者自訂資料**

- 使用 [收集使用者檔案](/end-user-flows/collect-user-profile) 功能於註冊時收集自訂資料。
- 使用 [Account API](/end-user-flows/account-settings/by-account-api) 實作終端使用者檔案或帳號設定。
  - 使用 [`GET /api/my-account`](https://openapi.logto.io/operation/operation-getprofile) 取得所有使用者資料。
  - 使用 [`PATCH /api/my-account`](https://openapi.logto.io/operation/operation-updateprofile) 更新使用者 _custom_data_。
- 使用 [Management API](/user-management/manage-users/#manage-via-logto-management-api) 進行使用者管理或進階自訂流程：
  - 使用 [`GET /api/users/{userId}`](https://openapi.logto.io/operation/operation-getuser) 取得所有使用者資料。
  - 使用 [`PATCH /api/users/{userId}/custom-data`](https://openapi.logto.io/operation/operation-updateusercustomdata) 更新使用者 _custom_data_。
- 你的客服團隊可直接於 <CloudLink to="/users">Console > 使用者管理</CloudLink> 更新使用者 _custom_data_。詳見[檢視與更新使用者檔案](/user-management/manage-users/#view-and-update-the-user-profile)。

請謹慎更新。更新使用者 _custom_data_ 會完全覆蓋原本儲存的內容。

例如，若你呼叫更新 _custom_data_ API 時的輸入如下（假設原本的 _custom_data_ 如前述範例）：

```json
{
  "customDataBaz": {
    "baz": "baz"
  }
}
```

則更新後的新 _custom_data_ 值為：

```json
{
  "customDataBaz": {
    "baz": "baz"
  }
}
```

也就是說，更新後的欄位值與先前的值無關。

## 屬性參考 \{#property-reference}

下列表格中的 DB 使用者資料表欄位（_password_encrypted_ 與 _password_encryption_method_ 除外）皆可於使用者檔案中查詢，亦可透過 [Management API](https://openapi.logto.io/operation/operation-getuser) 查詢。

| 名稱                                                                                | 型別      | 說明                         | 唯一 | 必填 |
| ----------------------------------------------------------------------------------- | --------- | ---------------------------- | ---- | ---- |
| [id](/user-management/user-data#id)                                                 | string    | 唯一識別碼                   | ✅   | ✅   |
| [username](/user-management/user-data#username)                                     | string    | 登入用使用者名稱             | ✅   | ❌   |
| [primary_email](/user-management/user-data#primary_email)                           | string    | 主要電子郵件                 | ✅   | ❌   |
| [primary_phone](/user-management/user-data#primary_phone)                           | string    | 主要手機號碼                 | ✅   | ❌   |
| [name](/user-management/user-data#name)                                             | string    | 全名                         | ❌   | ❌   |
| [avatar](/user-management/user-data#avatar)                                         | string    | 指向使用者頭像圖片的 URL     | ❌   | ❌   |
| [profile](/user-management/user-data#profile)                                       | object    | 使用者檔案                   | ❌   | ✅   |
| [identities](/user-management/user-data#social-identities)                          | object    | 從社交登入取得的使用者資訊   | ❌   | ✅   |
| [custom_data](/user-management/user-data#custom-data)                               | object    | 可自訂屬性中的額外資訊       | ❌   | ✅   |
| [application_id](/user-management/user-data#application_id)                         | string    | 使用者首次註冊的應用程式 ID  | ❌   | ✅   |
| [last_sign_in_at](/user-management/user-data#last_sign_in_at)                       | date time | 使用者最近一次登入的時間戳記 | ❌   | ✅   |
| [password_encrypted](/user-management/user-data#password_encrypted)                 | string    | 加密後的密碼                 | ❌   | ❌   |
| [password_encryption_method](/user-management/user-data#password_encryption_method) | string    | 密碼加密方法                 | ❌   | ❌   |
| [is_suspended](/user-management/user-data#is_suspended)                             | bool      | 使用者停用標記               | ❌   | ✅   |
| [mfa_verifications](/user-management/user-data#mfa_verification_factors)            | object[]  | MFA 驗證因子                 | ❌   | ✅   |

- **唯一**：確保資料表屬性值的[唯一性](https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-UNIQUE-CONSTRAINTS)。
- **必填**：確保資料表屬性值不可為 `null`。

## 相關資源 \{#related-resources}

<Url href="https://blog.logto.io/secure-hub-for-user-data/">使用者資料流動的安全樞紐</Url>
