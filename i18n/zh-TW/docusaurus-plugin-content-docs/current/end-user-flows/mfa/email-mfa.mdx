---
sidebar_position: 5
sidebar_label: MFA 電子郵件
---

# MFA 電子郵件驗證

Logto 支援以電子郵件為基礎的多重要素驗證 (MFA, Multi-factor authentication) 功能，透過向使用者註冊的電子郵件地址發送一次性驗證碼來提升帳號安全性。電子郵件 MFA 作為第二驗證因素，可與其他 MFA 因素（如 TOTP、通行密鑰、備用代碼）結合，為使用者提供彈性的雙重驗證選項。

## 概念 \{#concepts}

電子郵件驗證是最普及的 MFA 方法之一。它利用電子郵件帳號的廣泛可用性，將臨時的一次性驗證碼直接發送到使用者的電子郵件信箱。與需要額外安裝軟體的應用程式型驗證器不同，電子郵件 MFA 利用現有的電子郵件基礎設施，幾乎所有網際網路使用者都能透過瀏覽器、郵件客戶端或行動應用程式存取。因此，除了擁有電子郵件帳號外，無需特殊硬體或額外設定，使用者即可立即啟用。

## 設定 MFA 電子郵件驗證 \{#configure-email-verification-for-mfa}

**步驟 1：設定電子郵件連接器與範本**

1. 前往 <CloudLink to="/connectors/passwordless">主控台 > 連接器 > 電子郵件與簡訊連接器</CloudLink>
2. 選擇合適的電子郵件連接器（SendGrid、Mailgun 等）
3. 設定連線參數
4. 為 MFA 設定 [電子郵件範本](/connectors/email-connectors/email-templates) 與專用用途類型：

   - `MfaVerification` usageType 用於 MFA 驗證
   - `BindMFA` usageType 用於綁定 MFA
   - 小提示：[Logto 電子郵件服務](/connectors/email-connectors/built-in-email-service) 提供內建電子郵件範本

5. 參考 [電子郵件連接器](/connectors/email-connectors) 取得各供應商的詳細設定說明

**步驟 2：啟用 MFA 電子郵件驗證**

1. 前往 <CloudLink to="/mfa">主控台 > 多重要素驗證</CloudLink>
2. 啟用「電子郵件驗證碼」因素。建議將電子郵件 MFA 與其他 MFA 因素（TOTP、通行密鑰、簡訊、備用代碼）搭配使用，以降低單一因素依賴。
3. 設定你偏好的 MFA 政策（強制 / 選用）
4. 儲存設定變更

:::note 重要使用注意事項

1. **登入方式限制**：電子郵件驗證碼不可同時作為 [登入方式 (1FA)](/end-user-flows/sign-up-and-sign-in/sign-in) 與 MFA 因素 (2FA) 使用。每個電子郵件實作請選擇一種驗證流程。

2. **註冊方式相容性**：電子郵件驗證碼可同時用於註冊方式與 MFA。Logto 會根據你選擇的 MFA 政策最佳化終端使用者註冊流程，避免對同一電子郵件地址重複驗證。

3. **密碼重設相容性**：雖然電子郵件驗證碼可同時用於 [忘記密碼](/end-user-flows/sign-up-and-sign-in/reset-password) 與 MFA，但**不建議**這樣組合。此設定會降低 MFA 安全性，因為使用者可能透過忘記密碼的電子郵件驗證繞過 MFA，重設密碼後以新密碼進行主驗證 (1FA)，再用相同電子郵件方式進行 MFA 驗證。

:::

## 電子郵件 MFA 設定流程 \{#email-mfa-setup-flows}

MFA 設定提示可能出現在使用者註冊時或登入後，具體時機取決於你設定的 [MFA 政策](/end-user-flows/mfa/configure-mfa#global-mfa-configuration)。

電子郵件 MFA 設定流程會受到以下因素影響：

- **MFA 主要因素數量**：若有多個主要因素，使用者需選擇一個進行設定。主要因素指除備用代碼外的 MFA 方法。
- **啟用備用代碼**：啟用時，設定完主要 MFA 因素後會自動產生備用代碼，並提示使用者儲存。
- **註冊識別子設定**：若電子郵件地址作為 [註冊識別子](/end-user-flows/sign-up-and-sign-in/sign-up#set-up-the-sign-up-identifier) 且註冊時已用電子郵件驗證碼驗證，系統會自動將該電子郵件綁定為 MFA 因素，無需再次驗證。若有其他主要因素，UI 會顯示「新增另一個兩步驟驗證」選項（可略過），並明確標示已啟用 MFA。
- **現有使用者資料**：現有使用者登入後設定 MFA 時，需先完成主驗證，再進行 MFA 設定。若帳號已有已驗證的主要電子郵件地址，設定流程與上述註冊識別子情境相同。

以下為三種常見的電子郵件 MFA 綁定情境。

### 情境 1：電子郵件僅用於 MFA（典型流程）{scenario-1-email-address-only-used-for-mfa-typical-flow} \{#scenario-1-email-address-only-used-for-mfa-typical-flow}

當電子郵件地址不是註冊識別子，僅用於 MFA 時，請依標準設定流程操作：

- 若僅有一個電子郵件 MFA 因素，直接顯示該因素設定 UI。
- 若有多個主要 MFA 因素，顯示「設定 MFA」列表頁，讓使用者選擇要設定的因素。

**範例：**

<details>
  <summary>
    註冊：`手機號碼 + 簡訊驗證碼 + 密碼` | MFA：`電子郵件驗證碼 +
    備用代碼`
  </summary>
  <img src="/img/assets/email-mfa-setup-scenario-1-1.png" alt="Email MFA 設定流程 1-1" />
</details>

<details>
  <summary>
    註冊：`手機號碼 + 簡訊驗證碼 + 密碼` | MFA：`電子郵件驗證碼 +
    通行密鑰 + 驗證器應用程式 OTP + 備用代碼`
  </summary>
  <img src="/img/assets/email-mfa-setup-scenario-1-2.png" alt="Email MFA 設定流程 1-2" />
</details>

### 情境 2：電子郵件作為註冊識別子且已驗證{scenario-2-email-verified-as-the-sign-up-identifier} \{#scenario-2-email-verified-as-the-sign-up-identifier}

若電子郵件地址為註冊識別子，且註冊時已用電子郵件驗證碼驗證，系統會自動將該電子郵件綁定為 MFA 因素，無需額外驗證。

**範例：**

<details>
  <summary>
    註冊：`電子郵件地址 + 電子郵件驗證碼 + 密碼` | MFA：`電子郵件驗證碼 +
    備用代碼`
  </summary>
  <img src="/img/assets/email-mfa-setup-scenario-2.png" alt="Email MFA 設定流程 2" />
</details>

### 情境 3：電子郵件已驗證但有多個主要因素{scenario-3-email-verified-but-multiple-primary-factors-available} \{#scenario-3-email-verified-but-multiple-primary-factors-available}

若電子郵件地址於註冊時已驗證（作為註冊識別子），但帳號有多個主要 MFA 因素（如電子郵件加通行密鑰或驗證器應用程式），UI 會提示「新增另一個兩步驟驗證」。使用者可選擇新增其他因素或略過，提示同時也會說明已啟用 MFA。

**範例：**

<details>
  <summary>
    註冊：`電子郵件地址 + 電子郵件驗證碼 + 密碼` | MFA：`電子郵件驗證碼 +
    通行密鑰 + 驗證器應用程式 OTP + 備用代碼`
  </summary>
  <img src="/img/assets/email-mfa-setup-scenario-3.png" alt="Email MFA 設定流程 3" />
</details>

## 電子郵件 MFA 驗證流程 \{#email-mfa-verification-flows}

啟用電子郵件 MFA 的使用者登入時，完成主驗證 (1FA) 後，系統會提示其以電子郵件驗證碼作為第二驗證因素 (2FA) 進行身分驗證。

若有多個 MFA 因素，使用者可從已設定的因素中選擇。系統會根據 [MFA 設定](/end-user-flows/mfa/configure-mfa#mfa-verification-flow) 中指定的優先順序決定先提示哪個 MFA 因素。

**範例：**

<details>
  <summary>
    登入：`手機號碼 + 密碼` | MFA：`電子郵件驗證碼（上次使用） /
    驗證器應用程式 OTP / 備用代碼`
  </summary>
  <img src="/img/assets/email-mfa-verification-flow.png" alt="Email MFA 驗證流程" />
</details>

## 錯誤處理 \{#error-handling}

1. **電子郵件地址未綁定**

   - 錯誤代碼：`session.mfa.mfa_factor_not_enabled`
   - 處理方式：引導使用者先綁定電子郵件地址

2. **驗證碼錯誤**

   - 錯誤代碼：`verification_code.code_mismatch`
   - 處理方式：提示使用者重新輸入，限制重試次數

3. **驗證碼過期**

   - 錯誤代碼：`verification_code.expired`
   - 處理方式：提示使用者重新取得驗證碼

4. **發送頻率超過限制**
   - 錯誤代碼：`connector.rate_limit_exceeded`
   - 處理方式：顯示等待時間，限制重發次數
