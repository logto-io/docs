import TabItem from '@theme/TabItem';
import Tabs from '@theme/Tabs';

import AccessTokenResponse from './_access-token-response.mdx';
import M2mAccessTokenNote from './_m2m-access-token-sub-note.mdx';

Logto 提供內建的「Logto Management API」資源，這是一個唯讀資源，擁有 `all` 權限以存取 Logto Management API，你可以在 API 資源清單中看到它。
該資源的 API 標示符（API indicator）格式為 `https://{your-tenant-id}.logto.app/api`，這將是你在存取權杖 (Access token) 請求主體中使用的 resource 值。

<img alt="Logto Management API details" src="/img/assets/logto-management-api.png" width="600px" />

在存取 Logto Management API 前，請確保你的 M2M 應用程式已被指派包含此內建「Logto Management API」資源 `all` 權限的 M2M 角色 (Role)。

:::info
Logto 也為新建立的租戶預先配置了一個「Logto Management API access」M2M 角色，該角色已經指派了 Logto Management API 資源的 all 權限。你可以直接使用，無需手動設定權限。這個預設角色也可以根據需要編輯或刪除。
:::

現在，將上述內容整合並發送請求：

:::info
自 v1.30.1 版本起，Logto 提供官方 `@logto/api` Node.js SDK，協助你輕鬆與 Logto Management API 互動。
:::

<Tabs groupId="interact-with-m-api">

<TabItem value="with-@logto-api-sdk" label="Node.js with `@logto/api` SDK">

#### Logto Cloud \{#logto-cloud}

```js
import { createManagementApi } from '@logto/api/management';

const { apiClient, clientCredentials } = createManagementApi('your-tenant-id', {
  clientId: 'your-client-id',
  clientSecret: 'your-client-secret',
});

const { value } = await clientCredentials.getAccessToken();
console.log('Access token:', value);

// 或者你甚至可以跳過取得存取權杖 (Access token)，直接呼叫 API
const response = await apiClient.GET('/api/users');
console.log(response.data);
```

#### 自行託管 / OSS \{#self-hosted-oss}

OSS 使用者應使用 `default` 作為 tenant ID，並同時提供 `baseUrl` 與 `apiIndicator` 設定。

```js
const { apiClient, clientCredentials } = createManagementApi('default', {
  clientId: 'your-client-id',
  clientSecret: 'your-client-secret',
  // highlight-start
  baseUrl: 'https://your.logto.endpoint',
  apiIndicator: 'https://default.logto.app/api',
  // highlight-end
});
```

</TabItem>

<TabItem value="nodejs" label="Node.js">

```js
const logtoEndpoint = 'https://your.logto.endpoint'; // 請替換為你的 Logto endpoint
const tokenEndpoint = `${logtoEndpoint}/oidc/token`;
const applicationId = 'your-application-id';
const applicationSecret = 'your-application-secret';
const tenantId = 'your-tenant-id';

const fetchAccessToken = async () => {
  return await fetch(tokenEndpoint, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      Authorization: `Basic ${Buffer.from(`${applicationId}:${applicationSecret}`).toString(
        'base64'
      )}`,
    },
    body: new URLSearchParams({
      grant_type: 'client_credentials',
      resource: `https://${tenantId}.logto.app/api`,
      scope: 'all',
    }).toString(),
  });
};
```

:::caution
Logto Cloud 使用者注意：當你與 Logto Management API 互動時，不能使用自訂網域，請使用預設 Logto endpoint `https://{your_tenant_id}.logto.app/oidc/token` 來取得存取權杖 (Access token)。
:::

<AccessTokenResponse />
<M2mAccessTokenNote />

</TabItem>

<TabItem value="curl" label="cURL">

```bash
curl --location \
  --request POST 'https://your.logto.endpoint' \
  --header 'Authorization: Basic ${your_auth_string}' \
  --header 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode 'grant_type=client_credentials' \
  --data-urlencode 'resource=https://${tenantId}.logto.app/api' \
  --data-urlencode 'scope=all'
```

請記得將實際值替換為你自己的資訊。

:::caution
Logto Cloud 使用者注意：當你與 Logto Management API 互動時，不能使用自訂網域，請使用預設 Logto endpoint `https://{your_tenant_id}.logto.app/oidc/token` 來取得存取權杖 (Access token)。
:::

<AccessTokenResponse />
<M2mAccessTokenNote />

</TabItem>

</Tabs>
