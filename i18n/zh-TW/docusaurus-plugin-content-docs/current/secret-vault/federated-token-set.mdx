---
id: federated-token-set
title: 第三方權杖儲存與 API 存取
sidebar_label: 第三方權杖儲存
---

import Availability from '@components/Availability';

<Availability cloud oss={{ major: 1, minor: 31 }} />

第三方權杖集（又稱為聯邦權杖集，federated token set）是一種儲存在 Logto [秘密保管庫](/secret-vault) 的秘密類型，用於安全管理由第三方身分提供者 (IdP) 發出的存取權杖 (Access token) 與重新整理權杖 (Refresh token)。當使用者透過社交或企業級單一登入 (SSO) 連接器進行驗證 (Authentication) 時，Logto 會將發出的權杖儲存在保管庫中。這些權杖之後可被取出，用於代表使用者存取第三方 API，而無需再次驗證。

## 常見應用場景 \{#common-use-cases}

這項能力對於現代應用程式（如 AI 代理人、SaaS 平台、生產力工具與需代表使用者與第三方服務互動的客戶應用程式）至關重要。以下是一些實際範例：

**📅 行事曆管理應用**：使用者以 Google 登入後，你的生產力應用可自動同步行事曆事件、建立新會議並發送邀請，無需再次要求驗證。

**🤖 AI 助理**：AI 代理人可存取使用者的 GitHub 儲存庫以分析程式碼、建立 pull request 或管理議題。這一切僅需使用者在登入或帳號連結時一次性同意。

**📊 分析儀表板**：SaaS 平台可從使用者連結的社群帳號（Facebook、LinkedIn）拉取資料，產生洞察與報告，無需重複登入中斷工作流程。

## 啟用第三方權杖儲存 \{#enable-third-party-token-storage}

### 社交連接器 \{#social-connectors}

此功能適用於支援權杖儲存的 [社交連接器](/connectors/social-connectors)。第三方權杖可於 [社交登入](/end-user-flows/sign-up-and-sign-in/social-sign-in)、[社交帳號連結](/end-user-flows/account-settings/by-account-api#link-a-new-social-connection) 及 [為第三方 API 存取續約權杖時](/secret-vault/federated-token-set#reauthentication-and-token-renewal) 儲存。目前支援的連接器包括：[GitHub](/integrations/github)、[Google](/integrations/google)、[Facebook](/integrations/facebook)、[標準 OAuth 2.0](/integrations/oauth2)、[標準 OIDC](/integrations/oidc)。未來將陸續支援更多連接器。

1. 前往 <CloudLink to="/connectors/social">Console > Connectors > Social Connectors</CloudLink>。
2. 選擇你要啟用第三方權杖儲存的社交連接器。
3. 依照設定教學配置連接器，包含新增存取特定第三方 API 所需的權限範圍 (Scopes)。
4. 在「Setting」頁面啟用 **Store tokens for persistent API access** 選項。

### 企業級 SSO 連接器 \{#enterprise-sso-connectors}

所有 OIDC [企業連接器](/connectors/enterprise-connectors)皆支援權杖儲存。存取權杖 (Access token) 與重新整理權杖 (Refresh token) 可於 [企業級單一登入 (Enterprise SSO)](/end-user-flows/enterprise-sso) 時儲存。目前支援的連接器包括：[Google Workspace](/integrations/google-workspace)。

1. 前往 <CloudLink to="/enterprise-sso">Console > Enterprise SSO</CloudLink>。
2. 選擇你要啟用第三方權杖儲存的企業級 SSO 連接器。
3. 依照設定教學配置連接器，包含新增存取特定第三方 API 所需的權限範圍 (Scopes)。
4. 在「SSO Experience」分頁啟用 **Store tokens for persistent API access** 選項。

請記得儲存你的變更。

## 權杖儲存 \{#token-storage}

啟用第三方權杖儲存後，Logto 會在使用者透過社交或企業級 SSO 連接器驗證時，自動儲存由聯邦身分提供者發出的存取權杖 (Access token) 與重新整理權杖 (Refresh token)。包含：

- [社交登入與註冊](/end-user-flows/sign-up-and-sign-in/social-sign-in)
- [企業級 SSO 登入與註冊](/end-user-flows/enterprise-sso)
- [透過 Account API 進行社交帳號連結](/end-user-flows/account-settings/by-account-api#link-a-new-social-connection)

儲存的權杖會綁定於使用者的社交或企業級 SSO 身分，讓他們日後可於無需再次驗證的情況下取出權杖以存取 API。

### 檢查權杖儲存狀態 \{#checking-token-storage-status}

你可以在 Logto Console 檢查使用者的第三方權杖儲存狀態：

1. 前往 <CloudLink to="/users">Console > Users</CloudLink>。
2. 點擊你要檢查的使用者，進入該使用者詳細頁面。
3. 捲動至 **Connections** 區塊，這裡會列出所有與該使用者關聯的社交與企業級 SSO 連線。
4. 每個連線條目都會顯示權杖狀態標籤，指示該連線是否有儲存權杖。
5. 點擊連線條目可查看更多細節，包括儲存的存取權杖 (Access token) 中繼資料與重新整理權杖 (Refresh token) 是否可用。

你也可以透過 Management API 查詢使用者第三方身分與權杖儲存狀態：

- `GET /api/users/{userId}/identities/{target}?includeTokenSecret=true`：根據指定連接器 target（如 `github`、`google` 等）查詢使用者的社交身分與權杖儲存狀態。
- `GET /api/users/{userId}/sso-identities/{ssoConnectorId}?includeTokenSecret=true`：根據指定 SSO 連接器 ID 查詢使用者的企業級 SSO 身分與權杖儲存狀態。

### 權杖儲存狀態 \{#token-storage-status}

- **Active**：存取權杖 (Access token) 已儲存且有效。
- **Expired**：存取權杖已儲存但已過期。若有重新整理權杖 (Refresh token)，可用於取得新存取權杖。
- **Inactive**：此連線未儲存存取權杖。可能是使用者尚未透過此連線驗證，或權杖儲存已被刪除。
- **Not applicable**：此連接器不支援權杖儲存。

### 權杖中繼資料 \{#token-metadata}

為確保資料完整性與安全性，所有權杖在儲存進秘密保管庫前皆會加密。實際權杖值僅能由具備適當授權的終端使用者存取。開發者僅能取得權杖集的中繼資料，以瞭解儲存狀態而不暴露敏感內容。

- `createdAt`：首次建立連線並將權杖集儲存進秘密保管庫的時間戳記。
- `updatedAt`：權杖集最後一次更新的時間。
  - 若無重新整理權杖，該值與 **createdAt** 相同。
  - 若有重新整理權杖，該值反映最近一次存取權杖被刷新時的時間。
- `hasRefreshToken`：是否有重新整理權杖可用。
  若連接器支援離線存取且授權請求正確配置，Logto 會在身分提供者發出時一併儲存重新整理權杖與存取權杖。
  當存取權杖過期且有有效重新整理權杖時，Logto 會在使用者請求存取連接的服務時自動嘗試以儲存的重新整理權杖取得新存取權杖。
- `expiresAt`：存取權杖的預估過期時間（單位：秒）。
  此值根據身分提供者權杖端點回傳的 `expires_in` 計算。（僅當提供者回傳 `expires_in` 時才有此欄位。）
- `scope`：存取權杖的權限範圍，表示身分提供者授予的權限。
  有助於瞭解儲存的存取權杖可執行哪些操作。（僅當提供者回傳 `scope` 時才有此欄位。）
- `tokenType`：存取權杖的型別，通常為 "Bearer"。
  （僅當提供者回傳 `token_type` 時才有此欄位。）

## 權杖擷取 \{#token-retrieval}

啟用權杖儲存並將權杖安全儲存於 Logto 秘密保管庫後，終端使用者可透過整合 Logto [Account API](/end-user-flows/account-settings/by-account-api) 從你的用戶端應用程式擷取其第三方存取權杖 (Access token)。

- `GET /my-account/identities/:target/access-token`：指定連接器 target（如 github、google）以擷取社交身分的存取權杖。

- `GET /my-account/sso-identities/:connectorId/access-token`：指定連接器 ID 以擷取企業級 SSO 身分的存取權杖。

:::info
瞭解如何[啟用](/end-user-flows/account-settings/by-account-api#how-to-enable-account-api)與[存取](/end-user-flows/account-settings/by-account-api#access-account-api-using-access-token) Account API（使用 Logto 發出的存取權杖）。
:::

### 權杖輪替 \{#token-rotation}

權杖擷取端點會回傳：

- `200` OK：成功擷取且存取權杖仍有效。
- `404` Not Found：使用者未有指定 target 或連接器 ID 的社交或企業級 SSO 身分，或未儲存存取權杖。
- `401` Unauthorized：存取權杖已過期。

若存取權杖已過期且有重新整理權杖 (Refresh token)，Logto 會自動嘗試刷新存取權杖並於回應中回傳新權杖。秘密保管庫中的權杖儲存也會同步更新新存取權杖及其中繼資料。

## 權杖儲存刪除 \{#token-storage-deletion}

第三方權杖儲存直接綁定於每位使用者的社交或企業級 SSO 連線。這表示在下列情況下，儲存的權杖集會自動刪除：

- 關聯的社交或企業級 SSO 身分自使用者帳號移除。
- 使用者帳號自你的租戶刪除。
- 社交或企業級 SSO 連接器自你的租戶刪除。

### 撤銷權杖 \{#revoking-tokens}

你也可以手動刪除使用者的第三方權杖集以撤銷存取：

- 透過 Console：
  前往使用者身分詳細頁面，捲動至 **Access token** 區塊（若有權杖儲存），點擊區塊底部的 **Delete tokens** 按鈕。
- 透過 Management API：
  - `DELETE /api/secret/:id`：根據身分詳細頁取得的 ID 刪除指定秘密。

撤銷權杖集後，使用者需重新向第三方提供者驗證以取得新存取權杖，方可再次存取第三方 API。

## 重新驗證與權杖續約 \{#reauthentication-and-token-renewal}

當儲存的存取權杖已過期，或應用程式需請求額外 API 權限範圍時，終端使用者可重新向第三方提供者驗證以取得新存取權杖——無需再次登入 Logto。
這可透過 Logto [Social Verification API](https://openapi.logto.io/operation/operation-createverificationbysocial) 實現，允許使用者重新啟動聯邦社交授權流程並更新其儲存的權杖集。

:::note
重新啟動聯邦授權目前僅限於社交連接器。
對於企業級 SSO 連接器，重新驗證與權杖續約需使用者重新啟動完整 Logto 驗證流程，因目前尚不支援登入後直接向企業級 SSO 提供者重新授權。
:::

```mermaid
sequenceDiagram
    autonumber

    participant User as 使用者 (User)
    participant Logto as Logto
    participant Provider as 第三方提供者 (Third-party Provider)

    User->>Logto: post /api/verification/social
    Logto->>User: 重新導向至第三方提供者
    User->>Provider: 驗證與授權
    Provider->>User: 以授權碼導回
    User->>Logto: post /api/verification/social/verify，帶授權碼
    Logto->>User: 回傳社交驗證 ID
    User->>Logto: patch /my-account/identities/:target/access-token
```

1. 使用者呼叫 `POST /api/verification/social` 端點發起社交驗證請求。可指定自訂權限範圍 (Scopes) 以請求第三方提供者額外權限。

   ```sh
   curl -X POST https://<your-logto-domain>/api/verification/social \
     -H "Authorization: Bearer <access_token>" \
     -H "Content-Type: application/json" \
     -d '{
       "state": "<state>",
       "connectorId": "<logto_connectorId>",
       "redirectUri": "<redirect_uri>",
       "scope": "<custom_scope>"
     }'
   ```

   - **authorization header**：Logto 發出的使用者存取權杖。
   - **connectorId**：Logto 中的社交連接器 ID。
   - **redirectUri**：驗證後將使用者導回你應用程式的 URI。你需在提供者應用程式設定中註冊此 URI。
   - **scope**：（選填）自訂權限範圍，請求第三方提供者額外權限。若未指定，將使用連接器預設權限範圍。

2. Logto 建立新的社交驗證紀錄並回傳社交驗證 ID 及授權 URL，供你將使用者導向第三方提供者進行驗證。

   回應範例如下：

   ```json
   {
     "verificationRecordId": "<social_verification_id>",
     "authorizationUri": "<authorization_url>",
     "expiresAt": "<expiration_time>"
   }
   ```

3. 將使用者導向授權 URL。使用者於第三方提供者驗證並授權。

4. 第三方提供者以授權碼將使用者導回你的用戶端應用程式。

5. 處理授權回呼，將授權碼轉發至 Logto 驗證端點：

   ```sh
   curl -X POST https://<your-logto-domain>/api/verification/social/verify \
     -H "Authorization: Bearer <access_token>" \
     -d '{
       "verificationRecordId": "<social_verification_id>",
       "connectorData": {
         "code": "<authorization_code>",
         "state": "<state>",
         "redirectUri": "<redirect_uri>"
       }
     }'
   ```

   - **authorization header**：Logto 發出的使用者存取權杖。
   - **verificationRecordId**：前一步回傳的社交驗證 ID。
   - **connectorData**：授權碼及第三方提供者於回呼時回傳的其他資料。

   :::note
   請務必驗證 `state` 參數以防止 CSRF 攻擊。
   :::

6. Logto 驗證授權碼並向第三方提供者換取新存取權杖與重新整理權杖，然後於回應中回傳社交驗證 ID。

7. 最後，呼叫 `PATCH /my-account/identities/:target/access-token` 端點並帶入社交驗證 ID，以更新使用者的權杖儲存：

   ```sh
   curl -X PATCH https://<your-logto-domain>/my-account/identities/<target>/access-token \
     -H "Authorization: Bearer <access_token>" \
     -H "Content-Type: application/json" \
     -d '{
       "socialVerificationId": "<social_verification_id>"
     }'
   ```

   - **authorization header**：Logto 發出的使用者存取權杖。
   - **socialVerificationId**：前一步回傳的已驗證社交驗證紀錄 ID。

   這將以新存取權杖與重新整理權杖更新 Logto 秘密保管庫中的使用者權杖集，讓使用者無需再次登入 Logto 即可存取第三方 API。

   更新後的存取權杖將會回傳。
