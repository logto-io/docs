---
sidebar_position: 1
sidebar_label: å¯¦å‹™ä¸Šçš„è§’è‰²å‹å­˜å–æ§åˆ¶ (RBAC in practice)
description: 'è§’è‰²å‹å­˜å–æ§åˆ¶ (RBAC, Role-based Access Control) å¯¦å‹™æŒ‡å—ï¼šå­¸ç¿’å¦‚ä½•è¨­è¨ˆæ¬Šé™ã€ç®¡ç†è§’è‰²ï¼Œä¸¦åœ¨ä½ çš„ CMS ä¸­å»ºç«‹å®‰å…¨çš„æˆæ¬Š (Authorization)ã€‚'
---

<head>
  <link rel="canonical" href="https://blog.logto.io/rbac-in-practice" />
</head>

# å¯¦å‹™ä¸Šçš„è§’è‰²å‹å­˜å–æ§åˆ¶ (RBAC in practice)ï¼šç‚ºä½ çš„æ‡‰ç”¨ç¨‹å¼å¯¦ä½œå®‰å…¨çš„æˆæ¬Š (Authorization)

ä½ æ˜¯å¦åœ¨ç‚ºä½ çš„æ‡‰ç”¨ç¨‹å¼å¯¦ä½œä¸€å€‹å®‰å…¨ä¸”å¯æ“´å±•çš„æˆæ¬Š (Authorization) ç³»çµ±è€Œè‹¦æƒ±ï¼Ÿ**è§’è‰²å‹å­˜å–æ§åˆ¶ (RBAC, Role-based Access Control)** æ˜¯ç®¡ç†ä½¿ç”¨è€…æ¬Šé™çš„æ¥­ç•Œæ¨™æº–ï¼Œä½†æ­£ç¢ºå¯¦ä½œå»å……æ»¿æŒ‘æˆ°ã€‚æœ¬æ•™å­¸å°‡ä»¥å¯¦éš›çš„å…§å®¹ç®¡ç†ç³»çµ±ï¼ˆCMSï¼‰æ¡ˆä¾‹ï¼Œå¸¶ä½ å»ºç«‹ä¸€å¥—å¥å…¨çš„ RBAC ç³»çµ±ã€‚

è·Ÿè‘—æœ¬æŒ‡å—ï¼Œä½ å°‡å­¸æœƒï¼š

- âœ¨ å¦‚ä½•è¨­è¨ˆèˆ‡å¯¦ä½œç´°ç·»çš„æ¬Šé™ï¼Œç²¾ç¢ºæŒæ§æ“ä½œ
- ğŸ”’ å¦‚ä½•å°‡æ¬Šé™æœ‰æ„ç¾©åœ°çµ„ç¹”æˆè§’è‰²çš„æœ€ä½³å¯¦è¸
- ğŸ‘¤ æœ‰æ•ˆè™•ç†è³‡æºæ“æœ‰æ¬Šçš„æŠ€å·§
- ğŸš€ è®“ä½ çš„æˆæ¬Š (Authorization) ç³»çµ±å…·å‚™å¯æ“´å±•æ€§èˆ‡å¯ç¶­è­·æ€§çš„æ–¹å¼
- ğŸ’¡ ä»¥çœŸå¯¦ CMS æ¡ˆä¾‹å¯¦ä½œ

æœ¬æ•™å­¸çš„å®Œæ•´åŸå§‹ç¢¼å¯åœ¨ [GitHub](https://github.com/logto-io/rbac-sample) å–å¾—ã€‚

## ç†è§£ RBAC åŸºç¤ \{#understanding-rbac-fundamentals}

è§’è‰²å‹å­˜å–æ§åˆ¶ (RBAC) ä¸åƒ…åƒ…æ˜¯å°‡æ¬Šé™åˆ†é…çµ¦ä½¿ç”¨è€…ï¼Œæ›´æ˜¯å»ºç«‹ä¸€å¥—çµæ§‹åŒ–çš„æˆæ¬Š (Authorization) æ–¹æ³•ï¼Œå…¼é¡§å®‰å…¨æ€§èˆ‡å¯ç¶­è­·æ€§ã€‚

ä½ å¯ä»¥åœ¨ Auth Wiki é€²ä¸€æ­¥äº†è§£ [ä»€éº¼æ˜¯ RBAC](https://auth-wiki.logto.io/rbac)ã€‚

ä»¥ä¸‹æ˜¯æˆ‘å€‘åœ¨å¯¦ä½œä¸­æœƒéµå¾ªçš„é—œéµåŸå‰‡ï¼š

### ç´°ç·»çš„æ¬Šé™è¨­è¨ˆ \{#fine-grained-permission-design}

ç´°ç·»çš„æ¬Šé™è®“ä½ èƒ½ç²¾ç¢ºæ§åˆ¶ä½¿ç”¨è€…åœ¨ç³»çµ±ä¸­çš„æ“ä½œã€‚èˆ‡å…¶åƒ…ç”¨ã€Œç®¡ç†å“¡ã€æˆ–ã€Œä¸€èˆ¬ä½¿ç”¨è€…ã€é€™é¡å¯¬æ³›çš„å­˜å–å±¤ç´šï¼Œæˆ‘å€‘æœƒå®šç¾©ä½¿ç”¨è€…å¯å°è³‡æºåŸ·è¡Œçš„å…·é«”å‹•ä½œã€‚ä¾‹å¦‚ï¼š

- `read:articles` - æª¢è¦–ç³»çµ±ä¸­ä»»ä½•æ–‡ç« 
- `create:articles` - å»ºç«‹æ–°æ–‡ç« 
- `update:articles` - ä¿®æ”¹ç¾æœ‰æ–‡ç« 
- `publish:articles` - è®Šæ›´æ–‡ç« ç™¼ä½ˆç‹€æ…‹

### è³‡æºæ“æœ‰æ¬Šèˆ‡å­˜å–æ§åˆ¶ \{#resource-ownership-and-access-control}

è³‡æºæ“æœ‰æ¬Šæ˜¯æˆ‘å€‘ CMS æˆæ¬Š (Authorization) è¨­è¨ˆä¸­çš„æ ¸å¿ƒæ¦‚å¿µã€‚RBAC å®šç¾©ä¸åŒè§’è‰²å¯åŸ·è¡Œçš„å‹•ä½œï¼Œè€Œæ“æœ‰æ¬Šå‰‡ç‚ºå­˜å–æ§åˆ¶å¢æ·»å€‹äººå±¤é¢ï¼š

- ä½œè€…è‡ªå‹•æ“æœ‰ä»–å€‘å‰µå»ºçš„æ–‡ç« çš„å­˜å–æ¬Š
- é€™ç¨®è‡ªç„¶çš„æ“æœ‰æ¬Šæ¨¡å‹è®“ä½œè€…æ°¸é å¯ä»¥æª¢è¦–èˆ‡ç·¨è¼¯è‡ªå·±çš„å…§å®¹
- ç³»çµ±åœ¨è™•ç†æ–‡ç« æ“ä½œæ™‚æœƒåŒæ™‚æª¢æŸ¥è§’è‰²æ¬Šé™æˆ–æ“æœ‰æ¬Š
- ä¾‹å¦‚ï¼Œå³ä½¿æ²’æœ‰ `update:articles` æ¬Šé™ï¼Œä½œè€…ä»å¯ç·¨è¼¯è‡ªå·±çš„æ–‡ç« 
- é€™ç¨®è¨­è¨ˆæ¸›å°‘äº†é¡å¤–è§’è‰²æ¬Šé™çš„éœ€æ±‚ï¼ŒåŒæ™‚ç¶­æŒå®‰å…¨æ€§

é€™ç¨®é›™å±¤è¨­è¨ˆï¼ˆè§’è‰² + æ“æœ‰æ¬Šï¼‰è®“ç³»çµ±æ›´ç›´è¦ºä¸”å®‰å…¨ã€‚å‡ºç‰ˆè€…èˆ‡ç®¡ç†å“¡ä»å¯é€éè§’è‰²æ¬Šé™ç®¡ç†æ‰€æœ‰å…§å®¹ï¼Œè€Œä½œè€…å‰‡ä¿æœ‰å°è‡ªå·±ä½œå“çš„æ§åˆ¶æ¬Šã€‚

## è¨­è¨ˆå®‰å…¨çš„ API \{#designing-a-secure-apis}

æˆ‘å€‘å…ˆå¾è¨­è¨ˆ CMS æ ¸å¿ƒåŠŸèƒ½çš„ API ç«¯é»é–‹å§‹ï¼š

```
GET    /api/articles         # åˆ—å‡ºæ‰€æœ‰æ–‡ç« 
GET    /api/articles/:id     # å–å¾—ç‰¹å®šæ–‡ç« 
POST   /api/articles        # å»ºç«‹æ–°æ–‡ç« 
PATCH  /api/articles/:id    # æ›´æ–°æ–‡ç« 
DELETE /api/articles/:id    # åˆªé™¤æ–‡ç« 
PATCH  /api/articles/:id/published  # è®Šæ›´ç™¼ä½ˆç‹€æ…‹
```

### ç‚º API å¯¦ä½œå­˜å–æ§åˆ¶ \{#implement-access-control-for-your-api}

å°æ¯å€‹ç«¯é»ï¼Œæˆ‘å€‘éœ€è€ƒæ…®å…©å€‹å­˜å–æ§åˆ¶é¢å‘ï¼š

1. è³‡æºæ“æœ‰æ¬Š â€”â€” ä½¿ç”¨è€…æ˜¯å¦æ“æœ‰æ­¤è³‡æºï¼Ÿ
2. è§’è‰²å‹æ¬Šé™ â€”â€” ä½¿ç”¨è€…çš„è§’è‰²æ˜¯å¦å…è¨±æ­¤æ“ä½œï¼Ÿ

ä»¥ä¸‹æ˜¯æ¯å€‹ç«¯é»çš„å­˜å–æ§åˆ¶é‚è¼¯ï¼š

| ç«¯é»                              | å­˜å–æ§åˆ¶é‚è¼¯                                        |
| --------------------------------- | --------------------------------------------------- |
| GET /api/articles                 | - å…·æœ‰ `list:articles` æ¬Šé™è€…ï¼Œæˆ–ä½œè€…å¯è¦‹è‡ªå·±çš„æ–‡ç«  |
| GET /api/articles/:id             | - å…·æœ‰ `read:articles` æ¬Šé™è€…ï¼Œæˆ–è©²æ–‡ç« ä½œè€…         |
| POST /api/articles                | - å…·æœ‰ `create:articles` æ¬Šé™è€…                     |
| PATCH /api/articles/:id           | - å…·æœ‰ `update:articles` æ¬Šé™è€…ï¼Œæˆ–è©²æ–‡ç« ä½œè€…       |
| DELETE /api/articles/:id          | - å…·æœ‰ `delete:articles` æ¬Šé™è€…ï¼Œæˆ–è©²æ–‡ç« ä½œè€…       |
| PATCH /api/articles/:id/published | - åƒ…é™å…·æœ‰ `publish:articles` æ¬Šé™è€…                |

### å»ºç«‹å¯æ“´å±•çš„æ¬Šé™ç³»çµ± \{#creating-a-permission-system-that-scales}

æ ¹æ“š API å­˜å–éœ€æ±‚ï¼Œæˆ‘å€‘å¯ä»¥å®šç¾©ä¸‹åˆ—æ¬Šé™ï¼š

| æ¬Šé™             | èªªæ˜                   |
| ---------------- | ---------------------- |
| list:articles    | æª¢è¦–ç³»çµ±ä¸­æ‰€æœ‰æ–‡ç« åˆ—è¡¨ |
| read:articles    | é–±è®€ä»»ä½•æ–‡ç« çš„å®Œæ•´å…§å®¹ |
| create:articles  | å»ºç«‹æ–°æ–‡ç«              |
| update:articles  | ä¿®æ”¹ä»»ä½•æ–‡ç«            |
| delete:articles  | åˆªé™¤ä»»ä½•æ–‡ç«            |
| publish:articles | è®Šæ›´ç™¼ä½ˆç‹€æ…‹           |

æ³¨æ„ï¼Œé€™äº›æ¬Šé™åƒ…åœ¨å­˜å–éè‡ªå·±æ“æœ‰çš„è³‡æºæ™‚æ‰éœ€è¦ã€‚æ–‡ç« æ“æœ‰è€…å¯è‡ªå‹•ï¼š

- æª¢è¦–è‡ªå·±çš„æ–‡ç« ï¼ˆä¸éœ€ `read:articles`ï¼‰
- ç·¨è¼¯è‡ªå·±çš„æ–‡ç« ï¼ˆä¸éœ€ `update:articles`ï¼‰
- åˆªé™¤è‡ªå·±çš„æ–‡ç« ï¼ˆä¸éœ€ `delete:articles`ï¼‰

## å»ºç«‹æœ‰æ•ˆçš„è§’è‰² \{#building-effective-roles}

ç¾åœ¨æˆ‘å€‘å·²å®šç¾© API èˆ‡æ¬Šé™ï¼Œå¯ä»¥ä¾é‚è¼¯å°‡é€™äº›æ¬Šé™åˆ†çµ„æˆè§’è‰²ï¼š

| æ¬Šé™ / è§’è‰²      | ğŸ‘‘ ç®¡ç†å“¡ (Admin)            | ğŸ“ å‡ºç‰ˆè€… (Publisher)        | âœï¸ ä½œè€… (Author)     |
| ---------------- | ---------------------------- | ---------------------------- | -------------------- |
| **èªªæ˜**         | å®Œæ•´ç³»çµ±å­˜å–æ¬Šï¼Œå…¨é¢å…§å®¹ç®¡ç† | å¯æª¢è¦–æ‰€æœ‰æ–‡ç« ä¸¦ç®¡ç†ç™¼ä½ˆç‹€æ…‹ | å¯åœ¨ç³»çµ±ä¸­å»ºç«‹æ–°æ–‡ç«  |
| list:articles    | âœ…                           | âœ…                           | âŒ                   |
| read:articles    | âœ…                           | âœ…                           | âŒ                   |
| create:articles  | âœ…                           | âŒ                           | âœ…                   |
| update:articles  | âœ…                           | âŒ                           | âŒ                   |
| delete:articles  | âœ…                           | âŒ                           | âŒ                   |
| publish:articles | âœ…                           | âœ…                           | âŒ                   |

**æ³¨æ„**ï¼šä½œè€…è‡ªå‹•æ“æœ‰å°è‡ªå·±æ–‡ç« çš„è®€å– / æ›´æ–° / åˆªé™¤æ¬Šé™ï¼Œç„¡è«–è§’è‰²æ¬Šé™ç‚ºä½•ã€‚

æ¯å€‹è§’è‰²éƒ½é‡å°ç‰¹å®šè·è²¬è¨­è¨ˆï¼š

- **ç®¡ç†å“¡ (Admin)**ï¼šå…¨é¢æŒæ§ CMSï¼ŒåŒ…æ‹¬æ‰€æœ‰æ–‡ç« æ“ä½œ
- **å‡ºç‰ˆè€… (Publisher)**ï¼šå°ˆæ³¨æ–¼å…§å®¹å¯©æ ¸èˆ‡ç™¼ä½ˆç®¡ç†
- **ä½œè€… (Author)**ï¼šå°ˆæ³¨æ–¼å…§å®¹å‰µä½œ

é€™æ¨£çš„è§’è‰²çµæ§‹æ˜ç¢ºåˆ†å·¥ï¼š

- ä½œè€…å°ˆæ³¨æ–¼å…§å®¹å‰µä½œ
- å‡ºç‰ˆè€…ç®¡ç†å…§å®¹å“è³ªèˆ‡å¯è¦‹æ€§
- ç®¡ç†å“¡ç¶­è­·æ•´é«”ç³»çµ±

## åœ¨ Logto è¨­å®š RBAC \{#config-rbac-in-logto}

é–‹å§‹å‰ï¼Œä½ éœ€è¦åœ¨ [Logto Cloud](https://cloud.logto.io) å»ºç«‹å¸³è™Ÿï¼Œæˆ–ä¹Ÿå¯ä»¥ä½¿ç”¨ [Logto OSS ç‰ˆæœ¬](/logto-oss) è‡ªè¡Œæ¶è¨­ Logtoã€‚

æœ¬æ•™å­¸ç‚ºç°¡åŒ–æµç¨‹ï¼Œå°‡ä»¥ Logto Cloud ç‚ºä¾‹ã€‚

### è¨­å®šä½ çš„æ‡‰ç”¨ç¨‹å¼ \{#setting-up-your-application}

1. å‰å¾€ Logto Console çš„ã€Œæ‡‰ç”¨ç¨‹å¼ã€å»ºç«‹æ–°çš„ React æ‡‰ç”¨ç¨‹å¼
   - æ‡‰ç”¨ç¨‹å¼åç¨±ï¼šContent Management System
   - æ‡‰ç”¨ç¨‹å¼é¡å‹ï¼šå‚³çµ±ç¶²é æ‡‰ç”¨ç¨‹å¼
   - Redirect URIs: http://localhost:5173/callback

![CMS React æ‡‰ç”¨ç¨‹å¼](https://uploads.strapi.logto.io/cms_application_3ed42f2256.png)

### è¨­å®š API è³‡æºèˆ‡æ¬Šé™ \{#configuring-api-resources-and-permissions}

1. å‰å¾€ Logto Console çš„ã€ŒAPI è³‡æºã€å»ºç«‹æ–°çš„ API è³‡æº
   - API åç¨±ï¼šCMS API
   - API è­˜åˆ¥ç¢¼ï¼šhttps://api.cms.com
   - æ–°å¢æ¬Šé™è‡³ API è³‡æº
     - `list:articles`
     - `read:articles`
     - `create:articles`
     - `update:articles`
     - `publish:articles`
     - `delete:articles`

![CMS API è³‡æºç´°ç¯€](https://uploads.strapi.logto.io/cms_api_resource_b15ae2b91a.png)

### å»ºç«‹è§’è‰² \{#creating-roles}

å‰å¾€ Logto Console çš„ã€Œè§’è‰²ã€å»ºç«‹ä¸‹åˆ— CMS è§’è‰²

- ç®¡ç†å“¡ (Admin)
  - æ“æœ‰æ‰€æœ‰æ¬Šé™
- å‡ºç‰ˆè€… (Publisher)
  - æ“æœ‰ `read:articles`ã€`list:articles`ã€`publish:articles`
- ä½œè€… (Author)
  - æ“æœ‰ `create:articles`

![ç®¡ç†å“¡è§’è‰²](https://uploads.strapi.logto.io/admin_role_53edb35ecf.png)

![å‡ºç‰ˆè€…è§’è‰²](https://uploads.strapi.logto.io/publisher_role_2ac205cc32.png)

![ä½œè€…è§’è‰²](https://uploads.strapi.logto.io/author_role_f89cd99543.png)

### æŒ‡æ´¾è§’è‰²çµ¦ä½¿ç”¨è€… \{#assigning-roles-to-users}

å‰å¾€ Logto Console çš„ã€Œä½¿ç”¨è€…ç®¡ç†ã€å»ºç«‹ä½¿ç”¨è€…ã€‚

åœ¨ä½¿ç”¨è€…è©³æƒ…çš„ã€Œè§’è‰²ã€åˆ†é ä¸­ï¼Œä½ å¯ä»¥æŒ‡æ´¾è§’è‰²çµ¦è©²ä½¿ç”¨è€…ã€‚

æœ¬ä¾‹ä¸­ï¼Œæˆ‘å€‘å»ºç«‹ 3 ä½ä½¿ç”¨è€…ä¸¦åˆ†é…å¦‚ä¸‹è§’è‰²ï¼š

- Alexï¼šç®¡ç†å“¡ (Admin)
- Bobï¼šå‡ºç‰ˆè€… (Publisher)
- Charlieï¼šä½œè€… (Author)

![ä½¿ç”¨è€…ç®¡ç†](https://uploads.strapi.logto.io/user_management_c0bc17119f.png)

![ä½¿ç”¨è€…è©³æƒ… - Alex](https://uploads.strapi.logto.io/user_details_alex_702f96ef9a.png)

:::note
ç‚ºæ–¹ä¾¿å±•ç¤ºï¼Œæˆ‘å€‘é€é Logto Console å»ºç«‹é€™äº›è³‡æºèˆ‡è¨­å®šã€‚å¯¦éš›å°ˆæ¡ˆä¸­ï¼Œä½ ä¹Ÿå¯ä»¥é€é Logto æä¾›çš„ [Management API](/integrate-logto/interact-with-management-api) ç¨‹å¼åŒ–å»ºç«‹é€™äº›è³‡æºèˆ‡è¨­å®šã€‚
:::

## å‰ç«¯æ•´åˆ Logto RBAC \{#integrate-your-frontend-with-logto-rbac}

ç¾åœ¨æˆ‘å€‘å·²åœ¨ Logto è¨­å®šå¥½ RBACï¼Œå¯ä»¥é–‹å§‹æ•´åˆåˆ°å‰ç«¯ã€‚

é¦–å…ˆï¼Œä¾ç…§ [Logto å¿«é€Ÿå…¥é–€](/quick-starts) å°‡ Logto æ•´åˆé€²ä½ çš„æ‡‰ç”¨ç¨‹å¼ã€‚

æœ¬ä¾‹ä»¥ [React](/quick-starts/react) ç¤ºç¯„ã€‚

å®Œæˆ Logto è¨­å®šå¾Œï¼Œéœ€æ–°å¢ RBAC è¨­å®šè®“ Logto èƒ½æ­£ç¢ºé‹ä½œã€‚

```tsx
// frontend/src/App.tsx

const logtoConfig: LogtoConfig = {
  appId: LOGTO_APP_ID, // ä½ åœ¨ Logto Console å»ºç«‹çš„ app ID
  endpoint: LOGTO_ENDPOINT, // ä½ åœ¨ Logto Console å»ºç«‹çš„ endpoint
  resources: [API_RESOURCE], // ä½ åœ¨ Logto Console å»ºç«‹çš„ API resource identifierï¼Œä¾‹å¦‚ https://api.cms.com
  // å‰ç«¯å¯èƒ½æœƒå‘ API resource è«‹æ±‚çš„æ‰€æœ‰ scopes
  scopes: [
    'list:articles',
    'create:articles',
    'read:articles',
    'update:articles',
    'delete:articles',
    'publish:articles',
  ],
};
```

å¦‚æœä½ å·²ç™»å…¥ï¼Œè¨˜å¾—ç™»å‡ºä¸¦é‡æ–°ç™»å…¥è®“è¨­å®šç”Ÿæ•ˆã€‚

ç•¶ä½¿ç”¨è€…é€é Logto ç™»å…¥ä¸¦è«‹æ±‚ä¸Šè¿° API è³‡æºçš„å­˜å–æ¬Šæ– (Access token) æ™‚ï¼ŒLogto æœƒæ ¹æ“šä½¿ç”¨è€…è§’è‰²å°‡ç›¸é—œ scopesï¼ˆæ¬Šé™ï¼‰åŠ å…¥å­˜å–æ¬Šæ– (Access token)ã€‚

ä½ å¯ä»¥é€é `useLogto` hook çš„ `getAccessTokenClaims` å–å¾—å­˜å–æ¬Šæ– (Access token) ä¸­çš„ scopesã€‚

```tsx
// frontend/src/hooks/use-user-data.ts

import { useLogto } from '@logto/react';
import { API_RESOURCE } from '../config';
import { useState, useEffect } from 'react';

export const useUserData = () => {
  const { getAccessTokenClaims } = useLogto();
  const [userScopes, setUserScopes] = useState<string[]>([]);
  const [userId, setUserId] = useState<string>();

  useEffect(() => {
    const fetchScopes = async () => {
      const token = await getAccessTokenClaims(API_RESOURCE);
      setUserScopes(token?.scope?.split(' ') ?? []);
      setUserId(token?.sub);
    };

    fetchScopes();
  }, [getAccessTokenClaims]);

  return { userId, userScopes };
};
```

ä½ å¯ä»¥åˆ©ç”¨ `userScopes` åˆ¤æ–·ä½¿ç”¨è€…æ˜¯å¦æœ‰æ¬Šé™å­˜å–è³‡æºã€‚

```tsx
// frontend/src/pages/Dashboard.tsx

const Dashboard = () => {
  const { userId, userScopes } = useUserData();
  // ...

  return (
    <div>
      {/* ... */}
      {(userScopes.includes('delete:articles') || article.ownerId === userId) && (
        <button
          onClick={() => handleDelete(article.id)}
          className="text-red-600 hover:text-red-900"
        >
          Delete
        </button>
      )}
    </div>
  );
};
```

## å¾Œç«¯æ•´åˆ Logto RBAC \{#integrate-your-backend-with-logto-rbac}

æ¥ä¸‹ä¾†ï¼Œå°‡ Logto RBAC æ•´åˆé€²ä½ çš„å¾Œç«¯ã€‚

### å¾Œç«¯æˆæ¬Š (Authorization) ä¸­ä»‹è»Ÿé«” \{#backend-authorization-middleware}

é¦–å…ˆï¼Œæˆ‘å€‘éœ€è¦åœ¨å¾Œç«¯æ–°å¢ä¸€å€‹ä¸­ä»‹è»Ÿé«”ï¼Œæª¢æŸ¥ä½¿ç”¨è€…æ¬Šé™ã€é©—è­‰æ˜¯å¦å·²ç™»å…¥ï¼Œä»¥åŠæ˜¯å¦æœ‰æ¬Šå­˜å–ç‰¹å®š APIã€‚

```javascript
// backend/src/middleware/auth.js

const { createRemoteJWKSet, jwtVerify } = require('jose');

const getTokenFromHeader = (headers) => {
  const { authorization } = headers;
  const bearerTokenIdentifier = 'Bearer';

  if (!authorization) {
    throw new Error('Authorization header missing');
  }

  if (!authorization.startsWith(bearerTokenIdentifier)) {
    throw new Error('Authorization token type not supported');
  }

  return authorization.slice(bearerTokenIdentifier.length + 1);
};

const hasScopes = (tokenScopes, requiredScopes) => {
  if (!requiredScopes || requiredScopes.length === 0) {
    return true;
  }
  const scopeSet = new Set(tokenScopes);
  return requiredScopes.every((scope) => scopeSet.has(scope));
};

const verifyJwt = async (token) => {
  const JWKS = createRemoteJWKSet(new URL(process.env.LOGTO_JWKS_URL));

  const { payload } = await jwtVerify(token, JWKS, {
    issuer: process.env.LOGTO_ISSUER,
    audience: process.env.LOGTO_API_RESOURCE,
  });

  return payload;
};

const requireAuth = (requiredScopes = []) => {
  return async (req, res, next) => {
    try {
      // å–å¾—æ¬Šæ–
      const token = getTokenFromHeader(req.headers);

      // é©—è­‰æ¬Šæ–
      const payload = await verifyJwt(token);

      // å°‡ä½¿ç”¨è€…è³‡è¨ŠåŠ å…¥è«‹æ±‚
      req.user = {
        id: payload.sub,
        scopes: payload.scope?.split(' ') || [],
      };

      // é©—è­‰æ‰€éœ€ scopes
      if (!hasScopes(req.user.scopes, requiredScopes)) {
        throw new Error('Insufficient permissions');
      }

      next();
    } catch (error) {
      res.status(401).json({ error: 'Unauthorized' });
    }
  };
};

module.exports = {
  requireAuth,
  hasScopes,
};
```

å¦‚ä½ æ‰€è¦‹ï¼Œæ­¤ä¸­ä»‹è»Ÿé«”æœƒé©—è­‰å‰ç«¯è«‹æ±‚æ˜¯å¦å¸¶æœ‰æœ‰æ•ˆçš„å­˜å–æ¬Šæ– (Access token)ï¼Œä¸¦æª¢æŸ¥è©²æ¬Šæ–çš„å—çœ¾ (audience) æ˜¯å¦èˆ‡æˆ‘å€‘åœ¨ Logto Console å»ºç«‹çš„ API è³‡æºä¸€è‡´ã€‚

é©—è­‰ API è³‡æºçš„åŸå› åœ¨æ–¼ï¼Œæˆ‘å€‘çš„ API è³‡æºå¯¦éš›ä¸Šä»£è¡¨ CMS å¾Œç«¯çš„è³‡æºï¼Œæ‰€æœ‰ CMS æ¬Šé™éƒ½èˆ‡æ­¤ API è³‡æºç¶å®šã€‚

ç”±æ–¼é€™å€‹ API è³‡æºåœ¨ Logto ä»£è¡¨ CMS è³‡æºï¼Œå› æ­¤å‰ç«¯åœ¨å‘¼å«å¾Œç«¯ API æ™‚ï¼Œæœƒå¸¶ä¸Šå°æ‡‰çš„å­˜å–æ¬Šæ– (Access token)ï¼š

```typescript
// frontend/src/hooks/use-api.ts
export const useApi = () => {
  const { getAccessToken } = useLogto();

  return useMemo(
    () =>
      async (endpoint: string, options: RequestInit = {}) => {
        try {
          // å–å¾— API è³‡æºçš„å­˜å–æ¬Šæ– (Access token)
          const token = await getAccessToken(API_RESOURCE);

          if (!token) {
            throw new ApiRequestError('Failed to get access token');
          }

          const response = await fetch(`${API_BASE_URL}${endpoint}`, {
            ...options,
            headers: {
              'Content-Type': 'application/json',
              // å°‡å­˜å–æ¬Šæ– (Access token) åŠ å…¥è«‹æ±‚æ¨™é ­
              Authorization: `Bearer ${token}`,
              ...options.headers,
            },
          });

          // ... è™•ç†å›æ‡‰

          return await response.json();
        } catch (error) {
          // ... éŒ¯èª¤è™•ç†
        }
      },
    [getAccessToken]
  );
};
```

ç¾åœ¨æˆ‘å€‘å¯ä»¥ç”¨ `requireAuth` ä¸­ä»‹è»Ÿé«”ä¿è­· API ç«¯é»ã€‚

### ä¿è­· API ç«¯é» \{#protecting-api-endpoints}

å°æ–¼åƒ…å…è¨±ç‰¹å®šæ¬Šé™ä½¿ç”¨è€…å­˜å–çš„ APIï¼Œå¯ç›´æ¥åœ¨ä¸­ä»‹è»Ÿé«”ä¸­åŠ ä¸Šé™åˆ¶ã€‚ä¾‹å¦‚ï¼Œå»ºç«‹æ–‡ç«  API åƒ…å…è¨±æ“æœ‰ `create:articles` æ¬Šé™çš„ä½¿ç”¨è€…å­˜å–ï¼š

```javascript
// backend/src/routes/articles.js

const { requireAuth } = require('../middleware/auth');

router.post('/articles', requireAuth(['create:articles']), async (req, res) => {
  // ...
});
```

å°æ–¼éœ€åŒæ™‚æª¢æŸ¥æ¬Šé™èˆ‡è³‡æºæ“æœ‰æ¬Šçš„ APIï¼Œå¯ä½¿ç”¨ `hasScopes` å‡½å¼ã€‚ä¾‹å¦‚ï¼Œæ–‡ç« åˆ—è¡¨ APIï¼Œæ“æœ‰ `list:articles` æ¬Šé™è€…å¯å­˜å–æ‰€æœ‰æ–‡ç« ï¼Œå¦å‰‡åƒ…èƒ½å­˜å–è‡ªå·±å‰µå»ºçš„æ–‡ç« ï¼š

```javascript
// backend/src/routes/articles.js

const { requireAuth, hasScopes } = require('../middleware/auth');

router.get('/articles', requireAuth(), async (req, res) => {
  try {
    // æœ‰ list:articles æ¬Šé™å‰‡å›å‚³æ‰€æœ‰æ–‡ç« 
    if (hasScopes(req.user.scopes, ['list:articles'])) {
      const articles = await articleDB.list();
      return res.json(articles);
    }

    // å¦å‰‡åƒ…å›å‚³ä½¿ç”¨è€…è‡ªå·±çš„æ–‡ç« 
    const articles = await articleDB.listByOwner(req.user.id);
    res.json(articles);
  } catch (error) {
    res.status(500).json({ error: 'Failed to fetch articles' });
  }
});
```

è‡³æ­¤ï¼Œæˆ‘å€‘å·²å®Œæˆ RBAC å¯¦ä½œã€‚ä½ å¯ä»¥åƒè€ƒ [å®Œæ•´åŸå§‹ç¢¼](https://github.com/logto-io/rbac-sample) äº†è§£å®Œæ•´å¯¦ä½œç´°ç¯€ã€‚

## æ¸¬è©¦ CMS RBAC å¯¦ä½œ \{#test-the-cms-rbac-implementation}

ç¾åœ¨ï¼Œè®“æˆ‘å€‘ç”¨å‰›å‰›å»ºç«‹çš„ä¸‰ä½ä½¿ç”¨è€…æ¸¬è©¦ CMS RBAC å¯¦ä½œã€‚

:::note
å¦‚æœä½ ç™¼ç¾ç„¡æ³•ç”¨ã€Œä½¿ç”¨è€…ç®¡ç†ã€å»ºç«‹çš„å¸³è™Ÿç™»å…¥ï¼Œè«‹å…ˆå•Ÿç”¨å°æ‡‰çš„ç™»å…¥æ–¹å¼ã€‚å‰å¾€ Logto Console çš„ã€Œç™»å…¥é«”é©—ã€ä¸¦å•Ÿç”¨ä½ åå¥½çš„é©—è­‰ (Authentication) æ–¹å¼ï¼ˆå¦‚é›»å­éƒµä»¶ + å¯†ç¢¼æˆ–ä½¿ç”¨è€…åç¨± + å¯†ç¢¼ï¼‰ã€‚
:::

é¦–å…ˆï¼Œåˆ†åˆ¥ä»¥ Alex èˆ‡ Charles ç™»å…¥ä¸¦å»ºç«‹ä¸€äº›æ–‡ç« ã€‚

Alex æ“æœ‰ç®¡ç†å“¡ (Admin) è§’è‰²ï¼Œå¯å»ºç«‹ã€åˆªé™¤ã€æ›´æ–°ã€ç™¼ä½ˆä¸¦æª¢è¦–æ‰€æœ‰æ–‡ç« ã€‚

![CMS å„€è¡¨æ¿ - Alex](https://uploads.strapi.logto.io/cms_dashboard_alex_a11863a94b.png)

Charles æ“æœ‰ä½œè€… (Author) è§’è‰²ï¼Œåªèƒ½å»ºç«‹è‡ªå·±çš„æ–‡ç« ï¼Œä¸”åƒ…èƒ½æª¢è¦–ã€æ›´æ–°ã€åˆªé™¤è‡ªå·±æ“æœ‰çš„æ–‡ç« ã€‚

![CMS å„€è¡¨æ¿ - Charles - æ–‡ç« åˆ—è¡¨](https://uploads.strapi.logto.io/cms_dashboard_charles_05f610066a.png)

Bob æ“æœ‰å‡ºç‰ˆè€… (Publisher) è§’è‰²ï¼Œå¯æª¢è¦–èˆ‡ç™¼ä½ˆæ‰€æœ‰æ–‡ç« ï¼Œä½†ç„¡æ³•å»ºç«‹ã€æ›´æ–°æˆ–åˆªé™¤æ–‡ç« ã€‚

![CMS å„€è¡¨æ¿ - Bob](https://uploads.strapi.logto.io/cms_dashboard_bob_421a429b69.png)

## çµèª \{#conclusion}

æ­å–œä½ ï¼ä½ å·²å­¸æœƒå¦‚ä½•åœ¨æ‡‰ç”¨ç¨‹å¼ä¸­å¯¦ä½œå¥å…¨çš„ RBAC ç³»çµ±ã€‚

è‹¥éœ€æ›´é€²éšçš„æƒ…å¢ƒï¼ˆå¦‚å»ºæ§‹å¤šç§Ÿæˆ¶æ‡‰ç”¨ç¨‹å¼ï¼‰ï¼ŒLogto æä¾›å®Œæ•´çš„çµ„ç¹” (Organization) æ”¯æ´ã€‚æ­¡è¿åƒè€ƒæˆ‘å€‘çš„æŒ‡å—ï¼š[æ‰“é€ å¤šç§Ÿæˆ¶ SaaS æ‡‰ç”¨ç¨‹å¼ï¼šå¾è¨­è¨ˆåˆ°å¯¦ä½œçš„å®Œæ•´æŒ‡å—](https://blog.logto.io/build-multi-tenant-saas)ï¼Œæ·±å…¥äº†è§£çµ„ç¹”å±¤ç´šçš„å­˜å–æ§åˆ¶å¯¦ä½œã€‚

ç¥ä½ å¯«ç¨‹å¼æ„‰å¿«ï¼ğŸš€
