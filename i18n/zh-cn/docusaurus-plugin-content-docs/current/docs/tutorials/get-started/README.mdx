import TabItem from '@theme/TabItem';
import Tabs from '@theme/Tabs';

import gitpodRunning from './assets/gitpod-running.png';

# ⚡ 开始上手

## 启动 Logto

### 在线

在 Logto 仓库地址的前面添加 `https://gitpod.io/#`（或 <a href="https://gitpod.io/#https://github.com/logto-io/demo" target="_blank" rel="noopener">点按此处</a>）并访问该链接。稍等片刻，你会在屏幕下方的终端里看到类似如下信息：

<img src={gitpodRunning} alt="Gitpod 正在运行" width="600px" />

按住 Cmd (或 Ctrl) 并点按以 `https://3001-...` 开头的链接即可继续你的 Logto 之旅。玩得开心！

### 本地

<Tabs>

<TabItem value="docker-compose" label="Docker Compose">

[Docker Desktop](https://www.docker.com/products/docker-desktop) 通常自带 Docker Compose CLI。

:::danger
请不要在生产环境使用我们的 docker compose 命令！由于 `docker-compose.yml` 文件内部除 Logto 之外还捆绑内置了 Postgres 数据库镜像，
每次重新运行 docker compose 命令的时候都会重新生成一个新的数据库实例，而这会导致之前保存在数据库中的数据全部丢失。
:::

:::note
在第一个稳定版本之前，我们使用 `prerelease` 作为 Docker image 的 tag。
:::

```bash
curl -fsSL https://raw.githubusercontent.com/logto-io/logto/HEAD/docker-compose.yml | TAG=prerelease docker compose -p logto -f - up
```

在成功编排后，你将看到类似如下的信息：

</TabItem>

<TabItem value="docker" label="Docker">

1. 准备一个 [PostgreSQL](https://www.postgresql.org/)@^14.0 实例。
2. 拉取镜像：

:::note
在第一个稳定版本之前，我们使用 `prerelease` 作为 Docker image 的 tag。
:::

```bash
# ghcr
docker pull ghcr.io/logto-io/logto:prerelease
# DockerHub
docker pull svhd/logto:prerelease
```

3. 映射容器端口，例如 `3001:3001`；并给容器如下环境变量：

```yml
ALL_YES: 1
NO_INQUIRY: 0
TRUST_PROXY_HEADER: 1 # 如果你在 Logto 前使用了一个 HTTPS 代理（例如 Nginx），设置为 1
ENDPOINT: http://localhost:3001 # 如果你在使用自定义域名，将地址替换成你的 Logto URL
DB_URL_DEFAULT: postgres://username:password@your_postgres_url:5432 # 替换成你的 Postgres DSN
```

使用如上环境变量运行 docker 容器：

```bash
docker run \
--name logto \
-p 3001:3001 \
-e ALL_YES=1 -e NO_INQUIRY=0 \
-e TRUST_PROXY_HEADER=1 \
-e ENDPOINT=https://your-domain-url \
-e DB_URL_DEFAULT=postgres://username:password@172.17.0.1:5432 \
ghcr.io/logto-io/logto:prerelease
```

:::tip

- 如果你使用的是 Docker Hub，请将 `ghcr.io/logto-io/logto:prerelease` 替换成 `svhd/logto:prerelease`
- 在 `DB_URL_DEFAULT` 中使用 `172.17.0.1` 来指向主机 IP

:::

最终你将看到类似如下的信息：

</TabItem>

<TabItem value="script" label="Download script">

**前置条件**

- [Node.js](https://nodejs.org/) `^16.13.0`
- [PostgreSQL](https://postgresql.org/) `^14.0`

更高的版本通常可以工作，但不打包票。

虽然不是强制要求，但我们推荐给 Logto 提供一个专属的空数据库。

**下载并开始**

在你的终端中输入如下命令：

```bash
node -e "$(printf "%s" "$(curl -fsSL https://raw.githubusercontent.com/logto-io/logto/master/install.js)")"
```

这个脚本将会下载 Logto，并在你执行的位置创建一个名为 `logto` 的文件夹。在回答完一些 [简单的问题](../../references/core/configuration.md#questions) 后，你将看到类似如下的信息：

</TabItem>

</Tabs>

```text
App is running at http://localhost:3001
App is running at https://your-domain-url
```

前往 <a target="_blank" href="http://localhost:3001/" rel="noopener">http://localhost:3001/</a> 以继续你的 Logto 之旅。玩得开心！

<details>

<summary>配置（可跳过）</summary>

Logto 使用环境变量进行配置，并支持 `.env` 文件。使用细节以及完整的变量列表见 [配置](../../references/core/configuration.md) 页面。

</details>

_如果需要更多自定义操作或者通过程序化的方式访问 Logto，请浏览 [核心服务](../../references/core/README.mdx)。_

### 快速检修

<details>

<summary>
  我的浏览器无法加载「管理控制台」（显示错误 <code>Crypto.subtle is unavailable...</code>）
</summary>

「管理控制台」使用 [Web Crypto API](https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Crypto_API)。它要求 [secure contexts](https://developer.mozilla.org/zh-CN/docs/Web/Security/Secure_Contexts)，即 HTTPS 或地址为 `localhost` 的 HTTP。

如果你在 HTTP 下使用 IP 地址或者自定义域名，浏览器将无法载入「管理控制台」。

</details>

<details>

<summary>
  我正在使用自定义域名，但是我的浏览器无法加载「管理控制台」（显示错误{' '}
  <code>"code": "oidc.invalid_redirect_uri"</code>）
</summary>

如果你正在使用自定义域名而不是 `localhost`，你需要将环境变量 `ENDPOINT` 设置为 Logto URL。这是因为 OIDC 对 Redirect URI 有着严格要求。参见 [配置](../../references/core/configuration.md#通用) 以了解详情。

</details>

<details>

<summary>
  我在 Logto 前使用了一个 HTTPS 代理（例如 Nginx），但是我在登录「管理控制台」时报错（显示错误{' '}
  <code>TypeError: Failed to fetch</code>）
</summary>

- 首先，你需要在环境变量中将 `TRUST_PROXY_HEADER` 设置为 `true`。参见 [配置](../../references/core/configuration.md#使用-https-代理) 以了解详情。
- 其次，还需要在服务器的代理配置中将 `X-Forward-Proto` 设置为 `https`。参见 [Trusting TLS offloading proxies](https://github.com/panva/node-oidc-provider/blob/main/docs/README.md#trusting-tls-offloading-proxies) 以了解详情。

</details>

## 创建一个管理员账户

打开链接后你将看到一个简单介绍了「管理控制台」的欢迎页。点按「创建账户」以创建一个新的管理员账户。

:::note
目前你无法通过「管理控制台」创建多个管理员账户，并且只有第一个账户拥有管理员权限。如果你想创建多个管理员账户，请通过「管理 API」进行。
:::

:::caution
一旦创建了第一个账户，欢迎页将不再可用。
:::

在创建账户页面，输入你的用户名和密码以继续。

## 「开始上手」标签页

在创建了管理员账户后，浏览器将重定向至「管理控制台」中的「开始上手」标签页。这个页面展示了一些 Logto 可以做的事情。

我们的教程将按你看到的顺序进行。让我们开始吧！

![开始上手](./assets/get-started.png)
