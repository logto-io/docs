---
slug: /quick-starts/flutter-flow
sidebar_label: FlutterFlow
sidebar_custom_props:
  description: FlutterFlow คือเฟรมเวิร์ก low code สำหรับสร้างแอปไฮบริดด้วย flutter
---

import InitCustomAuthManagerCode from './code-snippets/_flutter-flow-auth-manager-init.md';
import AuthUserProviderCode from './code-snippets/_flutter-flow-auth-user-provider.md';
import FlutterSecureStorageCode from './code-snippets/_flutter-secure-storage.md';
import FlutterWebAuthCode from './code-snippets/_flutter-web-auth.md';

# ปรับแต่ง FlutterFlow CustomAuthManager ด้วย Logto SDK

FlutterFlow มีฟีเจอร์ [custom authentication](https://docs.flutterflow.io/data-and-backend/custom-authentication) ในตัวที่ช่วยให้คุณยืนยันตัวตนผู้ใช้ด้วย backend ของคุณเอง อย่างไรก็ตาม flow การยืนยันตัวตนแบบ custom ที่มีในตัวถูกออกแบบมาให้ทำงานกับ API การยืนยันตัวตนเพียงครั้งเดียวเท่านั้น หากคุณใช้ผู้ให้บริการข้อมูลระบุตัวตน (IdP) ของบุคคลที่สาม คำขอการยืนยันตัวตนจะสามารถทำได้เฉพาะโดยใช้ grant type `Resource Owner Password Credentials` ซึ่งไม่แนะนำให้ใช้ใน production ดูรายละเอียดเพิ่มเติมที่ [Deprecated ropc grant type](https://blog.logto.io/deprecated-ropc-grant-type/)

flow การยืนยันตัวตนแบบมาตรฐาน OpenID Connect (OIDC) จะมีหลายขั้นตอน เช่น การอนุญาต (Authorization) การแลกเปลี่ยนโทเค็น และการดึงข้อมูลผู้ใช้ หากต้องการใช้งาน flow OIDC มาตรฐานกับ IdP อย่าง Logto คุณจำเป็นต้องปรับแต่งคลาส `CustomAuthManager` ใน FlutterFlow

คู่มือนี้จะแสดงวิธีปรับแต่งคลาส `CustomAuthManager` ใน FlutterFlow โดยใช้ [Flutter SDK ของ Logto](../flutter/README.mdx) คุณจะได้ประโยชน์จาก SDK ของ Logto สำหรับ flow OIDC มาตรฐาน พร้อมกับยังคงใช้ UI builder ของ FlutterFlow ได้

:::tip

- แพ็กเกจ Logto SDK มีให้ใช้งานบน [pub.dev](https://pub.dev/packages/logto_dart_sdk) และ Logto [github repository](https://github.com/logto-io/dart)
- SDK นี้เหมาะสำหรับแพลตฟอร์ม Android และ iOS เท่านั้น

:::

## ข้อกำหนดเบื้องต้น \{#prerequisites}

- บัญชี [Logto Cloud](https://cloud.logto.io) หรือ [Logto ที่ติดตั้งเอง](/introduction/set-up-logto-oss)
- สร้างแอปพลิเคชัน Logto Flutter
- โปรเจกต์ FlutterFlow

## เปิดใช้งาน custom code ใน FlutterFlow \{#enable-flutterflow-custom-code}

เพื่อปรับแต่งคลาส `CustomAuthManager` คุณต้องเปิดใช้งานฟีเจอร์ custom code ใน FlutterFlow โดยทำตามคู่มือ [Manage Custom Code In GitHub](https://docs.flutterflow.io/customizing-your-app/manage-custom-code-in-github) เพื่อซิงค์โปรเจกต์ FlutterFlow ของคุณกับ GitHub

:::note
การจัดการ custom code ใน GitHub เป็นฟีเจอร์ระดับพรีเมียมใน FlutterFlow คุณต้องอัปเกรด FlutterFlow เป็นแผน pro เพื่อเปิดใช้งานฟีเจอร์นี้
:::

เมื่อเสร็จแล้ว คุณจะมี 3 branch ใน repository GitHub ของ FlutterFlow:

1. `main`: branch หลักสำหรับโปรเจกต์ flutter ใช้สำหรับ deploy โปรเจกต์ของคุณ
2. `flutterflow`: branch ที่ `FlutterFlow` จะซิงค์การเปลี่ยนแปลงจาก editor ของ FlutterFlow
3. `develop`: branch ที่คุณสามารถแก้ไข custom code ของคุณ

## สร้าง UI ของคุณใน FlutterFlow \{#create-your-ui-in-flutterflow}

เริ่มต้นด้วยการสร้าง UI ของคุณใน FlutterFlow คุณสามารถดู [เอกสาร FlutterFlow](https://docs.flutterflow.io/) เพื่อสร้าง UI ตามที่ต้องการ สำหรับคู่มือนี้ ขั้นต่ำเราจะสร้าง 2 หน้า:

1. หน้าโฮมแบบง่ายพร้อมปุ่มเข้าสู่ระบบ
2. หน้าข้อมูลผู้ใช้เพื่อแสดงข้อมูลผู้ใช้และปุ่มออกจากระบบ

ไปที่ `App Settings` -> หน้า `Authentication` และเปิดใช้งาน custom authentication ระบบจะสร้างคลาส `CustomAuthManager` ในโปรเจกต์ FlutterFlow ของคุณ

<center>
  <img
    src="/img/assets/flutter-flow-custom-authentication.png"
    alt="FlutterFlow custom authentication"
  />
</center>

เมื่อ UI พร้อมแล้ว ให้ไปที่หน้า `integrations` -> `GitHub` แล้วคลิกปุ่ม `Push to Repository` เพื่อ push การเปลี่ยนแปลงไปยัง branch `flutterflow`

<center>
  <img src="/img/assets/flutter-flow-github-push.png" alt="FlutterFlow GitHub push" />
</center>

## ปรับแต่ง CustomAuthManager \{#customize-the-customauthmanager}

สลับไปที่ branch `develop` ใน repository GitHub ของคุณ และ merge การเปลี่ยนแปลงล่าสุดจาก branch `flutterflow` รวมถึงหน้า UI ของคุณ และคลาส `CustomAuthManager` ที่สร้างไว้ล่วงหน้า

### ติดตั้ง dependency Logto SDK \{#install-logto-sdk-dependency}

เพิ่ม dependency Logto SDK ลงในโปรเจกต์ของคุณ

```bash
  flutter pub add logto_dart_sdk
```

:::note
แพ็กเกจ Http เสริม:

Logto client ต้องการ http client เพื่อเรียก API คุณสามารถใช้แพ็กเกจ `http` หรือ http client อื่นที่คุณต้องการ

```bash
  flutter pub add http
```

:::

### อัปเดต UserProvider \{#update-the-userprovider}

เพิ่มคลาส `OpenIdClaims` ลงในคลาส `CustomAuthUserProvider` เพื่อเก็บข้อมูลผู้ใช้

> คลาส `OpenIdClaims` เป็นส่วนหนึ่งของ Logto SDK ซึ่งจะให้ claims ของ `id_token` สำหรับผู้ใช้ที่ยืนยันตัวตนแล้ว

<AuthUserProviderCode />

### เริ่มต้น logto client ใน CustomAuthManager \{#init-the-logto-client-in-customauthmanager}

เริ่มต้น logto client ในคลาส `CustomAuthManager`

<InitCustomAuthManagerCode />

เมธอด `initialize` จะเริ่มต้น logto client และอัปเดต current user stream ด้วยสถานะการยืนยันตัวตนของผู้ใช้ที่เก็บไว้ใน local storage

> Logto SDK ใช้แพ็กเกจ [flutter_secure_storage](https://pub.dev/packages/flutter_secure_storage) เพื่อเก็บข้อมูลการยืนยันตัวตนของผู้ใช้อย่างปลอดภัย

### สร้างเมธอด Sign-in \{#implement-the-sign-in-method}

เรียกเมธอด `LogtoClient.signIn` เพื่อเริ่ม flow การยืนยันตัวตน OIDC มาตรฐาน หน้า Logto Sign-In จะถูกเปิดใน webview โดยใช้ [flutter_web_auth](https://pub.dev/packages/flutter_web_auth)

```dart
// lib/auth/custom_auth/custom_auth_manager.dart

Future<FlutterFlowAuthAuthUser?> signIn(
    String redirectUri,
  ) async {
    await logtoClient.signIn(redirectUri);

    var idTokenClaims = await logtoClient.idTokenClaims;

    return _updateCurrentUser(
      loggedIn: idTokenClaims != null,
      uid: idTokenClaims?.subject,
      idToken: idTokenClaims,
    );
  }

```

LogtoClient จะจัดการขั้นตอนการอนุญาต (authorization) การแลกเปลี่ยนโทเค็น และการดึงข้อมูลผู้ใช้ เมื่อผู้ใช้ได้รับการยืนยันตัวตนแล้ว `idTokenClaims` จะถูกเก็บไว้ใน local storage
ดึง `idTokenClaims` จาก LogtoClient และอัปเดต current user stream

### สร้างเมธอด Sign-out \{#implement-the-sign-out-method}

```dart
// lib/auth/custom_auth/custom_auth_manager.dart

Future signOut() async {
    await logtoClient.signOut();

    flutterFlowAuthAuthUserSubject.add(
      FlutterFlowAuthAuthUser(loggedIn: false),
    );
  }
```

### อัปเดตเมธอด auth util \{#update-the-auth-util-methods}

- เพิ่ม getter `authManager` เพื่อเข้าถึง instance ของ `CustomAuthManager`
- เพิ่ม getter `currentUserUid` เพื่อดึง uid ของผู้ใช้ปัจจุบัน
- เพิ่ม getter `currentUserData` เพื่อดึงข้อมูลผู้ใช้ปัจจุบัน
- เพิ่ม getter `logtoClient` เพื่อเข้าถึง instance ของ Logto client

```dart
// lib/auth/custom_auth/auth_util.dart

import 'package:logto_dart_sdk/logto_client.dart';
import 'package:logto_dart_sdk/src/modules/id_token.dart';

import 'custom_auth_manager.dart';

export 'custom_auth_manager.dart';

final _authManager = CustomAuthManager();
CustomAuthManager get authManager => _authManager;
String get currentUserUid => currentUser?.uid ?? '';
OpenIdClaims? get currentUserData => currentUser?.idToken;
LogtoClient get logtoClient => _authManager.logtoClient;
```

## เชื่อมต่อ custom authentication เข้ากับ UI ของคุณ \{#integrate-the-custom-authentication-in-your-ui}

### หน้าโฮม \{#home-page}

เรียกเมธอด `authManager.signIn` เพื่อเริ่ม flow การยืนยันตัวตนเมื่อผู้ใช้คลิกปุ่มเข้าสู่ระบบ

> `redirectUri` คือ callback URL ที่จะใช้รับ callback การอนุญาตจากหน้า Logto sign-in
> ดูรายละเอียดเพิ่มเติมเกี่ยวกับ redirectUri ได้ที่ [Flutter SDK](../flutter/README.mdx#implement-sign-in)

```dart
// lib/pages/home_page/home_page_widget.dart

final redirectUri = 'io.logto://callback';

// ...

FFButtonWidget(
  onPressed: () async {
    GoRouter.of(context).prepareAuthEvent();

    await authManager.signIn(redirectUri);

    context.replaceNamed('user');
  },
  text: 'Sign In',
  // ...
)
```

### หน้าข้อมูลผู้ใช้ \{#user-profile-page}

ใช้ auth util getter เพื่อเข้าถึงข้อมูลผู้ใช้ปัจจุบันและ instance ของ Logto client

```dart
// lib/pages/user/user_widget.dart

import '/auth/custom_auth/auth_util.dart';

// ...

children: [
  Text(
    'User ID: $currentUserUid',
  ),
  Text(
    'Display Name: ${currentUserData?.name}',
  ),
  Text(
    'Username: ${currentUserData?.username}',
  ),
  Text(
    'Email: ${currentUserData?.emailVerified ?? currentUserData?.email}',
  ),
]

```

สร้างเมธอด sign-out เมื่อผู้ใช้คลิกปุ่มออกจากระบบ

```dart
// lib/pages/user/user_widget.dart

FFButtonWidget(
  onPressed: () async {
    await authManager.signOut();

    context.replaceNamed('HomePage');
  },
  text: 'Sign Out',
  // ...
)
```

## อ่านเพิ่มเติม \{#further-readings}

Logto SDK มีเมธอดเพิ่มเติมสำหรับโต้ตอบกับ Logto API คุณสามารถปรับแต่งคลาส `CustomAuthManager` เพิ่มเติมเพื่อเพิ่มฟีเจอร์อื่น ๆ ได้

- [ข้อมูลโปรไฟล์ผู้ใช้](../flutter/README.mdx#get-user-information)
- [ทรัพยากร API และองค์กร](../flutter/README.mdx#api-resources-and-organizations)

## การแก้ไขปัญหา dependency \{#dependency-troubleshooting}

<FlutterSecureStorageCode />

<FlutterWebAuthCode />
