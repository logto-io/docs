import Checkpoint from '../../fragments/_checkpoint-test-your-application.md';
import AssumingUrl from '../../fragments/_web-assuming-url.mdx';
import WebConfigureRedirectUris from '../../fragments/_web-configure-redirect-uris.mdx';
import SignInFlowSummary from '../../fragments/_web-sign-in-flow-summary.mdx';

### เตรียมค่าคอนฟิกและมิดเดิลแวร์ที่จำเป็น \{#prepare-configs-and-required-middlewares}

เตรียมค่าคอนฟิกสำหรับ Logto client:

```ts title="app.ts"
import { LogtoExpressConfig } from '@logto/express';

const config: LogtoExpressConfig = {
  appId: '<your-application-id>',
  appSecret: '<your-application-secret>',
  endpoint: '<your-logto-endpoint>', // เช่น http://localhost:3001
  baseUrl: '<your-express-app-base-url>', // เช่น http://localhost:3000
};
```

SDK ต้องการให้ตั้งค่า [express-session](https://www.npmjs.com/package/express-session) ล่วงหน้า

```ts title="app.ts"
import cookieParser from 'cookie-parser';
import session from 'express-session';

app.use(cookieParser());
app.use(
  session({
    secret: 'random_session_key', // เปลี่ยนเป็น secret ของคุณเอง
    cookie: { maxAge: 14 * 24 * 60 * 60 * 1000 }, // หน่วยเป็นมิลลิวินาที
  })
);
```

### กำหนดค่า redirect URIs \{#configure-redirect-uris}

<SignInFlowSummary />

<AssumingUrl />

<WebConfigureRedirectUris />

### ลงทะเบียนเส้นทาง (routes) \{#register-routes}

SDK มีฟังก์ชันช่วยเหลือ `handleAuthRoutes` สำหรับลงทะเบียน 3 เส้นทางดังนี้:

1. `/logto/sign-in`: ลงชื่อเข้าใช้ด้วย Logto
2. `/logto/sign-in-callback`: จัดการ callback หลังลงชื่อเข้าใช้
3. `/logto/sign-out`: ลงชื่อออกด้วย Logto

เพิ่มโค้ดต่อไปนี้ในแอปของคุณ:

```ts title="app.ts"
import { handleAuthRoutes } from '@logto/express';

app.use(handleAuthRoutes(config));
```

### สร้างปุ่มลงชื่อเข้าใช้และลงชื่อออก \{#implement-sign-in-and-sign-out}

เมื่อได้ลงทะเบียนเส้นทางแล้ว ต่อไปจะเป็นการสร้างปุ่มลงชื่อเข้าใช้และลงชื่อออกในหน้าแรก โดยต้องเปลี่ยนเส้นทางผู้ใช้ไปยัง route สำหรับลงชื่อเข้าใช้หรือออกเมื่อจำเป็น เพื่อช่วยในเรื่องนี้ ให้ใช้ `withLogto` เพื่อ inject สถานะการยืนยันตัวตน (authentication) ไปที่ `req.user`

```ts title="app.ts"
import { withLogto } from '@logto/express';

app.get('/', withLogto(config), (req, res) => {
  res.setHeader('content-type', 'text/html');

  if (req.user.isAuthenticated) {
    res.end(`<div>สวัสดี ${req.user.claims?.sub}, <a href="/logto/sign-out">ลงชื่อออก</a></div>`);
  } else {
    res.end('<div><a href="/logto/sign-in">ลงชื่อเข้าใช้</a></div>');
  }
});
```

<Checkpoint />
