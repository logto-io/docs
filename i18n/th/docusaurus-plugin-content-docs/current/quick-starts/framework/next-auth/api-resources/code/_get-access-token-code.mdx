Auth.js จะดึงโทเค็นการเข้าถึง (Access token) เพียงครั้งเดียวโดยไม่มีพารามิเตอร์ resource เราจำเป็นต้องเขียนกระบวนการดึงโทเค็นการเข้าถึงด้วยตนเอง

#### รับโทเค็นรีเฟรช (Refresh token) \{#get-refresh-token}

อัปเดตการตั้งค่า Logto provider โดยเพิ่มพารามิเตอร์ "prompt" และตั้งค่าเป็น `consent` และตรวจสอบให้แน่ใจว่ามีขอบเขต `offline_access` รวมอยู่ด้วย:

```ts title="./auth.ts"
import NextAuth from 'next-auth';

export const { handlers, signIn, signOut, auth } = NextAuth({
  // ...
  authorization: {
    params: {
      // highlight-next-line
      prompt: 'consent',
      scope: 'openid offline_access shopping:read shopping:write',
      resource: 'https://shopping.your-app.com/api',
      // ...
    },
  },
  // ...
});
```

จากนั้นเพิ่ม callback เพื่อบันทึก `refresh_token` ลงใน session:

```ts title="./auth.ts"
export const { handlers, signIn, signOut, auth } = NextAuth({
  // ...
  callbacks: {
    async jwt({ token, account }) {
      if (account) {
        // ...
        // highlight-next-line
        token.refreshToken = account.refresh_token;
      }
      return token;
    },
    async session({ session, token }) {
      // ...
      // highlight-next-line
      session.refreshToken = token.refreshToken;
      return session;
    },
  },
});
```

#### ดึงโทเค็นการเข้าถึง (Fetch access token) \{#fetch-access-token}

เมื่อมี `refresh_token` แล้ว เราสามารถดึงโทเค็นการเข้าถึงจาก OIDC token endpoint ของ Logto ได้

```ts title="./app/page.tsx"
// ...

export default async function Home() {
  const session = await auth();

  if (session?.refreshToken) {
    // แทนที่ app ID และ secret ด้วยของคุณเอง สามารถดูได้ในส่วน "Integration"
    const basicAuth = Buffer.from('<logto-app-id>:<logto-app-secret>').toString('base64');

    // แทนที่ URL ด้วย endpoint Logto ของคุณ ควรลงท้ายด้วย `/oidc/token`
    const response = await fetch('https://xxx.logto.app/oidc/token', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        Authorization: `Basic ${basicAuth}`,
      },
      body: new URLSearchParams({
        grant_type: 'refresh_token',
        refresh_token: session.refreshToken,
        resource: 'https://shopping.your-app.com/api',
      }).toString(),
    });

    const data = await response.json();
    console.log(data.access_token);
  }

  // ...
}
```
