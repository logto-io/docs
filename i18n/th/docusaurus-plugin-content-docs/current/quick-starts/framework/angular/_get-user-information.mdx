import CodeBlock from '@theme/CodeBlock';

import ClaimsNeedNetworkRequest from '../../fragments/_claims-need-network-request.mdx';
import FindUserInfoMissing from '../../fragments/_find-user-info-missing.mdx';
import ScopesAndClaims from '../../fragments/_scopes-and-claims.mdx';
import ScopesAndClaimsIntroduction from '../../fragments/_scopes-claims-introduction.md';

เมื่อผู้ใช้ลงชื่อเข้าใช้สำเร็จ Logto จะออก [โทเค็น ID (ID token)](https://openid.net/specs/openid-connect-core-1_0.html#IDToken) ซึ่งมีการอ้างสิทธิ์ข้อมูลผู้ใช้ (user information claims) โทเค็น ID เป็น JSON Web Token (JWT)

สิ่งสำคัญที่ควรทราบคือ การอ้างสิทธิ์ข้อมูลผู้ใช้ที่สามารถดึงมาได้ขึ้นอยู่กับ
ขอบเขต (scopes) ที่ผู้ใช้เลือกขณะลงชื่อเข้าใช้ และเพื่อประสิทธิภาพและขนาดข้อมูล โทเค็น ID
อาจไม่มีการอ้างสิทธิ์ของผู้ใช้ทั้งหมด โดยบางการอ้างสิทธิ์จะมีเฉพาะใน [userinfo endpoint](https://openid.net/specs/openid-connect-core-1_0.html#UserInfo) เท่านั้น (ดู
รายการที่เกี่ยวข้องด้านล่าง)

ยูทิลิตี้ `buildAngularAuthConfig()` จะเปิดใช้งาน `autoUserInfo` และ `renewUserInfoAfterTokenRenew` หากไม่มี `resource` ถูกกำหนดใน config ซึ่งหมายความว่า Logto จะดึงข้อมูลผู้ใช้โดยอัตโนติหลังจากผู้ใช้ลงชื่อเข้าใช้ และจะรีเฟรชข้อมูลผู้ใช้หลังจากโทเค็นถูกรีเฟรช

:::info
หากต้องการเรียนรู้เพิ่มเติมเกี่ยวกับการตั้งค่าไลบรารี `angular-auth-oidc-client` ดู [เอกสารทางการ](https://angular-auth-oidc-client.com/)
:::

### แสดงข้อมูลผู้ใช้ \{#display-user-information}

`OidcSecurityService` มีวิธีที่สะดวกในการ subscribe สถานะการยืนยันตัวตนรวมถึงข้อมูลผู้ใช้:

```ts title="app/app.component.ts"
import { OidcSecurityService } from 'angular-auth-oidc-client';
import { decodeIdToken, type IdTokenClaims } from '@logto/js';

export class AppComponent implements OnInit {
  isAuthenticated = false;
  idTokenClaims?: IdTokenClaims;
  accessToken?: string;

  constructor(public oidcSecurityService: OidcSecurityService) {}

  ngOnInit() {
    this.oidcSecurityService.checkAuth().subscribe(({ isAuthenticated, idToken, accessToken }) => {
      console.log('app authenticated', isAuthenticated, idToken);
      this.isAuthenticated = isAuthenticated;
      this.idTokenClaims = decodeIdToken(idToken);
      this.accessToken = accessToken;
    });
  }

  // ...other methods
}
```

และนำไปใช้ในเทมเพลต:

```html title="app/app.component.html"
<button *ngIf="!isAuthenticated" (click)="signIn()">Sign in</button>
<ng-container *ngIf="isAuthenticated">
  <pre>{{ idTokenClaims | json }}</pre>
  <p>Access token: {{ accessToken }}</p>
  <!-- ... -->
  <button (click)="signOut()">Sign out</button>
</ng-container>
```

### ขอการอ้างสิทธิ์เพิ่มเติม \{#request-additional-claims}

<FindUserInfoMissing method="idToken" />

<ScopesAndClaimsIntroduction />

หากต้องการขอขอบเขต (scopes) เพิ่มเติม คุณสามารถตั้งค่าใน auth provider configs ได้ดังนี้:

```tsx title="app/app.config.ts"
import { UserScope, buildAngularAuthConfig } from '@logto/js';

export const appConfig: ApplicationConfig = {
  providers: [
    provideHttpClient(withFetch()),
    provideAuth({
      config: buildAngularAuthConfig({
        // ...other configs
        // highlight-start
        scopes: [
          UserScope.Email,
          UserScope.Phone,
          UserScope.CustomData,
          UserScope.Identities,
          UserScope.Organizations,
        ],
        // highlight-end
      }),
    }),
    // ...other providers
  ],
};
```

จากนั้นคุณสามารถเข้าถึงการอ้างสิทธิ์เพิ่มเติมในค่าที่คืนมาของ `idToken`

{/* eslint-disable prettier/prettier */}
<ClaimsNeedNetworkRequest
  type="option"
  configOption="userData"
  value="userData"
  codeSnippet={
    <CodeBlock language="ts" title="app/app.component.ts">{`import { OidcSecurityService } from 'angular-auth-oidc-client';
// highlight-next-line
import { type UserInfoResponse } from '@logto/js';

export class AppComponent implements OnInit {
  isAuthenticated = false;
  // highlight-next-line
  userData?: UserInfoResponse;
  accessToken?: string;

  constructor(public oidcSecurityService: OidcSecurityService) {}

  ngOnInit() {
    this.oidcSecurityService
      .checkAuth()
      // highlight-next-line
      .subscribe(({ isAuthenticated, userData, accessToken }) => {
        console.log('app authenticated', isAuthenticated, idToken);
        this.isAuthenticated = isAuthenticated;
        // highlight-next-line
        this.userData = userData;
        this.accessToken = accessToken;
      });
  }

  // ...other methods
}

// ตอนนี้คุณสามารถเข้าถึง claim \`userData.custom_data\` ได้แล้ว`}</CodeBlock>
}
/>
{/* eslint-enable prettier/prettier */}

### ขอบเขตและการอ้างสิทธิ์ \{#scopes-and-claims}

<ScopesAndClaims />
