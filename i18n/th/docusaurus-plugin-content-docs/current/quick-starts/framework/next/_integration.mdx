import Checkpoint from '../../fragments/_checkpoint-test-your-application.md';
import AssumingUrl from '../../fragments/_web-assuming-url.mdx';
import WebConfigureRedirectUris from '../../fragments/_web-configure-redirect-uris.mdx';
import SignInFlowSummary from '../../fragments/_web-sign-in-flow-summary.mdx';

### เริ่มต้น LogtoClient \{#init-logtoclient}

นำเข้าและเริ่มต้น LogtoClient:

```ts title="libraries/logto.ts"
import LogtoClient from '@logto/next';

export const logtoClient = new LogtoClient({
  appId: '<your-application-id>',
  appSecret: '<your-app-secret-copied-from-console>',
  endpoint: '<your-logto-endpoint>', // เช่น http://localhost:3001
  baseUrl: 'http://localhost:3000',
  cookieSecret: 'complex_password_at_least_32_characters_long',
  cookieSecure: process.env.NODE_ENV === 'production',
});
```

### กำหนดค่า Redirect URIs \{#configure-redirect-uris}

<SignInFlowSummary />

<AssumingUrl />

<WebConfigureRedirectUris redirectUri="http://localhost:3000/api/logto/sign-in-callback" />

### เตรียม API routes \{#prepare-api-routes}

เตรียม [API routes](https://nextjs.org/docs/pages/building-your-application/routing/api-routes) เพื่อเชื่อมต่อกับ Logto

กลับไปที่ IDE / editor ของคุณ ใช้โค้ดต่อไปนี้เพื่อสร้าง API routes ก่อน:

```ts title="pages/api/logto/[action].ts"
import { logtoClient } from '../../../libraries/logto';

export default logtoClient.handleAuthRoutes();
```

โค้ดนี้จะสร้าง 4 เส้นทางให้อัตโนมัติ:

1. `/api/logto/sign-in`: ลงชื่อเข้าใช้ด้วย Logto
2. `/api/logto/sign-in-callback`: จัดการ callback หลังลงชื่อเข้าใช้
3. `/api/logto/sign-out`: ลงชื่อออกด้วย Logto
4. `/api/logto/user`: ตรวจสอบว่าผู้ใช้ได้รับการยืนยันตัวตนกับ Logto หรือไม่ ถ้าใช่ จะคืนค่าข้อมูลผู้ใช้

### สร้างปุ่มลงชื่อเข้าใช้และลงชื่อออก \{#implement-sign-in-and-sign-out}

เราได้เตรียม API routes แล้ว ต่อไปจะสร้างปุ่มลงชื่อเข้าใช้และลงชื่อออกในหน้าแรกของคุณ โดยต้องเปลี่ยนเส้นทางผู้ใช้ไปยัง route สำหรับลงชื่อเข้าใช้หรือออกเมื่อจำเป็น เพื่อช่วยในส่วนนี้ ให้ใช้ `useSWR` เพื่อดึงสถานะการยืนยันตัวตนจาก `/api/logto/user`

ดู [คู่มือนี้](https://swr.vercel.app/docs/getting-started) เพื่อเรียนรู้เพิ่มเติมเกี่ยวกับ `useSWR`

```tsx title="/pages/index.tsx"
import { type LogtoContext } from '@logto/next';
import useSWR from 'swr';

const Home = () => {
  const { data } = useSWR<LogtoContext>('/api/logto/user');

  return (
    <nav>
      {data?.isAuthenticated ? (
        <p>
          สวัสดี, {data.claims?.sub},
          <button
            onClick={() => {
              window.location.assign('/api/logto/sign-out');
            }}
          >
            ลงชื่อออก
          </button>
        </p>
      ) : (
        <p>
          <button
            onClick={() => {
              window.location.assign('/api/logto/sign-in');
            }}
          >
            ลงชื่อเข้าใช้
          </button>
        </p>
      )}
    </nav>
  );
};

export default Home;
```

<Checkpoint />
