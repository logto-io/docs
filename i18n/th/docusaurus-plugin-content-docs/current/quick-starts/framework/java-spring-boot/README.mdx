---
slug: /quick-starts/java-spring-boot
sidebar_label: Java Spring Boot
sidebar_custom_props:
  description: Spring Boot คือเฟรมเวิร์กเว็บสำหรับ Java ที่ช่วยให้นักพัฒนาสร้างแอปพลิเคชันเซิร์ฟเวอร์ที่ปลอดภัย รวดเร็ว และขยายขนาดได้ด้วยภาษา Java
  logoFilename: 'spring-boot.svg'
---

import FindUserInfoMissing from '../../fragments/_find-user-info-missing.mdx';
import FurtherReadings from '../../fragments/_further-readings.md';
import ScopesAndClaimsIntroduction from '../../fragments/_scopes-claims-introduction.md';
import WebConfigureRedirectUris from '../../fragments/_web-configure-redirect-uris.mdx';
import SignInFlowSummary from '../../fragments/_web-sign-in-flow-summary.mdx';

import ScopesAndClaims from './_scopes-and-claims.mdx';

# เพิ่มการยืนยันตัวตนให้กับแอป Java Spring Boot ของคุณ (Add authentication to your Java Spring Boot application)

คู่มือนี้จะแสดงวิธีผสาน Logto เข้ากับแอป Java Spring Boot ของคุณ

:::tip

- คุณสามารถดูตัวอย่างโค้ดสำหรับคู่มือนี้ได้ที่ [spring-boot-sample](https://github.com/logto-io/spring-boot-sample) ใน github ของเรา
- ไม่จำเป็นต้องใช้ SDK อย่างเป็นทางการในการผสาน Logto กับแอป Java Spring Boot ของคุณ เราจะใช้ไลบรารี [Spring Security](https://spring.io/projects/spring-security) และ [Spring Security OAuth2](https://spring.io/guides/tutorials/spring-boot-oauth2) เพื่อจัดการโฟลว์การยืนยันตัวตน OIDC กับ Logto

:::

## ข้อกำหนดเบื้องต้น \{#prerequisites}

- มีบัญชี [Logto Cloud](https://cloud.logto.io) หรือ [Logto ที่โฮสต์เอง](/introduction/set-up-logto-oss)
- ตัวอย่างโค้ดของเราสร้างขึ้นโดยใช้ Spring Boot [securing web starter](https://spring.io/guides/gs/securing-web) ทำตามคำแนะนำเพื่อสร้างแอปเว็บใหม่หากคุณยังไม่มี
- ในคู่มือนี้ เราจะใช้ไลบรารี [Spring Security](https://spring.io/projects/spring-security) และ [Spring Security OAuth2](https://spring.io/guides/tutorials/spring-boot-oauth2) เพื่อจัดการโฟลว์การยืนยันตัวตน OIDC กับ Logto โปรดอ่านเอกสารอย่างเป็นทางการเพื่อเข้าใจแนวคิดต่าง ๆ

## ตั้งค่าแอป Java Spring Boot ของคุณ \{#configure-your-java-spring-boot-application}

### การเพิ่ม dependencies \{#adding-dependencies}

สำหรับผู้ใช้ [gradle](https://spring.io/guides/gs/gradle) ให้เพิ่ม dependencies ต่อไปนี้ในไฟล์ `build.gradle` ของคุณ:

```groovy title="build.gradle"
dependencies {
  implementation 'org.springframework.boot:spring-boot-starter-thymeleaf'
	implementation 'org.springframework.boot:spring-boot-starter-web'
  implementation 'org.springframework.boot:spring-boot-starter-security'
	implementation 'org.springframework.boot:spring-boot-starter-oauth2-client'
}
```

สำหรับผู้ใช้ [maven](https://spring.io/guides/gs/maven) ให้เพิ่ม dependencies ต่อไปนี้ในไฟล์ `pom.xml` ของคุณ:

```xml title="pom.xml"
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-thymeleaf</artifactId>
</dependency>
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-web</artifactId>
</dependency>
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-security</artifactId>
</dependency>
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-oauth2-client</artifactId>
</dependency>
```

### การตั้งค่า OAuth2 Client \{#oauth2-client-configuration}

ลงทะเบียนแอป `Java Spring Boot` ใหม่ใน Logto Console และรับ client credential และการตั้งค่า IdP สำหรับแอปเว็บของคุณ

เพิ่มการตั้งค่าต่อไปนี้ในไฟล์ `application.properties` ของคุณ:

```properties title="application.properties"
spring.security.oauth2.client.registration.logto.client-name=logto
spring.security.oauth2.client.registration.logto.client-id={{YOUR_CLIENT_ID}}
spring.security.oauth2.client.registration.logto.client-secret={{YOUR_CLIENT_ID}}
spring.security.oauth2.client.registration.logto.redirect-uri={baseUrl}/login/oauth2/code/{registrationId}
spring.security.oauth2.client.registration.logto.authorization-grant-type=authorization_code
spring.security.oauth2.client.registration.logto.scope=openid,profile,offline_access
spring.security.oauth2.client.registration.logto.provider=logto

spring.security.oauth2.client.provider.logto.issuer-uri={{LOGTO_ENDPOINT}}/oidc
spring.security.oauth2.client.provider.logto.authorization-uri={{LOGTO_ENDPOINT}}/oidc/auth
spring.security.oauth2.client.provider.logto.jwk-set-uri={{LOGTO_ENDPOINT}}/oidc/jwks
```

## การนำไปใช้ \{#implementation}

<SignInFlowSummary />

เพื่อเปลี่ยนเส้นทางผู้ใช้กลับมายังแอปของคุณหลังจากลงชื่อเข้าใช้ คุณต้องตั้งค่า redirect URI โดยใช้ property `client.registration.logto.redirect-uri` ในขั้นตอนก่อนหน้า

<WebConfigureRedirectUris />

### สร้าง WebSecurityConfig \{#implement-the-websecurityconfig}

#### สร้างคลาสใหม่ชื่อ `WebSecurityConfig` ในโปรเจกต์ของคุณ \{#create-a-new-class-websecurityconfig-in-your-project}

คลาส `WebSecurityConfig` จะใช้สำหรับกำหนดค่าความปลอดภัยของแอปของคุณ เป็นคลาสสำคัญที่จัดการโฟลว์การยืนยันตัวตนและการอนุญาต โปรดดู [Spring Security documentation](https://spring.io/guides/topicals/spring-security-architecture) สำหรับรายละเอียดเพิ่มเติม

```java title="WebSecurityConfig.java"
// โค้ดเหมือนเดิม
```

#### สร้าง bean `idTokenDecoderFactory` \{#create-a-idtokendecoderfactory-bean}

จำเป็นต้องทำเพราะ Logto ใช้ `ES384` เป็นอัลกอริทึมเริ่มต้น เราต้องเขียนทับ `OidcIdTokenDecoderFactory` เริ่มต้นเพื่อใช้อัลกอริทึมเดียวกัน

```java title="WebSecurityConfig.java"
// โค้ดเหมือนเดิม
```

#### สร้างคลาส LoginSuccessHandler เพื่อจัดการเหตุการณ์เข้าสู่ระบบสำเร็จ \{#create-a-loginsuccesshandler-class-to-handle-the-login-success-event}

เราจะเปลี่ยนเส้นทางผู้ใช้ไปยังหน้า `/user` หลังจากเข้าสู่ระบบสำเร็จ

```java title="CustomSuccessHandler.java"
// โค้ดเหมือนเดิม
```

#### สร้างคลาส LogoutSuccessHandler เพื่อจัดการเหตุการณ์ออกจากระบบสำเร็จ \{#create-a-logoutsuccesshandler-class-to-handle-the-logout-success-event}

ล้าง session และเปลี่ยนเส้นทางผู้ใช้ไปยังหน้าแรก

```java title="CustomLogoutHandler.java"
// โค้ดเหมือนเดิม
```

#### อัปเดตคลาส `WebSecurityConfig` ด้วย `securityFilterChain` \{#update-the-websecurityconfig-class-with-a-securityfilterchain}

[securityFilterChain](https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/web/DefaultSecurityFilterChain.html) คือชุดของฟิลเตอร์ที่รับผิดชอบในการประมวลผล request และ response ที่เข้ามา

เราจะกำหนดค่า `securityFilterChain` เพื่ออนุญาตเข้าถึงหน้าแรก และต้องยืนยันตัวตนสำหรับ request อื่น ๆ ทั้งหมด ใช้ `CustomSuccessHandler` และ `CustomLogoutHandler` เพื่อจัดการเหตุการณ์เข้าสู่ระบบและออกจากระบบ

```java title="WebSecurityConfig.java"
// โค้ดเหมือนเดิม
```

### สร้างหน้าแรก \{#create-a-home-page}

(คุณสามารถข้ามขั้นตอนนี้ได้หากมีหน้าแรกอยู่แล้วในโปรเจกต์ของคุณ)

```java title="HomeController.java"
// โค้ดเหมือนเดิม
```

คอนโทรลเลอร์นี้จะเปลี่ยนเส้นทางผู้ใช้ไปยังหน้าผู้ใช้หากผู้ใช้ได้รับการยืนยันตัวตนแล้ว มิฉะนั้นจะแสดงหน้าแรก เพิ่มลิงก์เข้าสู่ระบบในหน้าแรก

```html title="resources/templates/home.html"
<body>
  <h1>ยินดีต้อนรับ!</h1>

  <p><a th:href="@{/oauth2/authorization/logto}">เข้าสู่ระบบด้วย Logto</a></p>
</body>
```

### สร้างหน้าผู้ใช้ \{#create-a-user-page}

สร้างคอนโทรลเลอร์ใหม่เพื่อจัดการหน้าผู้ใช้:

```java title="UserController.java"
// โค้ดเหมือนเดิม
```

เมื่อผู้ใช้ได้รับการยืนยันตัวตนแล้ว เราจะดึงข้อมูล `OAuth2User` จาก principal ที่ได้รับการยืนยัน โปรดดู [OAuth2AuthenticationToken](https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/oauth2/client/authentication/OAuth2AuthenticationToken.html) และ [OAuth2User](https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/oauth2/core/user/OAuth2User.html) สำหรับรายละเอียดเพิ่มเติม

อ่านข้อมูลผู้ใช้และส่งไปยังเทมเพลต `user.html`

```html title="resources/templates/user.html"
<body>
  <h1>รายละเอียดผู้ใช้</h1>
  <div>
    <p>
    <div><strong>ชื่อ:</strong> <span th:text="${username}"></span></div>
    <div><strong>อีเมล:</strong> <span th:text="${email}"></span></div>
    <div><strong>รหัส:</strong> <span th:text="${sub}"></span></div>
    </p>
  </div>

  <form th:action="@{/logout}" method="post">
    <input type="submit" value="ออกจากระบบ" />
  </form>
</body>
```

#### ขอข้อมูลการอ้างสิทธิ์เพิ่มเติม \{#request-additional-claims}

<FindUserInfoMissing method="principal (OAuth2AuthenticationToken)" />

<ScopesAndClaimsIntroduction />

หากต้องการดึงข้อมูลผู้ใช้เพิ่มเติม คุณสามารถเพิ่ม scope เพิ่มเติมในไฟล์ `application.properties` ตัวอย่างเช่น หากต้องการขอ scope `email`, `phone` และ `urn:logto:scope:organizations` ให้เพิ่มบรรทัดต่อไปนี้ในไฟล์ `application.properties`:

```properties title="application.properties"
  spring.security.oauth2.client.registration.logto.scope=openid,profile,offline_access,email,phone,urn:logto:scope:organizations
```

จากนั้นคุณสามารถเข้าถึงข้อมูลการอ้างสิทธิ์เพิ่มเติมในอ็อบเจกต์ `OAuth2User`

### รันและทดสอบแอปพลิเคชัน \{#run-and-test-the-application}

รันแอปพลิเคชันและไปที่ `http://localhost:8080`

- คุณจะเห็นหน้าแรกพร้อมลิงก์เข้าสู่ระบบ
- คลิกที่ลิงก์เพื่อเข้าสู่ระบบด้วย Logto
- หลังจากยืนยันตัวตนสำเร็จ คุณจะถูกเปลี่ยนเส้นทางไปยังหน้าผู้ใช้พร้อมรายละเอียดของคุณ
- คลิกปุ่มออกจากระบบเพื่อออกจากระบบ คุณจะถูกเปลี่ยนเส้นทางกลับไปยังหน้าแรก

## ขอบเขต (Scopes) และ การอ้างสิทธิ์ (Claims) \{#scopes-and-claims}

<ScopesAndClaims />

## อ่านเพิ่มเติม \{#further-readings}

<FurtherReadings />
