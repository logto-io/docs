import Checkpoint from '../../fragments/_checkpoint-test-your-application.md';
import AssumingUrl from '../../fragments/_web-assuming-url.mdx';
import WebConfigureRedirectUris from '../../fragments/_web-configure-redirect-uris.mdx';
import SignInFlowSummary from '../../fragments/_web-sign-in-flow-summary.mdx';

### เพิ่ม Logto hook \{#add-logto-hook}

ในไฟล์ `hooks.server.ts` ของคุณ ให้เพิ่มโค้ดต่อไปนี้เพื่อแทรก Logto hook ลงในเซิร์ฟเวอร์ของคุณ:

```ts title="hooks.server.ts"
import { handleLogto } from '@logto/sveltekit';

export const handle = handleLogto(
  {
    endpoint: '<your-logto-endpoint>',
    appId: '<your-logto-app-id>',
    appSecret: '<your-logto-app-secret>',
  },
  {
    encryptionKey: '<a-random-string>',
  }
);
```

เนื่องจากข้อมูลเหล่านี้มีความสำคัญ ควรใช้ environment variables:

```ts title="hooks.server.ts"
import { handleLogto } from '@logto/sveltekit';
import { env } from '$env/dynamic/private';

export const handle = handleLogto(
  {
    endpoint: env.LOGTO_ENDPOINT,
    appId: env.LOGTO_APP_ID,
    appSecret: env.LOGTO_APP_SECRET,
  },
  {
    encryptionKey: env.LOGTO_COOKIE_ENCRYPTION_KEY,
  }
);
```

หากคุณมีหลาย hooks คุณสามารถใช้ [ฟังก์ชันช่วย sequence()](https://kit.svelte.dev/docs/modules#sveltejs-kit-hooks) เพื่อเชื่อมต่อ hooks เหล่านั้น:

```ts title="hooks.server.ts"
import { sequence } from '@sveltejs/kit/hooks';

export const handle = sequence(handleLogto, handleOtherHook);
```

ตอนนี้คุณสามารถเข้าถึง Logto client ได้ในอ็อบเจกต์ `locals` สำหรับ TypeScript คุณสามารถเพิ่ม type ใน `app.d.ts` ได้ดังนี้:

```ts
import type { LogtoClient, UserInfoResponse } from '@logto/sveltekit';

declare global {
  namespace App {
    interface Locals {
      logtoClient: LogtoClient;
      user?: UserInfoResponse;
    }
  }
}
```

เราจะพูดถึงอ็อบเจกต์ `user` ในภายหลัง

### สร้างฟังก์ชันลงชื่อเข้าใช้และออกจากระบบ \{#implement-sign-in-and-sign-out}

<AssumingUrl />

<SignInFlowSummary />

<WebConfigureRedirectUris />

ในหน้าที่คุณต้องการสร้างฟังก์ชันลงชื่อเข้าใช้และออกจากระบบ ให้กำหนด actions ดังนี้:

```ts title="+page.server.ts"
import type { Actions } from './$types';

export const actions: Actions = {
  signIn: async ({ locals }) => {
    await locals.logtoClient.signIn('http://localhost:3000/callback');
  },
  signOut: async ({ locals }) => {
    await locals.logtoClient.signOut('http://localhost:3000/');
  },
};
```

จากนั้นใช้ actions เหล่านี้ใน Svelte component ของคุณ:

```html title="+page.svelte"
<form method="POST" action="?/{data.user ? 'signOut' : 'signIn'}">
  <button type="submit">Sign {data.user ? 'out' : 'in'}</button>
</form>
```

<Checkpoint />
