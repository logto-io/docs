---
slug: /quick-starts/m2m
sidebar_label: เครื่องต่อเครื่อง
sidebar_custom_props:
  description: เปิดใช้งานการสื่อสารโดยตรงระหว่างเครื่อง
---

import TabItem from '@theme/TabItem';
import Tabs from '@theme/Tabs';

import AppNote from '../../fragments/_app-note.mdx';

import AccessLogtoManagementApiUsingAccessToken from './fragments/_access-logto-management-api-using-access-token.mdx';
import AccessTokenUsage from './fragments/_access-token-usage.mdx';
import BasicsAboutAccessTokenRequest from './fragments/_basics-about-access-token-request.mdx';
import FetchAccessTokenForLogtoManagementApi from './fragments/_fetch-access-token-for-logto-management-api.mdx';
import M2mAccessTokenSubNote from './fragments/_m2m-access-token-sub-note.mdx';
import M2mRoleAssignment from './fragments/_m2m-role-assignment.mdx';

# เครื่องต่อเครื่อง: การยืนยันตัวตนกับ Logto

<AppNote type="Machine-to-machine" />

## แนะนำ \{#intro}

เครื่องต่อเครื่อง (Machine-to-machine; M2M) เป็นแนวปฏิบัติทั่วไปสำหรับการยืนยันตัวตนหากคุณมีแอป (ไม่ใช่ผู้ใช้) ที่ต้องสื่อสารกับทรัพยากรโดยตรง (โดยปกติแล้วแอป M2M ไม่ต้องมีการโต้ตอบกับผู้ใช้ จึงไม่มี UI) เช่น บริการ API ที่อัปเดตข้อมูลผู้ใช้แบบกำหนดเองใน Logto, บริการสถิติที่ดึงคำสั่งซื้อรายวัน ฯลฯ

เนื่องจาก Logto ใช้ RBAC เป็นนโยบายควบคุมการเข้าถึง การกำหนดบทบาท M2M ให้กับแอป M2M จึงเป็นสิ่งจำเป็นเพื่อปกป้อง API ของคุณที่ต้องการการสื่อสารโดยตรงระหว่างบริการ

:::info
เพื่อเรียนรู้เกี่ยวกับ RBAC ปัจจุบันของเราและความแตกต่างระหว่างบทบาทผู้ใช้กับบทบาท M2M ดูที่ [กำหนดค่าบทบาทระดับโกลบอล](/authorization/role-based-access-control#configure-global-roles) เพื่อศึกษารายละเอียดเพิ่มเติม
:::

มีกรณีการใช้งานหลัก 2 แบบของแอปเครื่องต่อเครื่องใน Logto:

1. **เข้าถึง Logto Management API**: ในกรณีนี้ คุณต้องกำหนดบทบาท M2M ที่มีสิทธิ์ `all` จาก Logto Management API ที่มีมาให้กับแอป M2M ของคุณ
2. **เข้าถึงทรัพยากร API ของคุณ**: ในกรณีนี้ คุณต้องกำหนดบทบาท M2M ที่มีสิทธิ์จากทรัพยากร API ของคุณให้กับแอป M2M

<M2mRoleAssignment />

ต่อไป เราจะพาคุณผ่านกระบวนการแบบ end-to-end เพื่อความชัดเจน เราจะแยกขั้นตอนสำหรับการเข้าถึง Logto Management API และทรัพยากร API อื่น ๆ และสมมติว่าคุณได้สร้างแอป M2M ใน Logto แล้ว

## ดึงโทเค็นการเข้าถึง (Fetch an access token) \{#fetch-an-access-token}

### พื้นฐานเกี่ยวกับคำขอโทเค็นการเข้าถึง \{#basics-about-access-token-request}

<BasicsAboutAccessTokenRequest />

ตัวอย่างคำขอโทเค็นการเข้าถึง:

```http
POST /oidc/token HTTP/1.1
Host: your.logto.endpoint
Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW
Content-Type: application/x-www-form-urlencoded

grant_type=client_credentials
&resource=https://shopping.api
&scope=read:products write:products
```

### ขอรับโทเค็นการเข้าถึง \{#request-an-access-token}

:::note
ในการสาธิตต่อไปนี้ ให้แทนที่ `https://your.logto.endpoint` ด้วย Logto endpoint ที่คุณต้องการใช้งาน สำหรับ Logto Cloud จะเป็น `https://{your-tenant-id}.logto.app`
:::

<Tabs>

<TabItem value="Logto Management API" label="สำหรับ Logto Management API">
  <FetchAccessTokenForLogtoManagementApi />
</TabItem>

<TabItem value="API resource" label="สำหรับทรัพยากร API ของคุณ">
ในรายการ API Resource ของคุณ ให้ค้นหา API identifier ที่แอปต้องเข้าถึง หากคุณยังไม่ได้เพิ่ม API Resource ใน Logto หรือไม่ทราบว่า API Resource คืออะไร ดูที่ [การอนุญาต (Authorization)](/authorization)

<img
  alt="API identifier"
  src="/img/assets/api-identifier.png"
  width="600px"
  style={{ paddingBottom: '12px' }}
/>

สมมติว่าเรามีสิทธิ์ `read:products` และ `write:products` อยู่ภายใต้ทรัพยากร API “Online Shopping” นี้

ก่อนเข้าถึงทรัพยากร API ของคุณ ตรวจสอบให้แน่ใจว่าแอป M2M ของคุณได้รับมอบหมายบทบาท M2M ที่มีสิทธิ์จากทรัพยากร API ของคุณแล้ว

ตอนนี้ รวบรวมทุกอย่างที่เรามีและส่งคำขอ:

<Tabs>

<TabItem value="Node.js" label="Node.js">

```js
const logtoEndpoint = 'https://your.logto.endpoint';
const tokenEndpoint = `${logtoEndpoint}/oidc/token`;
const applicationId = 'your-application-id';
const applicationSecret = 'your-application-secret';

const fetchAccessToken = async () => {
  return await fetch(tokenEndpoint, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      Authorization: `Basic ${Buffer.from(`${applicationId}:${applicationSecret}`).toString(
        'base64'
      )}`,
    },
    body: new URLSearchParams({
      grant_type: 'client_credentials',
      resource: 'https://shopping.api',
      scope: 'read:products write:products',
    }).toString(),
  });
};
```

</TabItem>

<TabItem value="cURL" label="cURL">

```bash
curl --location \
  --request POST 'https://your.logto.endpoint/oidc/token' \
  --header 'Authorization: Basic ${your_auth_string}' \
  --header 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode 'grant_type=client_credentials' \
  --data-urlencode 'resource=https://shopping.api' \
  --data-urlencode 'scope=read:products write:products'
```

</TabItem>

</Tabs>

</TabItem>
</Tabs>

### การตอบกลับโทเค็นการเข้าถึง \{#access-token-response}

ตัวอย่าง response ที่สำเร็จจะมีลักษณะดังนี้:

```json
{
  "access_token": "eyJhbG...2g", // ใช้โทเค็นนี้สำหรับเข้าถึง Logto Management API
  "expires_in": 3600, // อายุโทเค็นเป็นวินาที
  "token_type": "Bearer", // ประเภทการยืนยันตัวตนสำหรับคำขอเมื่อใช้โทเค็นการเข้าถึง
  "scope": "all" // scope `all` สำหรับ Logto Management API
}
```

<M2mAccessTokenSubNote />

## เข้าถึงทรัพยากรโดยใช้โทเค็นการเข้าถึง \{#access-resource-using-access-token}

<AccessTokenUsage />

<Tabs>

<TabItem value="Logto Management API" label="โต้ตอบกับ Logto Management API">
  <AccessLogtoManagementApiUsingAccessToken />
</TabItem>

<TabItem value="Your API resource" label="โต้ตอบกับทรัพยากร API ของคุณ">
ใช้โทเค็นการเข้าถึงที่ขอมากับทรัพยากร API `https://shopping.api` เพื่อดึงสินค้าทั้งหมดใน shopping API:

<Tabs>
<TabItem value="Node.js" label="Node.js">

```js
const apiEndpoint = 'https://your.api.endpoint';
const accessToken = 'eyJhb...2g'; // โทเค็นการเข้าถึง

const fetchProducts = async () => {
  return await fetch(`${apiEndpoint}/products`, {
    method: 'GET',
    headers: {
      Authorization: `Bearer ${accessToken}`,
    },
  });
};
```

</TabItem>

<TabItem value="cURL" label="cURL">

```bash
curl --location \
  --request GET 'https://your.api.endpoint/products' \
  --header 'Authorization: Bearer eyJhbG...2 # โทเค็นการเข้าถึง
```

</TabItem>
</Tabs>
</TabItem>
</Tabs>

## การอนุญาต (Authorization) \{#authorization}

หากคุณปกป้องทรัพยากร API ของคุณเองที่ไม่ใช่ Logto Management API คุณต้องพัฒนา logic การอนุญาตในบริการ API ของคุณเพื่อยืนยันโทเค็นการเข้าถึงและตรวจสอบว่าแอป M2M มีสิทธิ์ที่จำเป็นในการเข้าถึงทรัพยากรหรือไม่

ดูรายละเอียดเพิ่มเติมได้ที่ [การอนุญาต (Authorization)](/authorization) และ [ตรวจสอบความถูกต้องของโทเค็นการเข้าถึง](/authorization/validate-access-tokens)
