---
id: federated-token-set
title: Armazenamento de tokens de terceiros & acesso √† API
sidebar_label: Armazenamento de tokens de terceiros
---

import Availability from '@components/Availability';

<Availability cloud oss={{ major: 1, minor: 31 }} />

O conjunto de tokens de terceiros (tamb√©m conhecido como conjunto de tokens federados) √© um tipo de segredo armazenado no [cofre de segredos](/secret-vault) do Logto, usado para gerenciar com seguran√ßa tokens de acesso e atualiza√ß√£o emitidos por provedores de identidade de terceiros. Quando um usu√°rio se autentica via um conector social ou SSO corporativo, o Logto armazena os tokens emitidos no cofre. Esses tokens podem ser recuperados posteriormente para acessar APIs de terceiros em nome do usu√°rio, sem exigir nova autentica√ß√£o.

## Casos de uso comuns \{#common-use-cases}

Essa capacidade √© essencial para aplicativos modernos como agentes de IA, plataformas SaaS, ferramentas de produtividade e aplicativos para clientes que precisam interagir com servi√ßos de terceiros em nome dos usu√°rios. Aqui est√£o alguns exemplos pr√°ticos:

**üìÖ Aplicativos de gerenciamento de calend√°rio**: Ap√≥s um usu√°rio fazer login com o Google, seu aplicativo de produtividade pode sincronizar automaticamente os eventos do calend√°rio, criar novas reuni√µes e enviar convites sem pedir que ele se autentique novamente.

**ü§ñ Assistentes de IA**: Um agente de IA pode acessar os reposit√≥rios do GitHub de um usu√°rio para analisar c√≥digo, criar pull requests ou gerenciar issues. Tudo com o consentimento √∫nico do usu√°rio durante o login ou vincula√ß√£o de conta.

**üìä Dashboards de an√°lise**: Plataformas SaaS podem extrair dados das contas de redes sociais conectadas dos usu√°rios (Facebook, LinkedIn) para gerar insights e relat√≥rios sem interromper o fluxo de trabalho com solicita√ß√µes de login repetidas.

## Habilitar armazenamento de tokens de terceiros \{#enable-third-party-token-storage}

### Conectores sociais \{#social-connectors}

Esse recurso est√° dispon√≠vel para [conectores sociais](/connectors/social-connectors) que suportam armazenamento de tokens. Os tokens de terceiros podem ser armazenados durante o [login social](/end-user-flows/sign-up-and-sign-in/social-sign-in), [vincula√ß√£o de conta social](/end-user-flows/account-settings/by-account-api#link-a-new-social-connection) e [ao renovar tokens para acesso √† API de terceiros](/secret-vault/federated-token-set#reauthentication-and-token-renewal). Os conectores atualmente suportados incluem: [GitHub](/integrations/github), [Google](/integrations/google), [Facebook](/integrations/facebook), [OAuth 2.0 padr√£o](/integrations/oauth2) e [OIDC padr√£o](/integrations/oidc). O suporte para conectores adicionais ser√° disponibilizado gradualmente.

1. Navegue at√© <CloudLink to="/connectors/social">Console > Conectores > Conectores Sociais</CloudLink>.
2. Selecione o conector social para o qual deseja habilitar o armazenamento de tokens de terceiros.
3. Siga os tutoriais de configura√ß√£o para configurar o conector, incluindo a adi√ß√£o dos escopos necess√°rios para acessar APIs de terceiros espec√≠ficas.
4. Na p√°gina "Configura√ß√£o", habilite a op√ß√£o **Armazenar tokens para acesso persistente √† API**.

### Conectores SSO corporativos \{#enterprise-sso-connectors}

O armazenamento de tokens est√° dispon√≠vel para todos os [conectores corporativos OIDC](/connectors/enterprise-connectors). Tokens de acesso e atualiza√ß√£o podem ser armazenados durante o [Single Sign-On corporativo](/end-user-flows/enterprise-sso). Os conectores atualmente suportados incluem: [Google Workspace](/integrations/google-workspace), [Microsoft Entra ID (OIDC)](/integrations/entra-id-oidc), [Okta](/integrations/okta) e [OIDC (Enterprise)](/integrations/oidc-sso).

1. Navegue at√© <CloudLink to="/enterprise-sso">Console > SSO Corporativo</CloudLink>.
2. Selecione o conector SSO corporativo para o qual deseja habilitar o armazenamento de tokens de terceiros.
3. Siga os tutoriais de configura√ß√£o para configurar o conector, incluindo a adi√ß√£o dos escopos necess√°rios para acessar APIs de terceiros espec√≠ficas.
4. Na guia "Experi√™ncia SSO", habilite a op√ß√£o **Armazenar tokens para acesso persistente √† API**.

Certifique-se de salvar suas altera√ß√µes.

## Armazenamento de tokens \{#token-storage}

Uma vez que o armazenamento de tokens de terceiros esteja habilitado, o Logto armazena automaticamente os tokens de acesso e atualiza√ß√£o emitidos pelo provedor de identidade federado sempre que um usu√°rio se autentica por meio de um conector social ou SSO corporativo. Isso inclui:

- [Login e cadastro social](/end-user-flows/sign-up-and-sign-in/social-sign-in)
- [Login e cadastro via SSO corporativo](/end-user-flows/enterprise-sso)
- [Vincula√ß√£o de conta social via Account API](/end-user-flows/account-settings/by-account-api#link-a-new-social-connection)

Os tokens armazenados s√£o vinculados √† identidade social ou SSO corporativa do usu√°rio, permitindo que ele recupere os tokens posteriormente para acesso √† API sem exigir nova autentica√ß√£o.

### Verificando o status do armazenamento de tokens \{#checking-token-storage-status}

Voc√™ pode verificar o status do armazenamento de tokens de terceiros de um usu√°rio no Console do Logto:

1. Navegue at√© <CloudLink to="/users">Console > Usu√°rios</CloudLink>.
2. Clique no usu√°rio que deseja inspecionar. Isso o levar√° √† p√°gina de detalhes do usu√°rio.
3. Role at√© a se√ß√£o **Conex√µes**. Esta √°rea lista todas as conex√µes sociais e SSO corporativas associadas ao usu√°rio.
4. Cada entrada de conex√£o mostra um r√≥tulo de status do token indicando se os tokens est√£o armazenados para essa conex√£o.
5. Clique na entrada da conex√£o para ver mais detalhes, incluindo os metadados do token de acesso armazenado e a disponibilidade do token de atualiza√ß√£o (se dispon√≠vel).

Voc√™ tamb√©m pode verificar as identidades de terceiros do usu√°rio e o status do armazenamento de tokens via Management API:

- `GET /api/users/{userId}/identities/{target}?includeTokenSecret=true`: Recupera a identidade social de um usu√°rio e o status do armazenamento de tokens associado √† identidade por um determinado conector (por exemplo, `github`, `google`, etc.).
- `GET /api/users/{userId}/sso-identities/{ssoConnectorId}?includeTokenSecret=true`: Recupera a identidade SSO corporativa de um usu√°rio e o status do armazenamento de tokens associado √† identidade por um determinado ID de conector SSO.

### Status do armazenamento de tokens \{#token-storage-status}

- **Ativo**: O token de acesso est√° armazenado e ativo.
- **Expirado**: O token de acesso est√° armazenado, mas expirou. Se um token de atualiza√ß√£o estiver dispon√≠vel, ele pode ser usado para obter um novo token de acesso.
- **Inativo**: Nenhum token de acesso est√° armazenado para esta conex√£o. Isso pode acontecer se o usu√°rio n√£o se autenticou por meio desta conex√£o ou se o armazenamento do token foi exclu√≠do.
- **N√£o aplic√°vel**: O conector n√£o suporta armazenamento de tokens.

### Metadados do token \{#token-metadata}

Para integridade e seguran√ßa dos dados, todos os tokens s√£o criptografados antes de serem armazenados no cofre de segredos. Os valores reais dos tokens s√≥ s√£o acess√≠veis ao usu√°rio final com a devida autoriza√ß√£o. Os desenvolvedores, por outro lado, s√≥ podem recuperar os metadados do conjunto de tokens para entender o estado dos tokens armazenados sem expor conte√∫do sens√≠vel.

- `createdAt`: O timestamp de quando a conex√£o foi estabelecida pela primeira vez e o conjunto de tokens foi inicialmente armazenado no cofre de segredos.
- `updatedAt`: A √∫ltima vez que o conjunto de tokens foi atualizado.
  - Se nenhum token de atualiza√ß√£o estiver dispon√≠vel, esse valor ser√° o mesmo que **createdAt**.
  - Se houver um token de atualiza√ß√£o, esse valor reflete a √∫ltima vez que o token de acesso foi renovado.
- `hasRefreshToken`: Indica se um token de atualiza√ß√£o est√° dispon√≠vel.
  Se o conector suportar acesso offline e a solicita√ß√£o de autoriza√ß√£o estiver devidamente configurada, o Logto armazena o token de atualiza√ß√£o quando ele √© emitido pelo provedor de identidade junto com o token de acesso.
  Quando o token de acesso expira e existe um token de atualiza√ß√£o v√°lido, o Logto tenta automaticamente obter um novo token de acesso usando o token de atualiza√ß√£o armazenado sempre que o usu√°rio solicita acesso ao provedor conectado.
- `expiresAt`: O tempo estimado de expira√ß√£o do token de acesso em **segundos**.
  Isso √© calculado com base no valor `expires_in` retornado pelo endpoint de token do provedor de identidade. (Este campo s√≥ est√° dispon√≠vel se o provedor incluir `expires_in` na resposta do token.)
- `scope`: O escopo do token de acesso, indicando as permiss√µes concedidas pelo provedor de identidade.
  Isso √© √∫til para entender quais a√ß√µes podem ser realizadas com o token de acesso armazenado. (Este campo s√≥ est√° dispon√≠vel se o provedor incluir `scope` na resposta do token.)
- `tokenType`: O tipo do token de acesso, normalmente "Bearer".
  (Este campo s√≥ est√° dispon√≠vel se o provedor incluir `token_type` na resposta do token.)

## Recupera√ß√£o de tokens \{#token-retrieval}

Uma vez que o armazenamento de tokens esteja habilitado e os tokens estejam armazenados com seguran√ßa no cofre de segredos do Logto, os usu√°rios finais podem recuperar seus tokens de acesso de terceiros a partir do seu aplicativo cliente integrando com a [Account API](/end-user-flows/account-settings/by-account-api) do Logto.

- `GET /my-account/identities/:target/access-token`: Recupera o token de acesso para uma identidade social especificando o conector (por exemplo, github, google).

- `GET /my-account/sso-identities/:connectorId/access-token`: Recupera o token de acesso para uma identidade SSO corporativa especificando o ID do conector.

:::info
Saiba como [habilitar](/end-user-flows/account-settings/by-account-api#how-to-enable-account-api) e [acessar](/end-user-flows/account-settings/by-account-api#access-account-api-using-access-token) a Account API usando o token de acesso emitido pelo Logto.
:::

### Rota√ß√£o de tokens \{#token-rotation}

Os endpoints de recupera√ß√£o de tokens retornam:

- `200` OK: Se o token de acesso for recuperado com sucesso e ainda estiver v√°lido.
- `404` N√£o encontrado: Se o usu√°rio n√£o tiver uma identidade social ou SSO corporativa associada ao conector especificado, ou se o token de acesso n√£o estiver armazenado.
- `401` N√£o autorizado: Se o token de acesso estiver expirado.

Se o token de acesso estiver expirado e um token de atualiza√ß√£o estiver dispon√≠vel, o Logto tentar√° automaticamente renovar o token de acesso e retornar√° o novo token de acesso na resposta. O armazenamento do token no cofre de segredos tamb√©m ser√° atualizado com o novo token de acesso e seus metadados.

## Exclus√£o do armazenamento de tokens \{#token-storage-deletion}

O armazenamento de tokens de terceiros est√° diretamente vinculado a cada conex√£o social ou SSO corporativa do usu√°rio. Isso significa que o conjunto de tokens armazenado ser√° automaticamente exclu√≠do nos seguintes casos:

- A identidade social ou SSO corporativa associada √© removida da conta do usu√°rio.
- A conta do usu√°rio √© exclu√≠da do seu tenant.
- O conector social ou SSO corporativo √© exclu√≠do do seu tenant.

### Revogando tokens \{#revoking-tokens}

Voc√™ tamb√©m pode excluir manualmente o conjunto de tokens de terceiros de um usu√°rio para revogar o acesso:

- Pelo Console:
  Navegue at√© a p√°gina de detalhes da identidade do usu√°rio. Role at√© a se√ß√£o **Token de acesso** (se o armazenamento de tokens estiver dispon√≠vel) e clique no bot√£o **Excluir tokens** ao final da se√ß√£o.
- Via Management API:
  - `DELETE /api/secret/:id`: Exclui um segredo espec√≠fico pelo seu ID, que pode ser obtido nos detalhes da identidade do usu√°rio.

Revogar o conjunto de tokens for√ßar√° o usu√°rio a se autenticar novamente com o provedor de terceiros para obter um novo token de acesso antes de poder acessar as APIs de terceiros novamente.

## Reautentica√ß√£o e renova√ß√£o de tokens \{#reauthentication-and-token-renewal}

Em cen√°rios onde um token de acesso armazenado expirou ou quando um aplicativo precisa solicitar escopos adicionais de API, os usu√°rios finais podem se reautenticar com o provedor de terceiros para obter um novo token de acesso‚Äîsem precisar fazer login novamente no Logto.
Isso pode ser feito atrav√©s da [Social Verification API](https://openapi.logto.io/operation/operation-createverificationbysocial) do Logto, que permite aos usu√°rios reiniciar um fluxo de autoriza√ß√£o social federada e atualizar seu conjunto de tokens armazenado.

:::note
A reinicializa√ß√£o da autoriza√ß√£o federada est√° atualmente limitada a conectores sociais.
Para conectores SSO corporativos, a reautentica√ß√£o e renova√ß√£o de tokens exigem que o usu√°rio inicie novamente todo o fluxo de autentica√ß√£o do Logto, pois a reautoriza√ß√£o direta com o provedor SSO corporativo n√£o √© suportada ap√≥s o login.
:::

```mermaid
sequenceDiagram
    autonumber

    participant User as Usu√°rio
    participant Logto as Logto
    participant Provider as Provedor de terceiros

    User->>Logto: post /api/verification/social
    Logto->>User: Redirecionar para o provedor de terceiros
    User->>Provider: Autenticar e autorizar
    Provider->>User: Redirecionar de volta com c√≥digo de autoriza√ß√£o
    User->>Logto: post /api/verification/social/verify com c√≥digo de autoriza√ß√£o
    Logto->>User: Retornar o ID de verifica√ß√£o social
    User->>Logto: patch /my-account/identities/:target/access-token
```

1. O usu√°rio inicia uma solicita√ß√£o de verifica√ß√£o social chamando o endpoint `POST /api/verification/social`. O usu√°rio pode especificar escopos personalizados para solicitar permiss√µes adicionais ao provedor de terceiros.

   ```sh
   curl -X POST https://<your-logto-domain>/api/verification/social \
     -H "Authorization: Bearer <access_token>" \
     -H "Content-Type: application/json" \
     -d '{
       "state": "<state>",
       "connectorId": "<logto_connectorId>",
       "redirectUri": "<redirect_uri>",
       "scope": "<custom_scope>"
     }'
   ```

   - **authorization header**: O token de acesso do usu√°rio emitido pelo Logto.
   - **connectorId**: O ID do conector social no Logto.
   - **redirectUri**: O URI para redirecionar o usu√°rio de volta ao seu aplicativo ap√≥s a autentica√ß√£o. Voc√™ precisar√° registrar esse URI nas configura√ß√µes do aplicativo do provedor.
   - **scope**: (Opcional) Escopos personalizados para solicitar permiss√µes adicionais ao provedor de terceiros. Se n√£o especificado, os escopos padr√£o configurados no conector ser√£o usados.

2. O Logto cria um novo registro de verifica√ß√£o social e retorna o ID de verifica√ß√£o social junto com a URL de autoriza√ß√£o para redirecionar o usu√°rio ao provedor de terceiros para autentica√ß√£o.

   A resposta ser√° semelhante a:

   ```json
   {
     "verificationRecordId": "<social_verification_id>",
     "authorizationUri": "<authorization_url>",
     "expiresAt": "<expiration_time>"
   }
   ```

3. Redirecione o usu√°rio para a URL de autoriza√ß√£o. O usu√°rio se autentica com o provedor de terceiros e concede permiss√µes.

4. O provedor de terceiros redireciona o usu√°rio de volta ao seu aplicativo cliente com um c√≥digo de autoriza√ß√£o.

5. Trate o callback de autoriza√ß√£o encaminhando o c√≥digo de autoriza√ß√£o para o endpoint de verifica√ß√£o do Logto:

   ```sh
   curl -X POST https://<your-logto-domain>/api/verification/social/verify \
     -H "Authorization: Bearer <access_token>" \
     -d '{
       "verificationRecordId": "<social_verification_id>",
       "connectorData": {
         "code": "<authorization_code>",
         "state": "<state>",
         "redirectUri": "<redirect_uri>"
       }
     }'
   ```

   - **authorization header**: O token de acesso do usu√°rio emitido pelo Logto.
   - **verificationRecordId**: O ID de verifica√ß√£o social retornado na etapa anterior.
   - **connectorData**: O c√≥digo de autoriza√ß√£o e quaisquer outros dados retornados pelo provedor de terceiros durante o callback.

   :::note
   N√£o se esque√ßa de validar o par√¢metro `state` para evitar ataques CSRF.
   :::

6. O Logto verifica o c√≥digo de autoriza√ß√£o e o troca por um novo token de acesso e token de atualiza√ß√£o do provedor de terceiros, retornando o ID de verifica√ß√£o social na resposta.

7. Por fim, atualize o armazenamento de tokens do usu√°rio chamando o endpoint `PATCH /my-account/identities/:target/access-token` com o ID de verifica√ß√£o social:

   ```sh
   curl -X PATCH https://<your-logto-domain>/my-account/identities/<target>/access-token \
     -H "Authorization: Bearer <access_token>" \
     -H "Content-Type: application/json" \
     -d '{
       "socialVerificationId": "<social_verification_id>"
     }'
   ```

   - **authorization header**: O token de acesso do usu√°rio emitido pelo Logto.
   - **socialVerificationId**: O ID do registro de verifica√ß√£o social retornado na etapa anterior.

   Isso atualizar√° o armazenamento do conjunto de tokens do usu√°rio no cofre de segredos do Logto com o novo token de acesso e token de atualiza√ß√£o, permitindo que o usu√°rio acesse APIs de terceiros sem precisar fazer login novamente no Logto.

   O token de acesso atualizado ser√° retornado.
