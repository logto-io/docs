---
sidebar_position: 4
sidebar_label: Conecte seu agente a APIs de terceiros
---

# Conecte seu agente de IA a APIs de terceiros

Este guia mostra como habilitar seu agente de IA para acessar APIs de terceiros (por exemplo, Google Calendar, GitHub, etc.) em nome dos usu√°rios. Aproveitando os conectores sociais do Logto e o Cofre de Segredos (Secret Vault), voc√™ pode armazenar e gerenciar tokens de acesso com seguran√ßa, permitindo que seu agente execute tarefas automatizadas sem solicitar repetidamente que os usu√°rios se autentiquem novamente.

Voc√™ aprender√° como:

- Configurar conectores sociais com armazenamento de tokens de terceiros.
- Solicitar permiss√µes m√≠nimas durante o login inicial.
- Solicitar permiss√µes adicionais progressivamente conforme necess√°rio.
- Recuperar e usar tokens armazenados para acessar APIs de terceiros.

## Por que seu agente de IA precisa de acesso a APIs de terceiros \{#why-your-ai-agent-needs-third-party-api-access}

Agentes de IA est√£o sendo cada vez mais usados para automatizar tarefas que exigem intera√ß√£o com servi√ßos externos. Por exemplo:

- **üìÖ Gerenciamento de calend√°rio**: Seu agente de IA pode agendar reuni√µes automaticamente, adicionar eventos ou ajustar compromissos no Google Calendar.
- **üìß Automa√ß√£o de e-mails**: Envie e-mails de acompanhamento, organize caixas de entrada ou redija respostas usando as APIs do Gmail.
- **üíª Gerenciamento de c√≥digo**: Crie issues no GitHub, revise pull requests ou gerencie reposit√≥rios.
- **üìÅ Gerenciamento de arquivos**: Fa√ßa upload, organize ou compartilhe arquivos no Google Drive ou Dropbox.

Para executar essas tarefas, seu agente de IA precisa de acesso seguro √†s APIs de terceiros autorizadas pelo usu√°rio, o que significa lidar corretamente e com seguran√ßa com tokens OAuth.

## Como funciona \{#how-it-works}

Aqui est√° uma vis√£o geral r√°pida do fluxo:

```mermaid
sequenceDiagram
    participant User as Usu√°rio
    participant Agent as Seu agente de IA
    participant Logto
    participant Google as Provedor de terceiros<br/>(ex: Google)

    rect rgba(200, 230, 200, 0.5)
        Note over User, Google: Usu√°rio concede permiss√µes ao provedor de terceiros
        User->>Agent: "Adicione uma reuni√£o ao meu calend√°rio amanh√£ √†s 15h"
        Agent->>User: Precisa de acesso ao Google Calendar, por favor autorize
        User->>Agent: Iniciar autoriza√ß√£o do Google
        Agent->>Logto: Iniciar verifica√ß√£o social
        Logto->>Google: Redirecionar para o Google
        User->>Google: Autenticar e conceder permiss√µes
        Google->>Logto: Retornar c√≥digo de autoriza√ß√£o
        Logto->>Google: Trocar c√≥digo por tokens
        Logto->>Logto: Armazenar tokens no Cofre de Segredos
        Logto->>Agent: Retornar resultado da verifica√ß√£o
    end

    rect rgba(200, 200, 230, 0.5)
        Note over User, Google: Execu√ß√£o da tarefa pelo agente de IA
        Agent->>Logto: Recuperar token de acesso do Google
        Logto->>Agent: Retornar token de acesso
        Agent->>Google: Chamar API do Google Calendar
        Google->>Agent: Retornar sucesso
        Agent->>User: "Pronto! Adicionei a reuni√£o ao seu calend√°rio."
    end
```

1. **Usu√°rio solicita uma tarefa**: O usu√°rio pede ao agente de IA para executar uma tarefa que exige acesso a uma API de terceiros (por exemplo, adicionar um evento ao calend√°rio).
2. **Solicita√ß√£o de autoriza√ß√£o**: O agente detecta a necessidade de acesso de terceiros e solicita autoriza√ß√£o ao usu√°rio.
3. **Tokens armazenados**: Ap√≥s a autoriza√ß√£o do usu√°rio, o Logto armazena com seguran√ßa os tokens de acesso e atualiza√ß√£o no Cofre de Segredos.
4. **Execu√ß√£o da tarefa**: O agente recupera o token armazenado e chama a API de terceiros para concluir a tarefa.

Uma vez autorizado, o usu√°rio pode realizar v√°rias tarefas sem precisar autorizar novamente. O Logto armazena os tokens com seguran√ßa e os atualiza automaticamente quando necess√°rio, proporcionando uma experi√™ncia cont√≠nua para as intera√ß√µes do agente de IA.

## Pr√©-requisitos \{#prerequisites}

Antes de come√ßar, certifique-se de ter:

- Um tenant do [Logto Cloud](https://cloud.logto.io) (ou Logto self-hosted v1.31+)
- Uma conta de provedor de terceiros com acesso √† API (por exemplo, [Google Cloud Console](https://console.cloud.google.com))
- Um aplicativo de agente de IA integrado ao Logto SDK (os usu√°rios podem fazer login no seu agente de IA)

## Configure o conector social com armazenamento de tokens \{#set-up-social-connector-with-token-storage}

Para permitir que seu agente de IA acesse APIs de terceiros, voc√™ precisa configurar um conector social com armazenamento de tokens ativado. Isso permite que o Logto armazene e gerencie tokens de acesso quando os usu√°rios autorizam servi√ßos de terceiros durante a intera√ß√£o com seu agente de IA.

Vamos usar o Google como exemplo:

1. Navegue at√© <CloudLink to="/connectors/social">Console > Conectores > Conectores sociais</CloudLink>.
2. Clique em **Adicionar conector social** e selecione **Google**.
3. Siga o [guia de configura√ß√£o do conector Google](/integrations/google) para configurar suas credenciais OAuth.
4. Nas configura√ß√µes do conector:
   - Ative **Armazenar tokens para acesso persistente √† API** para armazenar tokens no Cofre de Segredos.
   - Defina **Prompts** para incluir `consent` para garantir que os usu√°rios vejam a solicita√ß√£o de permiss√£o.
   - Ative **Acesso offline** para receber tokens de atualiza√ß√£o para acesso prolongado √† API.
5. Salve suas altera√ß√µes.

:::info
Voc√™ n√£o precisa adicionar este conector √† sua experi√™ncia de login. O conector ser√° usado para autoriza√ß√£o sob demanda quando seu agente de IA precisar acessar APIs de terceiros, n√£o para login do usu√°rio.
:::

## Solicite autoriza√ß√£o e acesse APIs de terceiros \{#request-authorization-and-access-third-party-apis}

Quando seu agente de IA precisar acessar uma API de terceiros (por exemplo, Google Calendar), ele deve primeiro verificar se o usu√°rio j√° autorizou o acesso. Caso contr√°rio, solicite a autoriza√ß√£o do usu√°rio.

:::info Ative o Account API
Antes de prosseguir, ative o Account API em <CloudLink to="/sign-in-experience/account-center">Console > Experi√™ncia de login > Central da conta</CloudLink>. Saiba mais sobre [como ativar o Account API](/end-user-flows/account-settings/by-account-api#how-to-enable-account-api).
:::

### Passo 1: Verifique se j√° existe autoriza√ß√£o \{#step-1-check-for-existing-authorization}

Primeiro, tente recuperar o token de acesso armazenado para ver se o usu√°rio j√° autorizou:

```tsx
async function getGoogleAccessToken(userAccessToken: string) {
  const response = await fetch(
    'https://[tenant-id].logto.app/my-account/identities/google/access-token',
    {
      headers: {
        Authorization: `Bearer ${userAccessToken}`,
      },
    }
  );

  return response.json();
}
```

### Passo 2: Solicite autoriza√ß√£o se necess√°rio \{#step-2-request-authorization-if-needed}

Se n√£o existir token, o token expirou ou voc√™ precisa ampliar o escopo do token de acesso, use a [API de Verifica√ß√£o Social](/secret-vault/federated-token-set#reauthentication-and-token-renewal) do Logto para iniciar o fluxo de autoriza√ß√£o:

```tsx
async function requestGoogleAuthorization(userAccessToken: string, scopes: string) {
  // Gere um estado aleat√≥rio para prote√ß√£o CSRF
  const state = crypto.randomUUID();
  sessionStorage.setItem('oauth_state', state);

  // Inicie a verifica√ß√£o social
  const response = await fetch('https://[tenant-id].logto.app/api/verification/social', {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${userAccessToken}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      connectorId: '<google_connector_id>',
      state,
      redirectUri: 'https://your-ai-agent.com/callback',
      scope: scopes,
    }),
  });

  const { verificationRecordId, authorizationUri } = await response.json();

  // Armazene verificationRecordId para uso posterior
  sessionStorage.setItem('verificationRecordId', verificationRecordId);

  // Redirecione o usu√°rio para o Google para autoriza√ß√£o
  window.location.href = authorizationUri;
}
```

### Passo 3: Trate o callback de autoriza√ß√£o \{#step-3-handle-the-authorization-callback}

Ap√≥s o usu√°rio conceder permiss√µes, o Google redireciona de volta para seu app. Complete a verifica√ß√£o e armazene os tokens:

```tsx
async function handleAuthorizationCallback(
  userAccessToken: string,
  callbackParams: URLSearchParams
) {
  const verificationRecordId = sessionStorage.getItem('verificationRecordId');
  const storedState = sessionStorage.getItem('oauth_state');
  const code = callbackParams.get('code');
  const state = callbackParams.get('state');

  // Valide o estado para evitar ataques CSRF
  if (state !== storedState) {
    throw new Error('Par√¢metro de estado inv√°lido');
  }

  // Verifique a autoriza√ß√£o
  await fetch('https://[tenant-id].logto.app/api/verification/social/verify', {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${userAccessToken}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      verificationRecordId,
      connectorData: {
        code,
        state,
        redirectUri: 'https://your-ai-agent.com/callback',
      },
    }),
  });

  // Armazene os tokens no Cofre de Segredos do Logto
  await fetch('https://[tenant-id].logto.app/my-account/identities/google/access-token', {
    method: 'PUT',
    headers: {
      Authorization: `Bearer ${userAccessToken}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      verificationRecordId,
    }),
  });

  // Limpeza
  sessionStorage.removeItem('verificationRecordId');
  sessionStorage.removeItem('oauth_state');
}
```

### Passo 4: Chame a API de terceiros \{#step-4-call-the-third-party-api}

Agora seu agente de IA pode recuperar o token e chamar a API:

```tsx
async function addCalendarEvent(userAccessToken: string, eventDetails: EventDetails) {
  // Obtenha o token de acesso do Google armazenado
  const tokenData = await getGoogleAccessToken(userAccessToken);

  if (!tokenData) {
    // Usu√°rio n√£o autorizou, solicite autoriza√ß√£o com escopo de calend√°rio
    await requestGoogleAuthorization(
      userAccessToken,
      'https://www.googleapis.com/auth/calendar.events'
    );
    return; // Continuar√° ap√≥s o redirecionamento
  }

  // Chame a API do Google Calendar
  const response = await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${tokenData.accessToken}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(eventDetails),
  });

  return response.json();
}
```

O Logto lida com a atualiza√ß√£o do token automaticamente. Se o token de acesso estiver expirado, mas existir um token de atualiza√ß√£o, o Logto obter√° um novo token de acesso de forma transparente ao chamar o endpoint de recupera√ß√£o.

## Solicite permiss√µes adicionais \{#request-additional-permissions}

√Ä medida que seu agente de IA assume mais tarefas, pode ser necess√°rio solicitar permiss√µes adicionais. Por exemplo, se o usu√°rio inicialmente autorizou apenas acesso de leitura ao calend√°rio, mas agora deseja criar eventos, voc√™ precisar√° de permiss√µes de escrita.

### Por que autoriza√ß√£o incremental? \{#why-incremental-authorization}

- **Melhor experi√™ncia do usu√°rio**: Os usu√°rios t√™m mais probabilidade de conceder permiss√µes quando entendem por que s√£o necess√°rias no contexto.
- **Taxas de convers√£o mais altas**: Menos permiss√µes iniciais significam menos atrito.
- **Constru√ß√£o de confian√ßa**: Usu√°rios confiam em aplicativos que pedem apenas o que realmente precisam.

### Exemplo: Atualizando de leitura para escrita \{#example-upgrading-from-read-to-write-access}

```tsx
async function createCalendarEvent(userAccessToken: string, eventDetails: EventDetails) {
  const tokenData = await getGoogleAccessToken(userAccessToken);

  if (!tokenData) {
    // Ainda n√£o autorizado, solicite permiss√£o de escrita no calend√°rio diretamente
    await requestGoogleAuthorization(userAccessToken, 'https://www.googleapis.com/auth/calendar');
    return;
  }

  // Tente criar o evento
  const response = await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${tokenData.accessToken}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(eventDetails),
  });

  if (response.status === 403) {
    // Permiss√µes insuficientes, solicite escopo adicional
    await requestGoogleAuthorization(
      userAccessToken,
      'https://www.googleapis.com/auth/calendar' // Acesso total ao calend√°rio
    );
    return;
  }

  return response.json();
}
```

:::tip
Ao solicitar escopos adicionais, o usu√°rio ver√° uma tela de consentimento mostrando apenas as novas permiss√µes solicitadas. As permiss√µes j√° concedidas ser√£o preservadas.
:::

## Gerencie o status dos tokens \{#manage-token-status}

O Console do Logto fornece visibilidade sobre o status dos tokens de cada usu√°rio:

1. Navegue at√© <CloudLink to="/users">Console > Gerenciamento de usu√°rios</CloudLink>.
2. Clique em um usu√°rio para ver seus detalhes.
3. Role at√© a se√ß√£o **Conex√µes** para ver todas as contas sociais vinculadas.
4. Cada conex√£o mostra o status do token:
   - **Ativo**: O token de acesso √© v√°lido e pronto para uso.
   - **Expirado**: O token de acesso expirou. Se existir um token de atualiza√ß√£o, ele ser√° renovado automaticamente na pr√≥xima recupera√ß√£o.
   - **Inativo**: N√£o h√° tokens armazenados para esta conex√£o.

## Melhores pr√°ticas de seguran√ßa \{#security-best-practices}

Ao construir agentes de IA que acessam APIs de terceiros, mantenha estas pr√°ticas de seguran√ßa em mente:

- **Solicite escopos m√≠nimos**: Solicite apenas as permiss√µes que seu agente realmente precisa.
- **Use autoriza√ß√£o incremental**: Solicite permiss√µes adicionais no contexto, n√£o todas de uma vez.
- **Trate a expira√ß√£o dos tokens de forma adequada**: Sempre trate casos em que os tokens possam estar expirados ou revogados.
- **Proteja os tokens de acesso do usu√°rio**: O token de acesso do Logto do usu√°rio √© a chave para recuperar tokens de terceiros. Proteja-o adequadamente.
- **Audite o acesso √† API**: Registre quando seu agente de IA acessa APIs de terceiros para solu√ß√£o de problemas e conformidade.

## Recursos relacionados \{#related-resources}

<Url href="/secret-vault/federated-token-set">Armazenamento de tokens de terceiros</Url>
<Url href="/connectors/social-connectors">Conectores sociais</Url>
<Url href="/end-user-flows/sign-up-and-sign-in/social-sign-in">Login social</Url>
<Url href="/end-user-flows/account-settings/by-account-api">Account API</Url>
