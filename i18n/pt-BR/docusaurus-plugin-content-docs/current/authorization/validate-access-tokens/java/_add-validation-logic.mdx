import TabItem from '@theme/TabItem';
import Tabs from '@theme/Tabs';

Usamos diferentes bibliotecas JWT dependendo do framework. Instale as dependências necessárias:

<Tabs groupId="api-framework">
  <TabItem value="spring-boot" label="Spring Boot">

Adicione ao seu `pom.xml`:

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.security</groupId>
    <artifactId>spring-security-oauth2-resource-server</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.security</groupId>
    <artifactId>spring-security-oauth2-jose</artifactId>
</dependency>
```

  </TabItem>
  <TabItem value="quarkus" label="Quarkus">

Adicione ao seu `pom.xml`:

```xml
<dependency>
    <groupId>io.quarkus</groupId>
    <artifactId>quarkus-smallrye-jwt</artifactId>
</dependency>
<dependency>
    <groupId>io.quarkus</groupId>
    <artifactId>quarkus-resteasy-reactive</artifactId>
</dependency>
```

  </TabItem>
  <TabItem value="micronaut" label="Micronaut">

Adicione ao seu `pom.xml`:

```xml
<dependency>
    <groupId>io.micronaut.security</groupId>
    <artifactId>micronaut-security-jwt</artifactId>
</dependency>
<dependency>
    <groupId>io.micronaut</groupId>
    <artifactId>micronaut-http-server-netty</artifactId>
</dependency>
```

  </TabItem>
  <TabItem value="vertx-web" label="Vert.x Web">

Adicione ao seu `pom.xml`:

```xml
<dependency>
    <groupId>io.vertx</groupId>
    <artifactId>vertx-web</artifactId>
</dependency>
<dependency>
    <groupId>io.vertx</groupId>
    <artifactId>vertx-auth-jwt</artifactId>
</dependency>
<dependency>
    <groupId>io.vertx</groupId>
    <artifactId>vertx-web-client</artifactId>
</dependency>
```

  </TabItem>
</Tabs>

Em seguida, implemente o middleware para verificar o token de acesso (Access token):

<Tabs groupId="api-framework">
  <TabItem value="spring-boot" label="Spring Boot">

```java title="JwtSecurityConfig.java"
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.oauth2.jwt.JwtDecoder;
import org.springframework.security.oauth2.jwt.NimbusJwtDecoder;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
@EnableWebSecurity
public class JwtSecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(authz -> authz
                .requestMatchers("/api/protected/**").authenticated()
                .anyRequest().permitAll()
            )
            .oauth2ResourceServer(oauth2 -> oauth2
                .jwt(jwt -> jwt.decoder(jwtDecoder()))
            );
        return http.build();
    }

    @Bean
    public JwtDecoder jwtDecoder() {
        return NimbusJwtDecoder.withJwkSetUri(AuthConstants.JWKS_URI)
            .build();
    }
}
```

```java title="JwtValidator.java"
import org.springframework.security.oauth2.jwt.Jwt;
import org.springframework.stereotype.Component;
import java.util.Arrays;
import java.util.List;

@Component
public class JwtValidator {

    public void verifyPayload(Jwt jwt) {
        // Implemente sua lógica de verificação aqui com base no modelo de permissão
        // Isso será mostrado na seção de modelos de permissão abaixo
    }
}
```

  </TabItem>
  <TabItem value="quarkus" label="Quarkus">

```java title="JwtVerificationFilter.java"
import org.eclipse.microprofile.jwt.JsonWebToken;
import jakarta.enterprise.context.ApplicationScoped;
import jakarta.inject.Inject;
import jakarta.ws.rs.container.ContainerRequestContext;
import jakarta.ws.rs.container.ContainerRequestFilter;
import jakarta.ws.rs.ext.Provider;

@Provider
@ApplicationScoped
public class JwtVerificationFilter implements ContainerRequestFilter {

    @Inject
    JsonWebToken jwt;

    @Override
    public void filter(ContainerRequestContext requestContext) {
        if (requestContext.getUriInfo().getPath().startsWith("/api/protected")) {
            try {
                verifyPayload(jwt);

                // Armazene o JWT no contexto para acesso nos controllers
                requestContext.setProperty("auth", jwt);

            } catch (AuthorizationException e) {
                requestContext.abortWith(
                    jakarta.ws.rs.core.Response.status(e.getStatusCode())
                        .entity("{\"error\": \"" + e.getMessage() + "\"}")
                        .build()
                );
            } catch (Exception e) {
                requestContext.abortWith(
                    jakarta.ws.rs.core.Response.status(401)
                        .entity("{\"error\": \"Invalid token\"}")
                        .build()
                );
            }
        }
    }

    private void verifyPayload(JsonWebToken jwt) {
        // Implemente sua lógica de verificação aqui com base no modelo de permissão
        // Isso será mostrado na seção de modelos de permissão abaixo
    }
}
```

  </TabItem>
  <TabItem value="micronaut" label="Micronaut">

```java title="application.yml"
micronaut:
  security:
    authentication: bearer
    token:
      jwt:
        signatures:
          jwks:
            logto:
              url: ${JWKS_URI:https://your-tenant.logto.app/oidc/jwks}
```

```java title="JwtClaimsValidator.java"
import io.micronaut.security.token.Claims;
import io.micronaut.security.token.validator.TokenValidator;
import jakarta.inject.Singleton;
import org.reactivestreams.Publisher;
import reactor.core.publisher.Mono;

@Singleton
public class JwtClaimsValidator implements TokenValidator {

    @Override
    public Publisher<Boolean> validateToken(String token, Claims claims) {
        return Mono.fromCallable(() -> {
            try {
                verifyPayload(claims);
                return true;
            } catch (AuthorizationException e) {
                throw new RuntimeException(e.getMessage());
            }
        });
    }

    private void verifyPayload(Claims claims) {
        // Implemente sua lógica de verificação aqui com base no modelo de permissão
        // Isso será mostrado na seção de modelos de permissão abaixo
    }
}
```

  </TabItem>
  <TabItem value="vertx-web" label="Vert.x Web">

```java title="JwtAuthHandler.java"
import io.vertx.core.Future;
import io.vertx.core.Handler;
import io.vertx.core.json.JsonObject;
import io.vertx.ext.auth.jwt.JWTAuth;
import io.vertx.ext.auth.jwt.JWTAuthOptions;
import io.vertx.ext.web.RoutingContext;
import io.vertx.ext.web.client.WebClient;

public class JwtAuthHandler implements Handler<RoutingContext> {

    private final JWTAuth jwtAuth;
    private final WebClient webClient;

    public JwtAuthHandler(io.vertx.core.Vertx vertx) {
        this.webClient = WebClient.create(vertx);
        this.jwtAuth = JWTAuth.create(vertx, new JWTAuthOptions());

        // Buscar JWKS e configurar JWT auth
        fetchJWKS().onSuccess(jwks -> {
            // Configurar JWKS (simplificado - talvez você precise de um parser JWKS adequado)
        });
    }

    @Override
    public void handle(RoutingContext context) {
        String authHeader = context.request().getHeader("Authorization");
        if (authHeader == null || !authHeader.startsWith("Bearer ")) {
            context.response()
                .setStatusCode(401)
                .putHeader("Content-Type", "application/json")
                .end("{\"error\": \"Authorization header missing or invalid\"}");
            return;
        }

        String token = authHeader.substring(7);
        jwtAuth.authenticate(new JsonObject().put("token", token))
            .onSuccess(user -> {
                try {
                    JsonObject principal = user.principal();
                    verifyPayload(principal);

                    // Armazene o principal do JWT no contexto para acesso nos handlers
                    context.put("auth", principal);
                    context.next();

                } catch (AuthorizationException e) {
                    context.response()
                        .setStatusCode(e.getStatusCode())
                        .putHeader("Content-Type", "application/json")
                        .end("{\"error\": \"" + e.getMessage() + "\"}");
                } catch (Exception e) {
                    context.response()
                        .setStatusCode(401)
                        .putHeader("Content-Type", "application/json")
                        .end("{\"error\": \"Invalid token\"}");
                }
            })
            .onFailure(err -> {
                context.response()
                    .setStatusCode(401)
                    .putHeader("Content-Type", "application/json")
                    .end("{\"error\": \"Invalid token\"}");
            });
    }

    private Future<JsonObject> fetchJWKS() {
        return webClient.getAbs(AuthConstants.JWKS_URI)
            .send()
            .map(response -> response.bodyAsJsonObject());
    }

    private void verifyPayload(JsonObject principal) {
        // Implemente sua lógica de verificação aqui com base no modelo de permissão
        // Isso será mostrado na seção de modelos de permissão abaixo
    }
}
```

  </TabItem>
</Tabs>

De acordo com seu modelo de permissão, você pode precisar adotar diferentes lógicas de verificação:

<Tabs groupId="permission-models">
<TabItem value="global-api-resources" label="Recursos globais de API">

<Tabs groupId="api-framework">
  <TabItem value="spring-boot" label="Spring Boot">

```java title="JwtValidator.java"
private void verifyPayload(Jwt jwt) {
    // Verifique se o claim de público (audience) corresponde ao seu indicador de recurso de API
    List<String> audiences = jwt.getAudience();
    if (!audiences.contains("https://your-api-resource-indicator")) {
        throw new AuthorizationException("Invalid audience");
    }

    // Verifique os escopos necessários para recursos globais de API
    List<String> requiredScopes = Arrays.asList("api:read", "api:write"); // Substitua pelos escopos necessários
    String scopes = jwt.getClaimAsString("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient scope");
    }
}
```

  </TabItem>
  <TabItem value="quarkus" label="Quarkus">

```java title="JwtVerificationFilter.java"
private void verifyPayload(JsonWebToken jwt) {
    // Verifique se o claim de público (audience) corresponde ao seu indicador de recurso de API
    if (!jwt.getAudience().contains("https://your-api-resource-indicator")) {
        throw new AuthorizationException("Invalid audience");
    }

    // Verifique os escopos necessários para recursos globais de API
    List<String> requiredScopes = Arrays.asList("api:read", "api:write"); // Substitua pelos escopos necessários
    String scopes = jwt.getClaim("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient scope");
    }
}
```

  </TabItem>
  <TabItem value="micronaut" label="Micronaut">

```java title="JwtClaimsValidator.java"
private void verifyPayload(Claims claims) {
    // Verifique se o claim de público (audience) corresponde ao seu indicador de recurso de API
    List<String> audiences = (List<String>) claims.get("aud");
    if (audiences == null || !audiences.contains("https://your-api-resource-indicator")) {
        throw new AuthorizationException("Invalid audience");
    }

    // Verifique os escopos necessários para recursos globais de API
    List<String> requiredScopes = Arrays.asList("api:read", "api:write"); // Substitua pelos escopos necessários
    String scopes = (String) claims.get("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient scope");
    }
}
```

  </TabItem>
  <TabItem value="vertx-web" label="Vert.x Web">

```java title="JwtAuthHandler.java"
private void verifyPayload(JsonObject principal) {
    // Verifique se o claim de público (audience) corresponde ao seu indicador de recurso de API
    JsonArray audiences = principal.getJsonArray("aud");
    if (audiences == null || !audiences.contains("https://your-api-resource-indicator")) {
        throw new AuthorizationException("Invalid audience");
    }

    // Verifique os escopos necessários para recursos globais de API
    List<String> requiredScopes = Arrays.asList("api:read", "api:write"); // Substitua pelos escopos necessários
    String scopes = principal.getString("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient scope");
    }
}
```

  </TabItem>
</Tabs>

</TabItem>
<TabItem value="organization-permissions" label="Permissões de organização (não-API)">

<Tabs groupId="api-framework">
  <TabItem value="spring-boot" label="Spring Boot">

```java title="JwtValidator.java"
private void verifyPayload(Jwt jwt) {
    // Verifique se o claim de público (audience) corresponde ao formato de organização
    List<String> audiences = jwt.getAudience();
    boolean hasOrgAudience = audiences.stream()
        .anyMatch(aud -> aud.startsWith("urn:logto:organization:"));

    if (!hasOrgAudience) {
        throw new AuthorizationException("Invalid audience for organization permissions");
    }

    // Verifique se o ID da organização corresponde ao contexto (você pode precisar extrair isso do contexto da requisição)
    String expectedOrgId = "your-organization-id"; // Extraia do contexto da requisição
    String expectedAud = "urn:logto:organization:" + expectedOrgId;
    if (!audiences.contains(expectedAud)) {
        throw new AuthorizationException("Organization ID mismatch");
    }

    // Verifique os escopos necessários da organização
    List<String> requiredScopes = Arrays.asList("invite:users", "manage:settings"); // Substitua pelos escopos necessários
    String scopes = jwt.getClaimAsString("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient organization scope");
    }
}
```

  </TabItem>
  <TabItem value="quarkus" label="Quarkus">

```java title="JwtVerificationFilter.java"
private void verifyPayload(JsonWebToken jwt) {
    // Verifique se o claim de público (audience) corresponde ao formato de organização
    boolean hasOrgAudience = jwt.getAudience().stream()
        .anyMatch(aud -> aud.startsWith("urn:logto:organization:"));

    if (!hasOrgAudience) {
        throw new AuthorizationException("Invalid audience for organization permissions");
    }

    // Verifique se o ID da organização corresponde ao contexto (você pode precisar extrair isso do contexto da requisição)
    String expectedOrgId = "your-organization-id"; // Extraia do contexto da requisição
    String expectedAud = "urn:logto:organization:" + expectedOrgId;
    if (!jwt.getAudience().contains(expectedAud)) {
        throw new AuthorizationException("Organization ID mismatch");
    }

    // Verifique os escopos necessários da organização
    List<String> requiredScopes = Arrays.asList("invite:users", "manage:settings"); // Substitua pelos escopos necessários
    String scopes = jwt.getClaim("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient organization scope");
    }
}
```

  </TabItem>
  <TabItem value="micronaut" label="Micronaut">

```java title="JwtClaimsValidator.java"
private void verifyPayload(Claims claims) {
    // Verifique se o claim de público (audience) corresponde ao formato de organização
    List<String> audiences = (List<String>) claims.get("aud");
    boolean hasOrgAudience = audiences != null && audiences.stream()
        .anyMatch(aud -> aud.startsWith("urn:logto:organization:"));

    if (!hasOrgAudience) {
        throw new AuthorizationException("Invalid audience for organization permissions");
    }

    // Verifique se o ID da organização corresponde ao contexto (você pode precisar extrair isso do contexto da requisição)
    String expectedOrgId = "your-organization-id"; // Extraia do contexto da requisição
    String expectedAud = "urn:logto:organization:" + expectedOrgId;
    if (!audiences.contains(expectedAud)) {
        throw new AuthorizationException("Organization ID mismatch");
    }

    // Verifique os escopos necessários da organização
    List<String> requiredScopes = Arrays.asList("invite:users", "manage:settings"); // Substitua pelos escopos necessários
    String scopes = (String) claims.get("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient organization scope");
    }
}
```

  </TabItem>
  <TabItem value="vertx-web" label="Vert.x Web">

```java title="JwtAuthHandler.java"
private void verifyPayload(JsonObject principal) {
    // Verifique se o claim de público (audience) corresponde ao formato de organização
    JsonArray audiences = principal.getJsonArray("aud");
    boolean hasOrgAudience = false;
    if (audiences != null) {
        for (Object aud : audiences) {
            if (aud.toString().startsWith("urn:logto:organization:")) {
                hasOrgAudience = true;
                break;
            }
        }
    }

    if (!hasOrgAudience) {
        throw new AuthorizationException("Invalid audience for organization permissions");
    }

    // Verifique se o ID da organização corresponde ao contexto (você pode precisar extrair isso do contexto da requisição)
    String expectedOrgId = "your-organization-id"; // Extraia do contexto da requisição
    String expectedAud = "urn:logto:organization:" + expectedOrgId;
    if (!audiences.contains(expectedAud)) {
        throw new AuthorizationException("Organization ID mismatch");
    }

    // Verifique os escopos necessários da organização
    List<String> requiredScopes = Arrays.asList("invite:users", "manage:settings"); // Substitua pelos escopos necessários
    String scopes = principal.getString("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient organization scope");
    }
}
```

  </TabItem>
</Tabs>

</TabItem>
<TabItem value="organization-level-api-resources" label="Recursos de API no nível da organização">

<Tabs groupId="api-framework">
  <TabItem value="spring-boot" label="Spring Boot">

```java title="JwtValidator.java"
private void verifyPayload(Jwt jwt) {
    // Verifique se o claim de público (audience) corresponde ao seu indicador de recurso de API
    List<String> audiences = jwt.getAudience();
    if (!audiences.contains("https://your-api-resource-indicator")) {
        throw new AuthorizationException("Invalid audience for organization-level API resources");
    }

    // Verifique se o ID da organização corresponde ao contexto (você pode precisar extrair isso do contexto da requisição)
    String expectedOrgId = "your-organization-id"; // Extraia do contexto da requisição
    String orgId = jwt.getClaimAsString("organization_id");
    if (!expectedOrgId.equals(orgId)) {
        throw new AuthorizationException("Organization ID mismatch");
    }

    // Verifique os escopos necessários para recursos de API no nível da organização
    List<String> requiredScopes = Arrays.asList("api:read", "api:write"); // Substitua pelos escopos necessários
    String scopes = jwt.getClaimAsString("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient organization-level API scopes");
    }
}
```

  </TabItem>
  <TabItem value="quarkus" label="Quarkus">

```java title="JwtVerificationFilter.java"
private void verifyPayload(JsonWebToken jwt) {
    // Verifique se o claim de público (audience) corresponde ao seu indicador de recurso de API
    if (!jwt.getAudience().contains("https://your-api-resource-indicator")) {
        throw new AuthorizationException("Invalid audience for organization-level API resources");
    }

    // Verifique se o ID da organização corresponde ao contexto (você pode precisar extrair isso do contexto da requisição)
    String expectedOrgId = "your-organization-id"; // Extraia do contexto da requisição
    String orgId = jwt.getClaim("organization_id");
    if (!expectedOrgId.equals(orgId)) {
        throw new AuthorizationException("Organization ID mismatch");
    }

    // Verifique os escopos necessários para recursos de API no nível da organização
    List<String> requiredScopes = Arrays.asList("api:read", "api:write"); // Substitua pelos escopos necessários
    String scopes = jwt.getClaim("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient organization-level API scopes");
    }
}
```

  </TabItem>
  <TabItem value="micronaut" label="Micronaut">

```java title="JwtClaimsValidator.java"
private void verifyPayload(Claims claims) {
    // Verifique se o claim de público (audience) corresponde ao seu indicador de recurso de API
    List<String> audiences = (List<String>) claims.get("aud");
    if (audiences == null || !audiences.contains("https://your-api-resource-indicator")) {
        throw new AuthorizationException("Invalid audience for organization-level API resources");
    }

    // Verifique se o ID da organização corresponde ao contexto (você pode precisar extrair isso do contexto da requisição)
    String expectedOrgId = "your-organization-id"; // Extraia do contexto da requisição
    String orgId = (String) claims.get("organization_id");
    if (!expectedOrgId.equals(orgId)) {
        throw new AuthorizationException("Organization ID mismatch");
    }

    // Verifique os escopos necessários para recursos de API no nível da organização
    List<String> requiredScopes = Arrays.asList("api:read", "api:write"); // Substitua pelos escopos necessários
    String scopes = (String) claims.get("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient organization-level API scopes");
    }
}
```

  </TabItem>
  <TabItem value="vertx-web" label="Vert.x Web">

```java title="JwtAuthHandler.java"
private void verifyPayload(JsonObject principal) {
    // Verifique se o claim de público (audience) corresponde ao seu indicador de recurso de API
    JsonArray audiences = principal.getJsonArray("aud");
    if (audiences == null || !audiences.contains("https://your-api-resource-indicator")) {
        throw new AuthorizationException("Invalid audience for organization-level API resources");
    }

    // Verifique se o ID da organização corresponde ao contexto (você pode precisar extrair isso do contexto da requisição)
    String expectedOrgId = "your-organization-id"; // Extraia do contexto da requisição
    String orgId = principal.getString("organization_id");
    if (!expectedOrgId.equals(orgId)) {
        throw new AuthorizationException("Organization ID mismatch");
    }

    // Verifique os escopos necessários para recursos de API no nível da organização
    List<String> requiredScopes = Arrays.asList("api:read", "api:write"); // Substitua pelos escopos necessários
    String scopes = principal.getString("scope");
    List<String> tokenScopes = scopes != null ? Arrays.asList(scopes.split(" ")) : List.of();

    if (!tokenScopes.containsAll(requiredScopes)) {
        throw new AuthorizationException("Insufficient organization-level API scopes");
    }
}
```

  </TabItem>
</Tabs>

</TabItem>
</Tabs>
