---
sidebar_position: 3
---

import illustration from '@site/docs/authorization/assets/rbac-global-api-resources.png';
import AuthorizationRequestExample from '@site/docs/authorization/fragments/AuthorizationRequestExample';
import ClientCredentialsRequestExample from '@site/docs/authorization/fragments/ClientCredentialsRequestExample';
import TokenRequestExample from '@site/docs/authorization/fragments/TokenRequestExample';
import TabItem from '@theme/TabItem';
import Tabs from '@theme/Tabs';

# Proteger recursos globais de API

export const resource = 'https://api.your-app.com';

Proteja APIs de todo o produto usando controle de acesso baseado em papel (RBAC) no Logto. Atribua pap√©is globais e permiss√µes para controlar o acesso de todos os usu√°rios e clientes em todo o seu aplicativo.

## O que s√£o recursos globais de API? \{#what-are-global-api-resources}

Recursos globais de API s√£o endpoints ou servi√ßos em seu aplicativo que s√£o acess√≠veis a todos os usu√°rios, independentemente de organiza√ß√£o ou locat√°rio. Normalmente, s√£o APIs p√∫blicas, servi√ßos centrais do produto ou qualquer endpoint que n√£o esteja vinculado a uma organiza√ß√£o espec√≠fica.

**Casos de uso incluem**

- APIs p√∫blicas ou endpoints compartilhados entre sua base de usu√°rios.
- Microsservi√ßos que n√£o est√£o atrelados √† multi-tenancy.
- APIs centrais do aplicativo (por exemplo, `/api/users`, `/api/products`) usadas por todos os clientes.

O Logto permite proteger essas APIs usando OAuth 2.1, combinado com controle de acesso flex√≠vel baseado em papel.

## Como funciona no Logto \{#how-it-works-in-logto}

- **Recursos de API e permiss√µes s√£o registrados globalmente:** Cada API que voc√™ deseja proteger √© definida com um indicador de recurso √∫nico (URI) e um conjunto de permiss√µes (escopos) que controlam o acesso.
- **O acesso √© controlado por pap√©is globais:** Voc√™ pode atribuir permiss√µes a pap√©is, que ent√£o s√£o atribu√≠dos a usu√°rios ou clientes.
- **Separado das permiss√µes em n√≠vel de organiza√ß√£o:** Recursos globais de API n√£o t√™m contexto de organiza√ß√£o. No entanto, podem ser usados em conjunto com pap√©is de organiza√ß√£o para fornecer uma camada adicional de contexto, se necess√°rio. Para proteger APIs em n√≠vel de organiza√ß√£o, veja [Proteger recursos de API em n√≠vel de organiza√ß√£o](/authorization/organization-level-api-resources).

<img src={illustration} alt="Recursos globais de API RBAC" style={{ maxWidth: '100%' }} />

### Vis√£o geral da implementa√ß√£o \{#implementation-overview}

1. **Registre seu recurso de API** e defina suas permiss√µes no Logto.
2. **Defina pap√©is** com as permiss√µes necess√°rias para acessar a API.
3. **Atribua pap√©is** a usu√°rios ou clientes.
4. **Use fluxos de autoriza√ß√£o OAuth 2.0** para obter tokens de acesso para a API (o par√¢metro resource deve corresponder ao identificador da API registrada).
5. **Valide os tokens de acesso** em sua API para aplicar as permiss√µes.

### Entendendo indicadores de recurso \{#understanding-resource-indicators}

O Logto modela recursos de API de acordo com [RFC 8707: Indicadores de Recurso para OAuth 2.0](https://www.rfc-editor.org/rfc/rfc8707.html). Um **indicador de recurso** √© um URI que identifica de forma √∫nica a API ou servi√ßo de destino solicitado.

**Pontos-chave**

- Indicadores de recurso devem ser URIs absolutos (por exemplo, `https://api.example.com`)
- Sem componente de fragmento; evite usar query strings sempre que poss√≠vel.
- Indicadores de recurso permitem tokens restritos por p√∫blico e suporte para arquiteturas multi-API.

**Exemplo**

- Management API: `https://my-tenant.logto.app/api`
- API global personalizada: `https://api.yourapp.com`

### Fluxo de autoriza√ß√£o: autenticando e protegendo sua API \{#authorization-flow-authenticating-and-securing-your-api}

O fluxo abaixo se aplica tanto √† autentica√ß√£o interativa do usu√°rio (navegador / aplicativo) quanto a cen√°rios backend m√°quina para m√°quina (M2M).

Observe que o fluxo n√£o inclui detalhes exaustivos sobre os par√¢metros ou cabe√ßalhos necess√°rios, mas foca nas etapas principais envolvidas. Continue lendo para ver como o fluxo funciona na pr√°tica.

```mermaid
sequenceDiagram
    participant Client as Cliente
    participant Logto as Logto
    participant API as Recurso de API

    alt Autentica√ß√£o do usu√°rio
        Cliente->>Logto: GET /oidc/auth
        Logto->>Logto: Redireciona usu√°rio para p√°gina de login
        Logto->>Cliente: Redireciona de volta com `authorization_code`
        alt Usar concess√£o authorization_code
            Cliente->>Logto: POST /oidc/token com `grant_type=authorization_code`<br/>e par√¢metro `resource`
        else Usar concess√£o refresh_token
            Cliente->>Logto: POST /oidc/token com `grant_type=authorization_code`
            Logto->>Cliente: Retorna refresh token
            Cliente->>Logto: POST /oidc/token com `grant_type=refresh_token`<br/>e par√¢metro `resource`
        end
    else Autentica√ß√£o cliente m√°quina para m√°quina (M2M)
        Cliente->>Logto: POST /oidc/token com `grant_type=client_credentials`<br/>e par√¢metro `resource`
    end

    Logto->>Cliente: Retorna token de acesso (JSON Web Token)
    Cliente->>Recurso de API: Requisi√ß√£o com Bearer token
    Recurso de API->>Recurso de API: Valida token de acesso

    alt Token √© v√°lido
      Recurso de API->>Cliente: Retorna dados do recurso protegido
    else Token √© inv√°lido
      Recurso de API->>Cliente: 401 N√£o autorizado
    end
```

_Autentica√ß√£o do usu√°rio = navegador / aplicativo. M2M = servi√ßo backend ou script usando credenciais de cliente._

:::note
O par√¢metro `resource` deve corresponder exatamente ao identificador da API (indicador de recurso) que voc√™ registrou no Logto.
:::

## Etapas de implementa√ß√£o \{#implementation-steps}

### Registre seus recursos de API \{#register-your-api-resources}

1. V√° para <CloudLink to="/api-resources">Console ‚Üí Recursos de API</CloudLink>.
2. Crie um novo recurso de API (por exemplo, `https://api.yourapp.com/org`) e defina suas permiss√µes (escopos).

Para etapas completas de configura√ß√£o, veja [Definir recursos de API com permiss√µes](/authorization/role-based-access-control#define-api-resources-with-permissions).

### Configure pap√©is globais \{#set-up-global-roles}

1. V√° para <CloudLink to="/roles">Console ‚Üí Pap√©is</CloudLink>.
2. Crie pap√©is que correspondam √†s permiss√µes da sua API (por exemplo, `read:products`, `write:products`).
3. Atribua esses pap√©is a usu√°rios ou clientes que precisam de acesso √† API.

Para etapas completas de configura√ß√£o, veja [Usar pap√©is globais](/authorization/role-based-access-control#configure-global-roles).

### Obtenha tokens de acesso para recursos globais de API \{#obtain-access-tokens-for-global-api-resources}

Antes de acessar um recurso global de API, seu cliente deve obter um token de acesso. O Logto emite [JSON Web Tokens (JWTs)](https://auth.wiki/jwt) como tokens de acesso para recursos globais de API. Isso normalmente √© feito usando o [fluxo de c√≥digo de autoriza√ß√£o OAuth 2.0](https://auth.wiki/authorization-code-flow), [fluxo de refresh token](https://auth.wiki/refresh-token) ou o [fluxo de client credentials](https://auth.wiki/client-credentials-flow).

#### Fluxo de c√≥digo de autoriza√ß√£o ou refresh token \{#authorization-code-or-refresh-token-flow}

Todos os SDKs oficiais do Logto suportam a obten√ß√£o de tokens de acesso para recursos globais de API usando o fluxo de refresh token nativamente. Uma biblioteca padr√£o de cliente OAuth 2.0 / OIDC tamb√©m pode ser usada para implementar esse fluxo.

<Tabs groupId="user-client">
<TabItem value="logto-sdk" label="Logto SDK">

Ao inicializar o cliente Logto, adicione o indicador de recurso ao par√¢metro `resources` (array), depois adicione as permiss√µes desejadas (escopos) ao par√¢metro `scopes`.

Uma vez que o usu√°rio esteja autenticado, passe o indicador de recurso no par√¢metro `resource` ou par√¢metro de nome similar ao solicitar o token de acesso (por exemplo, ao chamar `getAccessToken()`).

Para detalhes sobre cada SDK, veja os [Comece r√°pido](/quick-starts).

</TabItem>
<TabItem value="oauth-client" label="OAuth 2.0 / OIDC client library">

Ao configurar seu cliente OAuth 2.0 ou inicializar o fluxo de c√≥digo de autoriza√ß√£o, certifique-se de incluir o par√¢metro `resource` e os escopos desejados na solicita√ß√£o de autoriza√ß√£o.

Algumas bibliotecas podem n√£o suportar o par√¢metro `resource` nativamente, mas geralmente permitem passar par√¢metros adicionais na solicita√ß√£o de autoriza√ß√£o. Verifique a documenta√ß√£o da sua biblioteca para detalhes.

Aqui est√° um exemplo n√£o normativo da solicita√ß√£o de autoriza√ß√£o com os par√¢metros `resource` e `scope`:

<AuthorizationRequestExample resource={resource} scope="read:products write:products" />

Uma vez que o usu√°rio esteja autenticado, voc√™ receber√° um c√≥digo de autoriza√ß√£o. Troque esse c√≥digo por um token de acesso fazendo uma requisi√ß√£o POST para o endpoint `/oidc/token` do Logto, incluindo o par√¢metro `resource` no corpo da requisi√ß√£o.

Aqui est√° um exemplo n√£o normativo da solicita√ß√£o de token usando o tipo de concess√£o authorization code:

<TokenRequestExample grantType="authorization_code" resource={resource} />

Voc√™ tamb√©m pode usar o tipo de concess√£o `refresh_token` para obter um novo token de acesso sem intera√ß√£o do usu√°rio, desde que o par√¢metro `resource` seja inclu√≠do na requisi√ß√£o.

Aqui est√° um exemplo n√£o normativo da solicita√ß√£o de token usando o tipo de concess√£o refresh token:

<TokenRequestExample grantType="refresh_token" resource={resource} />

</TabItem>
</Tabs>

#### Fluxo de client credentials \{#client-credentials-flow}

Para cen√°rios m√°quina para m√°quina (M2M), voc√™ pode usar o fluxo de client credentials para obter um token de acesso para seu recurso global de API. Fazendo uma requisi√ß√£o POST para o endpoint `/oidc/token` do Logto, voc√™ pode solicitar um token de acesso usando seu client ID e secret.

H√° dois par√¢metros principais a serem inclu√≠dos na requisi√ß√£o:

- `resource`: O URI indicador de recurso da API que voc√™ deseja acessar (por exemplo, `https://api.yourapp.com`).
- `scope`: As permiss√µes que voc√™ deseja solicitar para a API (por exemplo, `read:products write:products`).

Aqui est√° um exemplo n√£o normativo da solicita√ß√£o de token usando o tipo de concess√£o client credentials:

<ClientCredentialsRequestExample
  resource="https://api.yourapp.com"
  scope="read:products write:products"
/>

### Validando tokens de acesso JWT em sua API \{#validating-jwt-access-tokens-in-your-api}

Os JWTs emitidos pelo Logto cont√™m reivindica√ß√µes que sua API pode usar para aplicar autoriza√ß√£o.

Quando sua API recebe uma requisi√ß√£o com um token de acesso emitido pelo Logto, voc√™ deve:

- Verificar a assinatura do token (usando os JWKs do Logto).
- Confirmar que o token n√£o est√° expirado (reivindica√ß√£o `exp`).
- Verificar se o `iss` (emissor) corresponde ao endpoint do seu Logto.
- Garantir que o `aud` (p√∫blico) corresponde ao identificador do recurso de API que voc√™ registrou (por exemplo, `https://api.yourapp.com`).
- Separar a reivindica√ß√£o `scope` (separada por espa√ßo) e verificar as permiss√µes necess√°rias.

Para guias passo a passo e espec√≠ficos por linguagem, veja [Como validar tokens de acesso](/authorization/validate-access-tokens).

### Opcional: Lidar com altera√ß√£o de permiss√£o do usu√°rio \{#optional-handle-user-permission-change}

:::info
üë∑ Trabalho em andamento. üöß
:::

## Boas pr√°ticas e dicas de seguran√ßa \{#best-practices-and-security-tips}

- **Mantenha as permiss√µes orientadas ao neg√≥cio:** Use nomes claros que correspondam a a√ß√µes reais.
- **Mantenha a expira√ß√£o do token curta:** Reduz o risco caso um token seja vazado.
- **Limite os escopos concedidos:** D√™ aos tokens apenas as permiss√µes realmente necess√°rias.
- **Use restri√ß√£o de p√∫blico:** Sempre verifique a reivindica√ß√£o `aud` para evitar uso indevido.

## Perguntas frequentes \{#faqs}

<details>
<summary>

### E se meu cliente n√£o suportar o par√¢metro resource? \{#what-if-my-client-doesn-t-support-the-resource-parameter}

</summary>

Defina um recurso de API padr√£o no Console do Logto. Os tokens ter√£o esse p√∫blico por padr√£o quando nenhum par√¢metro resource for especificado na solicita√ß√£o de token.

</details>

<details>
<summary>

### Por que recebo 401 N√£o autorizado da minha API? \{#why-do-i-get-401-unauthorized-from-my-api}

</summary>

Verifique os seguintes problemas comuns:

- **Assinatura do token**: Verifique se seu backend est√° buscando os JWKs corretos do Logto
- **Expira√ß√£o do token**: Certifique-se de que o token n√£o expirou (reivindica√ß√£o `exp`)
- **P√∫blico**: Confirme se a reivindica√ß√£o `aud` corresponde ao indicador de recurso de API registrado
- **Escopos necess√°rios**: Verifique se o token cont√©m as permiss√µes necess√°rias na reivindica√ß√£o `scope`

</details>

<details>
<summary>

### Como testar sem um cliente completo? \{#how-do-i-test-without-a-full-client}

</summary>

Use um [token de acesso pessoal](/user-management/personal-access-token) para simular chamadas autenticadas. Isso permite testar seus endpoints de API sem implementar um fluxo OAuth completo em seu aplicativo cliente.

</details>

## Leitura adicional \{#further-reading}

<Url href="/authorization/validate-access-tokens">Como validar tokens de acesso</Url>
<Url href="/use-cases/authorization/rbac-in-practice">
  RBAC na pr√°tica: Implementando autoriza√ß√£o segura para seu aplicativo
</Url>
<Url href="/developers/custom-token-claims">Personalizando reivindica√ß√µes de token</Url>
<Url href="https://www.rfc-editor.org/rfc/rfc8707.html">RFC 8707: Indicadores de Recurso</Url>
