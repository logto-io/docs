import redirectUriFigure from '../../assets/ios-redirect-uri.png';
import Checkpoint from '../../fragments/_checkpoint-test-your-application.md';
import ConfigureRedirectUri from '../../fragments/_configure-redirect-uri.mdx';
import SignInFlowSummary from '../../fragments/_web-sign-in-flow-summary.mdx';

### 初始化 LogtoClient

导入 `logto_dart_sdk` 包，并在应用程序的根部初始化 `LogtoClient` 实例。

```dart title="lib/main.dart"
import 'package:logto_dart_sdk/logto_dart_sdk.dart';
import 'package:http/http.dart' as http;

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  runApp(const MyApp());
}

class MyApp extends StatelessWidget {
  const MyApp({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return const MaterialApp(
      title: 'Flutter Demo',
      home: MyHomePage(title: 'Logto Demo Home Page'),
    );
  }
}

class MyHomePage extends StatefulWidget {
  const MyHomePage({Key? key, required this.title}) : super(key: key);
  final String title;

  @override
  State<MyHomePage> createState() => _MyHomePageState();
}

class _MyHomePageState extends State<MyHomePage> {
  late LogtoClient logtoClient;

  void render() {
    // 状态变化
  }

  // highlight-start
  // LogtoConfig
  final logtoConfig = const LogtoConfig(
    endpoint: "<your-logto-endpoint>",
    appId: "<your-app-id>"
  );

  void _init() {
    logtoClient = LogtoClient(
      config: logtoConfig,
      httpClient: http.Client(), // 可选的 http 客户端
    );
    render();
  }
  // highlight-end

  @override
  void initState() {
    super.initState();
    _init();
  }

  // ...
}
```

### 实现登录

<SignInFlowSummary />

在开始之前，你需要在管理控制台中为你的应用程序添加一个重定向 URI。

<ConfigureRedirectUri figureSrc={redirectUriFigure} redirectUri="io.logto://callback" />

- 对于 iOS，重定向 URI 方案并不重要，因为 `ASWebAuthenticationSession` 类会监听重定向 URI，无论它是否已注册。
- 对于 Android，重定向 URI 方案必须在 `AndroidManifest.xml` 文件中注册。

配置重定向 URI 后，我们在页面上添加一个登录按钮，该按钮将调用 `logtoClient.signIn` API 来启动 Logto 登录流程：

```dart title="lib/main.dart"
class _MyHomePageState extends State<MyHomePage> {
  // ...
  final redirectUri = 'io.logto://callback';

  @override
  Widget build(BuildContext context) {
    // ...

    Widget signInButton = TextButton(
      onPressed: () async {
        // highlight-start
        await logtoClient.signIn(redirectUri);
        render();
        // highlight-end
      },
      child: const Text('Sign In'),
    );

    return Scaffold(
      appBar: AppBar(
        title: Text(widget.title),
      ),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: <Widget>[
            SelectableText('My Demo App'),
            signInButton,
          ],
        ),
      ),
    );
  }
}
```

### 实现登出

现在让我们在主页上添加一个登出按钮，以便用户可以从你的应用程序中登出。

```dart title="lib/main.dart"
class _MyHomePageState extends State<MyHomePage> {
  // ...

  @override
  Widget build(BuildContext context) {
    // ...

    Widget signOutButton = TextButton(
      onPressed: () async {
        // highlight-start
        await logtoClient.signOut();
        render();
        // highlight-end
      },
      child: const Text('Sign Out'),
    );

    return Scaffold(
      appBar: AppBar(
        title: Text(widget.title),
      ),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: <Widget>[
            SelectableText('My Demo App'),
            signInButton,
            signOutButton,
          ],
        ),
      ),
    );
  }
}
```

### 处理认证状态

Logto SDK 提供了一个异步方法来检查认证状态。该方法是 `logtoClient.isAuthenticated`。如果用户已认证，该方法返回布尔值 `true`，否则返回 `false`。

在示例中，我们根据认证状态有条件地渲染登录和登出按钮。现在让我们更新 Widget 中的 `render` 方法来处理状态变化：

```dart title="lib/main.dart"
class _MyHomePageState extends State<MyHomePage> {
  // ...
  bool? isAuthenticated = false;

  void render() {
    setState(() async {
      // highlight-start
      isAuthenticated = await logtoClient.isAuthenticated;
      // highlight-end
    });
  }

  @override
  Widget build(BuildContext context) {
    // ...

    return Scaffold(
      appBar: AppBar(
        title: Text(widget.title),
      ),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: <Widget>[
            SelectableText('My Demo App'),
            isAuthenticated == true ? signOutButton : signInButton,
          ],
        ),
      ),
    );
  }
}
```

<Checkpoint />
