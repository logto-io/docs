---
sidebar_position: 1
---

# 用户数据结构

用户是身份服务中的核心实体。在 Logto 中，用户包含基于 [OpenID Connect](https://auth.wiki/openid-connect) 协议的基础认证 (Authentication) 数据，以及自定义数据。

## 用户资料 \{#user-profile}

每个用户都有一个包含[所有用户信息](#property-reference)的资料。

它由以下类型的数据组成：

- [基础数据](/user-management/user-data#basic-data)：来自用户资料的基本信息。它存储除了社交 `identities` 和 `custom_data` 之外的所有 _用户_ 属性，如用户 id、用户名、邮箱、手机号以及用户上次登录时间等。
- [社交身份](/user-management/user-data#social-identities)：存储通过社交登录（即使用社交连接器登录）获取的用户信息，如 Facebook、GitHub 和微信。
- [自定义数据](/user-management/user-data#custom-data)：存储未在预定义用户属性中列出的额外用户信息，如用户偏好的颜色和语言。

以下是通过 Facebook 登录获取的用户数据示例：

```json
{
  "id": "iHXPuSb9eMzt",
  "username": null,
  "primaryEmail": null,
  "primaryPhone": null,
  "name": "John Doe",
  "avatar": "https://example.com/avatar.png",
  "customData": {
    "preferences": {
      "language": "en",
      "color": "#f236c9"
    }
  },
  "identities": {
    "facebook": {
      "userId": "106077000000000",
      "details": {
        "id": "106077000000000",
        "name": "John Doe",
        "email": "johndoe@logto.io",
        "avatar": "https://example.com/avatar.png"
      }
    }
  },
  "lastSignInAt": 1655799453171,
  "applicationId": "admin_console"
}
```

你可以通过 <CloudLink to="/users">Logto 控制台</CloudLink> 或 Logto Management API 查询用户资料，例如 [`GET /api/users/:userId`](https://openapi.logto.io/operation/operation-getuser)。

## 基础数据 \{#basic-data}

让我们逐一了解用户 _基础数据_ 中的所有属性。

### id \{#id}

_id_ 是在 Logto 中用于唯一标识用户的自动生成主键。

### username \{#username}

_username_ 用于通过 _用户名_ 和密码登录。

其值来源于用户首次注册时填写的用户名。它可能为 `null`。非空值最长不超过 128 个字符，只能包含字母、数字和下划线（`_`），且不能以数字开头。区分大小写。

### primary_email \{#primary_email}

_primary_email_ 是用户的邮箱地址，用于通过邮箱和密码 / 验证码登录。

其值通常来源于用户首次注册时填写的邮箱地址。它可能为 `null`。最大长度为 128。

只有来自社交或企业单点登录 (SSO) 身份提供商的已验证邮箱地址才能同步并保存为 `primary_email`。

### primary_phone \{#primary_phone}

_primary_phone_ 是用户的手机号，用于通过手机号和密码 / 短信验证码登录。

其值通常来源于用户首次注册时填写的手机号。它可能为 `null`。非空值应包含以[国家区号](https://en.wikipedia.org/wiki/List_of_country_calling_codes)（不含加号 `+`）开头的数字。

只有来自社交或企业单点登录 (SSO) 身份提供商的已验证手机号才能同步并保存为 `primary_phone`。

### name \{#name}

_name_ 是用户的全名。最大长度为 128。

### avatar \{#avatar}

_avatar_ 是指向用户头像图片的 URL。最大长度为 2048。

如果用户通过 Google、Facebook 等社交连接器注册，其值可能会从社交用户信息中获取。

:::note

此属性映射到 [OpenID Connect](https://openid.net/connect/) 标准中的 `picture` 声明 (Claim)。

:::

### profile \{#profile}

_profile_ 存储了 OpenID Connect [标准声明 (Claims)](https://openid.net/specs/openid-connect-core-1_0.html#StandardClaims) 中未包含在用户属性中的额外信息。

其类型定义可在[此文件](https://github.com/logto-io/logto/blob/HEAD/packages/schemas/src/foundations/jsonb-types/users.ts#L6)中找到。以下是类型定义的副本：

```tsx
type UserProfile = Partial<{
  familyName: string;
  givenName: string;
  middleName: string;
  nickname: string;
  preferredUsername: string;
  profile: string;
  website: string;
  gender: string;
  birthdate: string;
  zoneinfo: string;
  locale: string;
  address: Partial<{
    formatted: string;
    streetAddress: string;
    locality: string;
    region: string;
    postalCode: string;
    country: string;
  }>;
}>;
```

:::note

`Partial` 表示所有属性都是可选的。

:::

与其他标准声明 (Claims) 不同的是，`profile` 中的属性只有在值不为空时，才会包含在 [ID 令牌 (ID token)](https://auth.wiki/id-token) 或 userinfo 端点响应中，而其他标准声明 (Claims) 的值为空时会返回 `null`。

### application_id \{#application_id}

_application_id_ 的值来源于用户首次登录的应用程序。它可能为 `null`。

### last_sign_in_at \{#last_sign_in_at}

_last_sign_in_at_ 是用户上次登录时的带时区时间戳。

### created_at \{#created_at}

_created_at_ 是用户注册账号时的带时区时间戳。

### updated_at \{#updated_at}

_updated_at_ 是用户资料信息最后一次更新时的带时区时间戳。

### has_password \{#has_password}

_has_password_ 是一个布尔值，表示用户是否设置了密码。你可以在 <CloudLink to="/users">控制台 > 用户管理</CloudLink> 的详情页查看和管理此状态，包括设置新密码或重置密码。

### password_encrypted \{#password_encrypted}

_password_encrypted_ 用于存储用户的加密密码。

其值来源于用户首次注册时填写的密码。它可能为 `null`。如果非空，原始内容（加密前）至少为六个字符。

### password_encryption_method \{#password_encryption_method}

_password_encryption_method_ 用于加密用户密码。其值在用户通过用户名和密码注册时初始化。它可能为 `null`。

Logto 默认使用 [Argon2](https://en.wikipedia.org/wiki/Argon2) 的实现 [node-argon2](https://github.com/ranisalt/node-argon2) 作为加密方法；如有兴趣可参考文档了解详情。

以下是密码为 `123456` 的用户的 _password_encrypted_ 和 _password_encryption_method_ 示例：

```json
{
  "password_encryption_method": "Argon2i",
  "password_encrypted": "$argon2i$v=19$m=4096,t=10,p=1$aZzrqpSX45DOo+9uEW6XVw$O4MdirF0mtuWWWz68eyNAt2u1FzzV3m3g00oIxmEr0U"
}
```

### is_suspended \{#is_suspended}

_is_suspended_ 是一个布尔值，表示用户是否被停用。你可以通过调用 [Logto Management API](https://openapi.logto.io/operation/operation-updateuserissuspended) 或使用 Logto 控制台进行管理。

一旦用户被停用，已授予的刷新令牌 (Refresh tokens) 会立即被吊销，用户将无法再通过 Logto 进行认证 (Authentication)。

### mfa_verification_factors \{#mfa_verification_factors}

_mfa_verification_factors_ 是一个数组，列出了与用户账户关联的[多因素认证 (MFA)](/end-user-flows/mfa)方式。可能的值包括：_Totp_（身份验证器应用 OTP）、_WebAuthn_（Passkey）、_BackupCode_。

```tsx
mfaVerificationFactors: ("Totp" | "WebAuthn" | "BackupCode")[];
```

## 社交身份 \{#social-identities}

_identities_ 包含通过[社交登录](/end-user-flows/sign-up-and-sign-in/social-sign-in)（即使用[社交连接器](/connectors/social-connectors)登录）获取的用户信息。每个用户的 _identities_ 都存储在独立的 JSON 对象中。

用户信息因社交身份提供商（即社交网络平台）而异，通常包括以下内容：

- 身份提供商的 _target_，如 "facebook" 或 "google"
- 用户在该提供商下的唯一标识
- 用户姓名
- 用户已验证邮箱
- 用户头像

用户账户可以通过社交登录关联多个社交身份提供商；从这些提供商获取的对应用户信息会存储在 _identities_ 对象中。

以下是同时通过 Google 和 Facebook 登录的用户的 _identities_ 示例：

```json
{
  "facebook": {
    "userId": "5110888888888888",
    "details": {
      "id": "5110888888888888",
      "name": "John Doe",
      "email": "johndoe@logto.io",
      "avatar": "https://example.com/avatar.png"
    }
  },
  "google": {
    "userId": "111000000000000000000",
    "details": {
      "id": "111000000000000000000",
      "name": "John Doe",
      "email": "johndoe@gmail.com",
      "avatar": "https://example.com/avatar.png"
    }
  }
}
```

## SSO 身份 \{#sso-identities}

_sso_identities_ 包含通过[企业单点登录 (SSO)](/end-user-flows/enterprise-sso)（即使用企业连接器进行单点登录](/connectors/enterprise-connectors)）获取的用户信息。每个用户的 _ssoIdentities_ 都存储在独立的 JSON 对象中。

从 SSO 身份提供商同步的数据取决于企业连接器中配置的 scopes。以下是 TypeScript 类型定义：

```ts
type SSOIdentity = {
  issuer: string;
  identityId: string;
  detail: JsonObject; // 参见 https://github.com/withtyped/withtyped/blob/master/packages/server/src/types.ts#L12
};
```

## 自定义数据 \{#custom-data}

_custom_data_ 存储未在预定义用户属性中列出的额外用户信息。

你可以使用 _custom_data_ 做以下事情：

- 记录用户是否完成了特定操作，如是否已查看欢迎页。
- 在用户资料中存储应用特定的数据，如用户在每个应用中的偏好语言和外观。
- 维护与用户相关的其他任意数据。

以下是 Logto 管理员用户的 _custom_data_ 示例：

```json
{
  "adminConsolePreferences": {
    "language": "en",
    "appearanceMode": "system",
    "experienceNoticeConfirmed": true
  },
  "customDataFoo": {
    "foo": "foo"
  },
  "customDataBar": {
    "bar": "bar"
  }
}
```

每个用户的 _custom_data_ 都存储在独立的 JSON 对象中。

:::note

不要在 _custom_data_ 中存放敏感数据。

:::

自定义数据可通过[自定义 JWT 令牌声明 (Claims)](/developers/custom-token-claims)在用户登录后访问，而 JWT 令牌是 base64 编码（非加密）且经常在网络中传输，任何敏感数据都容易被泄露。

你也可以通过 [Management API](https://openapi.logto.io/operation/operation-listusercustomdata) 获取包含 _custom_data_ 的用户资料，并将其发送到前端应用或外部后端服务。因此，将敏感信息放入 _custom_data_ 可能导致数据泄露。

如果你仍然需要将敏感信息放入 _custom_data_，建议先加密。只在可信方（如你的后端服务）进行加解密，避免在前端应用中处理。这样可以最大程度减少用户 _custom_data_ 被误泄露时的损失。

**如何收集和更新用户自定义数据**

- 使用[收集用户资料](/end-user-flows/collect-user-profile)功能，在用户注册时收集自定义数据。
- 使用 [Account API](/end-user-flows/account-settings/by-account-api) 实现终端用户资料或账户设置。
  - 使用 [`GET /api/my-account`](https://openapi.logto.io/operation/operation-getprofile) 获取所有用户数据。
  - 使用 [`PATCH /api/my-account`](https://openapi.logto.io/operation/operation-updateprofile) 更新用户的 _custom_data_。
- 使用 [Management API](/user-management/manage-users/#manage-via-logto-management-api) 进行用户管理或高级自定义流程：
  - 使用 [`GET /api/users/{userId}`](https://openapi.logto.io/operation/operation-getuser) 获取所有用户数据。
  - 使用 [`PATCH /api/users/{userId}/custom-data`](https://openapi.logto.io/operation/operation-updateusercustomdata) 更新用户的 _custom_data_。
- 你的支持团队可以直接在 <CloudLink to="/users">控制台 > 用户管理</CloudLink> 中更新用户 _custom_data_。了解更多[查看和更新用户资料](/user-management/manage-users/#view-and-update-the-user-profile)。

请谨慎更新。更新用户的 _custom_data_ 会完全覆盖存储中的原始内容。

例如，如果你调用更新 _custom_data_ API 时输入如下（假设原始 _custom_data_ 如前所示）：

```json
{
  "customDataBaz": {
    "baz": "baz"
  }
}
```

那么更新后的 _custom_data_ 值应为：

```json
{
  "customDataBaz": {
    "baz": "baz"
  }
}
```

也就是说，更新后的字段值与之前的值无关。

## 属性参考 \{#property-reference}

以下数据库用户表字段（除 _password_encrypted_ 和 _password_encryption_method_ 外）在用户资料中可见，这意味着你可以通过 [Management API](https://openapi.logto.io/operation/operation-getuser) 查询它们。

| 名称                                                                                | 类型      | 描述                     | 唯一 | 必填 |
| ----------------------------------------------------------------------------------- | --------- | ------------------------ | ---- | ---- |
| [id](/user-management/user-data#id)                                                 | string    | 唯一标识符               | ✅   | ✅   |
| [username](/user-management/user-data#username)                                     | string    | 登录用户名               | ✅   | ❌   |
| [primary_email](/user-management/user-data#primary_email)                           | string    | 主邮箱                   | ✅   | ❌   |
| [primary_phone](/user-management/user-data#primary_phone)                           | string    | 主手机号                 | ✅   | ❌   |
| [name](/user-management/user-data#name)                                             | string    | 全名                     | ❌   | ❌   |
| [avatar](/user-management/user-data#avatar)                                         | string    | 用户头像图片的 URL       | ❌   | ❌   |
| [profile](/user-management/user-data#profile)                                       | object    | 用户资料                 | ❌   | ✅   |
| [identities](/user-management/user-data#social-identities)                          | object    | 社交登录获取的用户信息   | ❌   | ✅   |
| [custom_data](/user-management/user-data#custom-data)                               | object    | 可自定义属性中的附加信息 | ❌   | ✅   |
| [application_id](/user-management/user-data#application_id)                         | string    | 用户首次注册的应用 ID    | ❌   | ✅   |
| [last_sign_in_at](/user-management/user-data#last_sign_in_at)                       | date time | 用户上次登录的时间戳     | ❌   | ✅   |
| [password_encrypted](/user-management/user-data#password_encrypted)                 | string    | 加密密码                 | ❌   | ❌   |
| [password_encryption_method](/user-management/user-data#password_encryption_method) | string    | 密码加密方法             | ❌   | ❌   |
| [is_suspended](/user-management/user-data#is_suspended)                             | bool      | 用户停用标记             | ❌   | ✅   |
| [mfa_verifications](/user-management/user-data#mfa_verification_factors)            | object[]  | MFA 验证因子             | ❌   | ✅   |

- **唯一**：确保数据库表属性值的[唯一性](https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-UNIQUE-CONSTRAINTS)。
- **必填**：确保数据库表属性值不能为 `null`。

## 相关资源 \{#related-resources}

<Url href="https://blog.logto.io/secure-hub-for-user-data/">用户数据流动的安全枢纽</Url>
