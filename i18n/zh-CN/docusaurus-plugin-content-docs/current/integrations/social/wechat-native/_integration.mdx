## 在微信开放平台创建移动应用 \{#create-a-mobile-app-in-the-wechat-open-platform}

:::tip

如果你已经完成了部分步骤，可以跳过相关章节。

:::

### 创建账号 \{#create-an-account}

打开 https://open.weixin.qq.com/，点击右上角的“注册”按钮，然后完成注册流程。

### 创建移动应用 \{#create-a-mobile-app}

使用你刚刚创建的账号登录。在“移动应用”标签页，点击绿色大按钮“创建移动应用”。

<img src="/img/assets/app-tabs.png" alt="App tabs" />

让我们在应用表单中填写所需信息。

<img src="/img/assets/create-mobile-app.png" alt="Create mobile app" />

#### 基本信息 \{#basic-info}

大部分内容都很直观，这里有一些小提示：

- 如果你只是想测试微信登录，且应用还未上架 App Store，在“应用已上架”部分选择“否”，即可跳过“应用下载链接”。
- “应用操作流程图”看起来有点棘手。根据我们的经验，你需要准备一个简单的流程图和几张应用截图，以提高审核通过的可能性。

点击“下一步”继续。

#### 平台信息 \{#platform-info}

你可以配置 iOS 和 / 或 Android 平台，以便将 Logto 与微信原生登录集成。

**iOS 应用**

勾选“iOS 应用”，然后根据你的应用选择目标设备类型。

<img src="/img/assets/platform.png" alt="App platform" />

如果你在 App Store 上架情况选择了“否”，这里可以跳过填写“AppStore 下载地址”。

填写 _Bundle ID_、_测试版 Bundle ID_ 和 _Universal Links_（实际上只需要一个链接 😂）。

:::note

_Bundle ID_ 和 _测试版 Bundle ID_ 可以填写相同的值。

:::

:::tip

微信原生登录要求配置 universal link。如果你还没有设置或不了解 universal link，请参考 [Apple 官方文档](https://developer.apple.com/ios/universal-links/)。

:::

**Android 应用**

勾选“Android 应用”。

<img src="/img/assets/platform-android-app.png" alt="Android app platform" />

填写 _应用签名_ 和 _应用包名_。

:::note

你需要为你的应用签名以获取签名信息。详情请参考 [签署你的应用](https://developer.android.com/studio/publish/app-signing)。

:::

签名完成后，你可以执行 `signingReport` 任务来获取签名信息。

```bash
./gradlew your-android-project:signingReport
```

对应构建变体报告中的 `MD5` 值即为 _应用签名_，但记得去掉所有分号并转为小写。

例如：`1A:2B:3C:4D` -> `1a2b3c4d`。

#### 等待审核结果 \{#waiting-for-the-review-result}

完成平台信息后，点击“提交审核”继续。通常审核速度较快，一般 1-2 天内会有结果。

我们猜测每次提交分配的审核员是随机的，因为标准有波动。你可能第一次会被拒绝，但不要灰心！如实说明你的现状，并向审核员询问如何修改。

## 在你的应用中启用微信原生登录 \{#enable-wechat-native-sign-in-in-your-app}

### iOS \{#ios}

我们假设你已经在应用中集成了 <MainSiteUrl href="/quick-starts/swift">Logto iOS SDK</MainSiteUrl>。在这种情况下，操作非常简单，甚至无需阅读微信 SDK 文档：

**1. 在 Xcode 项目中配置 universal link 和 URL scheme**

在 Xcode 项目 -> Signing & Capabilities 标签页，添加“Associated Domains”能力，并填写你之前配置的 universal link。

<img src="/img/assets/universal-link.png" alt="Universal link" />

然后进入“Info”标签页，添加一个 [自定义 URL scheme](https://developer.apple.com/documentation/xcode/defining-a-custom-url-scheme-for-your-app)，内容为微信 App ID。

<img src="/img/assets/custom-url-scheme.png" alt="Custom URL scheme" />

最后打开你的 `Info.plist`，在 `LSApplicationQueriesSchemes` 下添加 `weixinULAPI` 和 `weixin`。

<img src="/img/assets/plist.png" alt="Plist" />

:::note

我们知道这些操作看起来不太合理，但这是我们找到的最小可行方案。更多信息请参考 [神奇的官方指南](https://developers.weixin.qq.com/doc/oplatform/en/Mobile_App/Access_Guide/iOS.html)。

:::

**2. 将 `LogtoSocialPluginWechat` 添加到你的 Xcode 项目**

添加该 framework：

<img src="/img/assets/add-framework.png" alt="Add framework" />

并在 Build Settings > Linking > Other Linker Flags 中添加 `-ObjC`：

<img src="/img/assets/linker-flags.png" alt="Linker flags" />

:::note

该插件内置了 WeChat Open SDK 1.9.2。导入插件后可以直接使用 `import WechatOpenSDK`。

:::

**3. 在 `LogtoClient` 初始化选项中添加插件**

```swift
let logtoClient = LogtoClient(
  useConfig: config,
  socialPlugins: [LogtoSocialPluginWechat()]
)
```

**4. 正确处理 `onOpenURL`**

:::note

`LogtoClient.handle(url:)` 会处理你启用的所有原生连接器。你只需调用一次即可。

:::

```swift
// SwiftUI
YourRootView()
  .onOpenURL { url in
      LogtoClient.handle(url: url)
  }

// 或 AppDelegate
func application(_ app: UIApplication, open url: URL, options: /*...*/) -> Bool {
  LogtoClient.handle(url: url)
}
```

### Android \{#android}

我们假设你已经在应用中集成了 <MainSiteUrl href="/quick-starts/android">Logto Android SDK</MainSiteUrl>。在这种情况下，操作非常简单，甚至无需阅读微信 SDK 文档：

**1. 将 `Wechat Open SDK` 添加到你的项目**

确保你的 Gradle 项目仓库中包含 `mavenCentral()`：

```kotlin
repositories {
  // ...
  mavenCentral()
}
```

在依赖中添加 Wechat Open SDK：

```kotlin
dependencies {
  // ...
  api("com.tencent.mm.opensdk:wechat-sdk-android:6.8.0")  // kotlin-script
  // 或
  api 'com.tencent.mm.opensdk:wechat-sdk-android:6.8.0'   // groovy-script
}
```

**2. 在项目中引入 `WXEntryActivity`**

在你的包根目录下创建 `wxapi` 包，并在该包下添加 `WXEntryActivity`（以 `com.sample.app` 为例）：

```kotlin
// WXEntryActivity.kt
package com.sample.app.wxapi

import io.logto.sdk.android.auth.social.wechat.WechatSocialResultActivity

class WXEntryActivity: WechatSocialResultActivity()
```

```java
// WXEntryActivity.java
package com.sample.app.wxapi

import io.logto.sdk.android.auth.social.wechat.WechatSocialResultActivity

public class WXEntryActivity extends WechatSocialResultActivity {}
```

最终 `WXEntryActivity` 在项目中的位置应如下（以 Kotlin 为例）：

```bash
src/main/kotlin/com/sample/app/wxapi/WXEntryActivity.kt
```

**3. 修改 `AndroidManifest.xml`**

在你的 `AndroidManifest.xml` 中添加如下内容：

```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
  package="com.sample.app">

  <application>
    <!-- 需要添加的行 -->
    <activity android:name=".wxapi.WXEntryActivity" android:exported="true"/>
  </application>

</manifest>
```
