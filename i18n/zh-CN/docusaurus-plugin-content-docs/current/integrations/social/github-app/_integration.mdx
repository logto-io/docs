## 步骤 1：创建一个 GitHub App \{#step-1-create-a-github-app}

在你可以将 GitHub 作为认证 (Authentication) 提供商之前，必须在 GitHub 上创建一个 GitHub App 以获取 OAuth 2.0 凭据。

1. 前往 [GitHub](https://github.com/) 并使用你的账户登录，或根据需要创建一个新账户。
2. 导航到 [Settings > Developer settings > GitHub Apps](https://github.com/settings/apps)。
3. 点击 **New GitHub App** 注册一个新应用：
   - **GitHub App name**：输入你的应用的唯一名称。名称不能超过 34 个字符，并且在 GitHub 上必须唯一。
   - **Homepage URL**：输入你的应用主页 URL。
   - **Callback URL**：从你的 Logto GitHub 连接器复制 **Callback URI** 并粘贴到此处。如有需要，你可以添加多个回调 URL。用户通过 GitHub 登录后，将被重定向到这里，并携带 Logto 用于完成认证 (Authentication) 的授权码。
   - **Expire user authorization tokens**：保持此项**勾选**（推荐）。这将启用令牌过期和刷新令牌 (Refresh token)，提升安全性。
   - **Request user authorization (OAuth) during installation**：可选勾选此项，以便在安装期间提示用户授权你的应用。
   - **Webhook**：如果你不需要 webhook 事件，请取消勾选 **Active**。仅用于认证 (Authentication) 的场景通常不需要 webhook。
4. 在 **Permissions** 下，配置你的应用所需的权限（详见下方步骤 2）。
5. 在 **Where can this GitHub App be installed?** 下，选择 **Any account**，如果你希望任何 GitHub 账户的用户都能用你的应用进行认证 (Authentication)。
6. 点击 **Create GitHub App** 创建 GitHub App。

:::note
与 OAuth Apps 不同，GitHub Apps 使用细粒度权限而不是广泛的权限 (Scope)。你需要在 GitHub 控制台创建应用时配置权限，用户在授权时会授予对特定仓库的访问权限。

关于设置 GitHub Apps 的更多细节，请参阅 [注册 GitHub App](https://docs.github.com/en/apps/creating-github-apps/registering-a-github-app/registering-a-github-app)。
:::

## 步骤 2：在 GitHub 中配置权限 \{#step-2-configure-permissions-in-github}

GitHub Apps 使用细粒度权限而不是 OAuth 权限 (Scope)。你必须在**GitHub 控制台**创建或编辑 GitHub App 时配置权限。这些权限决定了你的应用可以访问哪些数据。

### 理解 GitHub App 权限 \{#understanding-github-app-permissions}

权限分为三类：

- **仓库权限**：访问仓库级资源（代码、议题、拉取请求等）
- **组织 (Organization) 权限**：访问组织级资源（成员、团队、项目等）
- **账户权限**：访问用户账户数据（邮箱、资料、关注者等）

对于每个权限，你可以选择：

- **No access**：应用无法访问该资源
- **Read-only**：应用只能读取该资源，不能修改
- **Read & write**：应用可以读取和修改该资源

### 认证 (Authentication) 推荐权限 \{#recommended-permissions-for-authentication}

对于基础的“使用 GitHub 登录”功能，配置以下最小**账户权限**：

| 权限                | 访问级别 | 用途                         |
| ------------------- | -------- | ---------------------------- |
| **Email addresses** | 只读     | 获取用户邮箱地址用于账户创建 |

:::tip
GitHub Apps 在代表用户操作时默认可以读取公开资料信息。你无需显式请求用户名、头像和公开资料 URL 等基础资料权限。
:::

### 访问 API 的额外权限 \{#additional-permissions-for-api-access}

如果你的应用需要在认证 (Authentication) 之外访问 GitHub API，请在 GitHub 控制台添加相应权限。以下是一些常见示例：

| 权限类型                | 权限          | 访问级别    | 用例说明                       |
| ----------------------- | ------------- | ----------- | ------------------------------ |
| **仓库**                | Contents      | 只读 / 读写 | 访问仓库文件和代码             |
| **仓库**                | Issues        | 读写        | 创建和管理议题                 |
| **仓库**                | Pull requests | 读写        | 创建和管理拉取请求             |
| **仓库**                | Metadata      | 只读        | 访问仓库元数据（许多操作所需） |
| **组织 (Organization)** | Members       | 只读        | 列出组织成员                   |
| **账户**                | Followers     | 只读        | 访问用户的关注者和关注列表     |

这不是完整列表——GitHub Apps 支持更多细粒度权限。完整列表请参阅 [GitHub Apps 所需权限](https://docs.github.com/en/rest/overview/permissions-required-for-github-apps)。

:::tip[与 OAuth Apps 的关键区别]
与在 Logto 连接器中配置权限 (Scope) 的 OAuth Apps 不同，GitHub App 权限完全在 GitHub 控制台管理。你可以在 Logto GitHub 连接器中将 `Scope` 字段留空——因为 GitHub Apps 不使用传统的 OAuth 权限 (Scope)。

只需在 GitHub 配置所需权限，用户在授权时会被提示授予访问权限。
:::

## 步骤 3：配置你的 Logto 连接器 \{#step-3-configure-your-logto-connector}

创建 GitHub App 后，你会被重定向到其设置页面，在这里可以获取凭据。

1. 在 GitHub App 的设置页面，复制 **Client ID** 并粘贴到 Logto 的 `clientId` 字段。
2. 在 **Client secrets** 下，点击 **Generate a new client secret**。复制生成的密钥并粘贴到 Logto 的 `clientSecret` 字段。
3. 在 Logto 中点击 **Save and Done**，将你的身份系统与 GitHub 连接。

:::warning
请妥善保管你的 Client secret，切勿在客户端代码中暴露。如果丢失，GitHub 的 client secret 无法找回——你需要生成新的密钥。
:::

:::note
GitHub App 的 Client ID 与 App ID 不同。请确保使用设置页面显示的 Client ID（标注为“Client ID”），而不是 App ID。
:::

## 步骤 4：常规设置 \{#step-4-general-settings}

以下是一些不会阻止与 GitHub 连接但可能影响终端用户认证 (Authentication) 体验的常规设置。

### 同步资料信息 \{#sync-profile-information}

在 GitHub 连接器中，你可以配置如何将 GitHub 用户信息同步到 Logto 用户资料，包括 `name`、`avatar` 和 `email`。可选项如下：

- **仅在注册时同步**：用户首次登录时拉取一次资料信息。
- **每次登录时同步**：每次用户登录时都会更新资料信息。

### 存储令牌以访问 GitHub API（可选） \{#store-tokens-to-access-github-apis-optional}

如果你希望访问 GitHub API 并以用户授权身份执行操作（无论是社交登录还是账户绑定），请在 Logto 启用令牌存储：

1. 在 GitHub App 设置中配置所需权限（见步骤 2）。
2. 在 Logto GitHub 连接器中启用 **Store tokens for persistent API access**。Logto 会将访问令牌 (Access token) 和刷新令牌 (Refresh token) 安全存储在 Secret Vault 中。

:::note
由于 GitHub Apps 总是签发刷新令牌 (Refresh token)，Logto 会自动存储两种令牌。访问令牌 (Access token) 有效期为 8 小时，但 Logto 可使用刷新令牌 (Refresh token) 获取新的访问令牌，确保最长 6 个月的 API 不间断访问。
:::

## 步骤 5：测试你的集成（可选） \{#step-5-test-your-integration-optional}

在正式上线前，测试你的 GitHub App 集成：

1. 在 Logto 开发租户中使用该连接器。
2. 验证用户是否可以通过 GitHub 登录。
3. 检查用户在授权时是否被正确提示所需权限。
4. 如果启用了令牌存储，验证访问令牌 (Access token)（和刷新令牌 (Refresh token)）是否正确存储。
5. 使用存储的令牌测试 API 调用，确保权限按预期工作。

GitHub Apps 可立即与任何 GitHub 用户账户配合使用——不像某些平台那样需要测试用户或应用审核。但如果你的应用安装在组织 (Organization) 上，组织所有者可能需要批准安装。
