# Logto SDK Convention

This document demonstrates functionalities provided by Logto SDK and the convention between various languages and platforms.

## Repo Design Strategy

- Every programming language should have an isolated git repository named `${language}`.
- Each programming language repository should be a mono repo.
- Both SDKs and their associated sample projects should be placed under this repository.

Examples:

- JS

  - js (core)
  - react
  - react-sample

- Kotlin
  - kotlin (core)
  - android
  - android-sample

## Core

### Basic Conventions

- The core should contain platform-independent functions only.
- The core should be named as `{$language}` and under the repository root directory. E.g., `logto/js/js`, `logto/kotlin/kotlin`.
- The core package should be named as `{$language}` under Logto scope. E.g., `@logto/js`, `io.logto.sdk:kotlin`.

### Basic Requirements

Any core SDK should contain:

- Types
- Utility functions
- Core functions

#### Types

##### OidcConfigResponse

The configuration of the identity provider, which can be retrieved via `/oidc/.well-known/openid-configuration` API.

###### Properties

| Name                  | Type     |
| --------------------- | -------- |
| authorizationEndpoint | `string` |
| tokenEndpoint         | `string` |
| endSessionEndpoint    | `string` |
| revocationEndpoint    | `string` |
| jwksUri               | `string` |
| issuer                | `string` |

##### CodeTokenResponse

The response data of `/oidc/token` (by authorization code).

###### Properties

| Name         | Type     | Required |
| ------------ | -------- | -------- |
| accessToken  | `string` | ✅       |
| refreshToken | `string` |          |
| idToken      | `string` | ✅       |
| scope        | `string` | ✅       |
| expiresIn    | `number` | ✅       |

##### RefreshTokenTokenResponse

The response data of `/oidc/token` (by refresh token) when refreshing tokens by a refresh token.

###### Properties

| Name         | Type     | Required |
| ------------ | -------- | -------- |
| accessToken  | `string` | ✅       |
| refreshToken | `string` | ✅       |
| idToken      | `string` |          |
| scope        | `string` | ✅       |
| expiresIn    | `number` | ✅       |

##### IdTokenClaims

Claims carried by the id token.

###### Properties

| Name      | Type       | Required |
| --------- | ---------- | -------- |
| sub       | `string`   | ✅       |
| aud       | `string`   | ✅       |
| exp       | `number`   | ✅       |
| iat       | `number`   | ✅       |
| iss       | `string`   | ✅       |
| atHash    | `string`   |          |
| username  | `string`   |          |
| name      | `string`   |          |
| avatar    | `string`   |          |
| roleNames | `string[]` |          |

#### Utility Functions

##### generateCodeVerifier

Generate a code verifier.
The length of the code verifier is hardcoded as 64.
The return value MUST be encrypted to an URL-safe base64 format string.

###### Reference

- [PKCE](https://oauth.net/2/pkce/)

###### Parameters

None.

###### Return Type

`string`

##### generateCodeChallenge

Generate a code challenge based on a code verifier.
This method encrypts the code verifier and returns the result in a URL-safe Base64 format.
We hardcode the encryption algorithm as `SHA-256` in Logto V1.

###### Reference

- [PKCE](https://oauth.net/2/pkce/)

###### Parameters

| Name         | Type     | Notes                                                      |
| ------------ | -------- | ---------------------------------------------------------- |
| codeVerifier | `string` | Generated by [generateCodeVerifier](#generatecodeverifier) |

###### Return Type

`string`

##### generateState

"State" is used to prevent the CSRF attack.
The length of the "state" is hardcoded as 64.
The result string to be returned MUST be encrypted to an URL-safe base64 format string.

###### Reference

- [CSRF](https://datatracker.ietf.org/doc/html/rfc6749#section-10.12)

###### Parameters

None.

###### Return Type

`string`

##### decodeIdToken

Decode an ID Token without secret verification.
Return an [IdTokenClaims](#IdTokenClaims) which carries all the token claims in the payload section.

###### Parameters

| Name  | Type     |
| ----- | -------- |
| token | `string` |

###### Return Type

[`IdTokenClaims`](#IdTokenClaims)

###### Throws

- the `token` is not a valid JWT.

##### verifyIdToken

Verify if an ID Token is legal.

###### Verify Signing Key

OIDC supported the JSON Web Key Set.
This function accepts a `JsonWebKeySet` object from a 3rd-party library (jose) for verification.

```json
// JsonWebKeySet example
{
  "keys": [
    {
      "kty": "RSA",
      "use": "sig",
      "kid": "xxxx",
      "e": "xxxx",
      "n": "xxxx"
    }
  ]
}
```

###### Verify Claims

- Verify the `iss` in the ID Token matches the issuer of this token.
- Verify the `aud` (audience) Claim is equal to the client ID.
- Verify that the current time is before the expiry time.
- Verify that the issued at time (`iat`) is not more than +/- 1 minute on the current time.

###### Reference:

- [OpenID connect core - ID Token Validation](https://openid.net/specs/openid-connect-core-1_0.html#IDTokenValidation)

###### Parameters

| Name     | Type            |
| -------- | --------------- |
| idToken  | `string`        |
| clientId | `string`        |
| issuer   | `string`        |
| jwks     | `JsonWebKeySet` |

###### Return Type

`void`

###### Throws

- verify signing key failed
- verify claims failed

##### verifyAndParseCodeFromCallbackUri

Verify the sign-in callbackUri is legal and return the `code` extracted from callbackUri.

###### Verify Callback URI

- Verify the `callbackUri` should start with `redirectUri`
- Verify there is no `error` in the `callbackUri` (Refer to [Error Response](https://datatracker.ietf.org/doc/html/rfc6749#section-4.1.2.1) in redirect URI).
- Verify the `callbackUri` contains `state`, which should equal to the `state` value you specified in [generateSignInUri](#generateSignInUri).
- Verify the `callbackUri` contains the parameter value `code`, which you will use when requesting to `/oidc/token` (by refresh token).

###### Parameters

| Name        | Type     |
| ----------- | -------- |
| callbackUri | `string` |
| redirectUri | `string` |
| state       | `string` |

###### Return Type

`string`

###### Throws

- verifications failed

#### Core Functions (TBD)

## Platform SDK

Platform SDK provides a standard way to integrate the client with Logto service in the specific platform and accelerates the integration process.

- Platform SDK encapsulates [the core](#core) with platform-specific implementation.
- Platform SDK should provide basic types that make SDK easier to use.
- Platform SDK should be exported as a class named `LogtoClient`.

### Basic Types

#### LogtoConfig (TBD)

#### AccessToken (TBD)

### LogtoClient

#### LogtoClient (TBD)
